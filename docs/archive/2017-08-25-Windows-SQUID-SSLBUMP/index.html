<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-archive/2017-08-25-Windows-SQUID-SSLBUMP" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Setting up HTTPS inspection (mitm) with Windows Squid | The Uncommon Engineer</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ronamosa.io/docs/archive/2017-08-25-Windows-SQUID-SSLBUMP"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Setting up HTTPS inspection (mitm) with Windows Squid | The Uncommon Engineer"><meta data-rh="true" name="description" content="I needed a way to inspect HTTPS traffic on my home network. Some dodgy browsing going on and i wanted to see it all, HTTPS included. Solution? Setup a squid proxy with ssl-bump configured to handle HTTPS."><meta data-rh="true" property="og:description" content="I needed a way to inspect HTTPS traffic on my home network. Some dodgy browsing going on and i wanted to see it all, HTTPS included. Solution? Setup a squid proxy with ssl-bump configured to handle HTTPS."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ronamosa.io/docs/archive/2017-08-25-Windows-SQUID-SSLBUMP"><link data-rh="true" rel="alternate" href="https://ronamosa.io/docs/archive/2017-08-25-Windows-SQUID-SSLBUMP" hreflang="en"><link data-rh="true" rel="alternate" href="https://ronamosa.io/docs/archive/2017-08-25-Windows-SQUID-SSLBUMP" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9UFF3RBJQ9-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Setting up HTTPS inspection (mitm) with Windows Squid","item":"https://ronamosa.io/docs/archive/2017-08-25-Windows-SQUID-SSLBUMP"}]}</script><link rel="search" type="application/opensearchdescription+xml" title="The Uncommon Engineer" href="/opensearch.xml">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DMRNTVGLRC"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DMRNTVGLRC",{anonymize_ip:!0})</script>

<script src="/js/console-clue.js"></script>
<script src="/js/metricool.js"></script><link rel="stylesheet" href="/assets/css/styles.dd12b5e8.css">
<script src="/assets/js/runtime~main.cb34a51e.js" defer="defer"></script>
<script src="/assets/js/main.fb1c5b66.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="ronamosa.io" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="ronamosa.io" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Uncommon Engineer</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog/">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/projects/">Projects</a><a class="navbar__item navbar__link" href="/changelog/">Changelog</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">▶ Start Here</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/books/reading-list">📚 Books &amp; Papers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/study/SCS-C01/">📗 Study</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/️-hacker">🏴‍☠️ Hacker</a><button aria-label="Expand sidebar category &#x27;🏴‍☠️ Hacker&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/-engineer">💻 Engineer</a><button aria-label="Expand sidebar category &#x27;💻 Engineer&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/archive/docker-wordpress/docker-wordpress-1">🗃 Archive</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/archive/docker-wordpress/docker-wordpress-1">Docker Wordpress Site</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/archive/terraform-aws-ec2/terraform-aws-1">Terraform AWS EC2</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2016-02-13-Ansible-CreateVMs-Vsphere-free_version">Creating VM&#x27;s using Ansible and ESXi 5.5 Free Version.</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2016-03-01-CISCO-ASA-VLAN-SETUP">Setting up a CISCO ASA 5505 VLAN &amp; VPN</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2016-03-18-First-Config_CISCO-ASA5505">Initializing a CISCO ASA 5505</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2017-01-20-Docker-Private-Registry_v1.0">Docker Trusted Registry (private) 1.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2017-06-09-Docker-volumes-no-such-file-ISSUE">Troubleshooting Docker Volumes errors</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2017-06-20-Docker-Jenkins-Pipeline-permission-ISSUES">Troubleshooting Docker issues on a Jenkins Pipeline</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2017-07-10-i3wm-Block-Status-Screen">i3wm (Window Manager) + Blocks + Screencasting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2017-07-18-RaspberryPi-Kali-Reverse-STunnel">Kali Raspberry Pi Reverse Shell (STunnel)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2017-08-23-FreeNAS-Torrent-Over_OpenVPN">FreeNAS: Using Transmission over OpenVPN (jailed)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/archive/2017-08-25-Windows-SQUID-SSLBUMP">Setting up HTTPS inspection (mitm) with Windows Squid</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2017-09-12-Windows10Pro-RDP-AzureADJoined">RDP to a Azure AD Joined Device</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2017-09-14-Reset_Win10_Passwd_Vmware_Guest">Reset Windows10 VMWare Guest Password.</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2017-10-13-Docker_Private_Registry_v2.0">Docker Private Registry 2.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2017-10-20-NGINX-Centos7-SELinux">NGINX on CentOS 7 with SELinux issues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2017-10-21-Jenkins_Setup_CentOS7">Setup a Jenkins Server on CentOS 7</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2017-10-22-Ubuntu-Desktop-USB-Thinkpad13">Quick Note - Install Ubuntu 16.04 via bootable USB</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2018-04-13-Docker-Remote-Work-Fortinet">Docker: Fortinet VPN in a container for remote work</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2018-04-21-Cisco-WAP200-Firmware-Upgrade">Cisco WAP200 Firmware Upgrade</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2018-06-23-Apache-Reverse-Proxy-TLSv1-2">Apache Reverse TLSv1.2 Proxy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2018-07-29-Building-my-AWS-s3-jekyll-blog">AWS S3 Static Blog</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2019-02-04-Delete-VirtualBox-VM-HDD">VirtualBox: Purge deleted hard disks.</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2020-04-27-Install-AWS-eksctl">Install eksctl tool for AWS Elastic Kubernetes Service (EKS)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2020-09-18-EKS-Spot-Instances">EKS with Spot Instances using Terraform</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2020-11-19-Ubiquiti-Home-Network-Part1">Ubiquiti Home Network: Part.1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/2020-11-28-Ubiquiti-Home-Network-Part2">Ubiquiti Home Network: Part.2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/archive/secret-page">The Unix Programmers Manual</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">🗃 Archive</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Setting up HTTPS inspection (mitm) with Windows Squid</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Setting up HTTPS inspection (mitm) with Windows Squid</h1></header><p>I needed a way to inspect HTTPS traffic on my home network. Some dodgy browsing going on and i wanted to see it all, HTTPS included. Solution? Setup a squid proxy with ssl-bump configured to handle HTTPS.</p>
<p>I&#x27;m a linux guy so my windows admin is meh, setting up a traditionally unix-based service on my windows server 2012 was a bit of a mission. But here are my notes from getting it (as far as i can tell) working.</p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_BuS1"><p>You can follow all these steps on the <a href="https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit" target="_blank" rel="noopener noreferrer">wiki</a> but just as i wished someone had written some of the documentation a little bit clearer, so i leave this here.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="requirements">Requirements<a href="#requirements" class="hash-link" aria-label="Direct link to Requirements" title="Direct link to Requirements">​</a></h2>
<ul>
<li>Windows Server 2012</li>
<li><a href="http://packages.diladele.com/squid/3.5.26/squid.msi" target="_blank" rel="noopener noreferrer">Squid 3.5.26 for Microsoft Windows</a></li>
<li><a href="https://cygwin.com/setup-x86_64.exe" target="_blank" rel="noopener noreferrer">Cygwin x86_64</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="installation">Installation<a href="#installation" class="hash-link" aria-label="Direct link to Installation" title="Direct link to Installation">​</a></h2>
<p>run the MS Squid MSI install GUI:</p>
<p><img decoding="async" loading="lazy" alt="squid gui install" src="/assets/images/windows-squid-gui-install-402bbe044db1127a1b9dc2ed3b30be2e.png" width="509" height="398" class="img_ev3q"></p>
<p>when you&#x27;re done you should have a little menu in the task bar, and when you run <code>services.msc</code> you should see a &#x27;Squid for Windows&#x27; service in &#x27;running&#x27; status.</p>
<p>run the Cygwin <code>setup-x86_64.exe</code> you downloaded:</p>
<p><img decoding="async" loading="lazy" alt="squid gui install" src="/assets/images/windows-squid-cygwingui-42a1d8d0d6142dd938aef73e436aef61.png" width="546" height="400" class="img_ev3q"></p>
<p>when this is done you should have a new desktop shortcut to crack open a cygwin terminal when you need one. also a &#x27;squid&#x27; terminal, which is just a &#x27;cmd&#x27; session in the squid home directory:</p>
<p><img decoding="async" loading="lazy" alt="squid gui install" src="/assets/images/windows-squid-shortcuts-a92ac8ddc401ffebb4b9375a837d35a7.png" width="92" height="345" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="create-your-proxy-root-ca-certificate">Create your Proxy ROOT CA certificate<a href="#create-your-proxy-root-ca-certificate" class="hash-link" aria-label="Direct link to Create your Proxy ROOT CA certificate" title="Direct link to Create your Proxy ROOT CA certificate">​</a></h2>
<p>I use the desktop cygwin shortcut to open a cygwin terminal to run some <code>openssl</code> commands to create your proxy servers ROOT Certificate Authority (CA) certificate.</p>
<p>I opened a cygwin terminal, changed into the squid installation directory <code>/cygdrive/c/Squid-3.5/etc/ssl</code> and ran my openssl command there:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">cd /cygdrive/c/Squid-3.5/etc/ssl</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">openssl req -new -newkey rsa:2048 -sha256 -days 365 -nodes -x509 -extensions v3_ca -keyout caproxy.pem -out caproxy.pem</span><br></span></code></pre></div></div>
<p>generate a certificate in a format (DER) you can import into client browsers/computers (via certificate import wizard)</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">openssl x509 -in caproxy.pem -outform DER -out caproxy.der</span><br></span></code></pre></div></div>
<p>I imported this .der certificate into the &#x27;Trusted Root Certification Authorities&#x27; folder on a client PC on my network.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="configure-squidconf-on-server">Configure squid.conf on server<a href="#configure-squidconf-on-server" class="hash-link" aria-label="Direct link to Configure squid.conf on server" title="Direct link to Configure squid.conf on server">​</a></h2>
<p>I modified the following section from <a href="https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit" target="_blank" rel="noopener noreferrer">wiki.squid-cache.org</a>
to match my installation.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">http_port 3128 ssl-bump \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  cert=/etc/ssl/caproxy.pem \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  generate-host-certificates=on dynamic_cert_mem_cache_size=4MB</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># For squid 3.5.x</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sslcrtd_program /lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl step1 at_step SslBump1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ssl_bump peek step1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ssl_bump bump all</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="errors-when-restarting-squid">Errors when restarting Squid<a href="#errors-when-restarting-squid" class="hash-link" aria-label="Direct link to Errors when restarting Squid" title="Direct link to Errors when restarting Squid">​</a></h2>
<p>When restarting for first time with the ssl settings enabled in your squid.conf you&#x27;re going to run into a few errors.
in <code>/var/log/cache.log</code> you&#x27;ll see this:
<code>(ssl_crtd): Uninitialized SSL certificate database directory: /var/lib/ssl_db. To initialize, run &quot;ssl_crtd -c -s /var/lib/ssl_db&quot;.</code></p>
<p>and squid will finally crash out with this (you&#x27;ll see this error in EventViewer as well):
<code>FATAL: The ssl_crtd helpers are crashing too rapidly, need help!</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-fix">The Fix<a href="#the-fix" class="hash-link" aria-label="Direct link to The Fix" title="Direct link to The Fix">​</a></h2>
<p>As you can see from the error message, we need to initialize our ssl cer db directory with <code>run &quot;ssl_crtd -c -s /var/lib/ssl_db&quot;.</code></p>
<p>now, open a &#x27;Squid Terminal&#x27; from your desktop shortcut in Windows Server 2012 and navigate to where the &#x27;ssl_crtd.exe&#x27; program is (e.g. for me, C:\Squid-3.5\lib\squid)</p>
<p>and run:</p>
<div class="language-dos codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-dos codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">C:\Squid-3.5\lib\squid\ssl_crtd.exe -c -s C:\Squid-3.5\var\lib\ssl_db</span><br></span></code></pre></div></div>
<p><strong>key thing to note here:</strong></p>
<ul>
<li>the dir &#x27;ssl_db&#x27; must <em>NOT ALREADY EXIST.</em> (or else you&#x27;re going to have a very bad time)</li>
</ul>
<p>Don&#x27;t be a dumbass like me and follow the error message <code>ssl_crtd: Cannot create blah blah</code> into a vortex of online forums about it that point to &quot;squid with cygwin is broken and therefore can never do ssl bumping for https traffic&quot;.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="success-finally">Success! (finally)<a href="#success-finally" class="hash-link" aria-label="Direct link to Success! (finally)" title="Direct link to Success! (finally)">​</a></h2>
<p><img decoding="async" loading="lazy" alt="squid crtd success" src="/assets/images/windows-squid-ssl_crtd-7e965af0e132aaea5583e54c8a9ebbd6.png" width="678" height="343" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="restart-squid-service-again">Restart Squid service (again)<a href="#restart-squid-service-again" class="hash-link" aria-label="Direct link to Restart Squid service (again)" title="Direct link to Restart Squid service (again)">​</a></h2>
<p>If your install and configuration was successful, check logfile <code>/var/log/cache.log</code>, and it should look like this:</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">Squid Cache (Version 3.5.26): Terminated abnormally.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">CPU Usage: 0.203 seconds = 0.125 user + 0.078 sys</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Maximum Resident Size: 1304576 KB</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Page faults with physical i/o: 5202</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:42 kid1| Set Current Directory to /var/cache/squid</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:42 kid1| Starting Squid Cache version 3.5.26 for x86_64-unknown-cygwin...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:42 kid1| Service Name: squid</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:42 kid1| Process ID 2944</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:42 kid1| Process Roles: worker</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:42 kid1| With 3200 file descriptors available</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:42 kid1| Initializing IP Cache...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:42 kid1| parseEtcHosts: /etc/hosts: (2) No such file or directory</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:42 kid1| DNS Socket created at [::], FD 5</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:42 kid1| DNS Socket created at 0.0.0.0, FD 6</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:42 kid1| Adding nameserver 8.8.8.8 from squid.conf</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:42 kid1| Adding nameserver 208.67.222.222 from squid.conf</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:42 kid1| helperOpenServers: Starting 5/32 &#x27;ssl_crtd&#x27; processes</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:42 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:42 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:42 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:43 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:43 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:43 kid1| Logfile: opening log daemon:/var/log/squid/access.log</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:43 kid1| Logfile Daemon: opening log /var/log/squid/access.log</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:43 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:43 kid1| Store logging disabled</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:43 kid1| Swap maxSize 0 + 262144 KB, estimated 20164 objects</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:43 kid1| Target number of buckets: 1008</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:43 kid1| Using 8192 Store buckets</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:43 kid1| Max Mem  size: 262144 KB</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:43 kid1| Max Swap size: 0 KB</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:43 kid1| Using Least Load store dir selection</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:43 kid1| Set Current Directory to /var/cache/squid</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:43 kid1| Finished loading MIME types and icons.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:43 kid1| HTCP Disabled.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:43 kid1| Squid plugin modules loaded: 0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:43 kid1| Adaptation support is off.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:43 kid1| Accepting SSL bumped HTTP Socket connections at local=[::]:3128 remote=[::] FD 21 flags=9</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:44 kid1| storeLateRelease: released 0 objects</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Set Current Directory to /var/cache/squid</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Starting Squid Cache version 3.5.26 for x86_64-unknown-cygwin...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Service Name: squid</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Process ID 144</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Process Roles: worker</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| With 3200 file descriptors available</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Initializing IP Cache...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| parseEtcHosts: /etc/hosts: (2) No such file or directory</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| DNS Socket created at [::], FD 5</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| DNS Socket created at 0.0.0.0, FD 6</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Adding nameserver 8.8.8.8 from squid.conf</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Adding nameserver 208.67.222.222 from squid.conf</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| helperOpenServers: Starting 5/32 &#x27;ssl_crtd&#x27; processes</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Logfile: opening log daemon:/var/log/squid/access.log</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Logfile Daemon: opening log /var/log/squid/access.log</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Store logging disabled</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Swap maxSize 0 + 262144 KB, estimated 20164 objects</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Target number of buckets: 1008</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Using 8192 Store buckets</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Max Mem  size: 262144 KB</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Max Swap size: 0 KB</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Using Least Load store dir selection</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Set Current Directory to /var/cache/squid</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Finished loading MIME types and icons.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| HTCP Disabled.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Squid plugin modules loaded: 0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Adaptation support is off.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:25 kid1| Accepting SSL bumped HTTP Socket connections at local=[::]:3128 remote=[::] FD 21 flags=9</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:59:26 kid1| storeLateRelease: released 0 objects</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 21:01:41 kid1| Starting new ssl_crtd helpers...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 21:01:41 kid1| helperOpenServers: Starting 1/32 &#x27;ssl_crtd&#x27; processes</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 21:01:41 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 21:30:14 kid1| Error negotiating SSL on FD 11: error:14090086:SSL routines:ssl3_get_server_certificate:certificate verify failed (1/-1/0)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 21:30:15 kid1| Error negotiating SSL on FD 11: error:14090086:SSL routines:ssl3_get_server_certificate:certificate verify failed (1/-1/0)</span><br></span></code></pre></div></div>
<p>now, this config could probably do with some more work and testing, but this is the bare bones of it and i wanted to get it down before i didn&#x27;t care about it anymore lol.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="set-client-computers-to-use-proxy">Set client computers to use proxy<a href="#set-client-computers-to-use-proxy" class="hash-link" aria-label="Direct link to Set client computers to use proxy" title="Direct link to Set client computers to use proxy">​</a></h2>
<p>on client side computer:</p>
<ol>
<li>open &#x27;internet options&#x27;</li>
<li>go to &#x27;communications&#x27; tab</li>
<li>click &#x27;LAN settings&#x27;</li>
<li>check &#x27;Use a proxy server&#x27;</li>
<li>Address: <code>IP of your proxy server</code></li>
<li>Port: 3128</li>
</ol>
<p>Get browsing and everything should connect/display for the client, no cert errors/issues, fully transparent.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting">Troubleshooting<a href="#troubleshooting" class="hash-link" aria-label="Direct link to Troubleshooting" title="Direct link to Troubleshooting">​</a></h2>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reference">Reference<a href="#reference" class="hash-link" aria-label="Direct link to Reference" title="Direct link to Reference">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="full-squidconf-file">full <code>squid.conf</code> file<a href="#full-squidconf-file" class="hash-link" aria-label="Direct link to full-squidconf-file" title="Direct link to full-squidconf-file">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">#</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Recommended minimum configuration:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Example rule allowing access from your local networks.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Adapt to list your (internal) IP networks from where browsing</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># should be allowed</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl localnet src 10.0.0.0/8	# RFC1918 possible internal network</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl localnet src 172.16.0.0/12	# RFC1918 possible internal network</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl localnet src 192.168.0.0/16	# RFC1918 possible internal network</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl localnet src fc00::/7       # RFC 4193 local private network range</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl SSL_ports port 443</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl Safe_ports port 80		# http</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl Safe_ports port 21		# ftp</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl Safe_ports port 443		# https</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl Safe_ports port 70		# gopher</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl Safe_ports port 210		# wais</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl Safe_ports port 1025-65535	# unregistered ports</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl Safe_ports port 280		# http-mgmt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl Safe_ports port 488		# gss-http</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl Safe_ports port 591		# filemaker</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl Safe_ports port 777		# multiling http</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl CONNECT method CONNECT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Recommended minimum Access Permission configuration:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Only allow cachemgr access from localhost</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">http_access allow localhost manager</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">http_access deny manager</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Deny requests to certain unsafe ports</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">http_access deny !Safe_ports</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Deny CONNECT to other than secure SSL ports</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">http_access deny CONNECT !SSL_ports</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># We strongly recommend the following be uncommented to protect innocent</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># web applications running on the proxy server who think the only</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># one who can access services on &quot;localhost&quot; is a local user</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#http_access deny to_localhost</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Example rule allowing access from your local networks.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Adapt localnet in the ACL section to list your (internal) IP networks</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># from where browsing should be allowed</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">http_access allow localnet</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">http_access allow localhost</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># And finally deny all other access to this proxy</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#http_access deny all</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Squid normally listens to port 3128</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#http_port 3128</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">http_port 3128 ssl-bump \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  cert=/etc/ssl/caproxy.pem \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  generate-host-certificates=on dynamic_cert_mem_cache_size=4MB</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># For squid 3.5.x</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sslcrtd_program /lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">acl step1 at_step SslBump1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ssl_bump peek step1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ssl_bump bump all</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Uncomment the line below to enable disk caching - path format is /cygdrive/&lt;full path to cache folder /&gt;, i.e.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#cache_dir aufs /cygdrive/d/squid/cache 3000 16 256</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Leave coredumps in the first cache dir</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">coredump_dir /var/cache/squid</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Add any of your own refresh_pattern entries above these.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">refresh_pattern ^ftp:		1440	20%	10080</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">refresh_pattern ^gopher:	1440	0%	1440</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">refresh_pattern -i (/cgi-bin/|\?) 0	0%	0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">refresh_pattern .		0	20%	4320</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dns_nameservers 8.8.8.8 208.67.222.222</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">max_filedescriptors 3200</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="full-error-output-in-varlogsquidcachelog">full error output in <code>/var/log/squid/cache.log</code><a href="#full-error-output-in-varlogsquidcachelog" class="hash-link" aria-label="Direct link to full-error-output-in-varlogsquidcachelog" title="Direct link to full-error-output-in-varlogsquidcachelog">​</a></h3>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| helperOpenServers: Starting 5/32 &#x27;ssl_crtd&#x27; processes</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(ssl_crtd): Uninitialized SSL certificate database directory: /var/lib/ssl_db. To initialize, run &quot;ssl_crtd -c -s /var/lib/ssl_db&quot;.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(ssl_crtd): Uninitialized SSL certificate database directory: /var/lib/ssl_db. To initialize, run &quot;ssl_crtd -c -s /var/lib/ssl_db&quot;.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(ssl_crtd): Uninitialized SSL certificate database directory: /var/lib/ssl_db. To initialize, run &quot;ssl_crtd -c -s /var/lib/ssl_db&quot;.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(ssl_crtd): Uninitialized SSL certificate database directory: /var/lib/ssl_db. To initialize, run &quot;ssl_crtd -c -s /var/lib/ssl_db&quot;.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| Logfile: opening log daemon:/var/log/squid/access.log</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| Logfile Daemon: opening log /var/log/squid/access.log</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(ssl_crtd): Uninitialized SSL certificate database directory: /var/lib/ssl_db. To initialize, run &quot;ssl_crtd -c -s /var/lib/ssl_db&quot;.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| WARNING: no_suid: setuid(0): (22) Invalid argument</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| Store logging disabled</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| Swap maxSize 0 + 262144 KB, estimated 20164 objects</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| Target number of buckets: 1008</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| Using 8192 Store buckets</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| Max Mem  size: 262144 KB</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| Max Swap size: 0 KB</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| Using Least Load store dir selection</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| Set Current Directory to /var/cache/squid</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| Finished loading MIME types and icons.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| HTCP Disabled.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| Squid plugin modules loaded: 0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| Adaptation support is off.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| Accepting SSL bumped HTTP Socket connections at local=[::]:3128 remote=[::] FD 21 flags=9</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| WARNING: ssl_crtd #Hlpr1 exited</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| Too few ssl_crtd processes are running (need 1/32)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| Closing HTTP port [::]:3128</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1| storeDirWriteCleanLogs: Starting...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1|   Finished.  Wrote 0 entries.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2017/08/25 20:58:33 kid1|   Took 0.00 seconds (  0.00 entries/sec).</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">FATAL: The ssl_crtd helpers are crashing too rapidly, need help!</span><br></span></code></pre></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/archive/2017-08-25-Windows-SQUID-SSLBUMP.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-09-22T07:31:42.000Z" itemprop="dateModified">Sep 22, 2025</time></b> by <b>Ron Amosa</b></span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/archive/2017-08-23-FreeNAS-Torrent-Over_OpenVPN"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">FreeNAS: Using Transmission over OpenVPN (jailed)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/archive/2017-09-12-Windows10Pro-RDP-AzureADJoined"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">RDP to a Azure AD Joined Device</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#requirements" class="table-of-contents__link toc-highlight">Requirements</a></li><li><a href="#installation" class="table-of-contents__link toc-highlight">Installation</a></li><li><a href="#create-your-proxy-root-ca-certificate" class="table-of-contents__link toc-highlight">Create your Proxy ROOT CA certificate</a></li><li><a href="#configure-squidconf-on-server" class="table-of-contents__link toc-highlight">Configure squid.conf on server</a></li><li><a href="#errors-when-restarting-squid" class="table-of-contents__link toc-highlight">Errors when restarting Squid</a></li><li><a href="#the-fix" class="table-of-contents__link toc-highlight">The Fix</a></li><li><a href="#success-finally" class="table-of-contents__link toc-highlight">Success! (finally)</a></li><li><a href="#restart-squid-service-again" class="table-of-contents__link toc-highlight">Restart Squid service (again)</a></li><li><a href="#set-client-computers-to-use-proxy" class="table-of-contents__link toc-highlight">Set client computers to use proxy</a></li><li><a href="#troubleshooting" class="table-of-contents__link toc-highlight">Troubleshooting</a></li><li><a href="#reference" class="table-of-contents__link toc-highlight">Reference</a><ul><li><a href="#full-squidconf-file" class="table-of-contents__link toc-highlight">full <code>squid.conf</code> file</a></li><li><a href="#full-error-output-in-varlogsquidcachelog" class="table-of-contents__link toc-highlight">full error output in <code>/var/log/squid/cache.log</code></a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/ron-amosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/ronamosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@uncommonengineer" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Discover</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/docs">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/about">About</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Last updated on Mon Sep 22 2025</div></div></div></footer></div>
</body>
</html>