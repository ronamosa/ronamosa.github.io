<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-study/CKS/Microservice Vulnerability/VulnerableSecrets" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Manage Kubernetes Secrets | The Uncommon Engineer</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:image" content="https://www.uncommonengineer.com/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://www.uncommonengineer.com/img/social-card.png"><meta data-rh="true" property="og:url" content="https://www.uncommonengineer.com/docs/study/CKS/Microservice Vulnerability/VulnerableSecrets"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Manage Kubernetes Secrets | The Uncommon Engineer"><meta data-rh="true" name="description" content="secrets - passords, api keys, creds"><meta data-rh="true" property="og:description" content="secrets - passords, api keys, creds"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.uncommonengineer.com/docs/study/CKS/Microservice Vulnerability/VulnerableSecrets"><link data-rh="true" rel="alternate" href="https://www.uncommonengineer.com/docs/study/CKS/Microservice Vulnerability/VulnerableSecrets" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.uncommonengineer.com/docs/study/CKS/Microservice Vulnerability/VulnerableSecrets" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9UFF3RBJQ9-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"‚ò∏ CKS","item":"https://www.uncommonengineer.com/docs/study/CKS/kubernetes-security-specialist-cks-study-guide"},{"@type":"ListItem","position":2,"name":"Manage Kubernetes Secrets","item":"https://www.uncommonengineer.com/docs/study/CKS/Microservice Vulnerability/VulnerableSecrets"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="The Uncommon Engineer RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="The Uncommon Engineer Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="The Uncommon Engineer" href="/opensearch.xml">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DMRNTVGLRC"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DMRNTVGLRC",{anonymize_ip:!0})</script>

<script src="/js/console-clue.js"></script>
<script src="/js/metricool.js"></script>
<script src="https://subscribe-forms.beehiiv.com/embed.js" async></script><link rel="stylesheet" href="/assets/css/styles.5170efae.css">
<script src="/assets/js/runtime~main.3d5cd519.js" defer="defer"></script>
<script src="/assets/js/main.727d0b4f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.svg" alt="The Uncommon Engineer" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/profile.svg" alt="The Uncommon Engineer" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Uncommon Engineer</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Technical</a><a class="navbar__item navbar__link" href="/blog/">Analysis &amp; Essays</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/projects/">Projects</a><a class="navbar__item navbar__link" href="/changelog/">Changelog</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">‚ñ∂ Start Here</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/books/reading-list">üìö Books &amp; Papers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/study/SCS-C01/">üìó Study</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/study/SCS-C01/">‚òÅÔ∏è SCS-01</a><button aria-label="Expand sidebar category &#x27;‚òÅÔ∏è SCS-01&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/study/SAA-03/aws-solutions-architect-associate-study-guide">‚òÅÔ∏è SAA-03</a><button aria-label="Expand sidebar category &#x27;‚òÅÔ∏è SAA-03&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/study/CCP/">‚òÅÔ∏è CCP</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/study/CKS/kubernetes-security-specialist-cks-study-guide">‚ò∏ CKS</a><button aria-label="Collapse sidebar category &#x27;‚ò∏ CKS&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/study/CKS/ExamNotes">Exam Notes</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/study/CKS/Cluster Setup/ClusterDashboard">Cluster Setup</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/study/CKS/Cluster Hardening/HardenRBAC">Cluster Hardening</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/study/CKS/System Hardening/SystemHardAppArmorSeccomp">System Hardening</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/study/CKS/Microservice Vulnerability/VulnerableContainerRuntime">Microservice Vulnerability</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/study/CKS/Microservice Vulnerability/VulnerableContainerRuntime">Container Runtime Sandboxes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/study/CKS/Microservice Vulnerability/VulnerableMTLS">Mutual TLS (mTLS)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/study/CKS/Microservice Vulnerability/VulnerableOSLevelSecurity">OS Level Security Domains</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/study/CKS/Microservice Vulnerability/VulnerableSecrets">Manage Kubernetes Secrets</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/study/CKS/Supply Chain Security/SupplyChainImages">Supply Chain Security</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/study/CKS/Runtime Security/RuntimeAuditing">Runtime Security</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/study/CKS/OPAGatekeeper">Open Policy Agent (OPA)</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/study/CKA/kubernetes-administrator-cka-study-guide">‚ò∏ CKA</a><button aria-label="Expand sidebar category &#x27;‚ò∏ CKA&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/study/Golang/go-the-complete-developers-guide">Golang</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/Ô∏è-hacker">üè¥‚Äç‚ò†Ô∏è Hacker</a><button aria-label="Expand sidebar category &#x27;üè¥‚Äç‚ò†Ô∏è Hacker&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/-engineer">üíª Engineer</a><button aria-label="Expand sidebar category &#x27;üíª Engineer&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/archive/docker-wordpress/docker-wordpress-1">üóÉ Archive</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">üìó Study</span></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/study/CKS/kubernetes-security-specialist-cks-study-guide"><span>‚ò∏ CKS</span></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Microservice Vulnerability</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Manage Kubernetes Secrets</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Manage Kubernetes Secrets</h1></header><p>secrets - passords, api keys, creds</p>
<p>k8s secrets source to deployment flow:</p>
<p>code --&gt; git --&gt; api server --&gt; kubelet<!-- -->:pod<!-- -->
secret --&gt; api server --&gt; kubelet<!-- -->:pod</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="simple-secret-scenario">simple secret scenario<a href="#simple-secret-scenario" class="hash-link" aria-label="Direct link to simple secret scenario" title="Direct link to simple secret scenario">‚Äã</a></h2>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">k create secret generic secret1 --from-literal user=admin</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">k create secret generic secret2 --from-literal pass=12345</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">k run pod --image=nginx --dry-run=client -oyaml &gt; pod.yaml</span><br></span></code></pre></div></div>
<p>edit <code>pod.yaml</code> add secrets mounts and env var</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">creationTimestamp</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token null important">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> pod</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> pod</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> pod</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> PASSWORD</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">secretKeyRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> secret2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> pass</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">volumeMounts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> secret1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">mountPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/etc/secret1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">readOnly</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> secret1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">secret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">secretName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> secret1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">dnsPolicy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ClusterFirst</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Always</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">status</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<p>create it <code>k create -f ./pod.yaml</code></p>
<p>check our ENV var shows our password: <code>k exec pod -- env | grep PASS</code>
check our mount shows our user: <code>k exec pod -- cat /etc/secret1/user</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="hack-secrets-in-docker">Hack secrets in Docker<a href="#hack-secrets-in-docker" class="hash-link" aria-label="Direct link to Hack secrets in Docker" title="Direct link to Hack secrets in Docker">‚Äã</a></h2>
<p>on worker node, run docker find out container</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-worker:~# docker ps | grep nginx</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">b74bd0f17bba   nginx                    &quot;/docker-entrypoint.‚Ä¶&quot;   21 seconds ago   Up 20 seconds             k8s_pod_pod_default_ce59b0e2-7c2c-4392-a769-49c50c4d75ce_0</span><br></span></code></pre></div></div>
<p>inspect that container id and look through the filesystem to find secrets</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-worker:~# docker inspect b74bd0f17bba | grep -i pass</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                &quot;PASSWORD=12345&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># look at these mounts</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-worker:~# docker inspect b74bd0f17bba | grep -i volume</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                &quot;/var/lib/kubelet/pods/ce59b0e2-7c2c-4392-a769-49c50c4d75ce/volumes/kubernetes.io~secret/secret1:/etc/secret1:ro&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                &quot;/var/lib/kubelet/pods/ce59b0e2-7c2c-4392-a769-49c50c4d75ce/volumes/kubernetes.io~projected/kube-api-access-5khc6:/var/run/secrets/kubernetes.io/serviceaccount:ro&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            &quot;VolumeDriver&quot;: &quot;&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            &quot;VolumesFrom&quot;: null,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                &quot;Source&quot;: &quot;/var/lib/kubelet/pods/ce59b0e2-7c2c-4392-a769-49c50c4d75ce/volumes/kubernetes.io~secret/secret1&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                &quot;Source&quot;: &quot;/var/lib/kubelet/pods/ce59b0e2-7c2c-4392-a769-49c50c4d75ce/volumes/kubernetes.io~projected/kube-api-access-5khc6&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            &quot;Volumes&quot;: null,</span><br></span></code></pre></div></div>
<p>copy this container filesystem to local</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-worker:~# docker cp b74bd0f17bba:/etc/secret1 secret1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-worker:~# cd secret1/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-worker:~/secret1# ls</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">user</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-worker:~/secret1# cat user </span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">admin</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="hack-secrets-in-etcd">Hack Secrets in ETCD<a href="#hack-secrets-in-etcd" class="hash-link" aria-label="Direct link to Hack Secrets in ETCD" title="Direct link to Hack Secrets in ETCD">‚Äã</a></h2>
<p>commands used</p>
<p>note: had to install etcdctl <code>root@cks-master:~# apt install -y etcd-client</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain"># access secret int etcd</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-master:~# cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep etcd</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    - --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    - --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    - --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    - --etcd-servers=https://127.0.0.1:2379</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># check health etcd</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-master:~# ETCDCTL_API=3 etcdctl endpoint health</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{&quot;level&quot;:&quot;warn&quot;,&quot;ts&quot;:&quot;2021-09-04T22:27:00.050Z&quot;,&quot;caller&quot;:&quot;clientv3/retry_interceptor.go:62&quot;,&quot;msg&quot;:&quot;retrying of unary invoker failed&quot;,&quot;target&quot;:&quot;endpoint://client-7340418a-6871-4270-ad79-7d02f2a2bb48/127.0.0.1:2379&quot;,&quot;attempt&quot;:0,&quot;error&quot;:&quot;rpc error: code = DeadlineExceeded desc = latest connection error: connection closed&quot;}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">127.0.0.1:2379 is unhealthy: failed to commit proposal: context deadline exceeded</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Error: unhealthy cluster</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># use the creds as per kube-apiserver.yaml</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ETCDCTL_API=3 etcdctl --cert /etc/kubernetes/pki/apiserver-etcd-client.crt --key /etc/kubernetes/pki/apiserver-etcd-client.key --cacert /etc/kubernetes/pki/etcd/ca.crt endpoint health</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">127.0.0.1:2379 is healthy: successfully committed proposal: took = 1.076931ms</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># --endpoints &quot;https://127.0.0.1:2379&quot; not necessary because we‚Äôre on same node</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># get secrets from `/registry/secrets/default/secret1`</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-master:~# ETCDCTL_API=3 etcdctl --cert /etc/kubernetes/pki/apiserver-etcd-client.crt --key /etc/kubernetes/pki/apiserver-etcd-client.key --cacert /etc/kubernetes/pki/etcd/ca.crt get /registry/secrets/default/secret1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/registry/secrets/default/secret1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">k8s</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">v1SecretÔøΩ</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ÔøΩ</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret1default&quot;*$952203d4-d5f6-4bbe-8f57-386c638c93bf2ÔøΩÔøΩœâzÔøΩ_</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl-createUpdatevÔøΩÔøΩœâFieldsV1:-</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">+{&quot;f:data&quot;:{&quot;.&quot;:{},&quot;f:user&quot;:{\}\},&quot;f:type&quot;:{\}\}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">useradminOpaque&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># see the key-pair = &quot;useradmin&quot;? now get password</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-master:~# ETCDCTL_API=3 etcdctl --cert /etc/kubernetes/pki/apiserver-etcd-client.crt --key /etc/kubernetes/pki/apiserver-etcd-client.key --cacert /etc/kubernetes/pki/etcd/ca.crt get /registry/secrets/default/secret2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/registry/secrets/default/secret2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">k8s</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">v1SecretÔøΩ</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ÔøΩ</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret2default&quot;*$14c16e50-0eb3-469a-9b96-be79622d08ac2ÔøΩÔøΩœâzÔøΩ_</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl-createUpdatevÔøΩÔøΩœâFieldsV1:-</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">+{&quot;f:data&quot;:{&quot;.&quot;:{},&quot;f:pass&quot;:{\}\},&quot;f:type&quot;:{\}\}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">pass12345Opaque&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>lesson here - unencrypted plain text secrets stored in ETCD.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="encrypt-etcd-at-rest">Encrypt ETCD at rest<a href="#encrypt-etcd-at-rest" class="hash-link" aria-label="Direct link to Encrypt ETCD at rest" title="Direct link to Encrypt ETCD at rest">‚Äã</a></h2>
<p>API server&#x27;s only thing allowed to talk to ETCD, so its responsible for encrypt/decrypt in this flow.</p>
<p>read <a href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data" target="_blank" rel="noopener noreferrer">etcd docs</a> page for encrypt/decrypt secrets.</p>
<p>Resource created kind <code>EncryptionConfiguration</code></p>
<ul>
<li>specify what resources to be encrypted by this config e.g. secrets</li>
<li>providers list array of encryption providers<!-- -->
<ul>
<li>the <code>identity: {}</code> provider is a &quot;no encryption&quot; provider</li>
<li>e.g. aesgcm, aescbc</li>
</ul>
</li>
</ul>
<p><strong>important</strong>: on STORE - providers used in ORDER - so only the first one used. on READ, it will go through ALL providers available to process what it needs to read.</p>
<p>pro-tip - to re-create ALL secrets in ALL namespaces if you want to enforce a new <code>EncryptionConfiguration</code> resource, so the following</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl get secrets --all-namespaces -o json | kubectl replace -f -</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hands-on-example">hands-on example<a href="#hands-on-example" class="hash-link" aria-label="Direct link to hands-on example" title="Direct link to hands-on example">‚Äã</a></h3>
<p>I am following along the <a href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/" target="_blank" rel="noopener noreferrer">k8s docs</a> myself first.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain"># create secret</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">head -c 32 /dev/urandom | base64</span><br></span></code></pre></div></div>
<p>save following to <code>/etc/kubernetes/etcd/ec.yaml</code></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> apiserver.config.k8s.io/v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> EncryptionConfiguration</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> secrets</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">providers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">aescbc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">keys</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> key1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">secret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> fNtJ9NkCpeJabcKMocX07jGu1hcL8bUvGvjH2PSIs24=</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">identity</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<p>update <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> to add the provider config</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  - command:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    - kube-apiserver</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    - --encryption-provider-config=/etc/kubernetes/etcd/ec.yaml</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    - --advertise-address=10.152.0.2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    - --allow-privileged=true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    - --authorization-mode=Node,RBAC</span><br></span></code></pre></div></div>
<p>add mount for this file <code>ec.yaml</code> for the kube-apiserver to use</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain"># mount</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    volumeMounts:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    - mountPath: /etc/kubernetes/etcd</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      name: etcd</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># volume</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  volumes:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  - hostPath:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      path: /etc/kubernetes/etcd</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      type: DirectoryOrCreate</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name: etcd</span><br></span></code></pre></div></div>
<p>API server will restart itself, check:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-master:/etc/systemd/system/kubelet.service.d# ps aux | grep apiserver</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">root      3010  9.9  9.4 1101516 380920 ?      Ssl  23:17   0:14 kube-apiserver --encryption-provider-config=/etc/kubernetes/etcd/ec.yaml --advertise-address=10.152.0.2 --allow-privileged=true --authorization-mode=Node,RBAC --client-ca-file=/etc/kubernetes/pki/ca.crt --enable-admission-plugins=NodeRestriction --enable-bootstrap-token-auth=true --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key --etcd-servers=https://127.0.0.1:2379 --insecure-port=0 --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key --requestheader-allowed-names=front-proxy-client --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6443 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/etc/kubernetes/pki/sa.pub --service-account-signing-key-file=/etc/kubernetes/pki/sa.key --service-cluster-ip-range=10.96.0.0/12 --tls-cert-file=/etc/kubernetes/pki/apiserver.crt --tls-private-key-file=/etc/kubernetes/pki/apiserver.key</span><br></span></code></pre></div></div>
<p>or</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-master:/etc/systemd/system/kubelet.service.d# docker ps | grep api</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">8fc3c24b04fd   4d217480042e             &quot;kube-apiserver --en‚Ä¶&quot;   3 minutes ago       Up 3 minutes                 k8s_kube-apiserver_kube-apiserver-cks-master_kube-system_0fcea4060dc98eb9e7237787e39dca2b_0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">a8a8ccb66f88   k8s.gcr.io/pause:3.4.1   &quot;/pause&quot;                 3 minutes ago       Up 3 minutes                 k8s_POD_kube-apiserver-cks-master_kube-system_0fcea4060dc98eb9e7237787e39dca2b_0</span><br></span></code></pre></div></div>
<p>if you need to troubleshoot</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-master:/etc/systemd/system/kubelet.service.d# ll /var/log/pods/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">total 40</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x 10 root root   4096 Sep  4 23:17 ./</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxrwxr-x 11 root syslog 4096 Sep  2 06:25 ../</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x  3 root root   4096 Aug  8 22:34 kube-system_coredns-558bd4d5db-kf8j9_ecb61ac8-aa71-445f-ace2-af33bd88b44f/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x  3 root root   4096 Aug  8 22:34 kube-system_coredns-558bd4d5db-nvqqp_e3d25308-e5b6-40c9-a803-b357ac189c22/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x  3 root root   4096 Aug  8 22:33 kube-system_etcd-cks-master_59e2fab1e68569ba366888edc129a284/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x  3 root root   4096 Sep  4 23:17 kube-system_kube-apiserver-cks-master_0fcea4060dc98eb9e7237787e39dca2b/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x  3 root root   4096 Aug  8 22:33 kube-system_kube-controller-manager-cks-master_b9a186e3d4d2fbecf180a0923a24ebcd/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x  3 root root   4096 Aug  8 22:34 kube-system_kube-proxy-rzbsd_25749ba6-4d3c-4f2e-a7c6-48a37ff03aa4/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x  3 root root   4096 Aug  8 22:33 kube-system_kube-scheduler-cks-master_4eedadadc796f45ef17aba32e2cc0d32/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x  5 root root   4096 Aug  8 22:34 kube-system_weave-net-2d9st_b91f6248-8b11-44ff-afec-79a7d3685ef2/</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="read-secrets">read secrets<a href="#read-secrets" class="hash-link" aria-label="Direct link to read secrets" title="Direct link to read secrets">‚Äã</a></h3>
<p>read the default token</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-master:/etc/systemd/system/kubelet.service.d# k get secrets default-token-nx5f5 -oyamlapiVersion: v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM1ekNDQWMrZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeE1EZ3dPREl5TXpJeE9Gb1hEVE14TURnd05qSXlNekl4T0Zvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTnNkCnR1K3dNRnJkeUdsSlpaUC9VRFFsTlVEeGFhQ2NFT2x6YXRHL3lwNTNBWTJNRG5PYmxHaXkrblh4S2JWd1BYNE8KdFdDdHh6bWhaUVJzMWpmODZuMkhOZGREWmhpVXMvd2dScUUxVC9ucUE2QTFsZFBuMm03L1BMQW5oTHFJTmJZeQo5NklXc2V0ZGxQRTkzSHQ0S2czU1RMUWJHR09ZVktCL2lMZnRpcUQzWUtzL29mZTA2ZTRMQ2RXc25nNmdsOSt0ClRTL0gyWittN2NJUDhLbW94cy9GMTltUW1NMTl2VnZTUStwbkNBTjJrSGRwbnF5STVjUTN5OUhUck5uOFRQQ3cKTWd0YW5kTXhpeEpzTlN2UnA0RG13cnhQYWp4dXZVblhjZXNRczRkSVYrS0pNL0F5TlQ1aVRiQzBDRUZYRTZPagpHNVhrL2d0ZHZadFg1YmN1S29FQ0F3RUFBYU5DTUVBd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZES1d3Q1V0Rm5sRGtQTHBkU2c1YnNxTGNjSUpNQTBHQ1NxR1NJYjMKRFFFQkN3VUFBNElCQVFDazBUeHNFV2dOT2NCNWdUcTBld3JwTFVOY3M1dUl5ZnlBSHowM0M5SDBJSU12UXJtcwpRL2wvemRVRTB4dG1PTi9mWWduVG5MUzhiSmVxSHpsM1FGeG9OMDBnTS9JNVlxSmtqZENudEN4eTljOENYNTl6ClJ2UlpuVTN4WXdYbDVMMU4waURaZ1hxK2JmUVJGK2tHZnJkNVpTZUxvczNkbUNVMmhMUm94alBNb2ZlVjZvcVcKaXRZQVBPTytQSS9MQjN3WXcraVEzRWE0cjFXU3RnVnVVU0xHVThUZHlhNWRiSTFsVW9nY29ZS0FIN3JsQUc0LwpSK2hTUGo0T1dwWXg0QVdXNDJaUE03RWJ4dTlXcUZ6ajJNSDJlVG11NmhrYlVqR1J6d3VkMHY2eFp4YnJCNjhPCnN2TXNKVUtWcW1UcWZIeWFGajZKU1Q4UmhtWmFYL3VrZGViNAotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  namespace: ZGVmYXVsdA==</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  token: ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNklqQlRUVnBMTldKM1VGbGtSa1p6VDNSNWMxZDJXalI2YldWbFZVRTRaVGcyTTFOZlFXaFNlRUpOU1hNaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbVJsWm1GMWJIUXRkRzlyWlc0dGJuZzFaalVpTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pWkdWbVlYVnNkQ0lzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJalUxT1dSaU5qZzRMVEl3Wm1FdE5EWXpNaTA0WVRVeUxXRTNORGRoWmpRMVl6VXlNaUlzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwa1pXWmhkV3gwT21SbFptRjFiSFFpZlEubVpjX2RzVXhmZWczOHItdklFbVNqVXc0UXBFR2JtMkpGZmMwRE83NlZwblpvd21mOENNNlZPd2pvZmJGQVV5NW0waEpnWFdfaUNRSVAwR3J3ZTZidHI3ZWZOcnVvUXJKbm5meDVrZFo2VURBWVNhRUJLMllfZFlGOGZid3I0ZzRrRElXSzJrSFBxSHNHTjZWX0FJZ3R4VFg0T1NmWDg4S3Roa19EQzJ4Z2tEYTlKMUI0dXI3dTJnMjZfRVVBODlVbndDdURmTWQyOW03WmhBc281VVJNa1o5TTl2SVZjMmczZFJkamlOSWhLeGZsRHFWR2pacTBjNC11Tzd3NE5xZVo2MjczWm5YLXdnNi10SU1pOFJFNUpkWUZ6R2x0blkxb25idUU3bVNBWnBROUFBYWp4U3AtU2xFV1EyUG42WTVBODRzWWlQWlY5ZmdDNE9tek5Hd1RR</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">kind: Secret</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    kubernetes.io/service-account.name: default</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    kubernetes.io/service-account.uid: 559db688-20fa-4632-8a52-a747af45c522</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  creationTimestamp: &quot;2021-08-08T22:33:47Z&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: default-token-nx5f5</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  namespace: default</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  resourceVersion: &quot;396&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  uid: 1fe556a9-f84d-4e55-b79d-76a24edd4c77</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">type: kubernetes.io/service-account-token</span><br></span></code></pre></div></div>
<p>read the default token key-pair in etcd</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-master:/etc/systemd/system/kubelet.service.d# ETCDCTL_API=3 etcdctl --cert /etc/kubernetes/pki/apiserver-etcd-client.crt --key /etc/kubernetes/pki/apiserver-etcd-client.key --cacert /etc/kubernetes/pki/etcd/ca.crt get /registry/secrets/default/default-token-nx5f5</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/registry/secrets/default/default-token-nx5f5</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">k8s</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">v1SecretÔøΩ</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ÔøΩ</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">default-token-nx5f5default&quot;*$1fe556a9-f84d-4e55-b79d-76a24edd4c772À∑ÔøΩÔøΩb-</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&quot;kubernetes.io/service-account.namedefaultbI</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">!kubernetes.io/service-account.uid$559db688-20fa-4632-8a52-a747af45c522zÔøΩÔøΩ</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">kube-controller-managerUpdatevÀ∑ÔøΩÔøΩFieldsV1:ÔøΩ</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ÔøΩ{&quot;f:data&quot;:{&quot;.&quot;:{},&quot;f:ca.crt&quot;:{},&quot;f:namespace&quot;:{},&quot;f:token&quot;:{\}\},&quot;f:metadata&quot;:{&quot;f:annotations&quot;:{&quot;.&quot;:{},&quot;f:kubernetes.io/service-account.name&quot;:{},&quot;f:kubernetes.io/service-account.uid&quot;:{\}\}},&quot;f:type&quot;:{\}\}ÔøΩ</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ca.crt-----BEGIN CERTIFICATE-----</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">MIIC5zCCAc+gAwIBAgIBADANBgkqhkiG9w0BAQsFADAVMRMwEQYDVQQDEwprdWJl</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cm5ldGVzMB4XDTIxMDgwODIyMzIxOFoXDTMxMDgwNjIyMzIxOFowFTETMBEGA1UE</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AxMKa3ViZXJuZXRlczCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBANsd</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">tu+wMFrdyGlJZZP/UDQlNUDxaaCcEOlzatG/yp53AY2MDnOblGiy+nXxKbVwPX4O</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">tWCtxzmhZQRs1jf86n2HNddDZhiUs/wgRqE1T/nqA6A1ldPn2m7/PLAnhLqINbYy</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">96IWsetdlPE93Ht4Kg3STLQbGGOYVKB/iLftiqD3YKs/ofe06e4LCdWsng6gl9+t</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">TS/H2Z+m7cIP8Kmoxs/F19mQmM19vVvSQ+pnCAN2kHdpnqyI5cQ3y9HTrNn8TPCw</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">MgtandMxixJsNSvRp4DmwrxPajxuvUnXcesQs4dIV+KJM/AyNT5iTbC0CEFXE6Oj</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">G5Xk/gtdvZtX5bcuKoECAwEAAaNCMEAwDgYDVR0PAQH/BAQDAgKkMA8GA1UdEwEB</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/wQFMAMBAf8wHQYDVR0OBBYEFDKWwCUtFnlDkPLpdSg5bsqLccIJMA0GCSqGSIb3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">DQEBCwUAA4IBAQCk0TxsEWgNOcB5gTq0ewrpLUNcs5uIyfyAHz03C9H0IIMvQrms</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Q/l/zdUE0xtmON/fYgnTnLS8bJeqHzl3QFxoN00gM/I5YqJkjdCntCxy9c8CX59z</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">RvRZnU3xYwXl5L1N0iDZgXq+bfQRF+kGfrd5ZSeLos3dmCU2hLRoxjPMofeV6oqW</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">itYAPOO+PI/LB3wYw+iQ3Ea4r1WStgVuUSLGU8Tdya5dbI1lUogcoYKAH7rlAG4/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">R+hSPj4OWpYx4AWW42ZPM7Ebxu9WqFzj2MH2eTmu6hkbUjGRzwud0v6xZxbrB68O</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">svMsJUKVqmTqfHyaFj6JST8RhmZaX/ukdeb4</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-----END CERTIFICATE-----</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        namespacedefaultÔøΩ</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">tokenÔøΩeyJhbGciOiJSUzI1NiIsImtpZCI6IjBTTVpLNWJ3UFlkRkZzT3R5c1d2WjR6bWVlVUE4ZTg2M1NfQWhSeEJNSXMifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tbng1ZjUiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjU1OWRiNjg4LTIwZmEtNDYzMi04YTUyLWE3NDdhZjQ1YzUyMiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.mZc_dsUxfeg38r-vIEmSjUw4QpEGbm2JFfc0DO76VpnZowmf8CM6VOwjofbFAUy5m0hJgXW_iCQIP0Grwe6btr7efNruoQrJnnfx5kdZ6UDAYSaEBK2Y_dYF8fbwr4g4kDIWK2kHPqHsGN6V_AIgtxTX4OSfX88Kthk_DC2xgkDa9J1B4ur7u2g26_EUA89UnwCuDfMd29m7ZhAso5URMkZ9M9vIVc2g3dRdjiNIhKxflDqVGjZq0c4-uO7w4NqeZ6273ZnX-wg6-tIMi8RE5JdYFzGltnY1onbuE7mSAZpQ9AAajxSp-SlEWQ2Pn6Y5A84sYiPZV9fgC4OmzNGwTQ#kubernetes.io/service-account-token&quot;</span><br></span></code></pre></div></div>
<p>its all unencrypted.</p>
<p>now create a new secret <code>very-secure</code> : <code>k create secret generic very-secure --from-literal cc=1234</code></p>
<p>now try and read <code>very-secure</code> from etcd</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-master:/etc/systemd/system/kubelet.service.d# ETCDCTL_API=3 etcdctl --cert /etc/kubernetes/pki/apiserver-etcd-client.crt --key /etc/kubernetes/pki/apiserver-etcd-client.key --cacert /etc/kubernetes/pki/etcd/ca.crt get /registry/secrets/default/very-secure</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/registry/secrets/default/very-secure</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ÔøΩÔøΩSÔøΩWKÔøΩ)aescbc:v1:key1:!ÔøΩÔøΩÔøΩDÔøΩ#eHÔøΩ ZÔøΩ&#x27;L&quot;ÔøΩg)GyQ(ÔøΩÔøΩpiÔøΩ-ÔøΩÔøΩ,ÔøΩ?Ã£ÔøΩ9ÔøΩ*ÔøΩNÔøΩÔøΩÔøΩÔøΩ6ÔøΩÔøΩ</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">RÔøΩÔøΩ&lt;ÔøΩ ÔøΩÔøΩÔøΩÔøΩ‹ìÔøΩÔøΩT`4ÔøΩÔøΩÔøΩÔøΩL‰ãªvÔøΩ~ÔøΩÔøΩÔøΩ`1ÔøΩaÔøΩÔøΩÔøΩzÔøΩm&gt;ÔøΩ$ÔøΩv”∫ÔøΩÔøΩ)«ßÔøΩ!qÔøΩk9ÔøΩÔøΩqnÔøΩ[ÔøΩÔøΩ</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                                                               ÔøΩÔøΩ$ÔøΩÔøΩ8dÔøΩÔøΩ4ÔøΩ^ÿµ+ÔøΩÔøΩf\ÔøΩ&lt;&quot;q\afÔøΩCÔøΩnUÔøΩÔøΩnÔøΩÔøΩ8ÔøΩ{ÔøΩƒÄÔøΩpÔøΩÔøΩj(ÔøΩÔøΩÔøΩ-ÔøΩÔøΩVÔøΩP9–âÔøΩ</span><br></span></code></pre></div></div>
<p>BUT- we can still see the secret through API server, which is a good thing- its the gateway, and outside of this = encrypted.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-master:/etc/systemd/system/kubelet.service.d# k get secrets very-secure -oyaml</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  cc: MTIzNA==</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">kind: Secret</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  creationTimestamp: &quot;2021-09-04T23:45:14Z&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: very-secure</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  namespace: default</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  resourceVersion: &quot;433676&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  uid: 0ce36039-b49f-4170-bb33-87cc95956bc3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">type: Opaque</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-master:/etc/systemd/system/kubelet.service.d# echo MTIzNA== | base64 -d</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">1234</span><br></span></code></pre></div></div>
<p>re-test by commenting out the <code>identity</code> provider from our <code>ec.yaml</code> so there is not more plain-text option, and re-creating ALL the secrets.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain"># restart api server</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-master:/etc/kubernetes/manifests# mv kube-apiserver.yaml ..</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-master:/etc/kubernetes/manifests# mv ../kube-apiserver.yaml .</span><br></span></code></pre></div></div>
<p>try look at secrets</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-master:~# k get secretsError from server (InternalError): Internal error occurred: unable to transform key &quot;/registry/secrets/default/default-token-nx5f5&quot;: no matching prefix found</span><br></span></code></pre></div></div>
<p>uncomment the identity provider an restart apiserver again!</p>
<p>BUT- the task is to encrypt ALL.</p>
<p>solution:</p>
<ul>
<li>add <code>identity</code> back to get etcd working again with unencrypted secrets</li>
<li>RE-CREATE all secrets, which will now create them encrypted.</li>
<li>comment out the <code>identity</code> provider again</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain"># replace all secrets</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">root@cks-master:/etc/kubernetes/manifests# k get secrets -A -oyaml | kubectl replace -f -</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/default-token-vz224 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/default-token-vfkf6 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/accessor-token-jzdtq replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/default-token-nx5f5 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/secret1 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/secret2 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/secure-ingress replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/very-secure replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/default-token-s4pm8 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/ingress-nginx-admission replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/ingress-nginx-admission-token-87grf replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/ingress-nginx-token-mqtsr replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/default-token-wjj9m replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/default-token-4xcrt replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/attachdetach-controller-token-x4dwp replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/bootstrap-signer-token-6svt8 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/bootstrap-token-9208wf replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/certificate-controller-token-fx595 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/clusterrole-aggregation-controller-token-w69k6 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/coredns-token-cxnf8 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/cronjob-controller-token-p74tz replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/daemon-set-controller-token-plxht replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/default-token-qr64v replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/deployment-controller-token-7htn8 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/disruption-controller-token-mgbrv replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/endpoint-controller-token-2grs7 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/endpointslice-controller-token-l8z9r replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/endpointslicemirroring-controller-token-rdcdz replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/ephemeral-volume-controller-token-ng626 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/expand-controller-token-cr6jc replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/generic-garbage-collector-token-tkswv replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/horizontal-pod-autoscaler-token-tl7qk replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/job-controller-token-vjtrs replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/kube-proxy-token-99z7x replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/namespace-controller-token-c8fjm replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/node-controller-token-j6ms7 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/persistent-volume-binder-token-dd7zn replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/pod-garbage-collector-token-j7j2h replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/pv-protection-controller-token-7qgz2 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/pvc-protection-controller-token-2tv7t replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/replicaset-controller-token-nnbvv replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/replication-controller-token-9qfnb replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/resourcequota-controller-token-jhg7j replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/root-ca-cert-publisher-token-szqv9 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/service-account-controller-token-d2wz7 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/service-controller-token-vc8v7 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/statefulset-controller-token-8dpqb replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/token-cleaner-token-x2n5g replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/ttl-after-finished-controller-token-skkr4 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/ttl-controller-token-lbvkr replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/weave-net-token-q8tfq replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/default-token-fkxcr replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/kubernetes-dashboard-certs replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/kubernetes-dashboard-csrf replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/kubernetes-dashboard-key-holder replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/kubernetes-dashboard-token-d7f5b replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secret/default-token-qwhh6 replaced</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># test you can read via API but NOT via etcdctl</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">k -n kube-system get secrets service-account-controller-token-d2wz7 -oyaml # works</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ETCDCTL_API=3 etcdctl --cert /etc/kubernetes/pki/apiserver-etcd-client.crt --key /etc/kubernetes/pki/apiserver-etcd-client.key --cacert /etc/kubernetes/pki/etcd/ca.crt get /registry/secrets/kube-system/service-account-controller-token-d2wz7 # encrypted</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># re-comment out indentity and restart apiserver -- from now on all secrets are encrypted in etcd!</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="recap">recap<a href="#recap" class="hash-link" aria-label="Direct link to recap" title="Direct link to recap">‚Äã</a></h2>
<p>configmaps vs secrets - keep them separate, secrets always need more security, configmaps not, so dont complicate configmaps with unnecessary encryption</p>
<p>for PROD - the <code>key</code> in the encryptionConfiguration better managed with a provider like <code>kms</code> with hashicorp vault (wont be on exam)</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/study/CKS/4. Microservice Vulnerability/VulnerableSecrets.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2026-02-20T20:05:57.000Z" itemprop="dateModified">Feb 20, 2026</time></b> by <b>Ron Amosa</b></span></div></div></footer><div class="newsletterCta_rTTm"><p><span class="emoji_bVKv">üì¨</span> I also write a fortnightly newsletter ‚Äî my thoughts on the machines that educate, empower, and exploit our society.<!-- --> <a href="/subscribe">Subscribe here.</a></p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/study/CKS/Microservice Vulnerability/VulnerableOSLevelSecurity"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">OS Level Security Domains</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/study/CKS/Supply Chain Security/SupplyChainImages"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Container Images</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#simple-secret-scenario" class="table-of-contents__link toc-highlight">simple secret scenario</a></li><li><a href="#hack-secrets-in-docker" class="table-of-contents__link toc-highlight">Hack secrets in Docker</a></li><li><a href="#hack-secrets-in-etcd" class="table-of-contents__link toc-highlight">Hack Secrets in ETCD</a></li><li><a href="#encrypt-etcd-at-rest" class="table-of-contents__link toc-highlight">Encrypt ETCD at rest</a><ul><li><a href="#hands-on-example" class="table-of-contents__link toc-highlight">hands-on example</a></li><li><a href="#read-secrets" class="table-of-contents__link toc-highlight">read secrets</a></li></ul></li><li><a href="#recap" class="table-of-contents__link toc-highlight">recap</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/ron-amosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/ronamosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@uncommonengineer" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Discover</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Analysis &amp; Essays</a></li><li class="footer__item"><a class="footer__link-item" href="/docs">Technical</a></li><li class="footer__item"><a class="footer__link-item" href="/about">About</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Last updated on Fri Feb 20 2026</div></div></div></footer></div>
</body>
</html>