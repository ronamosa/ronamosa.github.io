<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-engineer/K8s/2020-03-06-Istio-SDS-Cert-Manager" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Istio mTLS with SDS and Cert-Manager - Complete Service Mesh Security Guide | The Uncommon Engineer</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ronamosa.io/docs/engineer/K8s/2020-03-06-Istio-SDS-Cert-Manager"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Istio mTLS with SDS and Cert-Manager - Complete Service Mesh Security Guide | The Uncommon Engineer"><meta data-rh="true" name="description" content="Advanced guide to setting up Istio mutual TLS with Secret Discovery Service (SDS) and automated certificate management using Cert-Manager and Let&#x27;s Encrypt."><meta data-rh="true" property="og:description" content="Advanced guide to setting up Istio mutual TLS with Secret Discovery Service (SDS) and automated certificate management using Cert-Manager and Let&#x27;s Encrypt."><meta data-rh="true" name="keywords" content="istio mtls,service mesh security,cert-manager,sds,letsencrypt,kubernetes security,istio certificates,mutual tls"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ronamosa.io/docs/engineer/K8s/2020-03-06-Istio-SDS-Cert-Manager"><link data-rh="true" rel="alternate" href="https://ronamosa.io/docs/engineer/K8s/2020-03-06-Istio-SDS-Cert-Manager" hreflang="en"><link data-rh="true" rel="alternate" href="https://ronamosa.io/docs/engineer/K8s/2020-03-06-Istio-SDS-Cert-Manager" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9UFF3RBJQ9-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"💻 Engineer","item":"https://ronamosa.io/docs/category/-engineer"},{"@type":"ListItem","position":2,"name":"Istio mTLS with SDS and Cert-Manager - Complete Service Mesh Security Guide","item":"https://ronamosa.io/docs/engineer/K8s/2020-03-06-Istio-SDS-Cert-Manager"}]}</script><link rel="search" type="application/opensearchdescription+xml" title="The Uncommon Engineer" href="/opensearch.xml">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DMRNTVGLRC"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DMRNTVGLRC",{anonymize_ip:!0})</script>

<script src="/js/console-clue.js"></script>
<script src="/js/metricool.js"></script><link rel="stylesheet" href="/assets/css/styles.dd12b5e8.css">
<script src="/assets/js/runtime~main.cb34a51e.js" defer="defer"></script>
<script src="/assets/js/main.fb1c5b66.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="ronamosa.io" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="ronamosa.io" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Uncommon Engineer</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog/">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/projects/">Projects</a><a class="navbar__item navbar__link" href="/changelog/">Changelog</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">▶ Start Here</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/books/reading-list">📚 Books &amp; Papers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/study/SCS-C01/">📗 Study</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/️-hacker">🏴‍☠️ Hacker</a><button aria-label="Expand sidebar category &#x27;🏴‍☠️ Hacker&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/-engineer">💻 Engineer</a><button aria-label="Collapse sidebar category &#x27;💻 Engineer&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/ai">AI</a><button aria-label="Expand sidebar category &#x27;AI&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/️-projects">🛠️ Projects</a><button aria-label="Expand sidebar category &#x27;🛠️ Projects&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/AWS/AWS-EKS-Workshop">AWS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/Azure/2019-07-20-Sonarqube-AzureDisk-PersistentVolume">Azure</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/GCP/2019-11-27-GCP-Install-Ambassador-Helm2">GCP</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/engineer/K8s/2019-11-11-Helm-3-Kubernetes-Package-Manager">K8s</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/K8s/2019-11-11-Helm-3-Kubernetes-Package-Manager">Helm 3 Complete Guide - Kubernetes Package Manager and Application Deployment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/engineer/K8s/2020-03-06-Istio-SDS-Cert-Manager">Istio mTLS with SDS and Cert-Manager - Complete Service Mesh Security Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/K8s/2020-04-08-Istio-MTLS-with-External-Endpoint">Istio mTLS with External Endpoints - Egress Gateway Configuration Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/K8s/2019-07-09-Ambassador-Disable-TLS1">Ambassador API Gateway TLS Security - Disable TLS 1.0 and 1.1 for Better Security</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/K8s/2020-08-17-Secrethub-Secret-Management">SecretHub Kubernetes Secrets Management - Secure Secret Storage and Distribution</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/LAB">LAB</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/Misc/algos-system-design">Misc</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/archive/docker-wordpress/docker-wordpress-1">🗃 Archive</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/-engineer"><span>💻 Engineer</span></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">K8s</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Istio mTLS with SDS and Cert-Manager - Complete Service Mesh Security Guide</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Istio mTLS with SDS and Cert-Manager - Complete Service Mesh Security Guide</h1></header><div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Published Date: 06-MAR-2020</p></div></div>
<p>In this post we will be setting up a way for Istio to automatically provision and manage LetsEncrypt Signed TLS certificates for use in Kubernetes clusters.</p>
<blockquote>
<p>Why is this a big deal?</p>
</blockquote>
<p>Certificate management is usually a painful experience, and over time and many certificates added, this becomes more overhead for operations teams to manage. Just having a setup that automates the whole thing for you is pretty nice.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="architecture-diagram">Architecture Diagram<a href="#architecture-diagram" class="hash-link" aria-label="Direct link to Architecture Diagram" title="Direct link to Architecture Diagram">​</a></h2>
<p>Brief overview of the component and moving parts of the solution (there&#x27;ll be a few details missed out, but you get the overall picture):</p>
<p><img decoding="async" loading="lazy" alt="architecture" src="/assets/images/Azure-Istio-SDS-Cert-Manager-DNS-f472a5e6ad83257e1662f0e35f300d7e.png" width="2000" height="1498" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="key-components">Key Components<a href="#key-components" class="hash-link" aria-label="Direct link to Key Components" title="Direct link to Key Components">​</a></h3>
<ul>
<li>AKS cluster</li>
<li>Istio Service Mesh</li>
<li>SDS enabled Gateways</li>
<li>Cert-Manager, Issuers, Certificates</li>
<li>AzureDNS and DNS-01 ACME Challenge</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pre-requisites">Pre-requisites<a href="#pre-requisites" class="hash-link" aria-label="Direct link to Pre-requisites" title="Direct link to Pre-requisites">​</a></h2>
<ul>
<li>az-cli installed</li>
<li>kubectl instlaled</li>
<li>istioctl installed</li>
<li>helm v3 installed</li>
<li>a running AKS cluster (if you need a quick-setup cluster try this one: <a href="https://github.com/ronamosa/aks-starter-cluster" target="_blank" rel="noopener noreferrer">&quot;aks starter cluster&quot;</a>)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="istio-setup">Istio Setup<a href="#istio-setup" class="hash-link" aria-label="Direct link to Istio Setup" title="Direct link to Istio Setup">​</a></h2>
<p>With your newly built AKS cluster, make sure you have a copy of the <code>kubeconfig</code> file to run <code>&#x27;kubectl&#x27;</code> commands:</p>
<p><code>az aks get-credentials --name AKS-CLUSTER-NAME --resource-group RESOURCE-GROUP-OF-AKS-CLUSTER</code></p>
<p>you can add <code>--admin</code> if your cluster is RBAC enabled, to get the admin kubeconfig, and <code>--overwrite</code> is handy to add too, but you&#x27;ll get prompted to overwrite otherwise.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="check-access-to-your-cluster">Check access to your cluster<a href="#check-access-to-your-cluster" class="hash-link" aria-label="Direct link to Check access to your cluster" title="Direct link to Check access to your cluster">​</a></h3>
<p>run: <code>kubectl get nodes</code></p>
<p>output:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">NAME                               STATUS   ROLES   AGE   VERSION</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">aks-nodepool-38331632-vmss000000   Ready    agent   26h   v1.15.7</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">aks-nodepool-38331632-vmss000001   Ready    agent   26h   v1.15.7</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">aks-nodepool-38331632-vmss000002   Ready    agent   26h   v1.15.7</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="download-istio--istioctl">Download Istio &amp; istioctl<a href="#download-istio--istioctl" class="hash-link" aria-label="Direct link to Download Istio &amp; istioctl" title="Direct link to Download Istio &amp; istioctl">​</a></h3>
<p>install via curl:</p>
<p><code>$ curl -L https://istio.io/downloadIstio | sh -</code></p>
<p>setup the <code>istioctl</code> binary in your $PATH</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>current istio version as time of writing: 1.5.0</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="install-istio-with-sds-enabled">Install Istio with SDS enabled<a href="#install-istio-with-sds-enabled" class="hash-link" aria-label="Direct link to Install Istio with SDS enabled" title="Direct link to Install Istio with SDS enabled">​</a></h3>
<blockquote>
<p>What is SDS and why do I care?</p>
</blockquote>
<p><em>&#x27;<a href="https://www.envoyproxy.io/docs/envoy/v1.8.0/configuration/secret" target="_blank" rel="noopener noreferrer">Secret Discovery Service (SDS)</a>&#x27; is an envoyproxy feature that simplifies certificate management for proxy containers. This means for Istio, all the sidecars and their TLS needs are taken care of by enabling and configuring SDS in Istio for the k8s cluster. The TLS required private key, server certificate, and root certificate, are configured using the Secret Discovery Service (SDS). The ingress gateway can dynamically add, delete, or update its key/certificate pairs and its root certificate. You do not have to restart the ingress gateway.</em></p>
<p>using <code>istioctl</code> run:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">istioctl manifest apply \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --set profile=default \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --set values.gateways.istio-egressgateway.enabled=false \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --set values.gateways.istio-ingressgateway.sds.enabled=true</span><br></span></code></pre></div></div>
<ul>
<li>use <code>default</code> <a href="https://istio.io/docs/setup/additional-setup/config-profiles/" target="_blank" rel="noopener noreferrer">profile</a></li>
<li>disable <code>egress</code> gateway</li>
<li>enable SDS on <code>ingress</code> gateway</li>
</ul>
<p>this will install istio system in the <code>istio-system</code> namespace by default, you can check by running:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl -n istio-system get pods</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">NAME                                    READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">istio-ingressgateway-8577f4c6f8-nc7fb   1/1     Running   0          26h</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">istiod-59f6fbc78f-76vs6                 1/1     Running   0          26h</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">prometheus-868cf4cb84-jr8zf             2/2     Running   0          26h</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="patch-istio-ingressgateway">patch istio ingressgateway<a href="#patch-istio-ingressgateway" class="hash-link" aria-label="Direct link to patch istio ingressgateway" title="Direct link to patch istio ingressgateway">​</a></h3>
<p>the default ingress gateway (called <code>ingressgateway</code>) installation comes without HTTPS/tls added or configured:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">Name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">         ingressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">    istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">       operator.istio.io/component=IngressGateways</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              operator.istio.io/managed=Reconcile</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              operator.istio.io/version=1.5.0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              release=istio</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Annotations</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  kubectl.kubernetes.io/last</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">applied</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">configuration</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">API Version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  networking.istio.io/v1beta1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">         Gateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Creation Timestamp</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  </span><span class="token datetime number" style="color:rgb(247, 140, 108)">2020-03-07T01:38:00Z</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Generation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">          </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Resource Version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">2113</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Self Link</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">           /apis/networking.istio.io/v1beta1/namespaces/istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">system/gateways/ingressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">UID</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                 48a034e9</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">e83e</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">45c3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">a6dc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">ce969bcecfc2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Selector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">Istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  ingressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Servers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">Hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      *</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">Port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">Name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">      http</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">Number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">Protocol</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  HTTP</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                 &lt;none /</span><span class="token punctuation" style="color:rgb(199, 146, 234)">&gt;</span><br></span></code></pre></div></div>
<p>run this json <code>patch</code> command to update the gateway:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl -n istio-system \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  patch gateway ingressgateway --type=json \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  -p=&quot;$(cat patch.json)&quot;</span><br></span></code></pre></div></div>
<p>patch.json:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockTitle_OeMC">patch.json</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property" style="color:rgb(128, 203, 196)">&quot;op&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;add&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property" style="color:rgb(128, 203, 196)">&quot;path&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/spec/servers/1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property" style="color:rgb(128, 203, 196)">&quot;hosts&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;*&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;port&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property" style="color:rgb(128, 203, 196)">&quot;name&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https-443&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property" style="color:rgb(128, 203, 196)">&quot;number&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property" style="color:rgb(128, 203, 196)">&quot;protocol&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;HTTPS&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property" style="color:rgb(128, 203, 196)">&quot;tls&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property" style="color:rgb(128, 203, 196)">&quot;credentialName&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;ingress-cert&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;mode&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;SIMPLE&quot;</span><span class="token plain">\</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">\</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre></div></div>
<p>so now your <code>ingressgateway</code> gateway should look like this:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">Name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">         ingressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">    istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">       operator.istio.io/component=IngressGateways</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              operator.istio.io/managed=Reconcile</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              operator.istio.io/version=1.5.0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              release=istio</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Annotations</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  kubectl.kubernetes.io/last</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">applied</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">configuration</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">API Version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  networking.istio.io/v1beta1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">         Gateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Creation Timestamp</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  </span><span class="token datetime number" style="color:rgb(247, 140, 108)">2020-03-07T01:38:00Z</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Generation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">          </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Resource Version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">2113</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Self Link</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">           /apis/networking.istio.io/v1beta1/namespaces/istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">system/gateways/ingressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">UID</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                 48a034e9</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">e83e</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">45c3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">a6dc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">ce969bcecfc2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Selector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">Istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  ingressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Servers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">Hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      *</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">Port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">Name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">      http</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">Number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">Protocol</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  HTTP</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">Hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      *</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">Port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">Name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">      https</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">Number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">Protocol</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  HTTPS</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">Tls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">Credential Name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  ingress</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">cert</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">Mode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">             SIMPLE</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                 &lt;none /</span><span class="token punctuation" style="color:rgb(199, 146, 234)">&gt;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="checkpoint">Checkpoint<a href="#checkpoint" class="hash-link" aria-label="Direct link to Checkpoint" title="Direct link to Checkpoint">​</a></h3>
<p>At this point you should have the following things in place:</p>
<ul>
<li>a running AKS cluster</li>
<li>an Istio installation in the <code>istio-system</code> namespace</li>
<li>an <code>ingressgateway</code> gateway with HTTPS and TLS configured.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="install-bookinfo-demo-application">Install Bookinfo Demo Application<a href="#install-bookinfo-demo-application" class="hash-link" aria-label="Direct link to Install Bookinfo Demo Application" title="Direct link to Install Bookinfo Demo Application">​</a></h2>
<p>We need to install an application to demonstrate a valid TLS certificate on, and also show how that tls certificate is used for mutual TLS (mTLS) by Istio.</p>
<p>I will use my domain <code>cloudbuild.site</code> as the domain for this example, and configure the bookinfo application to route to subdomain <code>bookinfo.cloudbuild.site</code>.</p>
<p>create new namespace</p>
<p><code>kubectl create ns bookinfo</code></p>
<p>label namespace for instio sidecar injection</p>
<p><code>kubectl label namespace bookinfo istio-injection=enabled</code></p>
<p>deploy the bookinfo app into the <code>bookinfo</code> namespace</p>
<p><code>kubectl -n bookinfo apply -f https://raw.githubusercontent.com/istio/istio/release-1.5/samples/bookinfo/platform/kube/bookinfo.yaml</code></p>
<p>check pods</p>
<p><code>kubectl -n bookinfo get pods</code></p>
<p>you should see something like this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">NAME                              READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">details-v1-74f858558f-xx97s       2/2     Running   0          21h</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">productpage-v1-76589d9fdc-9qbf9   2/2     Running   0          21h</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ratings-v1-7855f5bcb9-x9lxz       2/2     Running   0          21h</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">reviews-v1-64bc5454b9-95dt4       2/2     Running   0          21h</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">reviews-v2-76c64d4bdf-8v2vm       2/2     Running   0          21h</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">reviews-v3-5545c7c78f-j4wlb       2/2     Running   0          21h</span><br></span></code></pre></div></div>
<p>each pod is <code>2/2</code> because now an istio side-car container is added to your pod deployment.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="install-modified-gateway">Install modified gateway<a href="#install-modified-gateway" class="hash-link" aria-label="Direct link to Install modified gateway" title="Direct link to Install modified gateway">​</a></h3>
<p>The default bookinfo gateway needed to be modified because we are using TLS certs in this demo - note I am using my own domain <code>cloudbuild.site</code> and routing requests to subdomain <code>bookinfo.cloudbuild.site</code>, so where you see my domain, substitute for yours.</p>
<p>The gateway needs to look like this:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Gateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> bookinfo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ingressgateway </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># use istio default controller</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">servers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">protocol</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> HTTP</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;bookinfo.cloudbuild.site&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">tls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">httpsRedirect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">protocol</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> HTTPS</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">tls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">mode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> SIMPLE</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">credentialName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ingress</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">cert</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;bookinfo.cloudbuild.site&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> VirtualService</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> bookinfo</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;bookinfo.cloudbuild.site&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">gateways</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> bookinfo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">http</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">uri</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">exact</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /productpage</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">uri</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">prefix</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /static</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">uri</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">exact</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /login</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">uri</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">exact</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /logout</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">uri</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">prefix</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /api/v1/products</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">route</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">destination</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> productpage</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">9080</span><br></span></code></pre></div></div>
<p>save this to a file called <code>bookinfo-gateway.yaml</code> and deploy like this:</p>
<p><code>kubectl -n bookinfo apply -f ./bookinfo-gateway.yaml</code></p>
<p>check it with:</p>
<p><code>kubectl -n bookinfo describe gw bookinfo</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="install-cert-manager">Install Cert-Manager<a href="#install-cert-manager" class="hash-link" aria-label="Direct link to Install Cert-Manager" title="Direct link to Install Cert-Manager">​</a></h2>
<blockquote>
<p>What is cert-manager and why should I care?</p>
</blockquote>
<p>Cert-Manager provides <em>&quot;x509 certificate management for Kubernetes&quot;</em> by making Certificate Authorities (CA) and Certificates first-class resource types in the Kubernetes API (literally paraphrasing the blurb from the <a href="https://cert-manager.io/" target="_blank" rel="noopener noreferrer">cert-manager site</a>).</p>
<p>Basically it&#x27;s a system that makes it really simple to automatically provision and manage CA-signed certificates for your cluster.</p>
<p>These are the instructions from <a href="https://docs.cert-manager.io/en/latest/getting-started/install/kubernetes.html" target="_blank" rel="noopener noreferrer">cert-manager docs</a> but I&#x27;m summarizing them here:</p>
<p>Pick <strong>ONE</strong> of the following methods</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="via-kubectl">via kubectl<a href="#via-kubectl" class="hash-link" aria-label="Direct link to via kubectl" title="Direct link to via kubectl">​</a></h3>
<p><code>kubectl apply --validate=false -f https://github.com/jetstack/cert-manager/releases/download/v0.13.1/cert-manager.yaml</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="via-helm">via helm<a href="#via-helm" class="hash-link" aria-label="Direct link to via helm" title="Direct link to via helm">​</a></h3>
<p>create Namespace:</p>
<p><code>kubectl create namespace cert-manager</code></p>
<p>label Namespace to disable validation:</p>
<p><code>kubectl label namespace cert-manager certmanager.k8s.io/disable-validation=true</code></p>
<p>check and delete any existing cert-manager releases:</p>
<p><code>helm -n cert-manager list</code></p>
<p><code>helm -n cert-manager delete cert-manager</code>As an example setup</p>
<p>add cert-manager to the repo, and install:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">helm repo add jetstack https://charts.jetstack.io</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">helm install \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  cert-manager jetstack/cert-manager \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --namespace cert-manager \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --version v0.13.1</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="check-cert-manager-installation">Check cert-manager installation<a href="#check-cert-manager-installation" class="hash-link" aria-label="Direct link to Check cert-manager installation" title="Direct link to Check cert-manager installation">​</a></h3>
<p>run:</p>
<p><code>kubectl -n cert-manager get pods</code></p>
<p>output:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">NAME                                       READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cert-manager-6f9d54fdc7-jl6wv              1/1     Running   0          26h</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cert-manager-cainjector-6b6c7955f4-whvjm   1/1     Running   0          26h</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cert-manager-webhook-84954f5587-bmkpc      1/1     Running   0          26h</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="setup-azure-dns-for-acme-challenge">Setup Azure DNS for ACME Challenge<a href="#setup-azure-dns-for-acme-challenge" class="hash-link" aria-label="Direct link to Setup Azure DNS for ACME Challenge" title="Direct link to Setup Azure DNS for ACME Challenge">​</a></h2>
<blockquote>
<p>Wait, why are we setting up DNS?</p>
</blockquote>
<p>For this automation, we will use cert-managers <a href="https://cert-manager.io/docs/configuration/acme/" target="_blank" rel="noopener noreferrer">&#x27;Automated Certificate Management Envrionment (ACME)&#x27;</a> Issuer. The ACME Issuer has 2 methods to verify you own a domain. These methods are called &quot;challenges&quot;, and the Issuer has to solve them to verify you own the domain.</p>
<p>One is via HTTP:</p>
<blockquote>
<p>HTTP01 challenges are completed by presenting a computed key, that should be present at a HTTP URL endpoint and is routable over the internet. This URL will use the domain name requested for the certificate. Once the ACME server is able to get this key from this URL over the internet, the ACME server can validate you are the owner of this domain. When a HTTP01 challenge is created, cert-manager will automatically configure your cluster ingress to route traffic for this URL to a small web server that presents this key.</p>
</blockquote>
<p>basically your Issuer has to get agenerated key served somewhere on your web server via that domain, proves you own the domain. solved.</p>
<p>The other is via DNS:</p>
<blockquote>
<p>DNS01 challenges are completed by providing a computed key that is present at a DNS TXT record. Once this TXT record has been propagated across the internet, the ACME server can successfully retrieve this key via a DNS lookup and can validate that the client owns the domain for the requested certificate. With the correct permissions, cert-manager will automatically present this TXT record for your given DNS provider.</p>
</blockquote>
<p>again, but via DNS records, your Issuer has to get a generated key entered into your DNS records, proves you own the domain. solved.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="azure-dns-zone">Azure DNS Zone<a href="#azure-dns-zone" class="hash-link" aria-label="Direct link to Azure DNS Zone" title="Direct link to Azure DNS Zone">​</a></h3>
<p>For this setup you need an Azure DNS Zone setup.</p>
<p>Go to your <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">Azure Portal</a> and create a DNS Zone, and then take note of the Name Servers, for example I made a zone called <code>cloudbuild.site</code> for my domain of the same name:</p>
<p><img decoding="async" loading="lazy" alt="azure_dns_zone" src="/assets/images/istiosds-dnszone-46187da5b785ee6877ef7eb7e43ee6bb.png" width="1369" height="286" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="update-domain-registrar-nameservers">Update domain registrar nameservers<a href="#update-domain-registrar-nameservers" class="hash-link" aria-label="Direct link to Update domain registrar nameservers" title="Direct link to Update domain registrar nameservers">​</a></h3>
<p>My domain <code>cloudbuild.site</code> is registered at <a href="https://www.gandi.net/en-NZ" target="_blank" rel="noopener noreferrer">https://www.gandi.net/en-NZ</a>, so I go there and change all the nameservers to point to my new Azure DNS Zone.</p>
<p>So when I query the nameservers for my domain <code>cloudbuild.site</code>, I should see this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">dig NS cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">; &lt;&lt;&gt;&gt; DiG 9.11.3-1ubuntu1.11-Ubuntu &lt;&lt;&gt;&gt; NS cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">;; global options: +cmd</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">;; Got answer:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 33922</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">;; flags: qr rd ra; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">;; OPT PSEUDOSECTION:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">; EDNS: version: 0, flags:; udp: 65494</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">;; QUESTION SECTION:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">;cloudbuild.site.		IN	NS</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">;; ANSWER SECTION:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cloudbuild.site.	3599	IN	NS	ns1-06.azure-dns.com.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cloudbuild.site.	3599	IN	NS	ns3-06.azure-dns.org.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cloudbuild.site.	3599	IN	NS	ns2-06.azure-dns.net.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cloudbuild.site.	3599	IN	NS	ns4-06.azure-dns.info.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">;; Query time: 46 msec</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">;; SERVER: 127.0.0.53#53(127.0.0.53)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">;; WHEN: Sun Mar 08 18:57:30 NZDT 2020</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">;; MSG SIZE  rcvd: 181</span><br></span></code></pre></div></div>
<p>now we&#x27;re ready to setup the azure dns solver!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="azuredns-config-setup"><code>azuredns-config</code> setup<a href="#azuredns-config-setup" class="hash-link" aria-label="Direct link to azuredns-config-setup" title="Direct link to azuredns-config-setup">​</a></h3>
<p>The <code>bot</code> that solves the dns-01 challenge for our Issuer is a service principal with the permissions to create a DNS record in our new Azure DNZ Zone.</p>
<p>Not too complicated, aye.</p>
<p>Use this script (I called it <code>setup_azuredns.sh</code>) to create the necessary <code>cert-manager-dns01</code> service principal (note, you need <code>jq</code> or <code>jshon</code> installed ), example:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AZURE_CERT_MANAGER_SP_NAME=&quot;cert-manager-dns01&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AZURE_CERT_MANAGER_DNS_RESOURCE_GROUP=&quot;azuredns-rg-prod&quot; # this is the resource group from the DNS Zone you created earlier</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AZURE_CERT_MANAGER_DNS_NAME=&quot;cloudbuild.site&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">DNS_SP=$(az ad sp create-for-rbac --name $AZURE_CERT_MANAGER_SP_NAME)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AZURE_CERT_MANAGER_SP_APP_ID=$(echo $DNS_SP | jq -r &#x27;.appId&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AZURE_CERT_MANAGER_SP_PASSWORD=$(echo $DNS_SP | jq -r &#x27;.password&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AZURE_TENANT_ID=$(echo $DNS_SP | jq -r &#x27;.tenant&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AZURE_SUBSCRIPTION_ID=$(az account show | jq -r &#x27;.id&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Lower the Permissions of the SP</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">az role assignment delete --assignee $AZURE_CERT_MANAGER_SP_APP_ID --role Contributor</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Give Access to DNS Zone</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">DNS_ID=$(az network dns zone show --name $AZURE_CERT_MANAGER_DNS_NAME --resource-group $AZURE_CERT_MANAGER_DNS_RESOURCE_GROUP --query &quot;id&quot; --output tsv)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">az role assignment create --assignee $AZURE_CERT_MANAGER_SP_APP_ID --role &quot;DNS Zone Contributor&quot; --scope $DNS_ID</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Check Permissions</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">az role assignment list --assignee $AZURE_CERT_MANAGER_SP_APP_ID</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Create Secret -- delete existing first.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl delete secret azuredns-config</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl create secret generic azuredns-config \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --from-literal=CLIENT_SECRET=$AZURE_CERT_MANAGER_SP_PASSWORD</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Get the Service Principal App ID for configuration</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">echo &quot;Principal: $AZURE_CERT_MANAGER_SP_APP_ID&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">echo &quot;Password: $AZURE_CERT_MANAGER_SP_PASSWORD&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">echo &quot;Tenant ID: $AZURE_TENANT_ID&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">echo &quot;Subscription ID: $AZURE_SUBSCRIPTION_ID&quot;</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Required Info</div><div class="admonitionContent_BuS1"><p>You need the <code>Principal</code> &amp; <code>Password</code> for the Issuer section below.</p></div></div>
<p>the script will:</p>
<ul>
<li>creates a service principal (SPN)</li>
<li>give SPN access to existing DNS Zone</li>
<li>create a k8s secret called <code>azuredns-config</code> with the SPN&#x27;s secret/password.</li>
</ul>
<p>the script comes from <a href="https://cert-manager.io/docs/configuration/acme/dns01/azuredns/" target="_blank" rel="noopener noreferrer">cert-manager.io</a>, modifications by me.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="azuredns-config-secret">azuredns-config secret<a href="#azuredns-config-secret" class="hash-link" aria-label="Direct link to azuredns-config secret" title="Direct link to azuredns-config secret">​</a></h3>
<p>This secret needs to be in the same namespace as your Issuer - so maybe add <code>-n &lt;namespace /&gt;</code> to the script, or create it manually.</p>
<p>The secret is created in the <code>setup_azuredns.sh</code> script but if you need to manually create it:</p>
<p><code>kubectl -n &lt;NAMESPACE_WHERE_ISSUER_IS /&gt; create secret generic azuredns-config --from-literal=CLIENT_SECRET=&lt;secret_goes_here /&gt;</code></p>
<p>take note of the <code>CLIENT_SECRET</code> bit as the required reference to the secret later on.</p>
<p><em>letsencrypt has 2 acme servers, a staging and a production one - we will use the production one.</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="create-issuer--certificates">Create Issuer &amp; Certificates<a href="#create-issuer--certificates" class="hash-link" aria-label="Direct link to Create Issuer &amp; Certificates" title="Direct link to Create Issuer &amp; Certificates">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="production-issuer">Production Issuer<a href="#production-issuer" class="hash-link" aria-label="Direct link to Production Issuer" title="Direct link to Production Issuer">​</a></h3>
<p>This is my prod Issuer (as an example) - read the comments and substitute accordingly:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> cert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">manager.io/v1alpha2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Issuer</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> letsencrypt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">prod</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">acme</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">server</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">//acme</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">v02.api.letsencrypt.org/directory</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">email</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ron@cloudbuilder.io </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># change to your email address.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">privateKeySecretRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> letsencrypt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">prod</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">solvers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">dns01</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">azuredns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">clientID</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> XXXXXXXXXXXXXXXXXXXXX </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># this the Principal from the &#x27;setup_azuredns.sh&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">clientSecretSecretRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azuredns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> CLIENT_SECRET</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">subscriptionID</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> YOUR</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">SUBSCRIPTION</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">ID</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">tenantID</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> YOUR</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">TENANT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">ID</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> YOUR</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">DNS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">ZONES</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">RESOURCEGROUP</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">NAME</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">hostedZoneName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> cloudbuild.site </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># change to your domain.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzurePublicCloud </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># leave this as-is.</span><br></span></code></pre></div></div>
<p>save to <code>IssuerProd.yaml</code> and because we want istio&#x27;s <code>ingressgateway</code> in <code>istio-system</code> namespace to find and use the cert via SDS, we need to ensure the following 3 things are all deployed in <strong>the <code>istio-system</code> namespace</strong>:</p>
<ul>
<li>azuredns-config secret</li>
<li>production Issuer</li>
<li>production Certificate</li>
</ul>
<p>deploy the Issuer:</p>
<p><code>kubectl -n istio-system apply -f ./IssuerProd.yaml</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="production-certificate">Production Certificate<a href="#production-certificate" class="hash-link" aria-label="Direct link to Production Certificate" title="Direct link to Production Certificate">​</a></h3>
<p>This is my prod Certificate (as an example) - read the comments and substitute accordingly:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> cert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">manager.io/v1alpha2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Certificate</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ingress</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">cert</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">secretName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ingress</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">cert</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">issuerRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> letsencrypt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">prod</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Issuer</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">commonName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> bookinfo.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">dnsNames</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> bookinfo.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">acme</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">dns01</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">provider</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azuredns</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">domains</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> cloudbuild.site</span><br></span></code></pre></div></div>
<p>save to <code>CertProd.yaml</code> and deploy into the <code>istio-system</code> namespace:</p>
<p><code>kubectl -n istio-system apply -f ./CertProd.yaml</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="check-cert-manager-logs">Check cert-manager logs<a href="#check-cert-manager-logs" class="hash-link" aria-label="Direct link to Check cert-manager logs" title="Direct link to Check cert-manager logs">​</a></h3>
<p>Once you deploy the cert, if everything is setup correctly you should see logs like this :</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">I0307 08:21:35.667035       1 controller.go:135] cert-manager/controller/orders &quot;msg&quot;=&quot;finished processing work item&quot; &quot;key&quot;=&quot;istio-system/ingress-cert-1810009586-3587251712&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">I0307 08:21:38.181385       1 dns.go:121] cert-manager/controller/challenges/Check &quot;msg&quot;=&quot;checking DNS propagation&quot; &quot;dnsName&quot;=&quot;bookinfo.cloudbuild.site&quot; &quot;domain&quot;=&quot;bookinfo.cloudbuild.site&quot; &quot;resource_kind&quot;=&quot;Challenge&quot; &quot;resource_name&quot;=&quot;ingress-cert-1810009586-3587251712-2272992580&quot; &quot;resource_namespace&quot;=&quot;istio-system&quot; &quot;type&quot;=&quot;dns-01&quot; &quot;nameservers&quot;=[&quot;10.0.0.10:53&quot;]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">I0307 08:21:49.666500       1 dns.go:133] cert-manager/controller/challenges/Check &quot;msg&quot;=&quot;waiting DNS record TTL to allow the DNS01 record to propagate for domain&quot; &quot;dnsName&quot;=&quot;bookinfo.cloudbuild.site&quot; &quot;domain&quot;=&quot;bookinfo.cloudbuild.site&quot; &quot;resource_kind&quot;=&quot;Challenge&quot; &quot;resource_name&quot;=&quot;ingress-cert-1810009586-3587251712-2272992580&quot; &quot;resource_namespace&quot;=&quot;istio-system&quot; &quot;type&quot;=&quot;dns-01&quot; &quot;fqdn&quot;=&quot;_acme-challenge.bookinfo.cloudbuild.site.&quot; &quot;ttl&quot;=60</span><br></span></code></pre></div></div>
<p>Once you see all sorts of successful activity happening, go to your Azure Portal and check your DNS Zone. All going well, you&#x27;ll see a new TXT record with a hash value like this:</p>
<p><img decoding="async" loading="lazy" alt="azure_dns_zone_txt" src="/assets/images/istiosds-dnszone-TXTrecord-0af78877fcafe99dec851fb7bc3f8db7.png" width="1261" height="429" class="img_ev3q"></p>
<p>Check the cert resource via kubectl:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># kubectl -n istio-system describe certs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">         ingress</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">cert</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">    istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">       &lt;none /</span><span class="token punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Annotations</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  kubectl.kubernetes.io/last</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">applied</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">configuration</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">API Version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  cert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">manager.io/v1alpha2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">         Certificate</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Creation Timestamp</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  </span><span class="token datetime number" style="color:rgb(247, 140, 108)">2020-03-07T08:21:31Z</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Generation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">          </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Resource Version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">69741</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Self Link</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">           /apis/cert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">manager.io/v1alpha2/namespaces/istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">system/certificates/ingress</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">cert</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">UID</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                 c97b2f16</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">4e32</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">4b48</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">9692</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">dfa94e9761fe</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Common Name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  bookinfo.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Dns Names</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    bookinfo.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Issuer Ref</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">Kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">       Issuer</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">Name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">       letsencrypt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">prod</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Secret Name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  ingress</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">cert</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Status</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Conditions</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">Last Transition Time</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  </span><span class="token datetime number" style="color:rgb(247, 140, 108)">2020-03-07T08:23:12Z</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">Message</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">               Certificate is up to date and has not expired</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">Reason</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                Ready</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">Status</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                </span><span class="token boolean important" style="color:rgb(255, 88, 116)">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">Type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                  Ready</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">Not After</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">               </span><span class="token datetime number" style="color:rgb(247, 140, 108)">2020-06-05T07:23:11Z</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">Events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  Type    Reason     Age   From          Message</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain">     </span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  Normal  Requested  12m   cert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">manager  Created new CertificateRequest resource &quot;ingress</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">cert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">1810009586&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  Normal  Issued     10m   cert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">manager  Certificate issued successfully</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="verify-certificate-via-openssl">Verify Certificate via OpenSSL<a href="#verify-certificate-via-openssl" class="hash-link" aria-label="Direct link to Verify Certificate via OpenSSL" title="Direct link to Verify Certificate via OpenSSL">​</a></h3>
<p><code>openssl s_client -connect bookinfo.cloudbuild.site:443</code></p>
<p>results, we see:</p>
<ul>
<li>LetsEncrypt Authority</li>
<li>CN of &#x27;bookinfo.cloudbuild.site&#x27;</li>
<li>Signed Certificate</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">CONNECTED(00000005)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">depth=2 O = Digital Signature Trust Co., CN = DST Root CA X3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">verify return:1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">depth=1 C = US, O = Let&#x27;s Encrypt, CN = Let&#x27;s Encrypt Authority X3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">verify return:1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">depth=0 CN = bookinfo.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">verify return:1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">---</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Certificate chain</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"> 0 s:CN = bookinfo.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">   i:C = US, O = Let&#x27;s Encrypt, CN = Let&#x27;s Encrypt Authority X3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"> 1 s:C = US, O = Let&#x27;s Encrypt, CN = Let&#x27;s Encrypt Authority X3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">   i:O = Digital Signature Trust Co., CN = DST Root CA X3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">---</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Server certificate</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-----BEGIN CERTIFICATE-----</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">MIIFaDCCBFCgAwIBAgISA/EH7xvZBS+ir5NoJM3ozbrHMA0GCSqGSIb3DQEBCwUA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">MEoxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MSMwIQYDVQQD</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ExpMZXQncyBFbmNyeXB0IEF1dGhvcml0eSBYMzAeFw0yMDAzMDcwNzIzMTFaFw0y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">MDA2MDUwNzIzMTFaMCMxITAfBgNVBAMTGGJvb2tpbmZvLmNsb3VkYnVpbGQuc2l0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ZTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAN6NdP6aMOyGV91eYKxY</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/PQUDOUGzvFGcf2hiAtf0rEycNHDsY8WGockRECDXfj+Z+q1WFwcuKP40Netc3K/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">4Ywnmg1P8Vt46R57QcsV43rBtC+aDCGR8vJPiUGxHbkzMqLSUmCHqupt6OmZdlxl</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0AjMd40+NboiKqKCYPTE/xtSoH8dCqEhRKIDZK1unFxOv4wQbV7lMYRwlfmv05zr</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">yTBozqGcwx3WU3I90cN8UKisbg5enb5DZGl3rRozRHZkXXg0gBiRzfr0xxA65nQ0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">BJ3LpIehjavprSzVDXGmuIVqLS3ZRgYxqzaYdohNZZN/JhjUlZqTpcm+Gzyj2iPh</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">YmUCAwEAAaOCAm0wggJpMA4GA1UdDwEB/wQEAwIFoDAdBgNVHSUEFjAUBggrBgEF</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">BQcDAQYIKwYBBQUHAwIwDAYDVR0TAQH/BAIwADAdBgNVHQ4EFgQUlZgrZj4o3utB</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">bjhVZfPFsW6ouCgwHwYDVR0jBBgwFoAUqEpqYwR93brm0Tm3pkVl7/Oo7KEwbwYI</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">KwYBBQUHAQEEYzBhMC4GCCsGAQUFBzABhiJodHRwOi8vb2NzcC5pbnQteDMubGV0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">c2VuY3J5cHQub3JnMC8GCCsGAQUFBzAChiNodHRwOi8vY2VydC5pbnQteDMubGV0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">c2VuY3J5cHQub3JnLzAjBgNVHREEHDAaghhib29raW5mby5jbG91ZGJ1aWxkLnNp</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dGUwTAYDVR0gBEUwQzAIBgZngQwBAgEwNwYLKwYBBAGC3xMBAQEwKDAmBggrBgEF</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">BQcCARYaaHR0cDovL2Nwcy5sZXRzZW5jcnlwdC5vcmcwggEEBgorBgEEAdZ5AgQC</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">BIH1BIHyAPAAdgCyHgXMi6LNiiBOh2b5K7mKJSBna9r6cOeySVMt74uQXgAAAXC0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">F08nAAAEAwBHMEUCIFKe+kYtgTIPYGjL1vL54oSias4Sn6nx6SGwQzWS6R8SAiEA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">hgJcnoKZXFX2Esz4jKFWTrft4Pz8XlUFhTKfoSHoQeQAdgBvU3asMfAxGdiZAKRR</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Ff93FRwR2QLBACkGjbIImjfZEwAAAXC0F096AAAEAwBHMEUCIH/cLlIYaGNTUWZA</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Lweli4M14z6k1hs9Rmk3E+eVCOTxAiEAj3NtSBT578yvCCD8IhtVzPHBILWsyC8o</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">HB/LKG78IrIwDQYJKoZIhvcNAQELBQADggEBAANnWf1U4PYT49n6b97GvGD1xE4i</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">JWJfuOqpT39dvIfx4YA0WhrzN4LwpdR+pejNDThs08usqvKIqCxY5SGSQY9Mip57</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">9r26qHN+Om3ufI/mZ81fvtH6PJQ0YgFG0kGMY/wZ4pZu2P2KwH5Tv2gGI4ZDl3tC</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cclqL4qn9+eMaxqF1mO1wE7HTNpo+aiyKupdLTau6GH9vfyxj/Z17UAUfi8mugnX</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">OxoyXx5d7U5Zi3ofJv1YfxFCoPNttyWhoWX2odHzoAvRDazzDy/bWmzPsM3gPeYC</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">GwdWUCABDkwRosiD0zs1YHjeSkTSkCa0snRZJi3reeC+zNbtyZ+O3VstYeQ=</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-----END CERTIFICATE-----</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">subject=CN = bookinfo.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">issuer=C = US, O = Let&#x27;s Encrypt, CN = Let&#x27;s Encrypt Authority X3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">---</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">No client certificate CA names sent</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Peer signing digest: SHA256</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Peer signature type: RSA-PSS</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Server Temp Key: X25519, 253 bits</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">---</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">SSL handshake has read 3057 bytes and written 406 bytes</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Verification: OK</span><br></span></code></pre></div></div>
<p><strong>SUCCESS!!</strong></p>
<p>Now you can browse and use your bookinfo app at <a href="https://bookinfo.cloudbuild.site/productpage" target="_blank" rel="noopener noreferrer">https://bookinfo.cloudbuild.site/productpage</a> with a valid TLS certificate, and working cert-manager and SDS setup with Azure DNS challenge solver!</p>
<p>I know this was pretty long, so any question, please feel free to ping me online, probably on <a href="https://twitter.com/rxnamxsa" target="_blank" rel="noopener noreferrer">Twitter</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/istio">istio</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/service-mesh">service-mesh</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/security">security</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/certificates">certificates</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/mtls">mtls</a></li></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/engineer/K8s/2020-03-06-Istio-SDS-Cert-Manager.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-09-22T07:31:42.000Z" itemprop="dateModified">Sep 22, 2025</time></b> by <b>Ron Amosa</b></span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/engineer/K8s/2019-11-11-Helm-3-Kubernetes-Package-Manager"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Helm 3 Complete Guide - Kubernetes Package Manager and Application Deployment</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/engineer/K8s/2020-04-08-Istio-MTLS-with-External-Endpoint"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Istio mTLS with External Endpoints - Egress Gateway Configuration Guide</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#architecture-diagram" class="table-of-contents__link toc-highlight">Architecture Diagram</a><ul><li><a href="#key-components" class="table-of-contents__link toc-highlight">Key Components</a></li></ul></li><li><a href="#pre-requisites" class="table-of-contents__link toc-highlight">Pre-requisites</a></li><li><a href="#istio-setup" class="table-of-contents__link toc-highlight">Istio Setup</a><ul><li><a href="#check-access-to-your-cluster" class="table-of-contents__link toc-highlight">Check access to your cluster</a></li><li><a href="#download-istio--istioctl" class="table-of-contents__link toc-highlight">Download Istio &amp; istioctl</a></li><li><a href="#install-istio-with-sds-enabled" class="table-of-contents__link toc-highlight">Install Istio with SDS enabled</a></li><li><a href="#patch-istio-ingressgateway" class="table-of-contents__link toc-highlight">patch istio ingressgateway</a></li><li><a href="#checkpoint" class="table-of-contents__link toc-highlight">Checkpoint</a></li></ul></li><li><a href="#install-bookinfo-demo-application" class="table-of-contents__link toc-highlight">Install Bookinfo Demo Application</a><ul><li><a href="#install-modified-gateway" class="table-of-contents__link toc-highlight">Install modified gateway</a></li></ul></li><li><a href="#install-cert-manager" class="table-of-contents__link toc-highlight">Install Cert-Manager</a><ul><li><a href="#via-kubectl" class="table-of-contents__link toc-highlight">via kubectl</a></li><li><a href="#via-helm" class="table-of-contents__link toc-highlight">via helm</a></li><li><a href="#check-cert-manager-installation" class="table-of-contents__link toc-highlight">Check cert-manager installation</a></li></ul></li><li><a href="#setup-azure-dns-for-acme-challenge" class="table-of-contents__link toc-highlight">Setup Azure DNS for ACME Challenge</a><ul><li><a href="#azure-dns-zone" class="table-of-contents__link toc-highlight">Azure DNS Zone</a></li><li><a href="#update-domain-registrar-nameservers" class="table-of-contents__link toc-highlight">Update domain registrar nameservers</a></li><li><a href="#azuredns-config-setup" class="table-of-contents__link toc-highlight"><code>azuredns-config</code> setup</a></li><li><a href="#azuredns-config-secret" class="table-of-contents__link toc-highlight">azuredns-config secret</a></li></ul></li><li><a href="#create-issuer--certificates" class="table-of-contents__link toc-highlight">Create Issuer &amp; Certificates</a><ul><li><a href="#production-issuer" class="table-of-contents__link toc-highlight">Production Issuer</a></li><li><a href="#production-certificate" class="table-of-contents__link toc-highlight">Production Certificate</a></li><li><a href="#check-cert-manager-logs" class="table-of-contents__link toc-highlight">Check cert-manager logs</a></li><li><a href="#verify-certificate-via-openssl" class="table-of-contents__link toc-highlight">Verify Certificate via OpenSSL</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/ron-amosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/ronamosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@uncommonengineer" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Discover</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/docs">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/about">About</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Last updated on Mon Sep 22 2025</div></div></div></footer></div>
</body>
</html>