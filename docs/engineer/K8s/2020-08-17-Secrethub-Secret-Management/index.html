<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-engineer/K8s/2020-08-17-Secrethub-Secret-Management" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">SecretHub Kubernetes Secrets Management - Secure Secret Storage and Distribution | The Uncommon Engineer</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ronamosa.io/docs/engineer/K8s/2020-08-17-Secrethub-Secret-Management"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="SecretHub Kubernetes Secrets Management - Secure Secret Storage and Distribution | The Uncommon Engineer"><meta data-rh="true" name="description" content="Complete guide to using SecretHub for Kubernetes secrets management. Learn secure secret storage, distribution, and access control for containerized applications."><meta data-rh="true" property="og:description" content="Complete guide to using SecretHub for Kubernetes secrets management. Learn secure secret storage, distribution, and access control for containerized applications."><meta data-rh="true" name="keywords" content="secrethub,kubernetes secrets,secret management,secure storage,k8s security,secrets distribution,container security"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ronamosa.io/docs/engineer/K8s/2020-08-17-Secrethub-Secret-Management"><link data-rh="true" rel="alternate" href="https://ronamosa.io/docs/engineer/K8s/2020-08-17-Secrethub-Secret-Management" hreflang="en"><link data-rh="true" rel="alternate" href="https://ronamosa.io/docs/engineer/K8s/2020-08-17-Secrethub-Secret-Management" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9UFF3RBJQ9-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"💻 Engineer","item":"https://ronamosa.io/docs/category/-engineer"},{"@type":"ListItem","position":2,"name":"SecretHub Kubernetes Secrets Management - Secure Secret Storage and Distribution","item":"https://ronamosa.io/docs/engineer/K8s/2020-08-17-Secrethub-Secret-Management"}]}</script><link rel="search" type="application/opensearchdescription+xml" title="The Uncommon Engineer" href="/opensearch.xml">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DMRNTVGLRC"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DMRNTVGLRC",{anonymize_ip:!0})</script>

<script src="/js/console-clue.js"></script>
<script src="/js/metricool.js"></script><link rel="stylesheet" href="/assets/css/styles.dd12b5e8.css">
<script src="/assets/js/runtime~main.cb34a51e.js" defer="defer"></script>
<script src="/assets/js/main.fb1c5b66.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="ronamosa.io" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="ronamosa.io" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Uncommon Engineer</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog/">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/projects/">Projects</a><a class="navbar__item navbar__link" href="/changelog/">Changelog</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">▶ Start Here</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/books/reading-list">📚 Books &amp; Papers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/study/SCS-C01/">📗 Study</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/️-hacker">🏴‍☠️ Hacker</a><button aria-label="Expand sidebar category &#x27;🏴‍☠️ Hacker&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/-engineer">💻 Engineer</a><button aria-label="Collapse sidebar category &#x27;💻 Engineer&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/ai">AI</a><button aria-label="Expand sidebar category &#x27;AI&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/️-projects">🛠️ Projects</a><button aria-label="Expand sidebar category &#x27;🛠️ Projects&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/AWS/AWS-EKS-Workshop">AWS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/Azure/2019-07-20-Sonarqube-AzureDisk-PersistentVolume">Azure</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/GCP/2019-11-27-GCP-Install-Ambassador-Helm2">GCP</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/engineer/K8s/2019-11-11-Helm-3-Kubernetes-Package-Manager">K8s</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/K8s/2019-11-11-Helm-3-Kubernetes-Package-Manager">Helm 3 Complete Guide - Kubernetes Package Manager and Application Deployment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/K8s/2020-03-06-Istio-SDS-Cert-Manager">Istio mTLS with SDS and Cert-Manager - Complete Service Mesh Security Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/K8s/2020-04-08-Istio-MTLS-with-External-Endpoint">Istio mTLS with External Endpoints - Egress Gateway Configuration Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/K8s/2019-07-09-Ambassador-Disable-TLS1">Ambassador API Gateway TLS Security - Disable TLS 1.0 and 1.1 for Better Security</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/engineer/K8s/2020-08-17-Secrethub-Secret-Management">SecretHub Kubernetes Secrets Management - Secure Secret Storage and Distribution</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/LAB">LAB</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/Misc/algos-system-design">Misc</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/archive/docker-wordpress/docker-wordpress-1">🗃 Archive</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/-engineer"><span>💻 Engineer</span></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">K8s</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">SecretHub Kubernetes Secrets Management - Secure Secret Storage and Distribution</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>SecretHub Kubernetes Secrets Management - Secure Secret Storage and Distribution</h1></header><div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Published Date: 17-AUG-2020</p></div></div>
<p>A simple example of setting up SecretHub secrets manager to secure all your application and infrastructure secrets at deployment</p>
<p>Secrets management, especially as part of a project/product team, is something that can easily get very messy with user, system and application credentials all over the place due to a lack of a secrets management system and practice setup. It&#x27;s important to figure this out early in the piece, especially for all the engineers who are going to be working on the application and infrastructure for that app, you want people to come into the team and have access to everything they need and not have to compromise any security to do so.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="objective">Objective<a href="#objective" class="hash-link" aria-label="Direct link to Objective" title="Direct link to Objective">​</a></h2>
<p>In this post I&#x27;m going to go through setting up <a href="https://secrethub.io/docs/start/getting-started/" target="_blank" rel="noopener noreferrer">SecretHub Secret Manager</a> to take care of the following common secrets management patterns:</p>
<ol>
<li>Shell Environment secrets</li>
<li>Infrastructure Code secrets</li>
</ol>
<p>Essentially we&#x27;re taking something that usually looks like this:</p>
<p><img decoding="async" loading="lazy" alt="pipeline problem" src="/assets/images/pipeline-problem-109da26ca3aaa119bd1b057347b26a0f.svg" width="921" height="281" class="img_ev3q"></p>
<p>Into this:</p>
<p><img decoding="async" loading="lazy" alt="pipeline solution" src="/assets/images/pipeline-cover-8557522fdeaf5c04fcd746b308b3cf8d.svg" width="962" height="412" class="img_ev3q"></p>
<p>By the end you will see how secrets can be managed for:</p>
<ul>
<li>A storage account key for terraform remote state file, in an ENV variable</li>
<li>An azure service principal for AKS, in the infrastructure code (terraform)</li>
<li>ssh private keys for AKS nodes, also in the infrastructure code (terraform)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pre-requisites">Pre-requisites<a href="#pre-requisites" class="hash-link" aria-label="Direct link to Pre-requisites" title="Direct link to Pre-requisites">​</a></h2>
<p>This post builds on Microsoft Azure so to follow along you will need the following things:</p>
<ul>
<li>Azure Account</li>
<li><code>az-cli</code> tool</li>
<li>terraform <code>0.12.x</code></li>
<li>clone of repo <a href="https://github.com/ronamosa/aks-secrethub-cluster" target="_blank" rel="noopener noreferrer">&#x27;aks-secrethub-cluster&#x27;</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="storage-account--key">Storage Account &amp; Key<a href="#storage-account--key" class="hash-link" aria-label="Direct link to Storage Account &amp; Key" title="Direct link to Storage Account &amp; Key">​</a></h3>
<p>Best practice for Terraform means using a remote state file saved on your cloud provider (securely) so we need to create an Azure storage account.</p>
<p>First, create a resource group:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">export RESOURCE_GROUP_NAME=&quot;terraform-rg&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">export LOCATION=&quot;australiasoutheast&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">az group create --name $\{RESOURCE_GROUP_NAME} --location $\{LOCATION}</span><br></span></code></pre></div></div>
<p>Now create the storage account:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">export STORAGE_ACCOUNT_NAME=&quot;terraform&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">az storage account create --resource-group $\{RESOURCE_GROUP_NAME} --name $\{STORAGE_ACCOUNT_NAME} --sku Standard_LRS --encryption-services blob</span><br></span></code></pre></div></div>
<p>Get the ARM access key from the storage account and use it to create a storage account container:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">CONTAINER_NAME=&quot;tfstate&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">export ARM_ACCESS_KEY=$(az storage account keys list --resource-group $\{RESOURCE_GROUP_NAME} --account-name $\{STORAGE_ACCOUNT_NAME} --query [0].value -o tsv)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">az storage container create --name $\{CONTAINER_NAME} --account-name $\{STORAGE_ACCOUNT_NAME} --account-key $\{ARM_ACCESS_KEY}</span><br></span></code></pre></div></div>
<p>Note the value of your <code>ARM_ACCESS_KEY</code> somewhere for later.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="service-principal">Service Principal<a href="#service-principal" class="hash-link" aria-label="Direct link to Service Principal" title="Direct link to Service Principal">​</a></h3>
<p>AKS needs a service principal with the permission to provision &amp; manage resources in Azure.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain"># you need your subcription ID handy</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">az account set --subscription=&quot;SUBSCRIPTION_ID&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">az ad sp create-for-rbac --role=&quot;Contributor&quot; --scopes=&quot;/subscriptions/SUBSCRIPTION_ID&quot;</span><br></span></code></pre></div></div>
<p>Output looks like this:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;appId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;00000000-0000-0000-0000-000000000000&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;displayName&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;azure-cli-2020-08-17-10-41-15&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;name&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;http://azure-cli-2020-08-17-10-41-15&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;password&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;0000-0000-0000-0000-000000000000&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;tenant&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;00000000-0000-0000-0000-000000000000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<p>Note the <code>appId</code> as <code>SPN_ID</code> and <code>password</code> as <code>SPN_SECRET</code> for later.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ssh-public-keys">SSH Public Keys<a href="#ssh-public-keys" class="hash-link" aria-label="Direct link to SSH Public Keys" title="Direct link to SSH Public Keys">​</a></h3>
<p>AKS <code>linux_profile</code> requires an <code>ssh_key</code> public key used to access the cluster.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">  linux_profile {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    admin_username = var.vm_user_name</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ssh_key {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      key_data = data.secrethub_secret.aks_ssh_key.value</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span></code></pre></div></div>
<p>Generate a new keypair:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">$ ssh-keygen</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Generating public/private rsa key pair.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Enter file in which to save the key (/home/user/.ssh/id_rsa): ./secrethub-keypair</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Enter passphrase (empty for no passphrase):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Enter same passphrase again:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Your identification has been saved in ./secrethub-keypair.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Your public key has been saved in ./secrethub-keypair.pub.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The key fingerprint is:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">SHA256:80P9EDgEkiEVpgpiYEuzqWFAJW43TlBqKimTvezHIjg user@laptop</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The keys randomart image is:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">+---[RSA 2048]----+</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|+Boo..*+...      |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|* O  +.. . .     |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|+@ +.     o .    |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|O*+..      o .   |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|O o.    S . o    |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|oo .     +   o   |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|. o.      o   .  |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|E.. o      .     |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">| o.o             |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">+----[SHA256]-----+</span><br></span></code></pre></div></div>
<p>Once you have your account, check it with: <code>secrethub account inspect</code></p>
<p>Substitute <code>SECRETHUB_ACCOUNT</code> for your secrethub account from now on.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="secrethub-setup">SecretHub Setup<a href="#secrethub-setup" class="hash-link" aria-label="Direct link to SecretHub Setup" title="Direct link to SecretHub Setup">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="directory-structure">Directory Structure<a href="#directory-structure" class="hash-link" aria-label="Direct link to Directory Structure" title="Direct link to Directory Structure">​</a></h3>
<p>Your secrethub setup is path based, so you need to think about directory structure of how you want your secret mapped out.</p>
<p>For this simple setup we will go with the following <a href="https://secrethub.io/docs/basics/best-practices/" target="_blank" rel="noopener noreferrer">recommended structure</a>, to group our secrets in terms of <code>environments</code> first and then more granularly in terms of <code>application</code> they belong to:</p>
<div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-txt codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">$SECRETHUB_ACCOUNT/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">├── aks_secrets/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    └── prod/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        ├── terraform/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        |   |-- aks_service_principal_id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        |   |-- aks_service_principal_secret</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        |   |-- aks_ssh_key</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        |── azure/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            |-- arm_access_key</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-directories">Create Directories<a href="#create-directories" class="hash-link" aria-label="Direct link to Create Directories" title="Direct link to Create Directories">​</a></h3>
<p>We need to create the directory paths mentioned in the previous section for our secrets:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">secrethub repo init $SECRETHUB_ACCOUNT/aks_secrets</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secrethub mkdir $SECRETHUB_ACCOUNT/aks_secrets/prod</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secrethub mkdir $SECRETHUB_ACCOUNT/aks_secrets/prod/terraform</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">secrethub mkdir $SECRETHUB_ACCOUNT/aks_secrets/prod/azure</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-secrethub-secrets">Create SecretHub Secrets<a href="#create-secrethub-secrets" class="hash-link" aria-label="Direct link to Create SecretHub Secrets" title="Direct link to Create SecretHub Secrets">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain"># azure secrets directory</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">echo $\{ARM_ACCESS_KEY} | secrethub write $SECRETHUB_ACCOUNT/aks_secrets/prod/azure/arm_access_key</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># terraform secrets directory</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">echo $\{SPN_ID} | secrethub write $SECRETHUB_ACCOUNT/aks_secrets/prod/terraform/aks_service_principal_id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">echo $\{SPN_SECRET} | secrethub write $SECRETHUB_ACCOUNT/aks_secrets/prod/terraform/aks_service_principal_secret</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cat $\{SSH_KEYPAIR} | secrethub write $SECRETHUB_ACCOUNT/aks_secrets/prod/terraform/aks_ssh_key</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="terraform-aks-setup">Terraform AKS Setup<a href="#terraform-aks-setup" class="hash-link" aria-label="Direct link to Terraform AKS Setup" title="Direct link to Terraform AKS Setup">​</a></h2>
<p>Clone the following repo if you haven&#x27;t already done so <a href="https://github.com/ronamosa/aks-secrethub-cluster" target="_blank" rel="noopener noreferrer">&#x27;aks-secrethub-cluster&#x27;</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="install-terraform-provider">Install Terraform Provider<a href="#install-terraform-provider" class="hash-link" aria-label="Direct link to Install Terraform Provider" title="Direct link to Install Terraform Provider">​</a></h3>
<p>SecretHub provides a terraform provider, follow the installation instructions found at <a href="https://secrethub.io/docs/reference/terraform/install/" target="_blank" rel="noopener noreferrer">&#x27;Install SecretHub Terraform Provider&#x27;</a></p>
<p>Or, run this for <code>amd64</code> version:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">mkdir -p ~/.terraform.d/plugins &amp;&amp; curl -SfL https://github.com/secrethub/terraform-provider-secrethub/releases/latest/download/terraform-provider-secrethub-linux-amd64.tar.gz | tar zxf - -C ~/.terraform.d/plugins</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="secrethub-terraform-resources">SecretHub Terraform Resources<a href="#secrethub-terraform-resources" class="hash-link" aria-label="Direct link to SecretHub Terraform Resources" title="Direct link to SecretHub Terraform Resources">​</a></h3>
<p>The main components where all the magic happen are as follows:</p>
<p>Declare the provider, and where to find your secrethub credentials in <code>prodiver.tf</code></p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">provider</span><span class="token keyword type variable" style="color:rgb(214, 222, 235)"> &quot;secrethub&quot; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">credential</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token plain"> file(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;~/.secrethub/credential&quot;</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<p>Because your secrets already exist, you want to set them up as data sources in <code>aks.tf</code></p>
<p><em>(remember to replace <code>$SECRETHUB_ACCOUNT</code> with your account details)</em></p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># secrethub secret - service principal id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">data </span><span class="token keyword type variable" style="color:rgb(214, 222, 235)">&quot;secrethub_secret&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;aks_service_principal_id&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">path</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;$SECRETHUB_ACCOUNT/aks_secrets/prod/terraform/aks_service_principal_id&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># secrethub secret - service principal secret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">data </span><span class="token keyword type variable" style="color:rgb(214, 222, 235)">&quot;secrethub_secret&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;aks_service_principal_secret&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">path</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;$SECRETHUB_ACCOUNT/aks_secrets/prod/terraform/aks_service_principal_secret&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># secrethub secret - ssh key for aks nodes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">data </span><span class="token keyword type variable" style="color:rgb(214, 222, 235)">&quot;secrethub_secret&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;aks_ssh_key&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">path</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;$SECRETHUB_ACCOUNT/aks_secrets/prod/terraform/aks_ssh_key&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<p>As a deployment-time secret, you use the file provided, <code>secrethub.env</code> which has the entry for the <code>ARM_ACCESS_KEY</code> to access your remote storage account to manage the terraform state file:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">{% raw %}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ARM_ACCESS_KEY = \{\{ $SECRETHUB_ACCOUNT/aks_secrets/prod/azure/arm_access_key \}\}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{% endraw %}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="run-deployment">Run Deployment<a href="#run-deployment" class="hash-link" aria-label="Direct link to Run Deployment" title="Direct link to Run Deployment">​</a></h2>
<p>Make sure to update <code>aks.tf</code> backend details, with your details (see above)</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">terraform</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">backend</span><span class="token keyword type variable" style="color:rgb(214, 222, 235)"> &quot;azurerm&quot; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">resource_group_name</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token plain"> RESOURCE_GROUP_NAME</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">storage_account_name</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token plain"> STORAGE_ACCOUNT_NAME</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">container_name</span><span class="token plain">       </span><span class="token punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token plain"> CONTAINER_NAME</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<p>After you have confirmed everything is in place, use the <code>make</code> command to build your infra:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">ENV=prod make plan</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ENV=prod make apply</span><br></span></code></pre></div></div>
<p>The Makefile will run an apply like this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">secrethub run -- terraform apply</span><br></span></code></pre></div></div>
<p>Where <code>secrethub.env</code> file will get picked up by default, the <code>ARM_ACCESS_KEY</code> will be imported in as an Environment variable, allowing terraform to access the remote storage account.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>In this post we have setup a simple AKS cluster using terraform to use SecretHub, to manage and secure our secrets.</p>
<p>We have setup a remote state file secret; an azure service principal secret and a terraform ssh key secret. All into the SecretHub Secrets Manager and have injected them securely at infrastructure deployment time.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="https://www.terraform.io/docs/providers/azurerm/guides/service_principal_client_secret.html" target="_blank" rel="noopener noreferrer">Terraform Azure Service Principal</a></li>
<li><a href="https://www.terraform.io/docs/providers/azurerm/r/kubernetes_cluster.html#ssh_key" target="_blank" rel="noopener noreferrer">Terraform Azure SSH Keys</a></li>
<li><a href="https://secrethub.io/docs/guides/environment-variables/" target="_blank" rel="noopener noreferrer">SecretHub Environment Variables</a></li>
<li><a href="https://github.com/ronamosa/aks-secrethub-cluster" target="_blank" rel="noopener noreferrer">Github: aks-secrethub-cluster</a></li>
<li><a href="https://secrethub.io/blog/decouple-application-secrets-from-ci-cd-pipeline/" target="_blank" rel="noopener noreferrer">SecretHub Pipeline Post</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/kubernetes">kubernetes</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/secrets">secrets</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/security">security</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/secrethub">secrethub</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/management">management</a></li></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/engineer/K8s/2020-08-17-Secrethub-Secret-Management.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-09-22T07:31:42.000Z" itemprop="dateModified">Sep 22, 2025</time></b> by <b>Ron Amosa</b></span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/engineer/K8s/2019-07-09-Ambassador-Disable-TLS1"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Ambassador API Gateway TLS Security - Disable TLS 1.0 and 1.1 for Better Security</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/engineer/LAB"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Home Lab Infrastructure Hub: Complete Setup &amp; Automation Guide</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#objective" class="table-of-contents__link toc-highlight">Objective</a></li><li><a href="#pre-requisites" class="table-of-contents__link toc-highlight">Pre-requisites</a><ul><li><a href="#storage-account--key" class="table-of-contents__link toc-highlight">Storage Account &amp; Key</a></li><li><a href="#service-principal" class="table-of-contents__link toc-highlight">Service Principal</a></li><li><a href="#ssh-public-keys" class="table-of-contents__link toc-highlight">SSH Public Keys</a></li></ul></li><li><a href="#secrethub-setup" class="table-of-contents__link toc-highlight">SecretHub Setup</a><ul><li><a href="#directory-structure" class="table-of-contents__link toc-highlight">Directory Structure</a></li><li><a href="#create-directories" class="table-of-contents__link toc-highlight">Create Directories</a></li><li><a href="#create-secrethub-secrets" class="table-of-contents__link toc-highlight">Create SecretHub Secrets</a></li></ul></li><li><a href="#terraform-aks-setup" class="table-of-contents__link toc-highlight">Terraform AKS Setup</a><ul><li><a href="#install-terraform-provider" class="table-of-contents__link toc-highlight">Install Terraform Provider</a></li><li><a href="#secrethub-terraform-resources" class="table-of-contents__link toc-highlight">SecretHub Terraform Resources</a></li></ul></li><li><a href="#run-deployment" class="table-of-contents__link toc-highlight">Run Deployment</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/ron-amosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/ronamosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@uncommonengineer" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Discover</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/docs">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/about">About</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Last updated on Mon Sep 22 2025</div></div></div></footer></div>
</body>
</html>