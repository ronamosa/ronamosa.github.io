<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-engineer/K8s/2020-04-08-Istio-MTLS-with-External-Endpoint" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Istio mTLS with External Endpoints - Egress Gateway Configuration Guide | The Uncommon Engineer</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ronamosa.io/docs/engineer/K8s/2020-04-08-Istio-MTLS-with-External-Endpoint"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Istio mTLS with External Endpoints - Egress Gateway Configuration Guide | The Uncommon Engineer"><meta data-rh="true" name="description" content="Configure Istio service mesh to handle mutual TLS (mTLS) with external sites using egress gateways. Learn secure external service communication and traffic management."><meta data-rh="true" property="og:description" content="Configure Istio service mesh to handle mutual TLS (mTLS) with external sites using egress gateways. Learn secure external service communication and traffic management."><meta data-rh="true" name="keywords" content="istio mtls,egress gateway,external endpoints,istio external services,service mesh security,istio traffic management,kubernetes security"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ronamosa.io/docs/engineer/K8s/2020-04-08-Istio-MTLS-with-External-Endpoint"><link data-rh="true" rel="alternate" href="https://ronamosa.io/docs/engineer/K8s/2020-04-08-Istio-MTLS-with-External-Endpoint" hreflang="en"><link data-rh="true" rel="alternate" href="https://ronamosa.io/docs/engineer/K8s/2020-04-08-Istio-MTLS-with-External-Endpoint" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9UFF3RBJQ9-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"💻 Engineer","item":"https://ronamosa.io/docs/category/-engineer"},{"@type":"ListItem","position":2,"name":"Istio mTLS with External Endpoints - Egress Gateway Configuration Guide","item":"https://ronamosa.io/docs/engineer/K8s/2020-04-08-Istio-MTLS-with-External-Endpoint"}]}</script><link rel="search" type="application/opensearchdescription+xml" title="The Uncommon Engineer" href="/opensearch.xml">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DMRNTVGLRC"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DMRNTVGLRC",{anonymize_ip:!0})</script>

<script src="/js/console-clue.js"></script>
<script src="/js/metricool.js"></script><link rel="stylesheet" href="/assets/css/styles.dd12b5e8.css">
<script src="/assets/js/runtime~main.cb34a51e.js" defer="defer"></script>
<script src="/assets/js/main.fb1c5b66.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="ronamosa.io" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="ronamosa.io" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Uncommon Engineer</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog/">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/projects/">Projects</a><a class="navbar__item navbar__link" href="/changelog/">Changelog</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">▶ Start Here</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/books/reading-list">📚 Books &amp; Papers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/study/SCS-C01/">📗 Study</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/️-hacker">🏴‍☠️ Hacker</a><button aria-label="Expand sidebar category &#x27;🏴‍☠️ Hacker&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/-engineer">💻 Engineer</a><button aria-label="Collapse sidebar category &#x27;💻 Engineer&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/ai">AI</a><button aria-label="Expand sidebar category &#x27;AI&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/️-projects">🛠️ Projects</a><button aria-label="Expand sidebar category &#x27;🛠️ Projects&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/AWS/AWS-EKS-Workshop">AWS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/Azure/2019-07-20-Sonarqube-AzureDisk-PersistentVolume">Azure</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/GCP/2019-11-27-GCP-Install-Ambassador-Helm2">GCP</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/engineer/K8s/2019-11-11-Helm-3-Kubernetes-Package-Manager">K8s</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/K8s/2019-11-11-Helm-3-Kubernetes-Package-Manager">Helm 3 Complete Guide - Kubernetes Package Manager and Application Deployment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/K8s/2020-03-06-Istio-SDS-Cert-Manager">Istio mTLS with SDS and Cert-Manager - Complete Service Mesh Security Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/engineer/K8s/2020-04-08-Istio-MTLS-with-External-Endpoint">Istio mTLS with External Endpoints - Egress Gateway Configuration Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/K8s/2019-07-09-Ambassador-Disable-TLS1">Ambassador API Gateway TLS Security - Disable TLS 1.0 and 1.1 for Better Security</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/K8s/2020-08-17-Secrethub-Secret-Management">SecretHub Kubernetes Secrets Management - Secure Secret Storage and Distribution</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/LAB">LAB</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/Misc/algos-system-design">Misc</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/archive/docker-wordpress/docker-wordpress-1">🗃 Archive</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/-engineer"><span>💻 Engineer</span></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">K8s</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Istio mTLS with External Endpoints - Egress Gateway Configuration Guide</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Istio mTLS with External Endpoints - Egress Gateway Configuration Guide</h1></header><div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Published Date: 08-APR-2020</p></div></div>
<p>In this post I endeavour to go through setting up <a href="https://istio.io/docs/tasks/traffic-management/egress/egress-gateway-tls-origination/" target="_blank" rel="noopener noreferrer">Istio Egress Gateway with TLS Origination</a> using a real-world external/remote server setup to do MTLS between an outside client and itself.</p>
<blockquote>
<p><em>Why do I care?</em></p>
</blockquote>
<p>I came across the need for this setup on a previous client engagement where Security was super important. The client wanted <em>all</em> points in the system to be secured as much as possible, which included mTLS between microservices in the AKS cluster; network segregation between all components, and the final piece was to setup MTLS between the azure cloud application and a 3rd party vendor with a public endpoint.</p>
<p>So, here we are!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="architecture-diagram">Architecture Diagram<a href="#architecture-diagram" class="hash-link" aria-label="Direct link to Architecture Diagram" title="Direct link to Architecture Diagram">​</a></h2>
<p><img decoding="async" loading="lazy" alt="architecture" src="/assets/images/istiomtls-arch-notworking-20310f07fb5f6f6f03d2ad97dd743677.png" width="1585" height="862" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="key-components">Key Components<a href="#key-components" class="hash-link" aria-label="Direct link to Key Components" title="Direct link to Key Components">​</a></h3>
<ul>
<li>AKS cluster</li>
<li>Istio Service Mesh</li>
<li>External NGINX Webserver with MTLS enabled.</li>
<li>FQDN <code>mtls.cloudbuild.site</code> used for as my example domain for the remote server.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pre-requisites">Pre-requisites<a href="#pre-requisites" class="hash-link" aria-label="Direct link to Pre-requisites" title="Direct link to Pre-requisites">​</a></h2>
<ul>
<li>az-cli installed</li>
<li>kubectl instlaled</li>
<li>istioctl installed</li>
<li>azure dns zone (or something you can resolve dns to for your certs)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="mtls-server">MTLS Server<a href="#mtls-server" class="hash-link" aria-label="Direct link to MTLS Server" title="Direct link to MTLS Server">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="certificates-server-certs-client-certs-and-intermediate-certs">Certificates: server certs, client certs and intermediate certs<a href="#certificates-server-certs-client-certs-and-intermediate-certs" class="hash-link" aria-label="Direct link to Certificates: server certs, client certs and intermediate certs" title="Direct link to Certificates: server certs, client certs and intermediate certs">​</a></h3>
<p>As per Istio&#x27;s documentation, we will use the following repo by <a href="https://github.com/nicholasjackson/" target="_blank" rel="noopener noreferrer">Nicholas Jackson</a> called <a href="https://github.com/nicholasjackson/mtls-go-example" target="_blank" rel="noopener noreferrer">mtls-go-example</a> to create the cert combination we need.</p>
<p>To create your certs, as per the website run:</p>
<p><code>./generate.sh &lt;domain_name /&gt; &lt;some-password /&gt;</code></p>
<p>for the example they use <code>localhost</code> to run it, and connect to it locally via <code>https://localhost</code>.</p>
<p>When you run the <code>./generate.sh</code> script, it will create 4 folders of certs for you that will make up a complete &quot;certificate chain&quot; aka <a href="https://www.thesslstore.com/knowledgebase/ssl-support/explaining-the-chain-of-trust/" target="_blank" rel="noopener noreferrer">&quot;chain of trust&quot;</a>.</p>
<p>and looks like this:</p>
<p><img decoding="async" loading="lazy" alt="go certs" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAAB2CAIAAAC8rBORAAAACXBIWXMAAA7EAAAOxAGVKw4bAAATeElEQVR4nO2de1RTV77H9zkhCZw8IYRHeETeAlKpAYSAyLMq+KpO1d723hnt7XRmuqZrdWo7fdq5dzoz1bp677ozq9OOTtedtta3ogXqLaVSRLCVVxXE8BDBSEIICclJQl4k94/jpDEJASQ8juzP8o+c39ln7534XYd99tnf/UMSEhIBBEIq0IXuAAQyY/ykseXOx0KafsDMWKjeQCDTAd5rIeQDqhZCPqBqIeQDqhZCPvzmqN68MKUdII7Dy3LeHDUEWYLMiWpfTZe8+miPc+RIT+TzDelz0ZYLNCrFbJmYh4YgC8icqDYvbNQl8lSC9KkEqXNkLnT81XvPn7n0w4fnG3xbLWSxMbVqg1iYCjd4PMVjM0a1eo+nrqvYr32X4vFUaDBL/IhQztABoJt+R6cDjTpXAx7IomLqp7HDLz+1Z0O2e/zXj6/9nxeemOwqjcmvQR4MALADxOXf7365Tq7Sr8tN+o9tvGimZ9EHcxifvPavynPvys/88TdPFAEAIoI5R9/aLTv9x46PX99VJCKKvfhEYcfHr6vO7x88/ntmAB0A8P6vthkuvI9XHwQAZCRFX/7Lb9RfHBg4/p9Fj8IX1w8PU9+cfvruJ+feeQ5F0cNVjY7gr7etLVudum3fIS8XRjP1lRuuuAQRfhKqv/RG+DlEl5S97rGaxvFBnYdXcUff2o0bTPkv/LfBZEYQBABw5I2fDQyrVj37buZy4aev/1uzZLD37kheWlxtW/cfPr3AZWK6cRMA4JUPKw5VNdqBHQBw8JePf9veU/bbDwJZmEZvnMavASEHU6sWN5i2vPnRuXeeQxHkb5WXAQAvbC9Yn5m8bd+hcZPFy4V5YSqXCMKJ9kv7F8QvAOUtBzQMwXhrC/0bjna5FEsRhuWuiF22a59i7N4QIjMpOnN59E9+d1ip0Z9vvN7ac2d9ZvJf7o4AABRqXDGmc5S02mwmi5X4rNUb4yL4dKrfbblrTyCkZloDQYdwEQTQadR1Gcnb9h02mr1JFgBQLpS7RFDBowgnGgCAMPhEJH8F/w/AVbUx4TzduMkhRABAOI+DIEjPZ2/fqwdBGq73TdntX7x/7J1nNnb+75uVTR2vfFgxovHxMBqyUEz38YUQbsXvf24wmbe/PbVkgaeZBAfWK3+mJG8hFOyObFTLDKCHBrKG1TgRuaNQT9hs0Tvfwg0mLy2azFbnB7KhUc2eA0cEPM5nb/x0/3Nb9hw4MmWfIaRgBu/GcIOp+KU/b3r9o+lINo2n5dCsk521W/TA7HleAgDQ1itt65V+9NKTaTGCSD43RRjW3ne3o1/21xd3pQjDBDxOdsoyjxf2Do2UrU6JCgnMTIr2o6DiFbE8NsNgMvcNjQSysGl8RQg5mJM3ug1ynhfJAgCoa15F+MsnO2u323+y77Bu3FT57i/aD7/67MZcu92+fd9hAED1/l9d+/i1/3p+O9WP4n7hweO1AXRa+6FXP/7t06GB7DeeWtfz2b7eI2/HCfhv/r1y9t8LskhAAta96Hzsq/W1eWFK96A4fdm24jTis95KsdrQH25rXjn0w+ybgywp5kq1EMjcAdd8QcgHVC2EfEDVQsgHVC2EfCAu+yEEB/OUSg9vB0SiVS0trfPVKwjEG/BeCyEfULUQ8gFVCyEfULUQ8jHflhWBMBYAu+NwaKB/njsAeQiYrWpZLNYzz+z54IO/ms3mKQtnri3JKihxjtxsb649d2qWffA5hHvCbrdPWRKyIMxWtTiOSyTdr7zy8oED700p3IhlsS6R5ekZy9MzXILVxz7tl3ROVgmCIGvW5AUHB585c/bB+uwdFEX37Nl9+vQZtVo9F/VDZo8PxrVffvlla2vbyy/vpVKps68NALA8fdVkpyIiIrZu3RoTE+OThiaDQvGwDBKyePDNuLa6uhpBwN69ew8ePGixTL1m3Dt0/4DJTrHZrM7ODj8/6vLlSV5qYDAYxcVFgYGBVCq1tbWttbU1ODhYLM7h8XhaLd7cfHVgYJAomZCQ8Oij6QwGY3hY0djYODY2RsR37HgCACCV3q2qqprl14H4HJ89jVVVVSMIsnfvS3/607u+qtOdrq6bAIDk5GTvxQICAsLDw48ePWa1WgEA/v7+GzeWd3R0XLxYJxAISktLz549OzqqioyMyM9fU1f3rUKhSEtLKy8vO378hM1mAwCcOnUajhAWLb6c+TKbLTQa3YcVzhKtVmswGAwGQ3x8nMFgaG5uwXFcIpEMDAwSuk9OTunu7u7r68NxvKmpCUXR6Oh7VjbbP1nQbwDxjM9UW1paKhbnHDhwwFcV+hAmk6XRaB2HGs0Yk8kCALBYTI1GQwTtdjuO4ywWc2G6CJkJvlFtcXFxbq54//4D4+PjPqnQt+h0OIfDdhxyOFydDgcA4LiOw+EQQQRBWCwWjuvsdrvNZoMPZIsZH6i2uLgoLy930UoWANDb24dhWEaGiMViJSUlCYXRxPi4q6srMTExNjaWzWbl5OTYbLbBwUHiphsfH8dgMIKDgxe67xAPzPZpjMlkikQZBw68Nx3JKuVD7lO27ty6Oelk7YNhNBqrqqpzcrLT0tK0Wvyrr2pGR0cBAFKptL7+UkaGiJhDqKqqJp7eGhubxGJxamrq8PBwZSWcQ1h0zPf6WoFwatUODdyafUOQh5j5Xofgc0Vu2rSRx7tvI/I7d6S1tbW+bQWyqCD9hq81NV+j6H2j84kJuFf4Qw7pVWs0wi0+lxxwfS2EfEDVQsgHVC2EfEDVQsgHVC2EfEDVQsgHVC2EfECP7nzDYGB6/aS7+0Omw8Pp0Q0LCy0pKTlx4qSXXlEolPl/ixYXF5eZmXHs2HEqlbpjxxMXL9YNDQ15LAl9wl4gk0cXQZCVK1empCTT6XS1Wn35cuPIyIjHhrRa/MaNLi/9ycgQBQYG1tR87b3Dc8A9FVoslhs3uhw2NRegT9g7ZPLoUqlUPj/44sW606fP6PWG4uLiyWowGAytrd5WqLksXVgQ2traDIZJhwpwWboXyOTRNZvNjrtjV9eNsrIyFEU9WruCg4O3b9/20Ud/AwCUlW0ICgry9/c3mUxtbW0dHffu4rGxsc8993MAwLlz5+VyeVJSUnr6yoCAgKEhWX19vdFodDH69vT0lJaWMJlMKpWqVCoHBgYTExPYbLZaPVZb+/XYmAYAgGFYbm5uRITAaDQ2N7f09vYCACgUilicEx8fPzExodP9mKlv9+6fXbjwfzKZLC4uNjc3l0ajqdXqxsZGmexedkFnnzCKollZWfHxcQiCdHf3fP/990t58EAyj66DyMgomUw2HTdiaGhoff0luVwWHh5eVFQkk8lGR1UAgFu3+okFjTabLSoqSizOqampUanUhYWFOTnZFy/WuRh9MQzj8/mffvoZiqK5ueK0tBU1NTV6vSE3VywWi6urvwQAPPZYqVaLnzhxMiSEX1JSMjIyotFoVq9eHR4eXlVVbTKZ0tNXhoeHu/RQJpNXVFRYLNaMDFFhYeHnnx8l4s4+4czMjKioyMrKKhRFy8o2jI2NSSQS3/2cJIOUHt34+PikpMRvv62fZnmDwaDXG3p7+5RKpZNo7A4X7ooVqRJJt1R612AwtLe3C4VCx7UOo6+jKp1O19XVRaFQ5PJhHMe7um7y+XwAQEgIPyQkpLGx0WAw3L49MDIyEhUVBQBISkq8evWqQqHQaDRSqdRj97RafHx8/Nq16ywWyzHQcviEEQRJSUlpbm4eGxtTqVQSSbdQ6Dkt5hLBZ/dawqO7f/+ce3QTExOys7Orqqq1Wu3Upe9nfHycTvd3j2MYFhERkZLy4zYLfn7efhmj0eQoYDIZCZ1hGIYgyNNPP+UoJpPJqFQqjUbDcW8pfOPj49LT01ksFjG4cp/cICpxHscrlR7SuS0dfKPaefPoCgQCsVhcWVn1YP9tNtu9seDExH0uXL1eL5Xe/e6776ZfFTEz9c+PCABAp9PbbLZ//OMTl5G90WjkcrmTdZhOpxcVFdXU1PT33+ZwOLt27QQAuPiEzWaz2Wyura0dHLwz/R4+xJDMo5uTk93S0qpSqVAURVHUSTozQ6PRhISEBAUFcbkcDMMkEklKSnJMTAyGYRwOh81mT12FG0qlUqVSFRSsDQwMZDCw0NBQIt7V1ZWVlRkZGYFhGIa5ZiBEkHuid767u/uEJZLurKyssLBQDMN4PB6dvoh2S5l/yOTRpVKpwcHBxI5dRKSurk4i6Z5Rh+81cetWTMyyLVs2W63W+vpL/f23abQmkWgVh8MxmUwtLS0PMPwAAFy4cEEsFm/cWE6lUjUazdmzFTabrbm5ZWLClpe3hslkmEwml6Gt0WhsaLgsFosxDLNarSqVihgeuPiEr1y5kpmZWVBQyGQy9Hp9Tc3XJpO39O0PN9CjCyEf0KMLIR+kdztCj+4ShPSqhR7dJcjCv46HQGYKVC2EfEDVQsgHVC2EfEDVQsgHVC2EfEDVQsgH9Oh6BkVRPp8/PDy80B2BeODh9OjOnpCQkI0byw8f/jsAYOXKlZGREVVV1dO/3HmN7HQMw5AZQTKPbl5erlAopNFoavVYU1OTXC6fTeeniUwmm9EiTBcD8JSGYchMIZNH12639/ff/uKLypMnT42OKgsK1vqkuSlRKBTd3TNYD+myLmJKwzBkppDJowsAIBan+vv7IwjiSHDnkccffzwoKNBisfT33758+bLNZhMKhatXZzEYjImJCblc3tR0BcdxAEBGhigxMTEgIGB8fPz27YGrV6+6fIVHHkkTCoVffFEJAODxeETGdJPJVFv7zdDQkHtD4H4DsNVqdRiGAwICxOKcyMhIk8l88+bN9vZ2AACLxSLcvzQaTavVXrrUIJPJZvkbPtyQz6NbWloSGxur1+vPnz/vpVh9fb1er2ez2Rs2rFcohiWSbg6HbbVaT5067efnJxKtKi8vP3ny5MTEBI8XPDg42NbWzmKx8vJy8/PzJ1vo6O/vv2nTxs7OG998842fH5Wwibs3BO43ADsnLSstLTGZzBUV5xgMRmFhodVq6ejopNPpfD6fsOampqaWlBQfOfI5TIbqBfJ5dGtqvj5y5HOp9G55ebmXzThGR0eNRqNCoZBKpUFBQUTQYrHgOK5Wqy9erKPTadHRUUR8fNyo1+vlcnl9fX18fNxk/pa4uFiDwXD16lWtFlepVMRQ1WNDzgZgB0FBQeHh4fX19RqNZmho6Icf2lNSUhxncRzHcbylpQXDMC6X+8C/z1KAfB5dAIBOp6uvr9+zZ7dAIPDo1abT6bm5uZGRERQKxW639/T0uhSYmJjAcdzdH6ZWjwEAJvONsdlsF2fOlA05w2QyzWaz48FubEzDZLqm7bVYLFardYnbwqaEZB5dNzzvvyISrWIyGcePnzCZTEVFhe4FEARhMBg6nd4lTsiI+IvvfpVer4+Kum8jAo8NuRiAHeh0OhqNhmEYsbsCl8tx3orGARwbTAmZPLo0Gi0hIYHL5XK53DVr8oxG4/CwwmNJBEHtdjuFQkFR1HlnIRaLFRYWymKxsrKyUBQdHBwk4qGhIYGBgVwuNycnh9jLw2w2UygUp7/4AADQ19fHYGBZWZlsNpvD4TAYDI8NuRiAHZerVCq5XJ6fv4bD4QgEgpUr02/cuOHj32hpQCaPLp1OX7EiNSgoyGKxjIyMVFZWTTZf0dbWVlBQsHPnDgqFYjQar127RsRRFM3Pz2cymSqVqrr6S8flDAajvLzMz8/v7t2hhoYGAIBKperp6X3ssdJjx447qtXrDVVV1dnZq1NTU202W2Njk8eGXAzAev2Pd/SvvqrJzRVv3brFbDZ3dnY6Nh2DzIgl5NF1nsByZt26dUqlsqWlZS4ahcwF0KMLIR/zfa/1Of7+/u4e3aW8w8VSAHp0IeQDrq+FkA+oWgj5gKqFkA+oWgj5gKqFkA+oWgj5gKqFkI+l4tGFntuHiaXi0XX23K5fv16hGG5tbZtpJZMl5YPMM2Ty6DqgUqmbN28eHzcQuelmSl9fH+EYmxGbN2/q6+vr7IRrCxceMnl0HRQWFgQEeEgbNk16enoewJK+GFLvQghI5tEFACQnL6dSqdevd0RECLwUczHTOv9ld16a6J4+F0yeejcvLy8vL89msx06dHiW3xEyG0jm0cUwTCQSnT1bERfnbZ2uu5nWxZVA4DF9Lpg89e7ly43QfbAYIJlHNzt79fXrHc7uAI94NNO64yV9rsfUu/Z7xlv4QLbAkMmjy+Vyw8MFdXXfTlnS3UzrEY/pc4kM5Q4mS70LWUDI5NGNiVnGZDKeffbfHZGtW7dUVJxzL+lupvXIdNLnOqXenfDovIXMPz5Q7bx5dNva2tva2onPjzySFhkZOdnMV19fn0gkysrKvHlTgiCI1Wp1eG5VKpWjmEQiKSgoUCgUw8PDVCrVbrd7uUNrNBqhUHjrVj+GBSiVo3CcsIDMdlw7U4/udOqczKM7fQgzbVhY2Pbt27Zu3SIQCByeW+di/f23GxubRKJVTz65a9Omjd4nJdra2ikUv507dxQVFQUEeJvlgMw1S8ijC3logB5dCPkgvdsR5tFdgpBetdCjuwSB79Yh5AOqFkI+/Kj+9734oVCpLhGCa503PMYhkPkH3msh5AOqFkI+oGoh5AOqFkI+5mq+NjxqmbMXV3ZnYI4agixB/h+W7uoMaUeyYQAAAABJRU5ErkJggg==" width="231" height="118" class="img_ev3q"></p>
<p>with the following directories:</p>
<ul>
<li>root cert (<code>ca.cert.pem</code>) &amp; private key</li>
<li>intermediate certs (<code>ca-chain.pem</code> and <code>intermediate.cert.pem</code>) &amp; private key</li>
<li>application (aka &quot;server&quot;) cert (<code>&lt;domain_name /&gt;.cert.pem</code>) &amp; private key -- e.g. <code>mtls.cloudbuild.site.cert.pem</code></li>
<li>client cert (<code>&lt;domain_name /&gt;.cert.pem</code>) &amp; private key -- e.g. <code>mtls.cloudbuild.site.cert.pem</code></li>
</ul>
<p>now that your certs are created and you understand what each one does,</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nginx-webserver">NGINX Webserver<a href="#nginx-webserver" class="hash-link" aria-label="Direct link to NGINX Webserver" title="Direct link to NGINX Webserver">​</a></h3>
<p>All you need is a server that runs nginx so you can throw this <code>nginx.conf</code> and the certs in there to be the MTLS endpoint that we will call from our &quot;client&quot; later on.</p>
<p>I spent way too much time getting this done via terraform and ansible that I&#x27;m going to put the ansible code here: <a href="https://gist.link" target="_blank" rel="noopener noreferrer">link to gist</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="nginxconf--certs">nginx.conf &amp; certs<a href="#nginxconf--certs" class="hash-link" aria-label="Direct link to nginx.conf &amp; certs" title="Direct link to nginx.conf &amp; certs">​</a></h4>
<p>Once you have nginx up &amp; running on your server:</p>
<ul>
<li>upload the <code>nginx.conf</code> below and save it to <code>/etc/nginx/nginx.conf</code></li>
<li>upload the following certs (I&#x27;m using my domain <code>mtls.cloudbuild.site</code> as an example):<!-- -->
<ul>
<li>server cert: <code>certs/3_application/certs/mtls.cloudbuild.site.cert.pem</code> = <code>/etc/nginx-server-certs/tls.crt</code></li>
<li>server private key: <code>certs/3_application/private/mtls.cloudbuild.site.key.pem</code> = <code>/etc/nginx-server-certs/tls.key</code></li>
<li>ca-certs: <code>certs/2_intermediate/certs/ca-chain.cert.pem</code> = <code>/etc/nginx-ca-certs/ca-chain.cert.pem</code></li>
</ul>
</li>
</ul>
<div class="language-ruby codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockTitle_OeMC">nginx.conf</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ruby codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">user www</span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">worker_processes auto</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">pid </span><span class="token regex-literal regex">/run/nginx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">pid</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">events </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">http </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># custom log format to show good debugging information.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  log_format ssl_client</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token string-literal string" style="color:rgb(173, 219, 103)">&#x27;$remote_addr - $remote_user [$time_local] &#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token string-literal string" style="color:rgb(173, 219, 103)">&#x27;&quot;$request&quot; $status $body_bytes_sent &#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token string-literal string" style="color:rgb(173, 219, 103)">&#x27;&quot;Client fingerprint&quot; $ssl_client_fingerprint &#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token string-literal string" style="color:rgb(173, 219, 103)">&#x27;&quot;Client DN&quot; $ssl_client_s_dn&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  error_log  </span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">var</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">log</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">nginx</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">log</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  server </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    listen </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"> ssl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># set our access_log to use the log_format from above.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    access_log </span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">var</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">log</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">nginx</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">listener</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">log ssl_client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># homepage for the NGINX server -- edit as needed.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    root </span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">usr</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">share</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">nginx</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">html</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    index index</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">html</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># server&#x27;s name -- mine is a fqdn</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    server_name mtls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">cloudbuild</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">site</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># setup the server cert, key and the ca-cert which will be the same one that signed the client certs.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ssl_certificate </span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">etc</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">nginx</span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">server</span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">certs</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">tls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">crt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ssl_certificate_key </span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">etc</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">nginx</span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">server</span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">certs</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">tls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ssl_client_certificate </span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">etc</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">nginx</span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">ca</span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">certs</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">ca</span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">chain</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">cert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">pem</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># enable mutual tls and set depth to be &gt;2.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ssl_verify_client on</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ssl_verify_depth </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><em>The <code>ssl_verify_client</code> is the thing that enables MTLS with incoming calls, and <code>ssl_verify_depth</code> needs to be set to &gt;2 or things behave badly.</em></p></div></div>
<ul>
<li>restart your <code>nginx.service</code> e.g. on ubuntu <code>sudo systemctl restart nginx.service</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-mtls-client-test">the MTLS client (test)<a href="#the-mtls-client-test" class="hash-link" aria-label="Direct link to the MTLS client (test)" title="Direct link to the MTLS client (test)">​</a></h3>
<p>With our MTLS server setup We&#x27;ll use curl to test if we can talk to the server using our client certificates.</p>
<p>The MTLS URL to call is <code>https://mtls.cloudbuild.site</code>.</p>
<p>curl without certificates:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">curl -v -k -I https://mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* Rebuilt URL to: https://mtls.cloudbuild.site/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">*   Trying 13.70.185.45...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TCP_NODELAY set</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* Connected to mtls.cloudbuild.site (13.70.185.45) port 443</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* ALPN, offering h2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* ALPN, offering http/1.1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* successfully set certificate verify locations:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">*   CAfile: /etc/ssl/certs/ca-certificates.crt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  CApath: /etc/ssl/certs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.3 (OUT), TLS handshake, Client hello (1):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.3 (IN), TLS handshake, Server hello (2):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (IN), TLS handshake, Certificate (11):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (IN), TLS handshake, Server key exchange (12):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (IN), TLS handshake, Request CERT (13):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (IN), TLS handshake, Server finished (14):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (OUT), TLS handshake, Certificate (11):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (OUT), TLS change cipher, Client hello (1):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (OUT), TLS handshake, Finished (20):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (IN), TLS handshake, Finished (20):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* ALPN, server accepted to use http/1.1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* Server certificate:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">*  subject: C=US; ST=Denial; L=Springfield; O=Dis; CN=mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">*  start date: Apr  4 11:36:35 2020 GMT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">*  expire date: Apr 14 11:36:35 2021 GMT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">*  issuer: C=US; ST=Denial; O=Dis; CN=mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">*  SSL certificate verify result: unable to get local issuer certificate (20), continuing anyway.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&gt; HEAD / HTTP/1.1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&gt; Host: mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&gt; User-Agent: curl/7.58.0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&gt; Accept: */*</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt; HTTP/1.1 400 Bad Request</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">HTTP/1.1 400 Bad Request</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt; Server: nginx/1.10.3 (Ubuntu)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Server: nginx/1.10.3 (Ubuntu)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt; Date: Wed, 08 Apr 2020 10:13:19 GMT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Date: Wed, 08 Apr 2020 10:13:19 GMT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt; Content-Type: text/html</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Content-Type: text/html</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt; Content-Length: 262</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Content-Length: 262</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt; Connection: close</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Connection: close</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* Closing connection 0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (OUT), TLS alert, Client hello (1):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>We get an <code>HTTP 400</code> error code, telling us to go away.</p>
<p>Now <code>curl</code> the same endpoint but this time present the server with the right client certificates:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">$ curl --cacert certs/2_intermediate/certs/ca-chain.cert.pem \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --cert certs/4_client/certs/mtls.cloudbuild.site.cert.pem \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --key certs/4_client/private/mtls.cloudbuild.site.key.pem \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    https://mtls.cloudbuild.site</span><br></span></code></pre></div></div>
<p>Note, the <code>ca-chain.pem</code> will be the same intermediate ca-cert the MTLS nginx server has configured for its setup. The server has the server cert &amp; key pair, and our client will present the client cert &amp; key pair which is signed by the same intermediate ca-cert as the server.</p>
<p>And we get a successful <code>HTTP 200 OK</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">* Rebuilt URL to: https://mtls.cloudbuild.site/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">*   Trying 13.70.185.45...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TCP_NODELAY set</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* Connected to mtls.cloudbuild.site (13.70.185.45) port 443</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* ALPN, offering h2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* ALPN, offering http/1.1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* successfully set certificate verify locations:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">*   CAfile: certs/2_intermediate/certs/ca-chain.cert.pem</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  CApath: /etc/ssl/certs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.3 (OUT), TLS handshake, Client hello (1):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.3 (IN), TLS handshake, Server hello (2):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (IN), TLS handshake, Certificate (11):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (IN), TLS handshake, Server key exchange (12):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (IN), TLS handshake, Request CERT (13):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (IN), TLS handshake, Server finished (14):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (OUT), TLS handshake, Certificate (11):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (OUT), TLS handshake, CERT verify (15):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (OUT), TLS change cipher, Client hello (1):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (OUT), TLS handshake, Finished (20):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* TLSv1.2 (IN), TLS handshake, Finished (20):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* ALPN, server accepted to use http/1.1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* Server certificate:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">*  subject: C=US; ST=Denial; L=Springfield; O=Dis; CN=mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">*  start date: Apr  4 11:36:35 2020 GMT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">*  expire date: Apr 14 11:36:35 2021 GMT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">*  common name: mtls.cloudbuild.site (matched)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">*  issuer: C=US; ST=Denial; O=Dis; CN=mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">*  SSL certificate verify ok.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&gt; HEAD / HTTP/1.1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&gt; Host: mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&gt; User-Agent: curl/7.58.0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&gt; Accept: */*</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt; HTTP/1.1 200 OK</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">HTTP/1.1 200 OK</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt; Server: nginx/1.10.3 (Ubuntu)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Server: nginx/1.10.3 (Ubuntu)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt; Date: Wed, 08 Apr 2020 10:25:29 GMT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Date: Wed, 08 Apr 2020 10:25:29 GMT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt; Content-Type: text/html</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Content-Type: text/html</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt; Content-Length: 557</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Content-Length: 557</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt; Last-Modified: Wed, 08 Apr 2020 00:53:53 GMT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Last-Modified: Wed, 08 Apr 2020 00:53:53 GMT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt; Connection: keep-alive</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Connection: keep-alive</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt; ETag: &quot;5e8d20a1-22d&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ETag: &quot;5e8d20a1-22d&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt; Accept-Ranges: bytes</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Accept-Ranges: bytes</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">* Connection #0 to host mtls.cloudbuild.site left intact</span><br></span></code></pre></div></div>
<p>And just for posterity, the logs from <code>/var/log/nginx/listener.log</code> with the new log_format we configured above looks like this:</p>
<p>curl with no certs</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">115.189.88.95 - - [08/Apr/2020:10:13:11 +0000] &quot;HEAD / HTTP/1.1&quot; 400 0 &quot;Client fingerprint&quot; - &quot;Client DN&quot; -</span><br></span></code></pre></div></div>
<p>curl with certs</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">115.189.88.95 - - [08/Apr/2020:10:25:29 +0000] &quot;HEAD / HTTP/1.1&quot; 200 0 &quot;Client fingerprint&quot; 7dccb99b6584e9b6cf624290952c7bd4b905412b &quot;Client DN&quot; /C=US/ST=Denial/L=Springfield/O=Dis/CN=mtls.cloudbuild.site</span><br></span></code></pre></div></div>
<p>Ok, now the real work begins... setting up an Istio Egress Gateway to do this MTLS certificate exchange with the MTLS server on the K8s cluster&#x27;s behalf.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="istio-egress-gateway-setup">Istio Egress Gateway Setup<a href="#istio-egress-gateway-setup" class="hash-link" aria-label="Direct link to Istio Egress Gateway Setup" title="Direct link to Istio Egress Gateway Setup">​</a></h2>
<p>You should have <code>istioctl</code> installed already (if not, go <a href="https://istio.io/docs/setup/getting-started/" target="_blank" rel="noopener noreferrer">here</a>).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="install-istio-with-egressgateway">install istio with egressgateway<a href="#install-istio-with-egressgateway" class="hash-link" aria-label="Direct link to install istio with egressgateway" title="Direct link to install istio with egressgateway">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">istioctl manifest apply --set values.global.istioNamespace=istio-system \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --set values.gateways.istio-ingressgateway.enabled=false \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --set values.gateways.istio-egressgateway.enabled=true \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --set values.global.proxy.accessLogFile=&quot;/dev/stdout&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --set values.sidecarInjectorWebhook.rewriteAppHTTPProbe=true</span><br></span></code></pre></div></div>
<ul>
<li>*enables <code>istio-egressgateway</code></li>
<li>*disables <code>istio-ingressgateway</code></li>
<li>*enables access logs for istio-proxy containers</li>
<li>*enables <code>rewriteAppHTTPProbe</code> which helps with healthcheck 503 errors.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-cert-k8s-secrets">create the cert k8s secrets<a href="#create-the-cert-k8s-secrets" class="hash-link" aria-label="Direct link to create the cert k8s secrets" title="Direct link to create the cert k8s secrets">​</a></h3>
<p>create the following secrets in the <code>istio-system</code> namespace so <code>egressgateway</code> can find them</p>
<ul>
<li>*1 x tls secret with the cert &amp; key pair</li>
<li>*1 x generic secret with the <code>ca-chain.cert.pem</code> file contents.</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl -n istio-system create secret tls nginx-client-certs --key certs/4_client/private/mtls.cloudbuild.site.key.pem --cert certs/4_client/certs/mtls.cloudbuild.site.cert.pem</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl -n istio-system create secret generic nginx-ca-certs --from-file=certs/2_intermediate/certs/ca-chain.cert.pem</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="patch-the-egressgateway">patch the egressgateway<a href="#patch-the-egressgateway" class="hash-link" aria-label="Direct link to patch the egressgateway" title="Direct link to patch the egressgateway">​</a></h3>
<p>There&#x27;s a better way to do this by setting these mounts during the <code>istioctl</code> install, but this is the manual post-install way:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl -n istio-system patch --type=json deploy istio-egressgateway -p &quot;$(cat patch-egress.json)&quot;</span><br></span></code></pre></div></div>
<p>where <code>patch-egress.json</code> is</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;op&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;add&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;path&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/spec/template/spec/containers/0/volumeMounts/0&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;mountPath&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/etc/istio/nginx-client-certs&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;name&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;nginx-client-certs&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;readOnly&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;op&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;add&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;path&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/spec/template/spec/volumes/0&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;name&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;nginx-client-certs&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;secret&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;secretName&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;nginx-client-certs&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;optional&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;op&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;add&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;path&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/spec/template/spec/containers/0/volumeMounts/1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;mountPath&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/etc/istio/nginx-ca-certs&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;name&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;nginx-ca-certs&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;readOnly&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;op&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;add&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;path&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/spec/template/spec/volumes/1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;name&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;nginx-ca-certs&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;secret&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;secretName&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;nginx-ca-certs&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;optional&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre></div></div>
<p>kill the egressgateway pod (<code>$ kubectl -n istio-system delete pods -lapp=istio-egressgateway</code>) so it can pick up the secrets (and the certs inside them).</p>
<p>Check you can now see the certs in the <code>egressgateway</code> pod in the <code>istio-system</code> namespace:</p>
<p>client certs</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">$ kubectl -n istio-system exec -ti istio-egressgateway-8544965cd5-2hdnc -- ls -al /etc/istio/nginx-client-certs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">total 8</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxrwxrwt 3 root root  120 Apr  8 13:56 .</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x 1 root root 4096 Apr  8 13:56 ..</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x 2 root root   80 Apr  8 13:56 ..2020_04_08_13_56_42.418467475</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">lrwxrwxrwx 1 root root   31 Apr  8 13:56 ..data -&gt; ..2020_04_08_13_56_42.418467475</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">lrwxrwxrwx 1 root root   14 Apr  8 13:56 tls.crt -&gt; ..data/tls.crt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">lrwxrwxrwx 1 root root   14 Apr  8 13:56 tls.key -&gt; ..data/tls.key</span><br></span></code></pre></div></div>
<p>ca-certs</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">$ kubectl -n istio-system exec -ti istio-egressgateway-8544965cd5-2hdnc -- ls -al /etc/istio/nginx-ca-certs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">total 8</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxrwxrwt 3 root root  100 Apr  8 13:56 .</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x 1 root root 4096 Apr  8 13:56 ..</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x 2 root root   60 Apr  8 13:56 ..2020_04_08_13_56_42.910605930</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">lrwxrwxrwx 1 root root   31 Apr  8 13:56 ..data -&gt; ..2020_04_08_13_56_42.910605930</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">lrwxrwxrwx 1 root root   24 Apr  8 13:56 ca-chain.cert.pem -&gt; ..data/ca-chain.cert.pem</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="warning-istio-documented-configs-not-working">WARNING: Istio Documented Configs (NOT WORKING)<a href="#warning-istio-documented-configs-not-working" class="hash-link" aria-label="Direct link to WARNING: Istio Documented Configs (NOT WORKING)" title="Direct link to WARNING: Istio Documented Configs (NOT WORKING)">​</a></h2>
<p>I followed the Istio documentation closely, and for the life of me could not get the configurations to work, or find any resolution to the error messages via the github issues section, or on their <a href="https://discuss.istio.io/" target="_blank" rel="noopener noreferrer">discuss forums</a> and slack channel.</p>
<p>I logged an issues ticket (<a href="https://github.com/istio/istio.io/issues/7063" target="_blank" rel="noopener noreferrer">https://github.com/istio/istio.io/issues/7063</a>) with the istio.io repo as I don&#x27;t think it&#x27;s an issue with Istio itself, just the documentation.</p>
<p>So the <em><strong>&quot;not working&quot;</strong></em> setup is as follows:</p>
<p>With everything setup as above, and following the <a href="https://istio.io/docs/tasks/traffic-management/egress/egress-gateway-tls-origination/" target="_blank" rel="noopener noreferrer">Egress Gateways with TLS Origination (v1.5.0)</a> I deployed the following configurations to a namespace called <code>mesh-internal</code></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Gateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> egressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">servers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> https</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">protocol</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> HTTPS</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">tls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">mode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> MUTUAL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">serverCertificate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /etc/certs/cert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">chain.pem</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">privateKey</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /etc/certs/key.pem</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">caCertificates</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /etc/certs/root</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">cert.pem</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DestinationRule</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> egressgateway</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">for</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egressgateway.istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">system.svc.cluster.local</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">subsets</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">trafficPolicy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">loadBalancer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">simple</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ROUND_ROBIN</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">portLevelSettings</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">tls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">mode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ISTIO_MUTUAL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">sni</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> VirtualService</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> direct</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">nginx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">through</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egress</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">gateways</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> mesh</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">http</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">gateways</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> mesh</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">route</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">destination</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egressgateway.istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">system.svc.cluster.local</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">subset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">weight</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">gateways</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">route</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">destination</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">weight</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DestinationRule</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> originate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">mtls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">for</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">trafficPolicy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">loadBalancer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">simple</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ROUND_ROBIN</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">portLevelSettings</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">tls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">mode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> MUTUAL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">clientCertificate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /etc/istio/nginx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">certs/tls.crt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">privateKey</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /etc/istio/nginx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">certs/tls.key</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">caCertificates</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /etc/istio/nginx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">ca</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">certs/ca</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">chain.cert.pem</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">sni</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mtls.cloudbuild.site</span><br></span></code></pre></div></div>
<p>this creates 4 x objects</p>
<ul>
<li>gateway.networking.istio.io/istio-egressgateway created</li>
<li>destinationrule.networking.istio.io/egressgateway-for-nginx created</li>
<li>virtualservice.networking.istio.io/direct-nginx-through-egress-gateway created</li>
<li>destinationrule.networking.istio.io/originate-mtls-for-nginx created</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="errors-nginx-certs--root-certpem">Errors: nginx certs &amp; root-cert.pem<a href="#errors-nginx-certs--root-certpem" class="hash-link" aria-label="Direct link to Errors: nginx certs &amp; root-cert.pem" title="Direct link to Errors: nginx certs &amp; root-cert.pem">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="invalid-path-nginx-certs">invalid path nginx certs<a href="#invalid-path-nginx-certs" class="hash-link" aria-label="Direct link to invalid path nginx certs" title="Direct link to invalid path nginx certs">​</a></h3>
<p>checking the istio-proxy container for a <code>sleep</code> pod inside my <code>mesh-internal</code> namespace:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">2020-04-12T02:39:07.916502Z	info	Envoy proxy is ready</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">[Envoy (Epoch 0)] [2020-04-12 02:40:53.418][16][warning][config] [external/envoy/source/common/config/grpc_subscription_impl.cc:87] gRPC config for type.googleapis.com/envoy.api.v2.Cluster rejected: Error adding/updating cluster(s) outbound|443||mtls.cloudbuild.site: Invalid path: /etc/istio/nginx-ca-certs/ca-chain.cert.pem</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="invalid-path-etccertsroot-certpem">invalid path /etc/certs/root-cert.pem<a href="#invalid-path-etccertsroot-certpem" class="hash-link" aria-label="Direct link to invalid path /etc/certs/root-cert.pem" title="Direct link to invalid path /etc/certs/root-cert.pem">​</a></h3>
<p>checking the <code>istio-egressgateway</code> pod I can see the following errors as well:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">[Envoy (Epoch 0)] [2020-04-12 02:54:07.787][15][warning][config] [external/envoy/source/common/config/grpc_subscription_impl.cc:87] gRPC config for type.googleapis.com/envoy.api.v2.Listener rejected: Error adding/updating listener(s) 0.0.0.0_443: Invalid path: /etc/certs/root-cert.pem</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="http11-503-service-unavailable-obviously">HTTP/1.1 503 Service Unavailable (obviously)<a href="#http11-503-service-unavailable-obviously" class="hash-link" aria-label="Direct link to HTTP/1.1 503 Service Unavailable (obviously)" title="Direct link to HTTP/1.1 503 Service Unavailable (obviously)">​</a></h3>
<p>Without the certs, checking with curl calling my mtls server I get:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">$ kubectl -n mesh-internal exec sleep-74997ffb46-flkcg -c sleep -- curl -s -I http://mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">HTTP/1.1 503 Service Unavailable</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">content-length: 91</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">content-type: text/plain</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">date: Sat, 11 Apr 2020 13:24:33 GMT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">server: envoy</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="unofficial-working-configuration">UNOFFICIAL: WORKING CONFIGURATION<a href="#unofficial-working-configuration" class="hash-link" aria-label="Direct link to UNOFFICIAL: WORKING CONFIGURATION" title="Direct link to UNOFFICIAL: WORKING CONFIGURATION">​</a></h2>
<p>After a lot of reading through istio githubs issues and discuss.istio.io forum, I pieced together the following changes that eventually lead to a successful TLS client-verified session with my external MTLS server.</p>
<p>Disclaimer: I don&#x27;t think this is how this setup is supposed to work (being able to only call the mtls server from a deployment with the annotation is a bit meh right?), this is just how I got things to work so that a bare <code>curl</code> to an http endpoint gets upgraded to <code>tls/443</code> and does the clint-certificate verification automatically.</p>
<p>Our architectural diagram ends up looking more like this:</p>
<p><img decoding="async" loading="lazy" alt="architecture" src="/assets/images/istiomtls-arch-working-42d8d9b65b80bf568cbde097ed198f53.png" width="1585" height="882" class="img_ev3q"></p>
<p>So, first the fixes for the cert errors-</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="etcroot-certpem-fix">/etc/root-cert.pem fix<a href="#etcroot-certpem-fix" class="hash-link" aria-label="Direct link to /etc/root-cert.pem fix" title="Direct link to /etc/root-cert.pem fix">​</a></h3>
<p>I changed port protocal from <code>HTTPS</code></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Gateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> egressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">servers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> https</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">protocol</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> HTTPS</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">tls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">mode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> MUTUAL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">serverCertificate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /etc/certs/cert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">chain.pem</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">privateKey</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /etc/certs/key.pem</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">caCertificates</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /etc/certs/root</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">cert.pem</span><br></span></code></pre></div></div>
<p>to <code>TLS</code></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Gateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> egressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">servers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> https</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">protocol</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> TLS</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">tls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">mode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> MUTUAL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">serverCertificate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /etc/certs/cert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">chain.pem</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">privateKey</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /etc/certs/key.pem</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">caCertificates</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /etc/certs/root</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">cert.pem</span><br></span></code></pre></div></div>
<p>And the error goes away.</p>
<p>I&#x27;m assuming its because there&#x27;s a <code>tls</code> section there and cert lookups get treated differently?</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="invalid-path-etcistionginx-ca-certsca-chaincertpem-fix">Invalid path: /etc/istio/nginx-ca-certs/ca-chain.cert.pem fix<a href="#invalid-path-etcistionginx-ca-certsca-chaincertpem-fix" class="hash-link" aria-label="Direct link to Invalid path: /etc/istio/nginx-ca-certs/ca-chain.cert.pem fix" title="Direct link to Invalid path: /etc/istio/nginx-ca-certs/ca-chain.cert.pem fix">​</a></h3>
<p>For this one I came across an open issue where someone advised the sidecar of the pod calling the MTLS backend server needs to have the certs mounted to it - which sort of defeats the purpose of this <em>&quot;egressgateway will handle verifying calls to the backend using istio&quot;</em> example right?</p>
<p>Anyway, I did the following:</p>
<ol>
<li>created the <code>nginx-client-certs</code> and <code>nginx-ca-certs</code> secrets inside my namespace <code>mesh-internal</code> (where my <code>sleep</code> pod is deployed)</li>
<li>added the following annotations (<code>sidecar.istio.io/userVolumeMount</code> and <code>sidecar.istio.io/userVolume</code>) to my sleep pods deployment manifest:</li>
</ol>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> sleep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mesh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">internal</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> sleep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">annotations</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">sidecar.istio.io/userVolumeMount</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;[{&quot;name&quot;:&quot;nginx-client-certs&quot;, &quot;mountPath&quot;:&quot;/etc/istio/nginx-client-certs&quot;, &quot;readonly&quot;:true},{&quot;name&quot;:&quot;nginx-ca-certs&quot;, &quot;mountPath&quot;:&quot;/etc/istio/nginx-ca-certs&quot;, &quot;readonly&quot;:true}]&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">sidecar.istio.io/userVolume</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;[{&quot;name&quot;:&quot;nginx-client-certs&quot;, &quot;secret&quot;:{&quot;secretName&quot;:&quot;nginx-client-certs&quot;\}\},{&quot;name&quot;:&quot;nginx-ca-certs&quot;, &quot;secret&quot;:{&quot;secretName&quot;:&quot;nginx-ca-certs&quot;\}\}]&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> sleep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">serviceAccountName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> sleep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> sleep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> governmentpaas/curl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">ssl</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/bin/sleep&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;3650d&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> IfNotPresent</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">volumeMounts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">mountPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /etc/sleep/tls</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> secret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">volume</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> secret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">volume</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">secret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">secretName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> sleep</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">optional</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><br></span></code></pre></div></div>
<p>Now my <code>sleep</code> pod doesn&#x27;t complain about the nginx certs anymore.</p>
<p>I see other pods like prometheus and an httpbin pod in my <code>mesh-internal</code> namespace complaining about not finding the certs, but I understand (currently) it&#x27;s because I haven&#x27;t &quot;sidecar mounted&quot; these certs directly to them.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="add-serviceentry-and-virtualservice">Add ServiceEntry and VirtualService<a href="#add-serviceentry-and-virtualservice" class="hash-link" aria-label="Direct link to Add ServiceEntry and VirtualService" title="Direct link to Add ServiceEntry and VirtualService">​</a></h3>
<p>I added a <code>ServiceEntry</code> and <code>VirtualService</code> combination (it wasn&#x27;t clear in the example that I needed to have one, and the previous section of the documentation delete&#x27;s the ServiceEntry so the following section seems to go ahead without one and doesn&#x27;t specify creating a new one?)</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ServiceEntry</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> external</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">mtls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">nginx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">server</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mesh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">internal</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">protocol</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> HTTP</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> https</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">protocol</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> TLS</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">resolution</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DNS</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> VirtualService</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mesh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">internal</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">tls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">sni_hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">route</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">destination</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">weight</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="changed-gateway-to-http">Changed Gateway to HTTP<a href="#changed-gateway-to-http" class="hash-link" aria-label="Direct link to Changed Gateway to HTTP" title="Direct link to Changed Gateway to HTTP">​</a></h3>
<p>Changed this from tls..</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Gateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> egressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">servers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> https</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">protocol</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> HTTPS</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">tls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">mode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> MUTUAL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">serverCertificate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /etc/certs/cert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">chain.pem</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">privateKey</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /etc/certs/key.pem</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">caCertificates</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /etc/certs/root</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">cert.pem</span><br></span></code></pre></div></div>
<p>to HTTP</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Gateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mesh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">internal</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> egressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">servers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">protocol</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> HTTP</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> mtls.cloudbuild.site</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="changed-destinationrule">Changed DestinationRule<a href="#changed-destinationrule" class="hash-link" aria-label="Direct link to Changed DestinationRule" title="Direct link to Changed DestinationRule">​</a></h3>
<p>from</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DestinationRule</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> egressgateway</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">for</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egressgateway.istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">system.svc.cluster.local</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">subsets</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">trafficPolicy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">loadBalancer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">simple</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ROUND_ROBIN</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">portLevelSettings</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">tls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">mode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ISTIO_MUTUAL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">sni</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mtls.cloudbuild.site</span><br></span></code></pre></div></div>
<p>to</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DestinationRule</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> egressgateway</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">for</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mesh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">internal</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egressgateway.istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">system.svc.cluster.local</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">subsets</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nginx</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="changed-virtualservice-to-port-80">Changed VirtualService to port 80<a href="#changed-virtualservice-to-port-80" class="hash-link" aria-label="Direct link to Changed VirtualService to port 80" title="Direct link to Changed VirtualService to port 80">​</a></h3>
<p>Now that my <code>Gateway</code> is port 80, I update the following route from <code>istio-egressgateway.istio-system.svc.cluster.local:443</code></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> VirtualService</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> direct</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">nginx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">through</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egress</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">gateways</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> mesh</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">http</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">gateways</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> mesh</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">route</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">destination</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egressgateway.istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">system.svc.cluster.local</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">subset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">weight</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">gateways</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">route</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">destination</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">weight</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100</span><br></span></code></pre></div></div>
<p>to <code>istio-egressgateway.istio-system.svc.cluster.local:80</code></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> VirtualService</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> direct</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">nginx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">through</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egress</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mesh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">internal</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">gateways</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> mesh</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">http</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">gateways</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> mesh</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">route</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">destination</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egressgateway.istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">system.svc.cluster.local</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">subset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">weight</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">gateways</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> istio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">egressgateway</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">route</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">destination</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">weight</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100</span><br></span></code></pre></div></div>
<p>And then it all works.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="working-output">Working Output<a href="#working-output" class="hash-link" aria-label="Direct link to Working Output" title="Direct link to Working Output">​</a></h2>
<p>So now when I curl from the <code>sleep</code> pod inside the <code>mesh-internal</code> namespace, I get the expected output:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">$ kubectl -n mesh-internal exec sleep-74997ffb46-cxs77 -c sleep -- curl  http://mtls.cloudbuild.site</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                                 Dload  Upload   Total   Spent    Left  Speed</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0&lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt;html /&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt;head /&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt;title /&gt;Welcome to nginx!&lt;/title&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt;style /&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    body {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        width: 35em;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        margin: 0 auto;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt;/style&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt;/head&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt;body /&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt;h1 /&gt;Welcome to the Mutual TLS Server!&lt;/h1&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt;p /&gt;If you see this page, you have successfully used the correct client-side certificates that match the ones</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  deployed on this server.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt;/p&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt;p /&gt;For more information please visit my website:&lt;a href=&quot;https://iamronamo.io/&quot; /&gt;iamronamo.io&lt;/a&gt;.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt;p /&gt;&lt;em /&gt;Thank you and goodnight.&lt;/em&gt;&lt;/p&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt;/body&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt;/html&gt;</span><br></span></code></pre></div></div>
<p>From the sleep pod&#x27;s <code>istio-proxy</code> container I can see it hitting my port 80 outbound endpoint:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">[2020-04-11T15:03:16.493Z] &quot;GET / HTTP/1.1&quot; 200 - &quot;-&quot; &quot;-&quot; 0 557 4 4 &quot;-&quot; &quot;curl/7.64.0&quot; &quot;738ceb49-93c9-4462-a53b-ab690bef4b93&quot; &quot;mtls.cloudbuild.site&quot; &quot;16.0.1.90:80&quot; outbound|80|nginx|istio-egressgateway.istio-system.svc.cluster.local 16.0.1.103:39040 52.189.232.175:80 16.0.1.103:45092 - -</span><br></span></code></pre></div></div>
<p>and from the <code>istio-egressgateway</code> pod I can see it going outbound on 443:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">[2020-04-11T15:04:37.866Z] &quot;GET / HTTP/2&quot; 200 - &quot;-&quot; &quot;-&quot; 0 557 4 4 &quot;16.0.1.103&quot; &quot;curl/7.64.0&quot; &quot;7d158baa-3ac4-4da7-9e91-a4ae6115c090&quot; &quot;mtls.cloudbuild.site&quot; &quot;52.189.232.175:443&quot; outbound|443||mtls.cloudbuild.site 16.0.1.90:43866 16.0.1.90:80 16.0.1.103:39040 - -</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>I have found Istio&#x27;s documentation to be workable most of the time. But sometimes the examples run into each other, so its hard to know what are the specifics of that example without something explicitly saying &quot;this example will create <code>n</code> components&quot;, or a repo/folder with the exact configs used to achieve whatever the thing was in the example.</p>
<p>The discuss forum and slack channels were very underwhelming. I don&#x27;t know what to put that down to, but they weren&#x27;t very active or helpful.</p>
<p>Anyway I&#x27;ve spent way too much time on this and it&#x27;s just good to get it working so I can put this all behind me.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/istio">istio</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/service-mesh">service-mesh</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/mtls">mtls</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/egress">egress</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/external-services">external-services</a></li></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/engineer/K8s/2020-04-08-Istio-MTLS-with-External-Endpoint.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-09-22T07:31:42.000Z" itemprop="dateModified">Sep 22, 2025</time></b> by <b>Ron Amosa</b></span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/engineer/K8s/2020-03-06-Istio-SDS-Cert-Manager"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Istio mTLS with SDS and Cert-Manager - Complete Service Mesh Security Guide</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/engineer/K8s/2019-07-09-Ambassador-Disable-TLS1"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Ambassador API Gateway TLS Security - Disable TLS 1.0 and 1.1 for Better Security</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#architecture-diagram" class="table-of-contents__link toc-highlight">Architecture Diagram</a><ul><li><a href="#key-components" class="table-of-contents__link toc-highlight">Key Components</a></li></ul></li><li><a href="#pre-requisites" class="table-of-contents__link toc-highlight">Pre-requisites</a></li><li><a href="#mtls-server" class="table-of-contents__link toc-highlight">MTLS Server</a><ul><li><a href="#certificates-server-certs-client-certs-and-intermediate-certs" class="table-of-contents__link toc-highlight">Certificates: server certs, client certs and intermediate certs</a></li><li><a href="#nginx-webserver" class="table-of-contents__link toc-highlight">NGINX Webserver</a></li><li><a href="#the-mtls-client-test" class="table-of-contents__link toc-highlight">the MTLS client (test)</a></li></ul></li><li><a href="#istio-egress-gateway-setup" class="table-of-contents__link toc-highlight">Istio Egress Gateway Setup</a><ul><li><a href="#install-istio-with-egressgateway" class="table-of-contents__link toc-highlight">install istio with egressgateway</a></li><li><a href="#create-the-cert-k8s-secrets" class="table-of-contents__link toc-highlight">create the cert k8s secrets</a></li><li><a href="#patch-the-egressgateway" class="table-of-contents__link toc-highlight">patch the egressgateway</a></li></ul></li><li><a href="#warning-istio-documented-configs-not-working" class="table-of-contents__link toc-highlight">WARNING: Istio Documented Configs (NOT WORKING)</a></li><li><a href="#errors-nginx-certs--root-certpem" class="table-of-contents__link toc-highlight">Errors: nginx certs &amp; root-cert.pem</a><ul><li><a href="#invalid-path-nginx-certs" class="table-of-contents__link toc-highlight">invalid path nginx certs</a></li><li><a href="#invalid-path-etccertsroot-certpem" class="table-of-contents__link toc-highlight">invalid path /etc/certs/root-cert.pem</a></li><li><a href="#http11-503-service-unavailable-obviously" class="table-of-contents__link toc-highlight">HTTP/1.1 503 Service Unavailable (obviously)</a></li></ul></li><li><a href="#unofficial-working-configuration" class="table-of-contents__link toc-highlight">UNOFFICIAL: WORKING CONFIGURATION</a><ul><li><a href="#etcroot-certpem-fix" class="table-of-contents__link toc-highlight">/etc/root-cert.pem fix</a></li><li><a href="#invalid-path-etcistionginx-ca-certsca-chaincertpem-fix" class="table-of-contents__link toc-highlight">Invalid path: /etc/istio/nginx-ca-certs/ca-chain.cert.pem fix</a></li><li><a href="#add-serviceentry-and-virtualservice" class="table-of-contents__link toc-highlight">Add ServiceEntry and VirtualService</a></li><li><a href="#changed-gateway-to-http" class="table-of-contents__link toc-highlight">Changed Gateway to HTTP</a></li><li><a href="#changed-destinationrule" class="table-of-contents__link toc-highlight">Changed DestinationRule</a></li><li><a href="#changed-virtualservice-to-port-80" class="table-of-contents__link toc-highlight">Changed VirtualService to port 80</a></li></ul></li><li><a href="#working-output" class="table-of-contents__link toc-highlight">Working Output</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/ron-amosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/ronamosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@uncommonengineer" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Discover</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/docs">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/about">About</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Last updated on Mon Sep 22 2025</div></div></div></footer></div>
</body>
</html>