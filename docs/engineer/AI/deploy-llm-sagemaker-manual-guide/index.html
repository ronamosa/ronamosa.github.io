<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-engineer/AI/DeployLLMToSageMaker" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Deploy Large Language Models to AWS SageMaker - Complete Manual Guide | The Uncommon Engineer</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:image" content="https://www.uncommonengineer.com/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://www.uncommonengineer.com/img/social-card.png"><meta data-rh="true" property="og:url" content="https://www.uncommonengineer.com/docs/engineer/AI/deploy-llm-sagemaker-manual-guide"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Deploy Large Language Models to AWS SageMaker - Complete Manual Guide | The Uncommon Engineer"><meta data-rh="true" name="description" content="Step-by-step tutorial for manually deploying LLMs to AWS SageMaker endpoints. Learn model preparation, inference code setup, and endpoint deployment for production AI."><meta data-rh="true" property="og:description" content="Step-by-step tutorial for manually deploying LLMs to AWS SageMaker endpoints. Learn model preparation, inference code setup, and endpoint deployment for production AI."><meta data-rh="true" name="keywords" content="aws sagemaker,llm deployment,large language model,machine learning,ai deployment,pytorch,sagemaker endpoints,model serving"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.uncommonengineer.com/docs/engineer/AI/deploy-llm-sagemaker-manual-guide"><link data-rh="true" rel="alternate" href="https://www.uncommonengineer.com/docs/engineer/AI/deploy-llm-sagemaker-manual-guide" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.uncommonengineer.com/docs/engineer/AI/deploy-llm-sagemaker-manual-guide" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9UFF3RBJQ9-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"üíª Engineer","item":"https://www.uncommonengineer.com/docs/category/-engineer"},{"@type":"ListItem","position":2,"name":"AI","item":"https://www.uncommonengineer.com/docs/category/ai"},{"@type":"ListItem","position":3,"name":"Deploy Large Language Models to AWS SageMaker - Complete Manual Guide","item":"https://www.uncommonengineer.com/docs/engineer/AI/deploy-llm-sagemaker-manual-guide"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="The Uncommon Engineer RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="The Uncommon Engineer Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="The Uncommon Engineer" href="/opensearch.xml">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DMRNTVGLRC"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DMRNTVGLRC",{anonymize_ip:!0})</script>

<script src="/js/console-clue.js"></script>
<script src="/js/metricool.js"></script>
<script src="https://subscribe-forms.beehiiv.com/embed.js" async></script><link rel="stylesheet" href="/assets/css/styles.5170efae.css">
<script src="/assets/js/runtime~main.3d5cd519.js" defer="defer"></script>
<script src="/assets/js/main.727d0b4f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.svg" alt="The Uncommon Engineer" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/profile.svg" alt="The Uncommon Engineer" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Uncommon Engineer</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Technical</a><a class="navbar__item navbar__link" href="/blog/">Analysis &amp; Essays</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/projects/">Projects</a><a class="navbar__item navbar__link" href="/changelog/">Changelog</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">‚ñ∂ Start Here</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/books/reading-list">üìö Books &amp; Papers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/study/SCS-C01/">üìó Study</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/Ô∏è-hacker">üè¥‚Äç‚ò†Ô∏è Hacker</a><button aria-label="Expand sidebar category &#x27;üè¥‚Äç‚ò†Ô∏è Hacker&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/-engineer">üíª Engineer</a><button aria-label="Collapse sidebar category &#x27;üíª Engineer&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/ai">AI</a><button aria-label="Collapse sidebar category &#x27;AI&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/AI">AI &amp; Machine Learning Projects Hub: LLM Deployment &amp; GenAI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/AI/Mistral-7B-SageMaker">Deploy Mistral-7B LLM with Ollama on AWS SageMaker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/AI/PrivateGPT">PrivateGPT Local Deployment on Linux - Secure Document Chat Without Cloud</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/AI/PrivateGPTAWS">PrivateGPT on AWS EC2 - Secure Cloud-Based Document Chat with LLMs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/AI/AgenticRagLlamaIndex">Building Agentic RAG with LlamaIndex - Advanced AI Agent Development</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/engineer/AI/deploy-llm-sagemaker-manual-guide">Deploy Large Language Models to AWS SageMaker - Complete Manual Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/AI/AWSGPT">AWS GPT Documentation Assistant - AI-Powered AWS Learning Tool</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/AI/PromptEngChatGPT">ChatGPT Prompt Engineering for Developers - Complete AI Interaction Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/AI/RetrievalAugmentedGeneration">Retrieval Augmented Generation (RAG) - Production-Ready AI Applications Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/AI/GenAIAmbassadorNotes">AWS GenAI Ambassador Program - AI Leadership and Community Building Notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/AI/Claude3OpusFinancialAdvisor">Claude 3 Opus Financial Advisor - AI-Powered Personal Finance Assistant</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/AI/PromptingAI">AI Prompting Collection - System, User, and Advanced Prompt Templates</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/AI/BedrockLangChainWorkshop1">Amazon Bedrock and LangChain Workshop - Enterprise AI Application Development</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/AI/LLMLangChainProject">LangChain AutoGPT Development - Building Autonomous AI Agents</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/Ô∏è-projects">üõ†Ô∏è Projects</a><button aria-label="Expand sidebar category &#x27;üõ†Ô∏è Projects&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/AWS/eks-workshop">AWS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/Azure/2019-07-20-Sonarqube-AzureDisk-PersistentVolume">Azure</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/GCP/2019-11-27-GCP-Install-Ambassador-Helm2">GCP</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/K8s/2019-11-11-Helm-3-Kubernetes-Package-Manager">K8s</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/LAB">LAB</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/Misc/algos-system-design">Misc</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/archive/docker-wordpress/docker-wordpress-1">üóÉ Archive</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/-engineer"><span>üíª Engineer</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/ai"><span>AI</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Deploy Large Language Models to AWS SageMaker - Complete Manual Guide</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Deploy Large Language Models to AWS SageMaker - Complete Manual Guide</h1></header><div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>These are notes for working out the steps and process for deploying an LLM to SageMaker as part of my YouTube video series, hence they will be rough, but I will include the link to the completed video.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="agenda">Agenda<a href="#agenda" class="hash-link" aria-label="Direct link to Agenda" title="Direct link to Agenda">‚Äã</a></h2>
<p>In this first video, we&#x27;ll focus on the end-to-end deployment process. We&#x27;ll cover:</p>
<ol>
<li>Preparing the LLM model for deployment</li>
<li>Writing the inference code to handle requests</li>
<li>Launching the model endpoint on SageMaker</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="deployment-overview">Deployment Overview<a href="#deployment-overview" class="hash-link" aria-label="Direct link to Deployment Overview" title="Direct link to Deployment Overview">‚Äã</a></h2>
<p>Key components</p>
<ol>
<li>model artefacts</li>
<li>inference code</li>
<li>Endpoint (sagemaker)</li>
</ol>
<p>Tasks at a high level</p>
<ol>
<li>prepare the model files, upload to S3</li>
<li>write some inference code, package with deps</li>
<li>create SM model using the model package</li>
<li>launch Endpoint to servce model.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prepare-llm">Prepare LLM<a href="#prepare-llm" class="hash-link" aria-label="Direct link to Prepare LLM" title="Direct link to Prepare LLM">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="model-theory">Model Theory<a href="#model-theory" class="hash-link" aria-label="Direct link to Model Theory" title="Direct link to Model Theory">‚Äã</a></h3>
<p>According to the SageMaker documentation, the model directory should have the following structure:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">/model.tar.gz</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">‚îú‚îÄ‚îÄ model.pth</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">‚îú‚îÄ‚îÄ code/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">‚îÇ   ‚îú‚îÄ‚îÄ inference.py</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt</span><br></span></code></pre></div></div>
<p>Here&#x27;s what each component represents:</p>
<ul>
<li><code>model.pth</code>: This is the serialized model file containing the trained weights of your PyTorch model.</li>
<li><code>code/</code>: This directory contains the necessary code files for the inference script.<!-- -->
<ul>
<li><code>inference.py</code>: This is the inference script that we&#x27;ll discuss later, containing the <code>model_fn</code>, <code>input_fn</code>, <code>predict_fn</code>, and <code>output_fn</code> functions.</li>
<li><code>requirements.txt</code>: This file lists the dependencies required by your inference script, such as the <code>torch</code> and <code>transformers</code> libraries.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-stable-diffusion-xl">Example Stable Diffusion XL<a href="#example-stable-diffusion-xl" class="hash-link" aria-label="Direct link to Example Stable Diffusion XL" title="Direct link to Example Stable Diffusion XL">‚Äã</a></h3>
<p>On my SageMaker instance, I deployed SDXL, from the terminal here&#x27;s what the artefacts look like:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">sagemaker-user@default:~/model-58101$ ls -ll</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">total 92</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-r--r-- 1 sagemaker-user users 12506 Mar  7 04:03 README.md</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x 3 sagemaker-user users    76 Mar  7 04:05 code</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x 2 sagemaker-user users    38 Mar  7 04:04 feature_extractor</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-r--r-- 1 sagemaker-user users   543 Mar  7 04:03 model_index.json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x 2 sagemaker-user users    50 Mar  7 04:04 safety_checker</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x 3 sagemaker-user users    61 Mar  7 04:04 scheduler</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x 2 sagemaker-user users    50 Mar  7 04:04 text_encoder</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x 2 sagemaker-user users   102 Mar  7 04:04 tokenizer</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x 2 sagemaker-user users    60 Mar  7 04:04 unet</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-r--r-- 1 sagemaker-user users 71237 Mar  7 04:03 v1-variants-scores.jpg</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">drwxr-xr-x 2 sagemaker-user users    60 Mar  7 04:04 vae</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sagemaker-user@default:~/model-58101$</span><br></span></code></pre></div></div>
<p>looking in code:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">sagemaker-user@default:~/model-58101/code$ ls -ll</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">total 8</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-r--r-- 1 sagemaker-user users 1170 Mar  7 03:57 inference.py</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-r--r-- 1 sagemaker-user users   38 Mar  7 03:57 requirements.txt</span><br></span></code></pre></div></div>
<p>and the default <code>inference.py</code> file that comes default</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> base64</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> torch</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> io </span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> BytesIO</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> diffusers </span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> StableDiffusionPipeline</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">model_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">model_dir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Load stable diffusion and move it to the GPU</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    pipe </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> StableDiffusionPipeline</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">model_dir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> torch_dtype</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">torch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">float16</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    pipe </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> pipe</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;cuda&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> pipe</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">predict_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> pipe</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># get prompt &amp; parameters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    prompt </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">pop</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;inputs&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># set valid HP for stable diffusion</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    num_inference_steps </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">pop</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;num_inference_steps&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">50</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    guidance_scale </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">pop</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;guidance_scale&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">7.5</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    num_images_per_prompt </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">pop</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;num_images_per_prompt&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># run generation with parameters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    generated_images </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> pipe</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        prompt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        num_inference_steps</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">num_inference_steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        guidance_scale</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">guidance_scale</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        num_images_per_prompt</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">num_images_per_prompt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;images&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># create response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    encoded_images </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">for</span><span class="token plain"> image </span><span class="token keyword" style="color:rgb(127, 219, 202)">in</span><span class="token plain"> generated_images</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        buffered </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> BytesIO</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">save</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">buffered</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">format</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;JPEG&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        encoded_images</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">base64</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">b64encode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">buffered</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">getvalue</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># create response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;generated_images&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> encoded_images</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prepare-llm-model">Prepare LLM Model<a href="#prepare-llm-model" class="hash-link" aria-label="Direct link to Prepare LLM Model" title="Direct link to Prepare LLM Model">‚Äã</a></h2>
<p>Fetch pre-trained, open source <code>GPT-Neo</code> model, from Hugging Face.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="download-llm-from-huggingface">Download LLM from HuggingFace<a href="#download-llm-from-huggingface" class="hash-link" aria-label="Direct link to Download LLM from HuggingFace" title="Direct link to Download LLM from HuggingFace">‚Äã</a></h3>
<p>a few options</p>
<ul>
<li>programmatically e.g. <code>from transformers import AutoTokenizer, AutoModelForCausalLM</code></li>
<li>git e.g. <code>git lfs install &amp;&amp; gti clone https://huggingface.co/distilgpt2</code></li>
</ul>
<p>On the HuggingFace model <a href="https://huggingface.co/EleutherAI/gpt-neox-20b" target="_blank" rel="noopener noreferrer">repo</a> page,</p>
<p><img decoding="async" loading="lazy" alt="HuggingFace Repo" src="/assets/images/SageMakerDeploy-clonerepo-89d34f51dc1ddc9d25a20218414b336f.png" width="620" height="223" class="img_ev3q"></p>
<p>I&#x27;m going with <code>git</code> so need to install <code>lfs</code> or</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain"># install</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sudo apt install git-lfs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># enable</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">git lfs install</span><br></span></code></pre></div></div>
<p>pull GPT-NeoX-20b down</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">~/Repositories ‚ùØ git clone https://huggingface.co/EleutherAI/gpt-neox-20b</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Cloning into &#x27;gpt-neox-20b&#x27;...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">remote: Enumerating objects: 125, done.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">remote: Counting objects: 100% (125/125), done.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">remote: Compressing objects: 100% (114/114), done.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">remote: Total 125 (delta 12), reused 121 (delta 10), pack-reused 0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Receiving objects: 100% (125/125), 1.14 MiB | 1.69 MiB/s, done.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Resolving deltas: 100% (12/12), done.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Filtering content: 100% (93/93), 76.91 GiB | 24.04 MiB/s, done.</span><br></span></code></pre></div></div>
<p>Damn, you can see there ^ the model is 76.91 GiB.</p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>LLM Too Large?</div><div class="admonitionContent_BuS1"><p>gpt-neox-20b i.e. 20 Billion parameter LLM included 46 pytorch bin files, which Claude explained looks like the LLM is sharded cos of the size, so I would have to try to either a) merge all bins or b) ensure the inference script was prepped to load all the shards first.</p><p>I&#x27;m going to leave this and look for a smaller, simpler model to learn on first, and will come back to this later.</p></div></div>
<p>Going with the GPT-125M LLM instead</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">~/Repositories ‚ùØ git clone https://huggingface.co/EleutherAI/gpt-neo-125m</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Cloning into &#x27;gpt-neo-125m&#x27;...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">remote: Enumerating objects: 65, done.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">remote: Counting objects: 100% (7/7), done.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">remote: Compressing objects: 100% (7/7), done.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">remote: Total 65 (delta 2), reused 0 (delta 0), pack-reused 58</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Unpacking objects: 100% (65/65), 1.11 MiB | 2.23 MiB/s, done.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Filtering content: 100% (4/4), 1.93 GiB | 21.55 MiB/s, done.</span><br></span></code></pre></div></div>
<p>the file list of r <code>gpt-neo-125m</code> looks more manageable and not sharded</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">~/R/gpt-neo-125m on main ‚ùØ ll</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">total 1.3G</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk 1007 Apr  2 19:01 config.json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk 478M Apr  2 19:03 flax_model.msgpack</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk  119 Apr  2 19:01 generation_config.json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk 446K Apr  2 19:01 merges.txt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk 502M Apr  2 19:03 model.safetensors</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk 502M Apr  2 19:03 pytorch_model.bin</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk 4.1K Apr  2 19:01 README.md</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk 502M Apr  2 19:03 rust_model.ot</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk  357 Apr  2 19:01 special_tokens_map.json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk  727 Apr  2 19:01 tokenizer_config.json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk 2.1M Apr  2 19:01 tokenizer.json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk 878K Apr  2 19:01 vocab.json</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="organise-model-artefacts">Organise Model Artefacts<a href="#organise-model-artefacts" class="hash-link" aria-label="Direct link to Organise Model Artefacts" title="Direct link to Organise Model Artefacts">‚Äã</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Claude 3</div><div class="admonitionContent_BuS1"><p>I used <a href="https://claude.ai/chat/" target="_blank" rel="noopener noreferrer">Claude 3 Opus</a> (paid) to generate the steps for me, and I just tweak any minor issues until it&#x27;s working.</p></div></div>
<p>Create a new directory for your model (e.g., <code>gpt-neo-125m-model</code>).</p>
<p>Copy the following files from the gpt-neo-125m model repository into the <code>gpt-neo-125m-model</code> directory:</p>
<ul>
<li><code>config.json</code>: This file contains the model configuration parameters.</li>
<li><code>pytorch_model.bin</code>: This file contains the pretrained model weights for PyTorch.</li>
<li><code>tokenizer.json</code>: This file contains the tokenizer configuration.</li>
<li><code>special_tokens_map.json</code>: This file contains the mappings for special tokens.</li>
<li><code>vocab.json</code>: This file contains the vocabulary used by the tokenizer.</li>
<li><code>merges.txt</code>: This file contains the byte-pair encoding (BPE) merges used by the tokenizer.</li>
</ul>
<p>Create a <code>requirements.txt</code> file in the <code>gpt-neo-125m-model</code> directory and specify the dependencies required for your model. For example:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">transformers</span><span class="token operator" style="color:rgb(127, 219, 202)">==</span><span class="token number" style="color:rgb(247, 140, 108)">4.12</span><span class="token number" style="color:rgb(247, 140, 108)">.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">torch</span><span class="token operator" style="color:rgb(127, 219, 202)">==</span><span class="token number" style="color:rgb(247, 140, 108)">1.9</span><span class="token number" style="color:rgb(247, 140, 108)">.0</span><br></span></code></pre></div></div>
<p>Adjust the versions based on your specific requirements and compatibility.</p>
<p>Create a <code>code/</code> directory in the <code>gpt-neo-125m-model</code> directory and place any custom inference code or scripts you have written there. For example, you can create a <code>inference.py</code> file with the following content:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> torch</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> transformers </span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> GPTNeoForCausalLM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> GPT2Tokenizer</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">device </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;cuda&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">cuda</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">is_available</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">else</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;cpu&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">model_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">model_dir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tokenizer </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> GPT2Tokenizer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">model_dir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    model </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> GPTNeoForCausalLM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">model_dir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    model</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    model</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token builtin" style="color:rgb(130, 170, 255)">eval</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> tokenizer</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">input_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">serialized_input_data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> content_type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> content_type </span><span class="token operator" style="color:rgb(127, 219, 202)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;application/json&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        input_data </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> json</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">serialized_input_data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        text </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> input_data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;text&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> text</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">raise</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Unsupported content type: {}&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token builtin" style="color:rgb(130, 170, 255)">format</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">content_type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">predict_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">input_data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> model_and_tokenizer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    model</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> tokenizer </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> model_and_tokenizer</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    input_ids </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> tokenizer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">input_data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> return_tensors</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;pt&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    output </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">generate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">input_ids</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> max_length</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> num_return_sequences</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    generated_text </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> tokenizer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">output</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> skip_special_tokens</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token boolean" style="color:rgb(255, 88, 116)">True</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> generated_text</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">output_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">prediction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> accept</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> accept </span><span class="token operator" style="color:rgb(127, 219, 202)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;application/json&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> json</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;generated_text&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> prediction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> accept</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">raise</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Unsupported accept type: {}&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token builtin" style="color:rgb(130, 170, 255)">format</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">accept</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre></div></div>
<p>Review code:</p>
<ul>
<li><code>model_fn(model_dir)</code>: This function is called by SageMaker to load the model. It takes the model_dir as input, which is the directory where the model files are stored. In this function, you load the tokenizer and the model, move the model to the appropriate device (CPU or GPU), and return the model and tokenizer.</li>
<li><code>input_fn(serialized_input_data, content_type)</code>: This function is called by SageMaker to deserialize the input data. It takes the serialized input data and the content type as input. In this example, it expects the input data to be in JSON format with a &quot;text&quot; key containing the input text. You can modify this function to handle different input formats based on your requirements.</li>
<li><code>predict_fn(input_data, model_and_tokenizer)</code>: This function is called by SageMaker to perform the actual prediction. It takes the deserialized input data and the loaded model and tokenizer as input. In this example, it encodes the input text using the tokenizer, generates text using the model, and decodes the generated output.</li>
<li><code>output_fn(prediction, accept)</code>: This function is called by SageMaker to serialize the prediction output. It takes the prediction and the desired output content type as input. In this example, it returns the generated text as a JSON response.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="package-deployment-model">Package Deployment Model<a href="#package-deployment-model" class="hash-link" aria-label="Direct link to Package Deployment Model" title="Direct link to Package Deployment Model">‚Äã</a></h3>
<p>Your directory should look like this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">~/Repositories/SM-gpt-neo-125m/gpt-neo-125m-model ‚ùØ ll</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">total 332M</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk 1007 Apr  2 21:41 config.json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk 1.2K Apr  2 22:02 inference.py</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk 446K Apr  2 21:41 merges.txt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk 502M Apr  2 21:40 pytorch_model.bin</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk   34 Apr  2 21:55 requirements.txt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk  357 Apr  2 21:41 special_tokens_map.json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk  727 Apr  2 21:41 tokenizer_config.json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-rw-rw-r-- 1 rxhackk rxhackk 878K Apr  2 21:41 vocab.json</span><br></span></code></pre></div></div>
<p>create a sub-dir, and organise your files like this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">~/Repositories/SM-gpt-neo-125m/gpt-neo-125m-model ‚ùØ tree                                                                                                          at ÔÄó 23:22:04</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">‚îú‚îÄ‚îÄ code</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">‚îÇ   ‚îú‚îÄ‚îÄ inference.py</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">‚îú‚îÄ‚îÄ config.json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">‚îú‚îÄ‚îÄ merges.txt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">‚îú‚îÄ‚îÄ pytorch_model.bin</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">‚îú‚îÄ‚îÄ special_tokens_map.json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">‚îú‚îÄ‚îÄ tokenizer_config.json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">‚îî‚îÄ‚îÄ vocab.json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">1 directory, 8 files</span><br></span></code></pre></div></div>
<p>Compress the entire <code>gpt-neo-125m-model</code> directory into a <code>tar.gz</code> file using a command like:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain"># change into the model dir, where the `code/` subdir is</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cd gpt-neo-125m-model</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">tar -czf gpt-neo-125m-model.tar.gz *</span><br></span></code></pre></div></div>
<p>You now have a file <code>gpt-neo-125m-model.tar.gz</code> that contains the necessary files for deploying the gpt-neo-125m model to SageMaker.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-model-to-sagemaker">Deploy Model to SageMaker<a href="#deploy-model-to-sagemaker" class="hash-link" aria-label="Direct link to Deploy Model to SageMaker" title="Direct link to Deploy Model to SageMaker">‚Äã</a></h2>
<p>Model is ready for upload, and then a SageMaker model using our &quot;custom&quot; LLM.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="upload-to-s3">Upload to s3<a href="#upload-to-s3" class="hash-link" aria-label="Direct link to Upload to s3" title="Direct link to Upload to s3">‚Äã</a></h3>
<p>Upload the <code>gpt-neo-125m-model.tar.gz</code> file to an S3 bucket.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">~/Repositories/SM-gpt-neo-125m ‚ùØ aws s3 cp gpt-neo-125m-model.tar.gz s3://ra-aws-s3-lab                                                                     ‚úò 252 at ÔÄó 22:11:03</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">upload: ./gpt-neo-125m-model.tar.gz to s3://ra-aws-s3-lab/gpt-neo-125m-model.tar.gz</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-role">Create Role<a href="#create-role" class="hash-link" aria-label="Direct link to Create Role" title="Direct link to Create Role">‚Äã</a></h3>
<p>cos I&#x27;m lazy, I got the <code>aws cli</code> commands to do this from the terminal:</p>
<p>create <code>assume-role-policy.json</code> to service-link our role:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Version&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;2012-10-17&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Statement&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Effect&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Allow&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Principal&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Service&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;sagemaker.amazonaws.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Action&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;sts:AssumeRole&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<p>create role: <code>aws iam create-role --role-name SageMakerExecutionRole --assume-role-policy-document file://assume-role-policy.json</code></p>
<p>output:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;Role&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;Path&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;RoleName&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;SageMakerExecutionRole&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;RoleId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;AROA4EFKKWBQIC4MCQHWD&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;Arn&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;arn:aws:iam::REDACTED:role/SageMakerExecutionRole&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;CreateDate&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;2024-04-02T09:49:20+00:00&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;AssumeRolePolicyDocument&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;Version&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;2012-10-17&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;Statement&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;Effect&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Allow&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;Principal&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;Service&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;sagemaker.amazonaws.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;Action&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;sts:AssumeRole&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<p>attach the <code>SageMakerFullAccess</code> policy: <code>aws iam attach-role-policy --role-name SageMakerExecutionRole --policy-arn arn:aws:iam::aws:policy/AmazonSageMakerFullAccess</code></p>
<p>output: N/A</p>
<p>get the ARN cos I need it for my deployment code: <code>aws iam get-role --role-name SageMakerExecutionRole --query &#x27;Role.Arn&#x27; --output text</code></p>
<p>output:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">arn</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain">aws</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain">iam</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain">REDACTED</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain">role/SageMakerExecutionRole</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>These create role commands were successful, but when running my <code>deploy.py</code> code, I ran into s3 permissions.</p></div></div>
<p>add <code>AmazonS3ReadOnlyAccess</code> to get <code>s3:GetObject</code> permissions for my role: <code>aws iam attach-role-policy --role-name SageMakerExecutionRole --policy-arn arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-endpoint">Create Endpoint<a href="#create-endpoint" class="hash-link" aria-label="Direct link to Create Endpoint" title="Direct link to Create Endpoint">‚Äã</a></h3>
<p>Use the SageMaker Python SDK to create the &quot;SageMaker Model&quot;.</p>
<p>Now, according to Claude, you can run this code in a number of places, it doesn&#x27;t matter, it will call the SageMaker API and stand up this model. You can call it locally (note: you need <code>pip install sagemaker</code>), or in a JupyterLab notebook, or AWS Cloud9.</p>
<p>I&#x27;m going to try to call it locally, the following code I put into <code>deploy.py</code>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> sagemaker</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">pytorch </span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> PyTorchModel</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">model_data </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;s3://ra-aws-s3-lab/gpt-neo-125m-model.tar.gz&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">role </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;arn:aws:iam::REDACTED:role/SageMakerExecutionRole&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">pytorch_model </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> PyTorchModel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    model_data</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">model_data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    role</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">role</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    framework_version</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;1.9.0&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    py_version</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;py38&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    entry_point</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;inference.py&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">predictor </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> pytorch_model</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">deploy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    instance_type</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;ml.m5.large&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    initial_instance_count</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre></div></div>
<p>Success!</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>there was a bunch of <a href="#troubleshooting">troubleshooting</a> that happened before this stood up, and notes have been updated retroactively, but I&#x27;ve tried to capture what came out of the original process.</p></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">~/Repositories/SM-gpt-neo-125m ‚ùØ python3 deploy.py   at 23:43:51</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sagemaker.config INFO - Not applying SDK defaults from location: /etc/xdg/xdg-ubuntu/sagemaker/config.yaml</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sagemaker.config INFO - Not applying SDK defaults from location: /home/rxhackk/.config/sagemaker/config.yaml</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">----------!%</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">~/Repositories/SM-gpt-neo-125m ‚ùØ   took 14m 1s at</span><br></span></code></pre></div></div>
<p>‚è±Ô∏è 14mins to deploy.</p>
<p>Check AWS Console</p>
<p><img decoding="async" loading="lazy" alt="Endpoint Success" src="/assets/images/SageMakerDeploy-endpoint-ba68531b44d5e983644750d7868ed14b.png" width="1523" height="239" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="test-the-endpoint">Test the Endpoint<a href="#test-the-endpoint" class="hash-link" aria-label="Direct link to Test the Endpoint" title="Direct link to Test the Endpoint">‚Äã</a></h2>
<p>The moment of truth!</p>
<p>Now the custom model is up &amp; running and our inference endpoint says &quot;‚úÖInService&quot; we should be able to invoke it and get the inference script workingf:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">aws sagemaker-runtime invoke-endpoint \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --endpoint-name my-endpoint \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --cli-binary-format raw-in-base64-out \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --body &#x27;{&quot;text&quot;: &quot;Hello, LLM!&quot;}&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --content-type application/json output.txt</span><br></span></code></pre></div></div>
<p>I need my new endpoint name. I can get it via AWS Console, or use cli to grab it,:</p>
<p>To get ALL info:</p>
<p><code>aws sagemaker list-endpoints</code></p>
<p>To get just EndpointName in a table:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">aws sagemaker list-endpoints \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --query &quot;Endpoints[*].[EndpointName]&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --output table</span><br></span></code></pre></div></div>
<p>output</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">-----------------------------------------------------------</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|                      ListEndpoints                      |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">+---------------------------------------------------------+</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|  pytorch-inference-2024-04-03-10-52-17-710              |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|  huggingface-pytorch-inference-2024-03-07-04-18-07-114  |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|  DEMO-1709699475-cbc3-endpointx                         |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|  SDXL-v2-1-RAMOS                                        |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">+---------------------------------------------------------+</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(END)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="invoke">Invoke<a href="#invoke" class="hash-link" aria-label="Direct link to Invoke" title="Direct link to Invoke">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">aws sagemaker-runtime invoke-endpoint \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --endpoint-name pytorch-inference-2024-04-03-10-52-17-710 \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --cli-binary-format raw-in-base64-out \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --body &#x27;{&quot;text&quot;: &quot;Hi, LLM!&quot;}&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --content-type application/json output.txt</span><br></span></code></pre></div></div>
<p>response:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    &quot;ContentType&quot;: &quot;application/json&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    &quot;InvokedProductionVariant&quot;: &quot;AllTraffic&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(END)</span><br></span></code></pre></div></div>
<p>‚úÖ We have a <code>output.txt</code> file now from our LLM</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">‚ùØ cat output.txt   took  44s at  11:58:49</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{&quot;generated_text&quot;: &quot;Hi, LLM!\n\nI&#x27;m a little confused about the word \&quot;soul\&quot; in the English language. I&#x27;m not sure what the word means in the English language, but I&#x27;m not sure what the word means in the English language. I&#x27;m not sure what the word means in the English language. I&#x27;m not sure what the word means in the English language. I&#x27;m not sure what the word means in the English language. I&#x27;m not sure what the word means in the&quot;}%</span><br></span></code></pre></div></div>
<p>Done.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bonus-re-deploy-updates-to-your-sagemaker-endpoint">Bonus: Re-Deploy Updates to your SageMaker Endpoint<a href="#bonus-re-deploy-updates-to-your-sagemaker-endpoint" class="hash-link" aria-label="Direct link to Bonus: Re-Deploy Updates to your SageMaker Endpoint" title="Direct link to Bonus: Re-Deploy Updates to your SageMaker Endpoint">‚Äã</a></h2>
<p>I needed to update my <code>inference.py</code> script to the following, to get better results:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">predict_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">input_data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> model_and_tokenizer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    model</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> tokenizer </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> model_and_tokenizer</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    input_ids </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> tokenizer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">input_data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> return_tensors</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;pt&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    output </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">generate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        input_ids</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        max_length</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">150</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        num_return_sequences</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        temperature</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0.7</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        top_k</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">50</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        top_p</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0.95</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    generated_text </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> tokenizer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">output</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> skip_special_tokens</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token boolean" style="color:rgb(255, 88, 116)">True</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> generated_text</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><br></span></code></pre></div></div>
<p>so the whole <code>inference.py</code> now reads</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> torch</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> transformers </span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> GPTNeoForCausalLM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> GPT2Tokenizer</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">device </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;cuda&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">cuda</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">is_available</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">else</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;cpu&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">model_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">model_dir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tokenizer </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> GPT2Tokenizer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">model_dir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    model </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> GPTNeoForCausalLM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">model_dir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    model</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    model</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token builtin" style="color:rgb(130, 170, 255)">eval</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> tokenizer</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">input_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">serialized_input_data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> content_type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> content_type </span><span class="token operator" style="color:rgb(127, 219, 202)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;application/json&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        input_data </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> json</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">serialized_input_data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        text </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> input_data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;text&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> text</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">raise</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Unsupported content type: {}&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token builtin" style="color:rgb(130, 170, 255)">format</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">content_type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">predict_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">input_data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> model_and_tokenizer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    model</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> tokenizer </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> model_and_tokenizer</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    input_ids </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> tokenizer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">input_data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> return_tensors</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;pt&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    output </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">generate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        input_ids</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        max_length</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">150</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        num_return_sequences</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        temperature</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0.7</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        top_k</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">50</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        top_p</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0.95</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    generated_text </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> tokenizer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">output</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> skip_special_tokens</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token boolean" style="color:rgb(255, 88, 116)">True</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> generated_text</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">output_fn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">prediction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> accept</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> accept </span><span class="token operator" style="color:rgb(127, 219, 202)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;application/json&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> json</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;generated_text&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> prediction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> accept</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">raise</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Unsupported accept type: {}&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token builtin" style="color:rgb(130, 170, 255)">format</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">accept</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>retar it, re-upload to s3.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="redeploy-sagemaker-model">Redeploy SageMaker Model<a href="#redeploy-sagemaker-model" class="hash-link" aria-label="Direct link to Redeploy SageMaker Model" title="Direct link to Redeploy SageMaker Model">‚Äã</a></h3>
<p>Here&#x27;s the trick to de-deploying the same endpoint, you just need to add this to the existing <code>deploy.py</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain"># original code</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">from sagemaker.pytorch import PyTorchModel</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">model_data = &quot;s3://ra-aws-s3-lab/gpt-neo-125m-model.tar.gz&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">role = &quot;arn:aws:iam::REDACTED:role/SageMakerExecutionRole&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">pytorch_model = PyTorchModel(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    model_data=model_data,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    role=role,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    framework_version=&quot;1.9.0&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    py_version=&quot;py38&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    entry_point=&quot;inference.py&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">predictor = pytorch_model.deploy(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    instance_type=&quot;ml.m5.large&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    initial_instance_count=1,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # add this oneline</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    update_endpoint=True</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">)</span><br></span></code></pre></div></div>
<p>Run re-deploy: <code>python3 deploy.py</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">~/Repositories/SM-gpt-neo-125m ‚ùØ python3 deploy.py                                           at  16:08:03</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sagemaker.config INFO - Not applying SDK defaults from location: /etc/xdg/xdg-ubuntu/sagemaker/config.yaml</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sagemaker.config INFO - Not applying SDK defaults from location: /home/rxhackk/.config/sagemaker/config.yaml</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">-</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">--------!%</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Ôåõ ÔÅº ~/Repositories/SM-gpt-neo-125m ‚ùØ                                                       took  13m 40s</span><br></span></code></pre></div></div>
<p>only took ‚è±Ô∏è <strong>13m40s</strong> this time.</p>
<p>check endpoints: <code>aws sagemaker list-endpoints --query &quot;Endpoints[*].[EndpointName]&quot; --output table</code></p>
<p>looks like its actually stop up a different endpoint:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">-----------------------------------------------------------</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|                      ListEndpoints                      |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">+---------------------------------------------------------+</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|  pytorch-inference-2024-04-04-03-16-43-017              |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|  pytorch-inference-2024-04-03-10-52-17-710              |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|  huggingface-pytorch-inference-2024-03-07-04-18-07-114  |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|  DEMO-1709699475-cbc3-endpointx                         |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">|  SDXL-v2-1-RAMOS                                        |</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">+---------------------------------------------------------+</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">(END)</span><br></span></code></pre></div></div>
<p>picking the new endpoint in our invoke method</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">aws sagemaker-runtime invoke-endpoint \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --endpoint-name pytorch-inference-2024-04-04-03-16-43-017 \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --cli-binary-format raw-in-base64-out \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --body &#x27;{&quot;text&quot;: &quot;Hi! how are you?&quot;}&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --content-type application/json \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  output.txt</span><br></span></code></pre></div></div>
<p>new output, but probably just as sh! as the previous, think it needs a lot more config attention, but that&#x27;s for another post.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">cat output.txt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{&quot;generated_text&quot;: &quot;Hi! how are you?\n\nI&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m back! I&#x27;m&quot;}%</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting">Troubleshooting<a href="#troubleshooting" class="hash-link" aria-label="Direct link to Troubleshooting" title="Direct link to Troubleshooting">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="python3-deploypy">python3 deploy.py<a href="#python3-deploypy" class="hash-link" aria-label="Direct link to python3 deploy.py" title="Direct link to python3 deploy.py">‚Äã</a></h3>
<p>Deploying the *.tar.gz model package from s3.</p>
<p>Error:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">botocore.exceptions.ClientError: An error occurred (ValidationException) when calling the CreateModel operation: Could not access model data at s3://ra-aws-s3-lab/gpt-neo-125m-model.tar.gz. Please ensure that the role &quot;arn:aws:iam::REDACTED:role/SageMakerExecutionRole&quot; exists and that its trust relationship policy allows the action &quot;sts:AssumeRole&quot; for the service principal &quot;sagemaker.amazonaws.com&quot;. Also ensure that the role has &quot;s3:GetObject&quot; permissions and that the object is located in us-east-1. If your Model uses multiple models or uncompressed models, please ensure that the role has &quot;s3:ListBucket&quot; permission.</span><br></span></code></pre></div></div>
<p>I have double checked my IAM Role, according to each comment in the error message, and my Role is legit. I even tested by attaching Administrator access to the role, and it got the same error.</p>
<p>After reading <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/pytorch/sagemaker.pytorch.html#pytorch-model" target="_blank" rel="noopener noreferrer">SageMaker Python Docs</a> I saw my <code>deploy.py</code> was missing an <code>entry_point</code>.</p>
<p><strong>Solution</strong>: I changed this</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">pytorch_model </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> PyTorchModel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    model_data</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">model_data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    role</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">role</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    framework_version</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;1.9.0&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    py_version</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;py38&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre></div></div>
<p>to this</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">pytorch_model </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> PyTorchModel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    model_data</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">model_data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    role</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">role</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    framework_version</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;1.9.0&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    py_version</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;py38&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    entry_point</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;inference.py&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre></div></div>
<p>And the IAM Role error went away üòí ‚úÖ</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>I don&#x27;t know why a missing parameter for pytorch model setup has to do with tripping on an IAM Role, maybe that&#x27;s just python ü§∑.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="no-such-file-or-directory-inferencepy">No such file or directory: &#x27;inference.py&#x27;<a href="#no-such-file-or-directory-inferencepy" class="hash-link" aria-label="Direct link to No such file or directory: &#x27;inference.py&#x27;" title="Direct link to No such file or directory: &#x27;inference.py&#x27;">‚Äã</a></h3>
<p>error message:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">sagemaker.config INFO - Not applying SDK defaults from location: /etc/xdg/xdg-ubuntu/sagemaker/config.yaml</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">sagemaker.config INFO - Not applying SDK defaults from location: /home/rxhackk/.config/sagemaker/config.yaml</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Traceback (most recent call last):</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  File &quot;/home/rxhackk/Repositories/SM-gpt-neo-125m/deploy.py&quot;, line 14, in &lt;module /&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    predictor = pytorch_model.deploy(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  File &quot;/home/rxhackk/.local/lib/python3.10/site-packages/sagemaker/model.py&quot;, line 1610, in deploy</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    self._create_sagemaker_model(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  File &quot;/home/rxhackk/.local/lib/python3.10/site-packages/sagemaker/model.py&quot;, line 865, in _create_sagemaker_model</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    container_def = self.prepare_container_def(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  File &quot;/home/rxhackk/.local/lib/python3.10/site-packages/sagemaker/pytorch/model.py&quot;, line 319, in prepare_container_def</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    self._upload_code(deploy_key_prefix, repack=self._is_mms_version())</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  File &quot;/home/rxhackk/.local/lib/python3.10/site-packages/sagemaker/model.py&quot;, line 763, in _upload_code</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    utils.repack_model(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  File &quot;/home/rxhackk/.local/lib/python3.10/site-packages/sagemaker/utils.py&quot;, line 548, in repack_model</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    _create_or_update_code_dir(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  File &quot;/home/rxhackk/.local/lib/python3.10/site-packages/sagemaker/utils.py&quot;, line 609, in _create_or_update_code_dir</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    shutil.copy2(inference_script, code_dir)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  File &quot;/usr/lib/python3.10/shutil.py&quot;, line 434, in copy2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    copyfile(src, dst, follow_symlinks=follow_symlinks)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  File &quot;/usr/lib/python3.10/shutil.py&quot;, line 254, in copyfile</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    with open(src, &#x27;rb&#x27;) as fsrc:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">FileNotFoundError: [Errno 2] No such file or directory: &#x27;inference.py&#x27;</span><br></span></code></pre></div></div>
<p><strong>Solution</strong>: for me this was due to an incorrect directory strucuture for the model package I created in <a href="#package-deployment-model">Package Deployment Model</a> (my original instructions, which I&#x27;ve fixed, but this was the step I borked this in).</p>
<p>Make sure you tar just the contents of the model package directory and not create a parent directory, i.e. when you untar or view the archive, you should see the <code>code/</code> directory (where the inference code is) straight away.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="invalid-base64">Invalid base64<a href="#invalid-base64" class="hash-link" aria-label="Direct link to Invalid base64" title="Direct link to Invalid base64">‚Äã</a></h3>
<p>Got this error:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">~/Repositories/SM-gpt-neo-125m ‚ùØ aws sagemaker-runtime invoke-endpoint \                                                                                    ‚úò 254 at ÔÄó 11:52:01</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --endpoint-name pytorch-inference-2024-04-03-10-52-17-710 \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --body &#x27;{&quot;text&quot;: &quot;Hi, LLM!&quot;}&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --content-type application/json output.txt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Invalid base64: &quot;{&quot;text&quot;: &quot;Hi, LLM!&quot;}&quot;</span><br></span></code></pre></div></div>
<p>I asked Claude3 and got these solutions:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">aws sagemaker-runtime invoke-endpoint \          ‚úò 255 at ÔÄó 11:52:39</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --endpoint-name pytorch-inference-2024-04-03-10-52-17-710 \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --body $(echo &#x27;{&quot;text&quot;: &quot;Hi, LLM!&quot;}&#x27; | base64) \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --content-type application/json \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  output.txt</span><br></span></code></pre></div></div>
<p>‚úÖ works.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">aws sagemaker-runtime invoke-endpoint \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --endpoint-name pytorch-inference-2024-04-03-10-52-17-710 \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --cli-binary-format raw-in-base64-out \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --body &#x27;{&quot;text&quot;: &quot;Hi, LLM!&quot;}&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --content-type application/json \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  output.txt</span><br></span></code></pre></div></div>
<p>‚úÖ works.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/ai">ai</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/aws">aws</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/sagemaker">sagemaker</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/llm">llm</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/machine-learning">machine-learning</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/pytorch">pytorch</a></li></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/engineer/AI/DeployLLMToSageMaker.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2026-02-20T20:05:57.000Z" itemprop="dateModified">Feb 20, 2026</time></b> by <b>Ron Amosa</b></span></div></div></footer><div class="newsletterCta_rTTm"><p><span class="emoji_bVKv">üì¨</span> I also write a fortnightly newsletter ‚Äî my thoughts on the machines that educate, empower, and exploit our society.<!-- --> <a href="/subscribe">Subscribe here.</a></p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/engineer/AI/AgenticRagLlamaIndex"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Building Agentic RAG with LlamaIndex - Advanced AI Agent Development</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/engineer/AI/AWSGPT"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">AWS GPT Documentation Assistant - AI-Powered AWS Learning Tool</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#agenda" class="table-of-contents__link toc-highlight">Agenda</a></li><li><a href="#deployment-overview" class="table-of-contents__link toc-highlight">Deployment Overview</a></li><li><a href="#prepare-llm" class="table-of-contents__link toc-highlight">Prepare LLM</a><ul><li><a href="#model-theory" class="table-of-contents__link toc-highlight">Model Theory</a></li><li><a href="#example-stable-diffusion-xl" class="table-of-contents__link toc-highlight">Example Stable Diffusion XL</a></li></ul></li><li><a href="#prepare-llm-model" class="table-of-contents__link toc-highlight">Prepare LLM Model</a><ul><li><a href="#download-llm-from-huggingface" class="table-of-contents__link toc-highlight">Download LLM from HuggingFace</a></li><li><a href="#organise-model-artefacts" class="table-of-contents__link toc-highlight">Organise Model Artefacts</a></li><li><a href="#package-deployment-model" class="table-of-contents__link toc-highlight">Package Deployment Model</a></li></ul></li><li><a href="#deploy-model-to-sagemaker" class="table-of-contents__link toc-highlight">Deploy Model to SageMaker</a><ul><li><a href="#upload-to-s3" class="table-of-contents__link toc-highlight">Upload to s3</a></li><li><a href="#create-role" class="table-of-contents__link toc-highlight">Create Role</a></li><li><a href="#create-endpoint" class="table-of-contents__link toc-highlight">Create Endpoint</a></li></ul></li><li><a href="#test-the-endpoint" class="table-of-contents__link toc-highlight">Test the Endpoint</a><ul><li><a href="#invoke" class="table-of-contents__link toc-highlight">Invoke</a></li></ul></li><li><a href="#bonus-re-deploy-updates-to-your-sagemaker-endpoint" class="table-of-contents__link toc-highlight">Bonus: Re-Deploy Updates to your SageMaker Endpoint</a><ul><li><a href="#redeploy-sagemaker-model" class="table-of-contents__link toc-highlight">Redeploy SageMaker Model</a></li></ul></li><li><a href="#troubleshooting" class="table-of-contents__link toc-highlight">Troubleshooting</a><ul><li><a href="#python3-deploypy" class="table-of-contents__link toc-highlight">python3 deploy.py</a></li><li><a href="#no-such-file-or-directory-inferencepy" class="table-of-contents__link toc-highlight">No such file or directory: &#39;inference.py&#39;</a></li><li><a href="#invalid-base64" class="table-of-contents__link toc-highlight">Invalid base64</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/ron-amosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/ronamosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@uncommonengineer" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Discover</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Analysis &amp; Essays</a></li><li class="footer__item"><a class="footer__link-item" href="/docs">Technical</a></li><li class="footer__item"><a class="footer__link-item" href="/about">About</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Last updated on Fri Feb 20 2026</div></div></div></footer></div>
</body>
</html>