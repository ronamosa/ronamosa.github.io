<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-engineer/LAB/proxmox-packer-vm" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Create Cloud-Init VM Templates with Packer on Proxmox | The Uncommon Engineer</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:image" content="https://www.uncommonengineer.com/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://www.uncommonengineer.com/img/social-card.png"><meta data-rh="true" property="og:url" content="https://www.uncommonengineer.com/docs/engineer/LAB/proxmox-packer-vm"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Create Cloud-Init VM Templates with Packer on Proxmox | The Uncommon Engineer"><meta data-rh="true" name="description" content="Complete guide to automate Proxmox VM template creation using Packer and cloud-init for Infrastructure as Code home lab setup. Includes troubleshooting and best practices."><meta data-rh="true" property="og:description" content="Complete guide to automate Proxmox VM template creation using Packer and cloud-init for Infrastructure as Code home lab setup. Includes troubleshooting and best practices."><meta data-rh="true" name="keywords" content="proxmox,packer,cloud-init,vm template,infrastructure as code,home lab,virtualization,automation"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.uncommonengineer.com/docs/engineer/LAB/proxmox-packer-vm"><link data-rh="true" rel="alternate" href="https://www.uncommonengineer.com/docs/engineer/LAB/proxmox-packer-vm" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.uncommonengineer.com/docs/engineer/LAB/proxmox-packer-vm" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9UFF3RBJQ9-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"üíª Engineer","item":"https://www.uncommonengineer.com/docs/category/-engineer"},{"@type":"ListItem","position":2,"name":"Create Cloud-Init VM Templates with Packer on Proxmox","item":"https://www.uncommonengineer.com/docs/engineer/LAB/proxmox-packer-vm"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="The Uncommon Engineer RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="The Uncommon Engineer Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="The Uncommon Engineer" href="/opensearch.xml">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DMRNTVGLRC"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DMRNTVGLRC",{anonymize_ip:!0})</script>

<script src="/js/console-clue.js"></script>
<script src="/js/metricool.js"></script>
<script src="https://subscribe-forms.beehiiv.com/embed.js" async></script><link rel="stylesheet" href="/assets/css/styles.5170efae.css">
<script src="/assets/js/runtime~main.3d5cd519.js" defer="defer"></script>
<script src="/assets/js/main.727d0b4f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.svg" alt="The Uncommon Engineer" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/profile.svg" alt="The Uncommon Engineer" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Uncommon Engineer</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Technical</a><a class="navbar__item navbar__link" href="/blog/">Analysis &amp; Essays</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/projects/">Projects</a><a class="navbar__item navbar__link" href="/changelog/">Changelog</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">‚ñ∂ Start Here</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/books/reading-list">üìö Books &amp; Papers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/study/SCS-C01/">üìó Study</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/Ô∏è-hacker">üè¥‚Äç‚ò†Ô∏è Hacker</a><button aria-label="Expand sidebar category &#x27;üè¥‚Äç‚ò†Ô∏è Hacker&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/-engineer">üíª Engineer</a><button aria-label="Collapse sidebar category &#x27;üíª Engineer&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/ai">AI</a><button aria-label="Expand sidebar category &#x27;AI&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/Ô∏è-projects">üõ†Ô∏è Projects</a><button aria-label="Expand sidebar category &#x27;üõ†Ô∏è Projects&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/AWS/eks-workshop">AWS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/Azure/2019-07-20-Sonarqube-AzureDisk-PersistentVolume">Azure</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/GCP/2019-11-27-GCP-Install-Ambassador-Helm2">GCP</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/K8s/2019-11-11-Helm-3-Kubernetes-Package-Manager">K8s</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/engineer/LAB">LAB</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB">Home Lab Infrastructure Hub: Complete Setup &amp; Automation Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/proxmox-hub">Proxmox Virtualization Hub: Complete Guide Collection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/pihole-dns">Pi-hole DNS Setup - Network-wide Ad Blocking and DNS Filtering</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/engineer/LAB/proxmox-packer-vm">Create Cloud-Init VM Templates with Packer on Proxmox</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/proxmox-cloudinit">Automate Proxmox VM Deployment with Ansible Cloud-Init Playbooks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/streamdeck-linux">Stream Deck XL Linux Setup - Complete Configuration Guide for Ubuntu</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/Terminal">Ultimate Linux Terminal Setup - Oh My Zsh, Powerlevel10k, and Productivity Tools</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/proxmox-lvm-mount">Mount Proxmox VM Logical Volumes for Direct Filesystem Access</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/pihole-docker-unbound">Pi-hole with Unbound DNS: Complete Docker Setup for Privacy &amp; Ad-Blocking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/setup-cursorai-appimage-gnome">How to Set Up CursorAI AppImage on GNOME Desktop (Linux)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/pihole-compromise">Pihole Checking for Compromise</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/fixing-pihole-unbound-servfail-aws">Fixing SERVFAIL DNS Resolution for AWS Console with Pi-hole + Unbound</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/proxmox-sysad">Proxmox: Systems Administration Notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/proxmox-terraform">Proxmox: Deploying Infrastructure with Terraform</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/Misc/algos-system-design">Misc</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/archive/docker-wordpress/docker-wordpress-1">üóÉ Archive</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/-engineer"><span>üíª Engineer</span></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">LAB</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Create Cloud-Init VM Templates with Packer on Proxmox</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Create Cloud-Init VM Templates with Packer on Proxmox</h1></header><p>I wanted to setup IaC for my home lab Proxmox server to create VM templates first using Packer, and then Terraform for deploying 3-node K8s clusters for demos and learning. I originally followed <a href="https://www.youtube.com/watch?v=1nf3WOEFq1Y" target="_blank" rel="noopener noreferrer">&quot;Christian Lempa&quot;</a> video and <a href="https://github.com/ChristianLempa/boilerplates/tree/main/packer/proxmox" target="_blank" rel="noopener noreferrer">boilerplates</a>, but couldn&#x27;t get them to work so went on a long winding journey trying different configs and reading up on cloud-config, autoinstall and read a bunch of other blogs.</p>
<p>I got it to finally work, which came back to almost the original configs by Christian, but with a lot more understanding.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="related-proxmox-guides">Related Proxmox Guides<a href="#related-proxmox-guides" class="hash-link" aria-label="Direct link to Related Proxmox Guides" title="Direct link to Related Proxmox Guides">‚Äã</a></h2>
<p>üìö <strong>Complete Proxmox Workflow</strong>: This guide is part of a comprehensive Proxmox automation series:</p>
<ul>
<li><strong>Next Step</strong>: <a href="/docs/engineer/LAB/proxmox-cloudinit">Automate VM Deployment with Ansible</a> - Deploy VMs from your templates using Ansible playbooks</li>
<li><strong>Advanced</strong>: <a href="/docs/engineer/LAB/proxmox-terraform">Proxmox Infrastructure with Terraform</a> - Orchestrate entire infrastructure deployments</li>
<li><strong>Troubleshooting</strong>: <a href="/docs/engineer/LAB/proxmox-lvm-mount">Mount VM Logical Volumes</a> - Direct filesystem access for debugging</li>
<li><strong>Complete Collection</strong>: <a href="/docs/engineer/LAB/proxmox-hub">Proxmox Virtualization Hub</a> - All Proxmox guides and best practices</li>
</ul>
<p>üè† <strong>Home Lab Integration</strong>: <a href="/docs/engineer/LAB/home-lab-hub">Home Lab Infrastructure Hub</a> - Complete home lab setup with networking and automation</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="packer-process">Packer Process<a href="#packer-process" class="hash-link" aria-label="Direct link to Packer Process" title="Direct link to Packer Process">‚Äã</a></h2>
<p>This is what the process looks like in a diagram as I understand it:</p>
<p><img decoding="async" loading="lazy" alt="Packer Proxmox VM creation process flow diagram showing Packer API calls, VM creation, cloud-init configuration, and template conversion" src="/assets/images/packer-proxmox-process-f3594e7c2a98e443131a75ebfbd3885f.png" width="690" height="376" class="img_ev3q"></p>
<p>These are the steps:</p>
<ol>
<li><code>packer</code> calls proxmox endpoint, using API Token (<code>variables.pkr.hcl</code>) and a VM template definition file (<code>ubuntu-server-focal.pkr.hcl</code>), and then <code>WAIT</code> for <code>SSH to become available...</code></li>
<li>a VM is create on proxmox</li>
<li>the VM pulls down <code>NFS-SERVER:iso/ubuntu-20.04.3-live-server-amd64.iso</code> and begins the install</li>
<li>with <code>cloud-init=true</code> the VM will boot and run the <code>boot_command</code> to pull down the initial configuration for the blank VM</li>
<li>packer will start a web server on the client machine, to serve the <code>http/user-data</code> file for the proxmox VM to download</li>
<li>this line <code>autoinstall ds=nocloud-net;s=http://\{\{ .HTTPIP \}\}:\{\{ .HTTPPort \}\}/</code> in the <code>boot_command</code> tells the VM where to get the init configs</li>
<li>the <code>http/user-data</code> config will install openssh, and create user <code>rxhackk</code> with public key auth enabled.</li>
<li>when the VM finishes intial install, it will reboot.</li>
<li>once rebooted, <code>packer</code> will ssh into the newly created, rebooted VM, and run the commanmds in <code>provisioner &quot;shell&quot; { inline =[</code> (or at least this is what I think it&#x27;s doing after the reboot and requies a working ssh connection)</li>
<li>when commands are finished, proxmox shuts down the completed VM and converts it into &quot;template&quot; format.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="key-concept">Key Concept<a href="#key-concept" class="hash-link" aria-label="Direct link to Key Concept" title="Direct link to Key Concept">‚Äã</a></h2>
<p>The key thing to understand in the setup, is which ssh or username settings are to be used where, if you mix that up, the you mix up the steps in the diagram and the packer process runs into authN issues with wrong pub_key, or <code>sudo -S</code> that needs an interactive session.</p>
<p>In <code>http/user-data</code> this is where cloud-init will pull in this config, install openssh and configure it for no root access, and public key authN:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">ssh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">install-server</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">allow-pw</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">disable_root</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">ssh_quiet_keygen</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">allow_public_ssh_keys</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><br></span></code></pre></div></div>
<p>Further down in <code>http/user-data</code> you configure the user that&#x27;s going inside the template VM. This is essentially an admin user that will be used to set some things up after the reboot. Note the <code>sudo</code> config to allow this user to run the <code>inline</code> commands in the <code>ubuntu-server-focal.pkr.hcl</code> file that needs root privs:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">user-data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">package_upgrade</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">timezone</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Pacific/Auckland</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">users</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> rxhackk</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">groups</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">adm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> sudo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">lock-passwd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">sudo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ALL=(ALL) NOPASSWD</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">ALL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">shell</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /bin/bash</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">ssh_authorized_keys</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> ssh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDqGjvb1c8rfv2bYNnQaRn8ggOBAUhK5jUhZUTr3dEgZDKl88leX5yBG1RWQOfc/ka/rlv6VrjuwRjy+EB1f98L9bU4JklM+/6iNqka57wrQmWIo852wK7shoDdbz55vIjdcw9S6ok11EYI39FNlVex0IYbhOlEoh/M1b0s= rxhackk@Computer</span><br></span></code></pre></div></div>
<p>That <code>ssh_authorized_keys</code> is the public key <code>~/.ssh/id_rsa.pub</code> for our user rxhackk on the packer client machine.</p>
<p>And finally, to tie it all together, in <code>ubuntu-server-focal.pkr.hcl</code> we specify the user we setup in <code>user-data</code> as the user to SSH to the VM post install and after the reboot, to finish the template setup:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># PACKER SSH Settings</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ssh_username = &quot;rxhackk&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ssh_private_key_file = &quot;~/.ssh/id_rsa&quot;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="proxmox-setup">Proxmox Setup<a href="#proxmox-setup" class="hash-link" aria-label="Direct link to Proxmox Setup" title="Direct link to Proxmox Setup">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-packer-user">Create A Packer user<a href="#create-a-packer-user" class="hash-link" aria-label="Direct link to Create A Packer user" title="Direct link to Create A Packer user">‚Äã</a></h3>
<p>Trying to follow security best practices at all times, we want a user with &quot;least privilege&quot; access to the proxmox API to do what&#x27;s needed to setup VM and no more. I&#x27;m just noting down the steps I followed here and it&#x27;s not a comprehensive step-by-step of the user setup process.</p>
<ol>
<li>login to your proxmox web GUI as <code>root</code></li>
<li>add packer user (ve)</li>
<li>create group Packer</li>
<li>add Group Permissions (PVEAdmin) to group Packer</li>
<li>add user packer to group Packer</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-api-token">Create API Token<a href="#create-api-token" class="hash-link" aria-label="Direct link to Create API Token" title="Direct link to Create API Token">‚Äã</a></h3>
<ol>
<li>login to your proxmox web GUI as <code>root</code></li>
<li>Use new <code>packer</code> user, API Token, no expiry, copy secret.</li>
<li>ensure <code>Privilege Separation</code> is not checked, otherwise this token doesn&#x27;t get the packer users group permissions.</li>
</ol>
<p>update file <code>proxmox-devops/packer/proxmox/variables.pkr.hcl</code> with creds.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain"># Your Proxmox IP Address</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">proxmox_api_url = &quot;https://{proxmox.hostname}:8006/api2/json&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># API Token ID</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">proxmox_api_token_id = &quot;packer@pve!packer&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># API Token Secret</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">proxmox_api_token_secret = &quot;{token_goes_here}&quot;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="packer-folder-structure">Packer Folder Structure<a href="#packer-folder-structure" class="hash-link" aria-label="Direct link to Packer Folder Structure" title="Direct link to Packer Folder Structure">‚Äã</a></h2>
<p>The following folders are found in Christian Lempa&#x27;s packer vm boilerplates repo here: <a href="https://github.com/ChristianLempa/boilerplates/tree/main/packer/proxmox" target="_blank" rel="noopener noreferrer">https://github.com/ChristianLempa/boilerplates/tree/main/packer/proxmox</a></p>
<p>Each OS VM template folder, e.g. <code>ubuntu-server-focal</code> laid out like this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">‚îî‚îÄ‚îÄ ubuntu-server-focal</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ‚îú‚îÄ‚îÄ files</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ‚îÇ   ‚îî‚îÄ‚îÄ 99-pve.cfg</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ‚îú‚îÄ‚îÄ http</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ‚îÇ   ‚îú‚îÄ‚îÄ meta-data</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ‚îÇ   ‚îî‚îÄ‚îÄ user-data</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ‚îú‚îÄ‚îÄ ubuntu-server-focal.pkr.hcl</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ‚îî‚îÄ‚îÄ variables.pkr.hcl</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="variablespkrhcl">variables.pkr.hcl<a href="#variablespkrhcl" class="hash-link" aria-label="Direct link to variables.pkr.hcl" title="Direct link to variables.pkr.hcl">‚Äã</a></h3>
<p>This variables file holds our creds, and presumably other vars to inject into our vm template below:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">proxmox_api_url = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://$\{proxmox.host}:8006/api2/json&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">proxmox_api_token_id = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;packer@pve!packer&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">proxmox_api_token_secret = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;1692cd56-e9aa-413e-9637-84debaa9eff7&quot;</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>I&#x27;m not sold this is the best format after seeing JSON based configs in some blogs that seem a lot simpler.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ubuntu-server-focalpkrhcl">ubuntu-server-focal.pkr.hcl<a href="#ubuntu-server-focalpkrhcl" class="hash-link" aria-label="Direct link to ubuntu-server-focal.pkr.hcl" title="Direct link to ubuntu-server-focal.pkr.hcl">‚Äã</a></h3>
<p>This is our VM template definition file, note the <code>source</code> resource feeds the <code>build</code> process</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain"># Ubuntu Server Focal</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># ---</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Packer Template to create an Ubuntu Server (Focal) on Proxmox</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Variable Definitions</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">variable </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;proxmox_api_url&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    type = string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">variable </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;proxmox_api_token_id&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    type = string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">variable </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;proxmox_api_token_secret&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    type = string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    sensitive = </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Resource Definition for the VM Template</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">source </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;proxmox&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;ubuntu-server-focal-template&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # Proxmox Connection Settings</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    proxmox_url = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;$\{var.proxmox_api_url}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    username = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;$\{var.proxmox_api_token_id}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    token = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;$\{var.proxmox_api_token_secret}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    insecure_skip_tls_verify = </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # VM General Settings</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    node = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;pve1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    vm_id = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;500&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    vm_name = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;ubuntu-server-focal-template&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    template_description = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Ubuntu Server Focal (22.04) Image&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # VM OS Settings</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # (Option </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">) Local ISO File</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    iso_file = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;NFS-SERVER:iso/ubuntu-20.04.3-live-server-amd64.iso&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # - or -</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # (Option </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain">) Download ISO</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # iso_url = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://releases.ubuntu.com/20.04/ubuntu-20.04.3-live-server-amd64.iso&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # iso_checksum = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;f8e3086f3cea0fb3fefb29937ab5ed9d19e767079633960ccb50e76153effc98&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    iso_storage_pool = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;local&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    unmount_iso = </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # VM System Settings</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    qemu_agent = </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # VM Hard Disk Settings</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    scsi_controller = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;virtio-scsi-pci&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    disks </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        disk_size = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;20G&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        format = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;raw&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        storage_pool = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;local-lvm&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        storage_pool_type = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;lvm&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        type = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;virtio&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # VM CPU Settings</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    cores = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # VM Memory Settings</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    memory = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;4096&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # VM Network Settings</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    network_adapters </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        model = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;virtio&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        bridge = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;vmbr0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        firewall = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;false&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # VM Cloud-Init Settings</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    cloud_init = </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    cloud_init_storage_pool = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;local-lvm&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # PACKER Boot Commands</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    boot_command = </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;&lt;esc /&gt;&lt;wait /&gt;&lt;esc /&gt;&lt;wait /&gt;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;&lt;f6 /&gt;&lt;wait /&gt;&lt;esc /&gt;&lt;wait /&gt;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;&lt;bs /&gt;&lt;bs /&gt;&lt;bs /&gt;&lt;bs /&gt;&lt;bs /&gt;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;autoinstall ds=nocloud-net;s=http://\{\{ .HTTPIP \}\}:\{\{ .HTTPPort \}\}/ &quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;--- &lt;enter /&gt;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    boot = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;c&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    boot_wait = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;5s&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # PACKER Autoinstall Settings</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    http_directory = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;http&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    http_bind_address = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;172.16.2.209&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    http_port_min = </span><span class="token number" style="color:rgb(247, 140, 108)">8802</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    http_port_max = </span><span class="token number" style="color:rgb(247, 140, 108)">8802</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # PACKER SSH Settings</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ssh_username = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;rxhackk&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ssh_private_key_file = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;~/.ssh/id_rsa&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # Raise the timeout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> when installation takes longer</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ssh_timeout = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;55m&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Build Definition to create the VM Template</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">build </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;ubuntu-server-focal&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    sources = </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;source.proxmox.ubuntu-server-focal-template&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # Provisioning the VM Template for Cloud-Init Integration in Proxmox #</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    provisioner </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;shell&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        inline = </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;while [ ! -f /var/lib/cloud/instance/boot-finished ]; do echo &#x27;Waiting for cloud-init...&#x27;; sleep 1; done&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;sudo rm /etc/ssh/ssh_host_*&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;sudo truncate -s 0 /etc/machine-id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;sudo apt -y autoremove --purge&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;sudo apt -y clean&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;sudo apt -y autoclean&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;sudo cloud-init clean&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;sudo rm -f /etc/cloud/cloud.cfg.d/subiquity-disable-cloudinit-networking.cfg&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;sudo sync&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # Provisioning the VM Template for Cloud-Init Integration in Proxmox #</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    provisioner </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;file&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        source = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;files/99-pve.cfg&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        destination = </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/tmp/99-pve.cfg&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # Provisioning the VM Template for Cloud-Init Integration in Proxmox #</span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    provisioner </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;shell&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        inline = </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;sudo cp /tmp/99-pve.cfg /etc/cloud/cloud.cfg.d/99-pve.cfg&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="httpuser-data">http/user-data<a href="#httpuser-data" class="hash-link" aria-label="Direct link to http/user-data" title="Direct link to http/user-data">‚Äã</a></h3>
<p>Packer will run a webserver for the proxmox host to connect to and download the following <code>user-data</code> file to configure cloud-init for the new template vm.</p>
<p>This version creates no default user, but sets up my own personal user under <code>user-data</code> with authorized keys (pub), and this user will correspond to the <code>ssh_username</code> and <code>ssh_password</code> in <code>ubuntu-server-focal.pkr.hcl</code> to be used by packer to SSH and run the <code>inline</code> statement:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#cloud-config</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">autoinstall</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">locale</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> en_US</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">keyboard</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">layout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> us</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">updates</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> security</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">apt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">disable_suites</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">security</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">ssh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">install-server</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">allow-pw</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">disable_root</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">ssh_quiet_keygen</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">allow_public_ssh_keys</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">packages</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> qemu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">guest</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">agent</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> sudo</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">layout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> direct</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">swap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">size</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">user-data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">package_upgrade</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">timezone</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Pacific/Auckland</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">users</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> rxhackk</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">groups</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">adm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> sudo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">lock-passwd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">sudo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ALL=(ALL) NOPASSWD</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">ALL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">shell</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /bin/bash</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">ssh_authorized_keys</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> ssh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDqGjvb1c8rfv2bYNnQaRn8ggOBAUhK5jUhZUTr3dEgZDKl88leX5yBG1RWQOfc/ka/rlv6VrjuwRjy+EB1f98L9bU4JklM+/6iNqka57wrQmWIo852wK7shoDdbz55vIjdcw9S6oVx1EYI39FNlVex0IYbhOlEoh/M1b0s= rxhackk@Computer</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="deploy">Deploy<a href="#deploy" class="hash-link" aria-label="Direct link to Deploy" title="Direct link to Deploy">‚Äã</a></h2>
<p>Now nothing left to it, but to do it.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="packer-validate">packer validate<a href="#packer-validate" class="hash-link" aria-label="Direct link to packer validate" title="Direct link to packer validate">‚Äã</a></h3>
<p>Check your configs &amp; definitions are valid:</p>
<p><code>packer validate -var-file=&#x27;./variables.pkr.hcl&#x27; ./ubuntu-server-focal.pkr.hcl</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="packer-build">packer build<a href="#packer-build" class="hash-link" aria-label="Direct link to packer build" title="Direct link to packer build">‚Äã</a></h3>
<p>Build the template:</p>
<p><code>packer build -var-file=&#x27;./variables.pkr.hcl&#x27; ./ubuntu-server-focal.pkr.hcl</code></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Video</div><div class="admonitionContent_BuS1"><p>TBC: I will screen record the process and embed it here.</p></div></div>
<p>This is what success looks like:</p>
<p><img decoding="async" loading="lazy" alt="Packer build success output showing successful Proxmox VM template creation with cloud-init configuration" src="/assets/images/packer-proxmox-success-71d327b8e209c3946b1fbab7b33a86ea.png" width="742" height="119" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting">Troubleshooting<a href="#troubleshooting" class="hash-link" aria-label="Direct link to Troubleshooting" title="Direct link to Troubleshooting">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>ssh settings</div><div class="admonitionContent_BuS1"><p>Most of the issues I ran into was because the ssh details i.e. the openssh server, the ssh user in <code>http/user-data</code> as well as the template definition were all mismatched at different stages. The fixes were getting these parts correct because you can get indirectly related issues as well.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="timeout-waiting-for-ssh">Timeout waiting for SSH<a href="#timeout-waiting-for-ssh" class="hash-link" aria-label="Direct link to Timeout waiting for SSH" title="Direct link to Timeout waiting for SSH">‚Äã</a></h3>
<p>I kept getting this error</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">Ôåõ ÔÅº ~/R/proxmox-devops/packer/proxmox/ubuntu-server-focal ‚ùØ packer build -var-file=&#x27;../variables.pkr.hcl&#x27; ./ubuntu-server-focal.pkr.hcl                     took Ôâí 20m 24s at ÔÄó 23:33:03</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ubuntu-server-focal.proxmox.ubuntu-server-focal-template: output will be in this color.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">==&gt; ubuntu-server-focal.proxmox.ubuntu-server-focal-template: Creating VM</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">==&gt; ubuntu-server-focal.proxmox.ubuntu-server-focal-template: Starting VM</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">==&gt; ubuntu-server-focal.proxmox.ubuntu-server-focal-template: Starting HTTP server on port 8802</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">==&gt; ubuntu-server-focal.proxmox.ubuntu-server-focal-template: Waiting 5s for boot</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">==&gt; ubuntu-server-focal.proxmox.ubuntu-server-focal-template: Typing the boot command</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">==&gt; ubuntu-server-focal.proxmox.ubuntu-server-focal-template: Waiting for SSH to become available...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">==&gt; ubuntu-server-focal.proxmox.ubuntu-server-focal-template: Timeout waiting for SSH.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">==&gt; ubuntu-server-focal.proxmox.ubuntu-server-focal-template: Stopping VM</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">==&gt; ubuntu-server-focal.proxmox.ubuntu-server-focal-template: Deleting VM</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Build &#x27;ubuntu-server-focal.proxmox.ubuntu-server-focal-template&#x27; errored after 20 minutes 23 seconds: Timeout waiting for SSH.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">==&gt; Wait completed after 20 minutes 23 seconds</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">==&gt; Some builds didn&#x27;t complete successfully and had errors:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">--&gt; ubuntu-server-focal.proxmox.ubuntu-server-focal-template: Timeout waiting for SSH.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">==&gt; Builds finished but no artifacts were created.</span><br></span></code></pre></div></div>
<p>This was because the ssh I setup in <code>http/user-data</code> didn&#x27;t match the user in <a href="###ubuntu-server-focal.pkr.hcl">ubuntu-server-focal.pkr.hcl</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="locked-out-of-vm">locked out of vm<a href="#locked-out-of-vm" class="hash-link" aria-label="Direct link to locked out of vm" title="Direct link to locked out of vm">‚Äã</a></h3>
<p>Trying to diagnose the issue with a vm that had no root account, and the user I had setup was locked out, I managed to get into the vm, and when I checked logs <code>/var/log/auth.log</code> I saw this:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">May  6 04:25:56 ubuntu-focal sshd[2336]: Invalid user rxhackk from 172.16.2.209 port 35030</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">May  6 04:25:56 ubuntu-focal sshd[2336]: Connection closed by invalid user rxhackk 172.16.2.209 port 35030 [preauth]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">May  6 04:26:03 ubuntu-focal sshd[2339]: error: kex_exchange_identification: Connection closed by remote host</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">May  6 04:26:03 ubuntu-focal sshd[2340]: Invalid user rxhackk from 172.16.2.209 port 34800</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">May  6 04:26:03 ubuntu-focal sshd[2340]: Connection closed by invalid user rxhackk 172.16.2.209 port 34800 [preauth]</span><br></span></code></pre></div></div>
<p>This whole packer setup relies heavily on the ssh user setup.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="reverse-shell-qm">reverse shell qm<a href="#reverse-shell-qm" class="hash-link" aria-label="Direct link to reverse shell qm" title="Direct link to reverse shell qm">‚Äã</a></h3>
<p>ran listener on desktop <code>rlwrap nc -lvnp 6666</code> and then tried to run <code>qm guest exec 101 &#x27;bash -c &#x27;exec bash -i &amp;&gt;/dev/tcp/172.16.2.209/6666 &lt;&amp;1&#x27;&#x27;</code> on proxmox host.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">‚Äã</a></h2>
<ul>
<li>&quot;Agent not running issues&quot;, see <a href="https://github.com/hashicorp/packer-plugin-proxmox/issues/91" target="_blank" rel="noopener noreferrer">oliviermichaelis</a> comment with the <code>late-commands</code>.</li>
<li>proxmox qemu (qm) commands for diagnosing and troubleshooting vm disks and configs from proxmox host.</li>
<li>Ubuntu <a href="https://ubuntu.com/server/docs/install/autoinstall" target="_blank" rel="noopener noreferrer">autoinstall docs</a></li>
<li>Packer <a href="https://developer.hashicorp.com/packer/plugins/builders/proxmox/clone" target="_blank" rel="noopener noreferrer">proxmox clone docs</a></li>
<li><a href="https://thedatabaseme.de/2022/10/16/what-a-golden-boy-use-packer-to-build-proxmox-images/" target="_blank" rel="noopener noreferrer">What a golden boy ‚Äì Use Packer to build Proxmox images</a> -- great reference for configs.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="appendix">Appendix<a href="#appendix" class="hash-link" aria-label="Direct link to Appendix" title="Direct link to Appendix">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cloud-config-identity">cloud-config Identity<a href="#cloud-config-identity" class="hash-link" aria-label="Direct link to cloud-config Identity" title="Direct link to cloud-config Identity">‚Äã</a></h3>
<p>This <code>cloud-config</code> version creates an <code>ubuntu</code> user with <code>ubuntu</code> password, encrypted format via <code>mkpasswd</code>:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#cloud-config</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">autoinstall</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">locale</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> en_US</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">keyboard</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">layout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> us</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">identity</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">realname</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Ubuntu User&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">username</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">password</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;$y$j9T$Ht7UYyr0iHxvPC9gzZQCl1$mQe.T8pfy6ThzlbEULE0fk71zdofPwKaiZFF0l4VUT1&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">hostname</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">focal</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">ssh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">install-server</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">allow-pw</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">packages</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> qemu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">guest</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">agent</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> sudo</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">layout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> direct</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">swap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">size</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><br></span></code></pre></div></div>
<p>the identity password needs to be in an encrypted format, use <code>mkpasswd</code> to create your password in a valid format. the <code>#cloud-config</code> at the start is a requirement for the file to be recognised as a valid cloud-init config file.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/proxmox">proxmox</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/packer">packer</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/iac">iac</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/virtualization">virtualization</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/home-lab">home-lab</a></li></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/engineer/LAB/proxmox-packer-vm.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2026-02-20T20:05:57.000Z" itemprop="dateModified">Feb 20, 2026</time></b> by <b>Ron Amosa</b></span></div></div></footer><div class="newsletterCta_rTTm"><p><span class="emoji_bVKv">üì¨</span> I also write a fortnightly newsletter ‚Äî my thoughts on the machines that educate, empower, and exploit our society.<!-- --> <a href="/subscribe">Subscribe here.</a></p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/engineer/LAB/pihole-dns"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Pi-hole DNS Setup - Network-wide Ad Blocking and DNS Filtering</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/engineer/LAB/proxmox-cloudinit"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Automate Proxmox VM Deployment with Ansible Cloud-Init Playbooks</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#related-proxmox-guides" class="table-of-contents__link toc-highlight">Related Proxmox Guides</a></li><li><a href="#packer-process" class="table-of-contents__link toc-highlight">Packer Process</a></li><li><a href="#key-concept" class="table-of-contents__link toc-highlight">Key Concept</a></li><li><a href="#proxmox-setup" class="table-of-contents__link toc-highlight">Proxmox Setup</a><ul><li><a href="#create-a-packer-user" class="table-of-contents__link toc-highlight">Create A Packer user</a></li><li><a href="#create-api-token" class="table-of-contents__link toc-highlight">Create API Token</a></li></ul></li><li><a href="#packer-folder-structure" class="table-of-contents__link toc-highlight">Packer Folder Structure</a><ul><li><a href="#variablespkrhcl" class="table-of-contents__link toc-highlight">variables.pkr.hcl</a></li><li><a href="#ubuntu-server-focalpkrhcl" class="table-of-contents__link toc-highlight">ubuntu-server-focal.pkr.hcl</a></li><li><a href="#httpuser-data" class="table-of-contents__link toc-highlight">http/user-data</a></li></ul></li><li><a href="#deploy" class="table-of-contents__link toc-highlight">Deploy</a><ul><li><a href="#packer-validate" class="table-of-contents__link toc-highlight">packer validate</a></li><li><a href="#packer-build" class="table-of-contents__link toc-highlight">packer build</a></li></ul></li><li><a href="#troubleshooting" class="table-of-contents__link toc-highlight">Troubleshooting</a><ul><li><a href="#timeout-waiting-for-ssh" class="table-of-contents__link toc-highlight">Timeout waiting for SSH</a></li><li><a href="#locked-out-of-vm" class="table-of-contents__link toc-highlight">locked out of vm</a></li><li><a href="#reverse-shell-qm" class="table-of-contents__link toc-highlight">reverse shell qm</a></li></ul></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li><li><a href="#appendix" class="table-of-contents__link toc-highlight">Appendix</a><ul><li><a href="#cloud-config-identity" class="table-of-contents__link toc-highlight">cloud-config Identity</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/ron-amosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/ronamosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@uncommonengineer" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Discover</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Analysis &amp; Essays</a></li><li class="footer__item"><a class="footer__link-item" href="/docs">Technical</a></li><li class="footer__item"><a class="footer__link-item" href="/about">About</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Last updated on Fri Feb 20 2026</div></div></div></footer></div>
</body>
</html>