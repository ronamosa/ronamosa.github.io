<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-engineer/LAB/proxmox-cloudinit" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Automate Proxmox VM Deployment with Ansible Cloud-Init Playbooks | The Uncommon Engineer</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:image" content="https://www.uncommonengineer.com/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://www.uncommonengineer.com/img/social-card.png"><meta data-rh="true" property="og:url" content="https://www.uncommonengineer.com/docs/engineer/LAB/proxmox-cloudinit"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Automate Proxmox VM Deployment with Ansible Cloud-Init Playbooks | The Uncommon Engineer"><meta data-rh="true" name="description" content="Step-by-step guide to configure Proxmox for automated VM provisioning using Ansible playbooks and cloud-init templates. Includes API setup and troubleshooting."><meta data-rh="true" property="og:description" content="Step-by-step guide to configure Proxmox for automated VM provisioning using Ansible playbooks and cloud-init templates. Includes API setup and troubleshooting."><meta data-rh="true" name="keywords" content="proxmox,ansible,cloud-init,vm automation,playbooks,infrastructure automation,proxmox api,vm provisioning"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.uncommonengineer.com/docs/engineer/LAB/proxmox-cloudinit"><link data-rh="true" rel="alternate" href="https://www.uncommonengineer.com/docs/engineer/LAB/proxmox-cloudinit" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.uncommonengineer.com/docs/engineer/LAB/proxmox-cloudinit" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9UFF3RBJQ9-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"üíª Engineer","item":"https://www.uncommonengineer.com/docs/category/-engineer"},{"@type":"ListItem","position":2,"name":"Automate Proxmox VM Deployment with Ansible Cloud-Init Playbooks","item":"https://www.uncommonengineer.com/docs/engineer/LAB/proxmox-cloudinit"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="The Uncommon Engineer RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="The Uncommon Engineer Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="The Uncommon Engineer" href="/opensearch.xml">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DMRNTVGLRC"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DMRNTVGLRC",{anonymize_ip:!0})</script>

<script src="/js/console-clue.js"></script>
<script src="/js/metricool.js"></script>
<script src="https://subscribe-forms.beehiiv.com/embed.js" async></script><link rel="stylesheet" href="/assets/css/styles.5170efae.css">
<script src="/assets/js/runtime~main.3d5cd519.js" defer="defer"></script>
<script src="/assets/js/main.727d0b4f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.svg" alt="The Uncommon Engineer" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/profile.svg" alt="The Uncommon Engineer" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Uncommon Engineer</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Technical</a><a class="navbar__item navbar__link" href="/blog/">Analysis &amp; Essays</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/projects/">Projects</a><a class="navbar__item navbar__link" href="/changelog/">Changelog</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">‚ñ∂ Start Here</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/books/reading-list">üìö Books &amp; Papers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/study/SCS-C01/">üìó Study</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/Ô∏è-hacker">üè¥‚Äç‚ò†Ô∏è Hacker</a><button aria-label="Expand sidebar category &#x27;üè¥‚Äç‚ò†Ô∏è Hacker&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/-engineer">üíª Engineer</a><button aria-label="Collapse sidebar category &#x27;üíª Engineer&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/ai">AI</a><button aria-label="Expand sidebar category &#x27;AI&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/Ô∏è-projects">üõ†Ô∏è Projects</a><button aria-label="Expand sidebar category &#x27;üõ†Ô∏è Projects&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/AWS/eks-workshop">AWS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/Azure/2019-07-20-Sonarqube-AzureDisk-PersistentVolume">Azure</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/GCP/2019-11-27-GCP-Install-Ambassador-Helm2">GCP</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/K8s/2019-11-11-Helm-3-Kubernetes-Package-Manager">K8s</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/engineer/LAB">LAB</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB">Home Lab Infrastructure Hub: Complete Setup &amp; Automation Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/proxmox-hub">Proxmox Virtualization Hub: Complete Guide Collection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/pihole-dns">Pi-hole DNS Setup - Network-wide Ad Blocking and DNS Filtering</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/proxmox-packer-vm">Create Cloud-Init VM Templates with Packer on Proxmox</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/engineer/LAB/proxmox-cloudinit">Automate Proxmox VM Deployment with Ansible Cloud-Init Playbooks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/streamdeck-linux">Stream Deck XL Linux Setup - Complete Configuration Guide for Ubuntu</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/Terminal">Ultimate Linux Terminal Setup - Oh My Zsh, Powerlevel10k, and Productivity Tools</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/proxmox-lvm-mount">Mount Proxmox VM Logical Volumes for Direct Filesystem Access</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/pihole-docker-unbound">Pi-hole with Unbound DNS: Complete Docker Setup for Privacy &amp; Ad-Blocking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/setup-cursorai-appimage-gnome">How to Set Up CursorAI AppImage on GNOME Desktop (Linux)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/pihole-compromise">Pihole Checking for Compromise</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/fixing-pihole-unbound-servfail-aws">Fixing SERVFAIL DNS Resolution for AWS Console with Pi-hole + Unbound</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/proxmox-sysad">Proxmox: Systems Administration Notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/LAB/proxmox-terraform">Proxmox: Deploying Infrastructure with Terraform</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/Misc/algos-system-design">Misc</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/archive/docker-wordpress/docker-wordpress-1">üóÉ Archive</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/-engineer"><span>üíª Engineer</span></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">LAB</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Automate Proxmox VM Deployment with Ansible Cloud-Init Playbooks</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Automate Proxmox VM Deployment with Ansible Cloud-Init Playbooks</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">‚Äã</a></h2>
<p>Basically what we&#x27;re trying to setup is a Proxmox Host that can run Ansible playbooks against to create cloud-init enabled virtual machines from a pre-made template we source from official cloud sources.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="related-proxmox-guides">Related Proxmox Guides<a href="#related-proxmox-guides" class="hash-link" aria-label="Direct link to Related Proxmox Guides" title="Direct link to Related Proxmox Guides">‚Äã</a></h2>
<p>üìö <strong>Complete Automation Workflow</strong>: This guide builds on previous Proxmox automation:</p>
<ul>
<li><strong>Prerequisites</strong>: <a href="/docs/engineer/LAB/proxmox-packer-vm">Create VM Templates with Packer</a> - Build the cloud-init templates first</li>
<li><strong>Next Level</strong>: <a href="/docs/engineer/LAB/proxmox-terraform">Infrastructure Orchestration with Terraform</a> - Manage entire environments declaratively</li>
<li><strong>Troubleshooting</strong>: <a href="/docs/engineer/LAB/proxmox-lvm-mount">Mount VM Logical Volumes</a> - Debug VM issues with direct filesystem access</li>
<li><strong>Complete Collection</strong>: <a href="/docs/engineer/LAB/proxmox-hub">Proxmox Virtualization Hub</a> - All Proxmox automation guides</li>
</ul>
<p>üè† <strong>Infrastructure Context</strong>: <a href="/docs/engineer/LAB/home-lab-hub">Home Lab Infrastructure Hub</a> - Complete home lab networking and automation setup</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="systems--architecture-diagram">Systems / Architecture Diagram<a href="#systems--architecture-diagram" class="hash-link" aria-label="Direct link to Systems / Architecture Diagram" title="Direct link to Systems / Architecture Diagram">‚Äã</a></h3>
<p>What you can see here is the following:</p>
<ul>
<li>Ansible desktop client running <code>ansible-playbook</code> with proxmox user api token credentials</li>
<li>a console session as <code>root@pam</code> user which sources an official cloud image and create a cloud-init enabled template from it</li>
<li>the playbook successfully creates <code>clone vm 1</code> and <code>clone vm 2</code> from the template.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Proxmox Ansible automation architecture diagram showing desktop client, Proxmox host with API, and automated VM deployment workflow" src="/assets/images/proxmox-architecture-ca514721e0f49a2222cc67a7958f5bd7.png" width="1287" height="1187" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="proxmox-host-setup">Proxmox Host Setup<a href="#proxmox-host-setup" class="hash-link" aria-label="Direct link to Proxmox Host Setup" title="Direct link to Proxmox Host Setup">‚Äã</a></h2>
<p>Install the following for the Proxmox host to handle requests from the ansible modules <a href="https://docs.ansible.com/ansible/latest/collections/community/general/proxmox_module.html" target="_blank" rel="noopener noreferrer">proxmox</a> and <a href="https://docs.ansible.com/ansible/latest/collections/community/general/proxmox_kvm_module.html" target="_blank" rel="noopener noreferrer">proxmox_kvm</a></p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">apt install -y python-pip3 python3-dev build-essential libguestfs-tools</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">pip3 install virtualenv</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">pip3 install proxmoxer requests</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>Caution</div><div class="admonitionContent_BuS1"><p>tbh I don&#x27;t know if <code>proxmoxer</code> or <code>requests</code> actually do anything with my setup, so ymmv.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="user-api-token">User API Token<a href="#user-api-token" class="hash-link" aria-label="Direct link to User API Token" title="Direct link to User API Token">‚Äã</a></h3>
<p>I&#x27;ve opted to use API tokens instead of my users account credentials for security reasons where you can set an expiry date and also limit permissions on the tokens. Just easier to manage and keep separate from your user.</p>
<p>On your proxmox host, go to <code>Datacenter-&gt; API Tokens</code>:</p>
<p><img decoding="async" loading="lazy" alt="Proxmox datacenter permissions interface showing API token creation and user permission configuration" src="/assets/images/proxmox-apitoken1-adfcdd7bafb27d5ea67b5f2c0232fed4.png" width="410" height="710" class="img_ev3q"></p>
<p>and create a token under your chosen user:</p>
<p><img decoding="async" loading="lazy" alt="Proxmox API token creation dialog with user selection and privilege configuration options" src="/assets/images/proxmox-usertoken-dc7d57513ec4bb8d44feeef9bc0f79e5.png" width="606" height="214" class="img_ev3q"></p>
<p>here are your token id and secret, make a note as you&#x27;ll need them later on in our ansible playbooks:</p>
<p><img decoding="async" loading="lazy" alt="Proxmox generated API token secret display with security warning and copy functionality" src="/assets/images/proxmox-usertokensecret-9298159cdecd3a58c6e858e3ac85fc50.png" width="605" height="192" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>tokenid</div><div class="admonitionContent_BuS1"><p>note the format of the tokenid <code>ansible@pam!ansible_pve_token</code>:</p><ul>
<li>user = <code>ansible@pam</code></li>
<li>id = <code>ansible_pve_token</code></li>
</ul></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cloud-image--customizations">Cloud image + Customizations<a href="#cloud-image--customizations" class="hash-link" aria-label="Direct link to Cloud image + Customizations" title="Direct link to Cloud image + Customizations">‚Äã</a></h3>
<p>You will download and customize a cloud image on the proxmox host, that&#x27;s the easiest most straight-forward way until this step gets automated.</p>
<p>As per <a href="https://daynet236.wordpress.com/2022/01/09/automating-the-creation-of-a-cloud-init-image-for-proxmox/" target="_blank" rel="noopener noreferrer">ianddays blog</a>, you need to have the following files available:</p>
<ul>
<li><code>/root/keys/id_mykeys.pub</code> with the public key you allow to ssh to this image</li>
<li><code>/root/ansible</code> is just a file with the ansible users sudo permissions i.e. just a file with this text: <code>ansible ALL=(ALL) NOPASSWD: ALL</code></li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>machine-id</div><div class="admonitionContent_BuS1"><p>Important note on the <code>machine-id</code> inside the cloud image: the file <code>/etc/machine-id</code> has an ID in it, if you don&#x27;t delete it and leave the file blank before you convert the image to template, the clones you create from the template will all have the same machine-id and be assigned the same network details.</p><p>I added in the <code>&gt;/etc/machine-id</code> command making the <code>machine-id</code> file blank.</p></div></div>
<p>Run these commands on your Proxmox Host:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain"># download cloud-init enabled cloud image -- Ubuntu</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">wget https://cloud-images.ubuntu.com/impish/current/impish-server-cloudimg-amd64.img</span><br></span></code></pre></div></div>
<p>We use <a href="https://libguestfs.org/virt-customize.1.html" target="_blank" rel="noopener noreferrer">virt-customize</a> to modify the disk image <em>in place</em> and add our customizations without needing the image to be running.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Does not have to be run as root, preferrably not according to the authors of the tool.</p></div></div>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain"># customize the image using `virt-customize` provided by libguestfs-tools package.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">virt-customize -a impish-server-cloudimg-amd64.img --update</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">virt-customize -a impish-server-cloudimg-amd64.img --install qemu-guest-agent</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">virt-customize -a impish-server-cloudimg-amd64.img --run-command &#x27;useradd --shell /bin/bash ansible&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">virt-customize -a impish-server-cloudimg-amd64.img --run-command &#x27;mkdir -p /home/ansible/.ssh&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">virt-customize -a impish-server-cloudimg-amd64.img --ssh-inject ansible:file:/root/keys/id_mykeys.pub</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">virt-customize -a impish-server-cloudimg-amd64.img --run-command &#x27;chown -R ansible:ansible /home/ansible&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">virt-customize -a impish-server-cloudimg-amd64.img --upload /root/ansible:/etc/sudoers.d/ansible</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">virt-customize -a impish-server-cloudimg-amd64.img --run-command &#x27;chmod 0440 /etc/sudoers.d/ansible&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">virt-customize -a impish-server-cloudimg-amd64.img --run-command &#x27;chown root:root /etc/sudoers.d/ansible&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">virt-customize -a impish-server-cloudimg-amd64.img --run-command &#x27;&gt;/etc/machine-id&#x27; # important step so your clones get unique mac address / network details.</span><br></span></code></pre></div></div>
<p>Now we create a VM in proxmox and use our customized, cloud-init enabled image as the disk image for the VM:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">#create vm + customize</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">qm create 9000 --name &quot;ubuntu-impish-cloudinit-template&quot; --memory 2048 --cores 2 --net0 virtio,bridge=vmbr0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">qm importdisk 9000 impish-server-cloudimg-amd64.img ZFS01</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">qm set 9000 --scsihw virtio-scsi-pci --scsi0 ZFS01:vm-9000-disk-0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">qm set 9000 --boot c --bootdisk scsi0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">qm set 9000 --ide2 ZFS01:cloudinit</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">qm set 9000 --serial0 socket --vga serial0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">qm set 9000 --agent enabled=1</span><br></span></code></pre></div></div>
<p>Finally, convert to template:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain"># convert vm to template</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">qm template 9000</span><br></span></code></pre></div></div>
<p>You should now have a template in your GUI that looks like this:</p>
<p><img decoding="async" loading="lazy" alt="Proxmox VM list showing cloud-init template VM 9000 with Ubuntu configuration ready for cloning" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQYAAAAZCAIAAABcoBeRAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAPF0lEQVR4nO2ceVCTV7vAT1gGDRCymRCigghCEGxBTSltbQmVxarQglhQCCPlUkBEaloVoSoMQ0REuIoybi2likhZOorWMXQK4lDFpWUATdj3RSAEJCRku3+cfu99vyRE0PLdsTe/YZjzPuc528P7nOcs74DpFkqBHj1vOCqVSlOC+ZdcBVQQAB8hShVajoDRrEuPnjcLrf6A/q2JUqnUmlapVEb/ByPQo+fv49X8AXEDtbTeJfT8k5ktOChRqAn1LqHnnwY6RKhJ1NxAK9pdIi0tTSAQaG2PQqGEhoauXbt2YYajR8/fBhIZAABquwWlUqlQKJRKpUKFkc/MIEUMDAz+rSTCtm3bfv/991YN2Gz2qVOnQkJCamtrtS7RtFJbW8tkMs3NzT08PBoaGqBQIpHExsaSyWQGg1FSUoIo5+XlrVixwsrKKiUlRaFQQGFNTY2rqyuBQNi+fbtQKNTaSmBg4NDQkNasioqK999/f+4dfk2ePXuGx+MXqLijo+O8jA+JiIjgcrmv3CWVSmVpadnY2Ki7b6858FcmIiIiIyMDzvEKhUKhUMjlcrlcLpPJpFKpRCKZnp6empqanJwUiURCoXB0dHR4eHhwcLBvYKh3cPj55MzzFzL0j4FWD1u6dOlKDUxMTDZu3Pjll1+eP3++rq5uLp7a19e3adOmmJiYrq6uiIgILy+v6elpAMCxY8fq6+sfPnyYmZm5c+fO9vZ2AEBNTc2hQ4euXLnC4/EKCwt/+OEHAMCLFy+2bNkSFxfX2Ng4NTW1d+9ezVbu3buHx+MpFMp8J5I50t7ezmQy56hMo9HOnDnzym29ZvEFRXff0LnvvvtuS0uLmsK8zDhHVLOcl0JvAQAcPHjw2rVriP/8b3xQKOQzEhNTPMBg1Mpqdwmt4HA4Y2PjDRs2xMTElJeXNzc3v7TI9evXXV1dIyIiCARCVFQUg8EoKysDAJw7d+7IkSPW1tabN2/esmXLpUuXoDAqKsrd3Z3BYHA4nAsXLgAArl69umrVqsjISCsrKy6Xe+3atcnJSbVWkpKStLrK34VMJuvo6JijMg6HCwkJeeW2XrP4gqK7b+jczs7OGdSCBDIvM84Frf6ACKEPPH/+fGJiQvXvGwkYTAAAmv4A5uUSlpaWra2t2dnZtbW1VCr11q1bJzTIzs6+c+cOUmR6enp8fBx5XLx4sUAgEIlEfX197u7uUOju7g69q6mpSbdw9erVRkZGamZta2vr7Ox0dnYGAPD5/CVLliBZLi4uVVVVAAClUrl//34qlWpra5udnQ1zaTRaU1MTTMfHx6ekpAAAYmJiDh8+vH79ejMzMycnp7q6OqFQ+OGHH46NjS1btkwsFoeEhOTl5cFSpaWlH3zwgZqV2traCAQCAKC4uNjX15fFYpmamr799tv19fXBwcEkEsnPz4/P5wMAEhMTExISXF1dsVism5tbTU0Nuvjk5GRoaCiBQCCTybGxsUqlEtbf2Njo7u6Ow+FYLNbIyIjmnykvL8/e3p5MJoeFhU1MTKCzent7/f39CQSCnZ3d8ePH4dujdUQKheLw4cNLly5dvnx5VlYW1EQPLSgoKDQ0FI/HW1panj9/Hp378ccfDw8Pe3l5QeND1Mz47NkzLy8vPB7v6elZWVkJdRgMRkpKypIlS4hEYlJSUllZmYODg7W1dUZGBgBAJBLh8fjU1FQymUyhUOLi4iQSCSyIwWAAAE+fPvX19SWTyVZWVrt375bL5enp6bdu3eJyuTk5OSqVqqqqKigoyNPTMykpqbu7W9N0kHm4hLOzc2lpqb+/f8Ds+Pv7l5aWIkV8fHyamprKysqmpqaKi4t5PN7IyMjg4CAGg8Hj8VCHRCINDQ0BAAYHB0kkEiIUCoUzMzNoIQCASCRCZYTq6upVq1bp7nldXZ1CoWhqajp79mxqampFRYUO5aysrNzc3IGBgXXr1h08eJBAIFRXVxOJxJ6eHiwWO3dzAQBu376dkJAwMDBAo9GYTGZkZGRra6tYLM7NzYUKp0+f5nA4vb29bDZ78+bN6Ff8+PHjvb29f/75Z3V1dUlJyc8//wzleXl5paWlLS0t/f39+fn5ai2Wl5dzudyioqL79+8PDAx8++236NzAwEAKhcLn84uKik6dOnX58uXZep6fn//999+XlZXdv3//3r17ajaHDb3zzjtDQ0MpKSm7d+9GxwQej0ehUKqqqry8vBAh2owGBgbe3t7e3t4dHR3ffPMNm83+448/oFpNTU1bW1txcXFGRkZ+fv6jR49OnjyZlJQ0PDwMABCJRFVVVY8ePaqurq6trU1NTUV3KSoqyt7evqmp6fbt2zdu3Lhz505SUpKfn9/+/fvj4+P5fD6Hw9m7d29paSn0vdnGPg+X8PHxMTIy0txjqGFoaIgUcXJyKioqOnDgAIVCuXr16qZNm/B4vFKpxGAwGFTMksvlAABkIkTLtQrRj93d3fb29rp7TiKRuFwumUz28fGJjo4uKirSocxisTw8PMzNzcPDw0dHR3XXrBsXFxd/f38cDufv77927VofHx8CgbBlyxahUAgVNm3atGPHDiKRmJCQ4OTkhPZVqVQqFouHh4ednJz6+/u3bt0K5eHh4XQ6nUqlBgQEaHbv4sWLiYmJ69atW7ly5blz5zZs2IBk8fn8hoaG3NxcCoWyfv36r776Cu7WtFJYWHjo0CEmk0mj0U6fPq2pYGFhERcXZ2JiEh0dPTMzo7ma1cEvv/xiaGj49ddfEwgEPz+/gICAH3/8EWYlJCTgcLiNGzdSqdQ9e/aYmZl99tlnZmZmiMWys7Otra0ZDMaxY8cKCwvR1RYUFGRmZlIoFCwWi8fj4UkMAACDwahUqpKSEh8fHyaTaWpqGhwc/NfhkjYW/F4iKCgoKCgIpv38/KhUKpVKVSqV4+PjMM4KhUJLS0sAAJVKHRsbg5pCoRCHw2GxWLQQrYwwMzOzaNEirU0jy0obGxsjo79G6ujoqHk2gF6VIkfMxsbGuoeGlHJwcIDT2N27dxcvXowoIPHN2NiYRqNpVmtnZ4ekHRwc0NE8OTkZAPD555+PjY1t3br1+PHjcE2I7FCNjY2lUqla693d3StXroQKtra2tra2SIV9fX2WlpZIoLOzs+vt7Z1tRH19fUjspdPpOBxOTXPNmjXQpIhhNWlpaYG9tbCw6OzsROTt7e1DQ0PW1taIJDAwECa0WgzdBGIxBweH/v7+v7YEAAAAmpubd+zYIRKJ7Ozs1OZNlUoFQ25AQIChoaGRkZGObs8jSrwCLS0tUVFRsN9SqbS2tpbFYhGJxGXLlj18+BDq1NfXr1mzBgDw1ltv6RYKBAKZTIZ+jQAANBqttbUVeURsMTU1hew6urq6EHlra6uNjY2acmNjI1IDRtuWC41mKT6fLxQKhUIh3NLMnba2NnSaTqcjjy0tLfv27WttbX3y5Mng4OCJEyegHB2ENVu3srLq6emBcoFAkJmZiajR6fTBwUF44gcA6OjosLKymm1Ey5YtQ46MxsfHNYPAS60EALC3t4cdQ/sDAMDS0tLDw6PnX/B4PA6H89LaIIjF2traqFQqYo2xsbHg4OC0tLTGxsby8nI7Ozu4vYYhQqVSkcnknTt3lpaWXrly5dKlS/v27dNa/9joyMK6BJ1OLy8vz8zMHB4eTkhIcHFxgS/Nrl270tPTJyYm7t+/f/PmzfDwcABAZGTkhQsXWlpahoaGcnJyvvjiCwDAtm3bmpubKyoqpqenU1NTt2/fbm5ujm4Cfd5HIBDGx8fLysrkcnlOTo5YLIby58+fJycni0SiX3/99cyZMxEREQAAIpFYWFgolUp/++23u3fv6h6IRCKBjk0kEsvLy8fGxrq6ugoKCl7TPjdv3iwuLp6cnMzPz4dzGJKVlZUVHx8/OjqKwWBkMplMJptLhWFhYSdOnGhoaOjp6UlMTESfCq5atWrNmjWJiYlCofDJkydZWVnQ7FpHFBYWlp6e/vjx49HR0fj4eE0/fCkvXrzQFEIz+vr6NjQ0nDt3TiQS3b59e926dZrxajY4HE5/f39bW9v+/ft37tyJyCcmJpRKpbm5uUKhqKysrKurm56ehkFPLBarVKpPPvnk2rVrjx8/npycrKioQE8WaL6MZC+sS2Cx2JKSksLCQkdHx5GRkRs3bkB5SkrK6tWrHRwcdu3aVVBQADcDH3300dGjR319fdevX799+3Y2mw0AwOFwlZWVaWlpy5cvVygUmutaNzc3lUoF938UCiUnJyc5ORmLxfJ4PA8PD6jDYrF6e3ttbW2jo6OzsrJYLBYAICcn58GDBxYWFuHh4WjjamJra7t69WoSiSQWizkcDpFIXLFihaOjIxLuX5mwsLDCwkI6nZ6fn3/9+nUqlYpkcblcoVBoY2Pj5uZGo9EOHz48lwpDQ0NjY2P9/f2dnZ1NTU2R2AIAwGAwP/30U39//4oVKwIDA3fv3h0WFgYA0Dqi6OhoNpu9detWFxcXBoMx3+8Vtm3b5u3tzePx0ELEjIsWLaqsrCwoKKDT6fHx8WfPnkUOFV9KUFDQe++95+7uzmQyjx49ishtbGyOHDny6aefOjo6VldXJycnp6enCwQCLy+v8+fPnzlzxs3Nbc+ePbm5uWw2+8GDB1rjklQiqf6Vp+Xj8ODg4JMnT6KDOEJYWBj6GEErVVVVavueheby5csCgQBtoDeCxMTERYsWwRNGPS8FHsJKJBITExMoUXt10fdx6rdycjn6VhtCIBCwJCu1VtY6289vey2VSm/evPk6A1sIQkJCvL29JRLJbPtsPf94dFxjo9Mq1BfjWvVP/PfZ+bkEg8F4+vSpbh0HB4d51fn6GBgYfPfddzKZ7M1yCU9PTx3nHnrUMDEx4XA4OnY1mkEDnXipM0A+Yn08v4UTAEAqlcIizc3NXC4XCkNCQvz8/AAAGAwGiWt69CwomhEADbJqUvsWEIFEIqktnHq6uzo72rXMUhYWFgcOHEBLMBiMgYGBoaHhxYsXkTdeJBIhx95isfjNmqH1/D9Ed3wAALQK+HH/tUtLlBCJRPDqR5OX3hPr0fMf42+PEjKZzPPdtfp/R6DnTWW2rTPyuatWl0Acg0gkap44TU5OLOy9hB49/zHULtSRR5hAfuu+dzc3x+ldQs8/gdledLQc8QfdjvE/ZUNwFYNn/KYAAAAASUVORK5CYII=" width="262" height="25" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="create-vms-from-cloud-init-template">Create VMs from cloud-init template<a href="#create-vms-from-cloud-init-template" class="hash-link" aria-label="Direct link to Create VMs from cloud-init template" title="Direct link to Create VMs from cloud-init template">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ansible-playbooks">Ansible Playbooks<a href="#ansible-playbooks" class="hash-link" aria-label="Direct link to Ansible Playbooks" title="Direct link to Ansible Playbooks">‚Äã</a></h3>
<p>I have ansible installed on my desktop and will run the playbooks on my local machine which will call my Proxmox Host/Server, and the proxmoxer module will execute the request and create our vms.</p>
<p>First, simple hosts file setup, in a folder called <code>playbook/</code>, a file named <code>hosts</code>:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">proxmox</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">your.proxmox.host ansible_user=root</span><br></span></code></pre></div></div>
<p>And then, a very simple playbook, let&#x27;s call it <code>playbook/create-cloud-vm.yml</code></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># create-cloud-vm.yml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Deploy our Cloud-init VMs&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> proxmox</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">tasks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Clone cloud</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">init template</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">community.general.proxmox_kvm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">node</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> proxmox</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">vmid</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">9000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">clone</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> gemini</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> cloud</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">api_user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ansible@pam</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">api_token_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ansible_pve_token</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">api_token_secret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 1daf3b05</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">5f94</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">4f10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">b924</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">888ba30b038b</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">api_host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> your.proxmox.host</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ZFS01</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">timeout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">90</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Start VM</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">community.general.proxmox_kvm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">node</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> proxmox</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> cloud</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">api_user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ansible@pam</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">api_token_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ansible_pve_token</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">api_token_secret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 1daf3b05</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">5f94</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">4f10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">b924</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">888ba30b038b</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">api_host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> your.proxmox.host</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">state</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> started</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>SECURITY.SECURITY.SECURITY</div><div class="admonitionContent_BuS1"><p>Obviously!!</p><p><strong>DON&#x27;T</strong> hard code your creds like this and <strong>DO</strong> look into an <code>ansible-vault</code> setup for fetching/injecting creds at runtime so you don&#x27;t have them lying around or accidentally commit to source. Version 2 of this write-up will have a security section at a later date. These are just general notes for now.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="run-playbooks">Run Playbooks<a href="#run-playbooks" class="hash-link" aria-label="Direct link to Run Playbooks" title="Direct link to Run Playbooks">‚Äã</a></h3>
<p>Right, there&#x27;s nothing left to it but to do it, from your local desktop ansible setup, run: <code>ansible-playbook -i hosts playbooks/create-cloud-vm.yml</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="verify">Verify<a href="#verify" class="hash-link" aria-label="Direct link to Verify" title="Direct link to Verify">‚Äã</a></h2>
<p>If everything was setup correctly and more importantly, that <code>cloud init</code> actually did its magic, you will see</p>
<ul>
<li>each cloned VM has a hostname of the vm name you specified in the playbook e.g. <code>cloud-1</code></li>
<li>each cloned VM has a unique IP address and a unique <code>/etc/machine-id</code> number.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting">Troubleshooting<a href="#troubleshooting" class="hash-link" aria-label="Direct link to Troubleshooting" title="Direct link to Troubleshooting">‚Äã</a></h2>
<p>Just some random troubleshooting notes:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="check-the-proxmox-api">Check the Proxmox API<a href="#check-the-proxmox-api" class="hash-link" aria-label="Direct link to Check the Proxmox API" title="Direct link to Check the Proxmox API">‚Äã</a></h3>
<p>Checking Proxmox API is working: <code>curl -k -d &quot;username=root@pam&amp;password=yourpassword&quot; https://10.0.0.1:8006/api2/json/access/ticket</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="proxmox-vm-wont-stop">Proxmox: VM wont stop<a href="#proxmox-vm-wont-stop" class="hash-link" aria-label="Direct link to Proxmox: VM wont stop" title="Direct link to Proxmox: VM wont stop">‚Äã</a></h3>
<ol>
<li>console into the proxmox server</li>
<li>try <code>qemu stop &lt;VMID /&gt;</code></li>
<li>if it says &quot;can&#x27;t lock file &#x27;/var/lock/...&quot; do <code>rm -f /var/lock/....</code> whatever that file is</li>
<li>do <code>qm stop &lt;VIMID /&gt;</code> again.</li>
</ol>
<p>One other place to look for the lock file is <code>/run/lock/qemu-server/*</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">‚Äã</a></h2>
<p>Credit for various parts of the process goes to these folks, some of the docs were not easy to follow, but credit where due:</p>
<ul>
<li><a href="https://daynet236.wordpress.com/2022/01/09/automating-the-creation-of-a-cloud-init-image-for-proxmox/" target="_blank" rel="noopener noreferrer">cloud-init image for proxmox</a>. Useful Rating: 10/10</li>
<li><a href="https://pve.proxmox.com/wiki/Cloud-Init_Support" target="_blank" rel="noopener noreferrer">proxmox wiki</a>. Useful Rating: 9/10</li>
<li><a href="https://blog.dmcindoe.dev/posts/2021-07-31/automating-proxmox-with-ansible/" target="_blank" rel="noopener noreferrer">blog.dmcindoe.dev</a>. Useful Rating: 8/10</li>
<li><a href="https://vectops.com/2020/01/provision-proxmox-vms-with-ansible-quick-and-easy/" target="_blank" rel="noopener noreferrer">vectops blogs</a>. Useful Rating: 7/10</li>
<li><a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#selecting-an-ansible-artifact-and-version-to-install" target="_blank" rel="noopener noreferrer">ansible documentation</a> Usefule Rating: 9/10</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/proxmox">proxmox</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/ansible">ansible</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/automation">automation</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/cloud-init">cloud-init</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/iac">iac</a></li></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/engineer/LAB/proxmox-cloudinit.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2026-02-20T20:05:57.000Z" itemprop="dateModified">Feb 20, 2026</time></b> by <b>Ron Amosa</b></span></div></div></footer><div class="newsletterCta_rTTm"><p><span class="emoji_bVKv">üì¨</span> I also write a fortnightly newsletter ‚Äî my thoughts on the machines that educate, empower, and exploit our society.<!-- --> <a href="/subscribe">Subscribe here.</a></p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/engineer/LAB/proxmox-packer-vm"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Create Cloud-Init VM Templates with Packer on Proxmox</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/engineer/LAB/streamdeck-linux"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Stream Deck XL Linux Setup - Complete Configuration Guide for Ubuntu</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#related-proxmox-guides" class="table-of-contents__link toc-highlight">Related Proxmox Guides</a><ul><li><a href="#systems--architecture-diagram" class="table-of-contents__link toc-highlight">Systems / Architecture Diagram</a></li></ul></li><li><a href="#proxmox-host-setup" class="table-of-contents__link toc-highlight">Proxmox Host Setup</a><ul><li><a href="#user-api-token" class="table-of-contents__link toc-highlight">User API Token</a></li><li><a href="#cloud-image--customizations" class="table-of-contents__link toc-highlight">Cloud image + Customizations</a></li></ul></li><li><a href="#create-vms-from-cloud-init-template" class="table-of-contents__link toc-highlight">Create VMs from cloud-init template</a><ul><li><a href="#ansible-playbooks" class="table-of-contents__link toc-highlight">Ansible Playbooks</a></li><li><a href="#run-playbooks" class="table-of-contents__link toc-highlight">Run Playbooks</a></li></ul></li><li><a href="#verify" class="table-of-contents__link toc-highlight">Verify</a></li><li><a href="#troubleshooting" class="table-of-contents__link toc-highlight">Troubleshooting</a><ul><li><a href="#check-the-proxmox-api" class="table-of-contents__link toc-highlight">Check the Proxmox API</a></li><li><a href="#proxmox-vm-wont-stop" class="table-of-contents__link toc-highlight">Proxmox: VM wont stop</a></li></ul></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/ron-amosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/ronamosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@uncommonengineer" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Discover</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Analysis &amp; Essays</a></li><li class="footer__item"><a class="footer__link-item" href="/docs">Technical</a></li><li class="footer__item"><a class="footer__link-item" href="/about">About</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Last updated on Fri Feb 20 2026</div></div></div></footer></div>
</body>
</html>