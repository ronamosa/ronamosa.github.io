<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-engineer/GCP/2020-05-25-GCE-OS-Login-VM" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Setup Google Compute Engine VM to ssh using OS Login. | The Uncommon Engineer</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ronamosa.io/docs/engineer/GCP/2020-05-25-GCE-OS-Login-VM"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Setup Google Compute Engine VM to ssh using OS Login. | The Uncommon Engineer"><meta data-rh="true" name="description" content="Published Date: 25-MAY-2020"><meta data-rh="true" property="og:description" content="Published Date: 25-MAY-2020"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ronamosa.io/docs/engineer/GCP/2020-05-25-GCE-OS-Login-VM"><link data-rh="true" rel="alternate" href="https://ronamosa.io/docs/engineer/GCP/2020-05-25-GCE-OS-Login-VM" hreflang="en"><link data-rh="true" rel="alternate" href="https://ronamosa.io/docs/engineer/GCP/2020-05-25-GCE-OS-Login-VM" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9UFF3RBJQ9-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"💻 Engineer","item":"https://ronamosa.io/docs/category/-engineer"},{"@type":"ListItem","position":2,"name":"Setup Google Compute Engine VM to ssh using OS Login.","item":"https://ronamosa.io/docs/engineer/GCP/2020-05-25-GCE-OS-Login-VM"}]}</script><link rel="search" type="application/opensearchdescription+xml" title="The Uncommon Engineer" href="/opensearch.xml">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DMRNTVGLRC"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DMRNTVGLRC",{anonymize_ip:!0})</script>

<script src="/js/console-clue.js"></script>
<script src="/js/metricool.js"></script><link rel="stylesheet" href="/assets/css/styles.dd12b5e8.css">
<script src="/assets/js/runtime~main.cb34a51e.js" defer="defer"></script>
<script src="/assets/js/main.fb1c5b66.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="ronamosa.io" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="ronamosa.io" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Uncommon Engineer</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog/">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/projects/">Projects</a><a class="navbar__item navbar__link" href="/changelog/">Changelog</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">▶ Start Here</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/books/reading-list">📚 Books &amp; Papers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/study/SCS-C01/">📗 Study</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/️-hacker">🏴‍☠️ Hacker</a><button aria-label="Expand sidebar category &#x27;🏴‍☠️ Hacker&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/-engineer">💻 Engineer</a><button aria-label="Collapse sidebar category &#x27;💻 Engineer&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/ai">AI</a><button aria-label="Expand sidebar category &#x27;AI&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/️-projects">🛠️ Projects</a><button aria-label="Expand sidebar category &#x27;🛠️ Projects&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/AWS/AWS-EKS-Workshop">AWS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/Azure/2019-07-20-Sonarqube-AzureDisk-PersistentVolume">Azure</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/engineer/GCP/2019-11-27-GCP-Install-Ambassador-Helm2">GCP</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/GCP/2019-11-27-GCP-Install-Ambassador-Helm2">Setup Ambassador API Gateway on GCP.</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/engineer/GCP/2020-05-25-GCE-OS-Login-VM">Setup Google Compute Engine VM to ssh using OS Login.</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/K8s/2019-11-11-Helm-3-Kubernetes-Package-Manager">K8s</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/LAB">LAB</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/Misc/algos-system-design">Misc</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/archive/docker-wordpress/docker-wordpress-1">🗃 Archive</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/-engineer"><span>💻 Engineer</span></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">GCP</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Setup Google Compute Engine VM to ssh using OS Login.</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Setup Google Compute Engine VM to ssh using OS Login.</h1></header><div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Published Date: 25-MAY-2020</p></div></div>
<p>A quick setup for when you&#x27;re firing up GCE VM&#x27;s and dont have to worry about managing and organizing ssh keys to jump into any of them. Setup OS Login for the project and any instance launched automatically allows access with the configure keys (obviously check your security needs).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="objective">Objective<a href="#objective" class="hash-link" aria-label="Direct link to Objective" title="Direct link to Objective">​</a></h2>
<p>To have a simple GCE VM instance you can ssh to easily with the same SSH key to any instance stood up in the project (can disble project-wide enable and do it per-instance using <code>gcloud</code>)</p>
<p>We will be using terraform to do the following:</p>
<ul>
<li>Setup a simple GCE VM</li>
<li>Configure IAM for users to use OS Login method for managing ssh keys</li>
</ul>
<p>Manually upload ssh keys to GCP using <code>gcloud</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="google-api-permissions">Google API permissions<a href="#google-api-permissions" class="hash-link" aria-label="Direct link to Google API permissions" title="Direct link to Google API permissions">​</a></h2>
<p>You will need the following google api&#x27;s enabled if you haven&#x27;t already:</p>
<ul>
<li>cloudapis.googleapis.com             Google Cloud APIs</li>
<li>cloudresourcemanager.googleapis.com  Cloud Resource Manager API</li>
<li>compute.googleapis.com               Compute Engine API</li>
<li>oslogin.googleapis.com               Cloud OS Login API</li>
</ul>
<p>e.g.</p>
<p>find service <code>gcloud services list --available</code>, enable with: <code>gcloud services enable cloudresourcemanager.googleapis.com</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="gcp-service-account">GCP Service Account<a href="#gcp-service-account" class="hash-link" aria-label="Direct link to GCP Service Account" title="Direct link to GCP Service Account">​</a></h2>
<p>For terraform, I created a service account to run commands as <code>terrform</code> user.</p>
<p>Use this bash script to create a service account and a <code>account.json</code> file for that user:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">#!/usr/bin/env bash</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">project=&quot;&lt;your_project_name /&gt;&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">gcloud iam service-accounts create terraform \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --display-name &quot;Terraform Service Account&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --description &quot;Service account to use with Terraform&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">echo &quot;Create IAM policy binding for the Terraform service account&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">gcloud projects add-iam-policy-binding &quot;$\{project}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --member serviceAccount:&quot;terraform@$\{project}.iam.gserviceaccount.com&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --role roles/editor</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">echo &quot;Create IAM service policy key &#x27;account.json&#x27;&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">gcloud iam service-accounts keys create account.json \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --iam-account &quot;terraform@$\{project}.iam.gserviceaccount.com&quot;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="terraform">Terraform<a href="#terraform" class="hash-link" aria-label="Direct link to Terraform" title="Direct link to Terraform">​</a></h2>
<p>Now that we have our <code>account.json</code> key file for our <code>terraform</code> service account we can look at the following <code>main.tf</code> file</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="maintf">main.tf<a href="#maintf" class="hash-link" aria-label="Direct link to main.tf" title="Direct link to main.tf">​</a></h3>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">provider &quot;google&quot; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  credentials = &quot;$\{file(&quot;account.json&quot;)}&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  project = &quot;&lt;your_project_name /&gt;&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  region  = &quot;us-east1&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource &quot;google_compute_instance&quot; &quot;demo&quot; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name         = &quot;oslogin-demo&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  machine_type = &quot;n1-standard-1&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  zone         = &quot;us-east1-c&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags = [&quot;vm&quot;, &quot;login&quot;]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  scheduling{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    on_host_maintenance = &quot;TERMINATE&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  boot_disk {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    initialize_params {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      image = &quot;ubuntu-os-cloud/ubuntu-1604-lts&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      size = 50</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  network_interface {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    network = &quot;default&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    access_config {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  metadata = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    foo = &quot;bar&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Super simple VM, based on ubuntu-16 LTS, all defaults.</p>
<p>Next let&#x27;s look at the OS Login setup</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="oslogintf">oslogin.tf<a href="#oslogintf" class="hash-link" aria-label="Direct link to oslogin.tf" title="Direct link to oslogin.tf">​</a></h3>
<p>The two OS Login roles available are:</p>
<ul>
<li>roles/compute.osLogin (non-root)</li>
<li>roles/compute.osAdminLogin (root available)</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><em>Your terraform user needs the <code>Project IAM Admin</code> role enabled to be able to admin IAM Policy.</em></p></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">gcloud projects add-iam-policy-binding &lt;your_project_name /&gt; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --member serviceAccount:terraform@&lt;your_project_name /&gt;.iam.gserviceaccount.com \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --role roles/resourcemanager.projectIamAdmin</span><br></span></code></pre></div></div>
<p>Terraform for setting up OS Login</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">resource &quot;google_compute_project_metadata_item&quot; &quot;oslogin&quot; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  project = &quot;&lt;your_project_name /&gt;&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  key     = &quot;enable-oslogin&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  value   = &quot;TRUE&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource &quot;google_project_iam_member&quot; &quot;owner_binding&quot; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  project = &quot;&lt;your_project_name /&gt;&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  role    = &quot;roles/compute.osAdminLogin&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  member  = &quot;user:me@mydomain.com&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><em>I&#x27;m using my GCP account owner account as the one that&#x27;s going to login to any GCE instances created in this project, so the syntax is <code>user:...</code> whereas if I were using a service account it would be e.g. <code>serviceAccount:terraform@$\{project}.iam.gserviceaccount.com</code>.</em></p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="upload-your-ssh-keys">Upload your SSH keys<a href="#upload-your-ssh-keys" class="hash-link" aria-label="Direct link to Upload your SSH keys" title="Direct link to Upload your SSH keys">​</a></h3>
<p>This is the important step, upload the PUBLIC KEY of the pair you want to use to ssh into the instances</p>
<p>e.g.</p>
<p><code>gcloud compute os-login ssh-keys add --key-file ~/.ssh/ida_rsa.pub</code></p>
<p><strong>this key will be associated with the GCLOUD USER you are logged in as i.e. not <code>terraform</code></strong></p>
<p>For me, that was my GCP owner account on this project.</p>
<p>You can check your OS Login keys with this command: <code>gcloud compute os-login ssh-keys list</code> or checkout your profile with <code>gcloud compute os-login describe-profile</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="build--ssh">Build &amp; SSH<a href="#build--ssh" class="hash-link" aria-label="Direct link to Build &amp; SSH" title="Direct link to Build &amp; SSH">​</a></h2>
<p>Easy build, no remote statefile needed:</p>
<ul>
<li><code>terraform init</code></li>
<li><code>terraform apply</code></li>
</ul>
<p>build takes about 18s, output looks like this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">google_compute_project_metadata_item.oslogin: Creating...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">google_project_iam_member.owner_binding: Creating...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">google_compute_instance.demo: Creating...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">google_compute_project_metadata_item.oslogin: Still creating... [10s elapsed]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">google_project_iam_member.owner_binding: Still creating... [10s elapsed]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">google_compute_instance.demo: Still creating... [10s elapsed]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">google_project_iam_member.owner_binding: Creation complete after 13s [id=&lt;your_project_name /&gt;/roles/compute.osAdminLogin/user:me@mydomain.com]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">google_compute_project_metadata_item.oslogin: Creation complete after 14s [id=enable-oslogin]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">google_compute_instance.demo: Creation complete after 18s [id=projects/&lt;your_project_name /&gt;/zones/us-east1-c/instances/oslogin-demo]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>Now, if all&#x27;s gone right you will be able to ssh to your new vm.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="get-ip-address--ssh">get ip address &amp; ssh<a href="#get-ip-address--ssh" class="hash-link" aria-label="Direct link to get ip address &amp; ssh" title="Direct link to get ip address &amp; ssh">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">gcloud compute instances list</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">NAME          ZONE        MACHINE_TYPE   PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP    STATUS</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">oslogin-demo  us-east1-c  n1-standard-1               10.142.0.6   34.74.255.103  RUNNING</span><br></span></code></pre></div></div>
<p>if you uploaded your default <code>~/.ssh/id_rsa</code> keys, you can ssh directly like this:</p>
<p><code>ssh me_mydomain_com@34.74.255.103</code></p>
<p>if you created a new key e.g. <code>~/.ssh/newkey</code>, you will ssh like this (<code>-i /private/key</code>):</p>
<p><code>ssh -i ~/.ssh/newkey me_mydomain_com@34.74.255.103</code></p>
<p>And voila:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">Welcome to Ubuntu 16.04.6 LTS (GNU/Linux 4.15.0-1071-gcp x86_64)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"> * Documentation:  https://help.ubuntu.com</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"> * Management:     https://landscape.canonical.com</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"> * Support:        https://ubuntu.com/advantage</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0 packages can be updated.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">0 updates are security updates.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The programs included with the Ubuntu system are free software;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">the exact distribution terms for each program are described in the</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">individual files in /usr/share/doc/*/copyright.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">applicable law.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">The programs included with the Ubuntu system are free software;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">the exact distribution terms for each program are described in the</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">individual files in /usr/share/doc/*/copyright.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">applicable law.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Creating directory &#x27;/home/me_mydomain_com&#x27;.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">groups: cannot find name for group ID 1512007361</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">me_mydomain_com@oslogin-demo:~$</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="https://medium.com/infrastructure-adventures/centralized-ssh-login-to-google-compute-engine-instances-d00f8654f379" target="_blank" rel="noopener noreferrer">Centralized SSH login to Google Compute Engine instances</a></li>
<li><a href="https://www.terraform.io/docs/providers/google/r/compute_instance.html#guest_accelerator" target="_blank" rel="noopener noreferrer">Terraform: Google Compute Instance</a></li>
<li><a href="https://cloud.google.com/compute/docs/instances/connecting-advanced#thirdpartytools" target="_blank" rel="noopener noreferrer">Google: SSH with third party tools</a></li>
<li><a href="https://cloud.google.com/iam/docs/granting-roles-to-service-accounts#gcloud" target="_blank" rel="noopener noreferrer">Google: Granting Roles to Service Accounts</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/engineer/GCP/2020-05-25-GCE-OS-Login-VM.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-09-22T07:31:42.000Z" itemprop="dateModified">Sep 22, 2025</time></b> by <b>Ron Amosa</b></span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/engineer/GCP/2019-11-27-GCP-Install-Ambassador-Helm2"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Setup Ambassador API Gateway on GCP.</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/engineer/K8s/2019-11-11-Helm-3-Kubernetes-Package-Manager"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Helm 3 Complete Guide - Kubernetes Package Manager and Application Deployment</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#objective" class="table-of-contents__link toc-highlight">Objective</a></li><li><a href="#google-api-permissions" class="table-of-contents__link toc-highlight">Google API permissions</a></li><li><a href="#gcp-service-account" class="table-of-contents__link toc-highlight">GCP Service Account</a></li><li><a href="#terraform" class="table-of-contents__link toc-highlight">Terraform</a><ul><li><a href="#maintf" class="table-of-contents__link toc-highlight">main.tf</a></li><li><a href="#oslogintf" class="table-of-contents__link toc-highlight">oslogin.tf</a></li><li><a href="#upload-your-ssh-keys" class="table-of-contents__link toc-highlight">Upload your SSH keys</a></li></ul></li><li><a href="#build--ssh" class="table-of-contents__link toc-highlight">Build &amp; SSH</a><ul><li><a href="#get-ip-address--ssh" class="table-of-contents__link toc-highlight">get ip address &amp; ssh</a></li></ul></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/ron-amosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/ronamosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@uncommonengineer" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Discover</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/docs">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/about">About</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Last updated on Mon Sep 22 2025</div></div></div></footer></div>
</body>
</html>