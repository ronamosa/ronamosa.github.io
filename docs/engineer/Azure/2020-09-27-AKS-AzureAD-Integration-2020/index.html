<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-engineer/Azure/2020-09-27-AKS-AzureAD-Integration-2020" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">AKS Azure AD Integration - Complete Security Setup with Kubernetes RBAC | The Uncommon Engineer</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ronamosa.io/docs/engineer/Azure/2020-09-27-AKS-AzureAD-Integration-2020"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="AKS Azure AD Integration - Complete Security Setup with Kubernetes RBAC | The Uncommon Engineer"><meta data-rh="true" name="description" content="Comprehensive guide to integrating Azure Active Directory (AAD) with AKS for enhanced security. Configure Kubernetes RBAC, user authentication, and access control."><meta data-rh="true" property="og:description" content="Comprehensive guide to integrating Azure Active Directory (AAD) with AKS for enhanced security. Configure Kubernetes RBAC, user authentication, and access control."><meta data-rh="true" name="keywords" content="aks azure ad,kubernetes rbac,aks security,azure active directory,k8s authentication,aks rbac,azure security"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ronamosa.io/docs/engineer/Azure/2020-09-27-AKS-AzureAD-Integration-2020"><link data-rh="true" rel="alternate" href="https://ronamosa.io/docs/engineer/Azure/2020-09-27-AKS-AzureAD-Integration-2020" hreflang="en"><link data-rh="true" rel="alternate" href="https://ronamosa.io/docs/engineer/Azure/2020-09-27-AKS-AzureAD-Integration-2020" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9UFF3RBJQ9-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"💻 Engineer","item":"https://ronamosa.io/docs/category/-engineer"},{"@type":"ListItem","position":2,"name":"AKS Azure AD Integration - Complete Security Setup with Kubernetes RBAC","item":"https://ronamosa.io/docs/engineer/Azure/2020-09-27-AKS-AzureAD-Integration-2020"}]}</script><link rel="search" type="application/opensearchdescription+xml" title="The Uncommon Engineer" href="/opensearch.xml">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DMRNTVGLRC"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DMRNTVGLRC",{anonymize_ip:!0})</script>

<script src="/js/console-clue.js"></script>
<script src="/js/metricool.js"></script><link rel="stylesheet" href="/assets/css/styles.dd12b5e8.css">
<script src="/assets/js/runtime~main.cb34a51e.js" defer="defer"></script>
<script src="/assets/js/main.fb1c5b66.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="ronamosa.io" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="ronamosa.io" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Uncommon Engineer</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog/">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/projects/">Projects</a><a class="navbar__item navbar__link" href="/changelog/">Changelog</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">▶ Start Here</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/books/reading-list">📚 Books &amp; Papers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/study/SCS-C01/">📗 Study</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/️-hacker">🏴‍☠️ Hacker</a><button aria-label="Expand sidebar category &#x27;🏴‍☠️ Hacker&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/-engineer">💻 Engineer</a><button aria-label="Collapse sidebar category &#x27;💻 Engineer&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/ai">AI</a><button aria-label="Expand sidebar category &#x27;AI&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/️-projects">🛠️ Projects</a><button aria-label="Expand sidebar category &#x27;🛠️ Projects&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/AWS/AWS-EKS-Workshop">AWS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/engineer/Azure/2019-07-20-Sonarqube-AzureDisk-PersistentVolume">Azure</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/Azure/2019-07-20-Sonarqube-AzureDisk-PersistentVolume">SonarQube on AKS with Azure Disk - Helm Chart and Persistent Volume Setup</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/Azure/2019-02-12-Azure-Terraform-Lease-Break">Azure Blob Storage Lease Management - Break Terraform State Lock Issues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/Azure/2019-01-28-Azure-Kubernetes-up-and-running-1">Azure Kubernetes Service (AKS) Setup Guide - Part 1: Cluster Creation and Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/Azure/2019-02-04-Azure-Kubernetes-up-and-running-2">Azure Kubernetes Service (AKS) Setup Guide - Part 2: Application Deployment and Services</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/engineer/Azure/2019-02-04-Azure-Kubernetes-up-and-running-3">Azure Kubernetes Service (AKS) Setup Guide - Part 3: Monitoring, Scaling, and Security</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/engineer/Azure/2020-09-27-AKS-AzureAD-Integration-2020">AKS Azure AD Integration - Complete Security Setup with Kubernetes RBAC</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/GCP/2019-11-27-GCP-Install-Ambassador-Helm2">GCP</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/K8s/2019-11-11-Helm-3-Kubernetes-Package-Manager">K8s</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/LAB">LAB</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/engineer/Misc/algos-system-design">Misc</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/archive/docker-wordpress/docker-wordpress-1">🗃 Archive</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/-engineer"><span>💻 Engineer</span></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Azure</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">AKS Azure AD Integration - Complete Security Setup with Kubernetes RBAC</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>AKS Azure AD Integration - Complete Security Setup with Kubernetes RBAC</h1></header><div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Published Date: 27-SEP-2020</p></div></div>
<p>This post is going to look at how to create an Azure AKS Cluster with Azure AD Integration enabled to deploy K8s RBAC policies so your users will only be allowed to do things on the AKS Cluster that is tied to their Azure AD Group, and RBAC policies for those groups.</p>
<blockquote>
<p>Why is this important?</p>
</blockquote>
<p>Security.</p>
<p>You always want to operate your infrastructure/systems/whatever on the principle of <em>&quot;least privilege&quot;</em>, because why have more permissions than is necessary to do your job effectively? There&#x27;s no good reason and usually a lot of bad outcomes for not locking user access down to just what&#x27;s required for that user.</p>
<p>The setup is pretty straight forward, but the magic is in how you implement the controls once your AKS Cluster is now linked into your Azure AD.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="aks-aad-integration">AKS-AAD Integration<a href="#aks-aad-integration" class="hash-link" aria-label="Direct link to AKS-AAD Integration" title="Direct link to AKS-AAD Integration">​</a></h3>
<p>What we&#x27;re actually creating here are authentication and authorization layers to interact with the AKS Cluster.</p>
<p>At a very basic level, to run a command like <code>az aks get-credentials --name prod-cluster --resource-group prod-aks-cluster-rg</code>, you need to first be logged into Azure using <code>az login</code>, get a token that says you can run <code>az aks</code> commands and then pull a kubeconfig file down from Azure:</p>
<p><img decoding="async" loading="lazy" alt="aad-cluster-auth" src="/assets/images/aad-cluster-level-authentication-flow-fa4bdb9e347591c206d7e2eee22464a5.png" width="518" height="242" class="img_ev3q"></p>
<p>The next layer of granularity comes once we have used <code>az login</code>, we have pulled down and merged kubeconfig into our <code>~/.kube/config</code> file (Linux) and now want to run <code>kubectl</code> commands to talk to the AKS Cluster. If you run <code>kubectl</code> and don&#x27;t have a token, you will be prompted to login.</p>
<p>Once you are authenticated successfully, you can start talking to the Kubernetes API Server via <code>kubectl</code>... its at this point you will run into RBAC (Role Base Access Control).</p>
<p>Not to be confused with <a href="https://docs.microsoft.com/en-us/azure/aks/manage-azure-rbac" target="_blank" rel="noopener noreferrer">&#x27;Azure RBAC for Kubernetes Authorization</a> which is where Azure AD Groups have roles assigned to it directly, RBAC for this post is the standard Kubernetes RBAC where we deploy roles &amp; bindings to the cluster and the Kubernetes API will manage the permissions for AAD authenticated users.</p>
<p><img decoding="async" loading="lazy" alt="aad-integration" src="/assets/images/aad-integration-6fe79ad42b2a8daa527b6b5e47c275a8.png" width="712" height="254" class="img_ev3q"></p>
<p>And a more detailed sequence diagram of what&#x27;s happening showing the Auth Webhook Server performing the authorizations</p>
<p><img decoding="async" loading="lazy" alt="aad-auth-flow" src="/assets/images/aad-auth-flow-6ee6528b59c50c8966e82ce5e23a6d88.png" width="1046" height="641" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="components">Components<a href="#components" class="hash-link" aria-label="Direct link to Components" title="Direct link to Components">​</a></h3>
<p>The build involves:</p>
<ul>
<li>1 x Virtual Network (VNET)</li>
<li>1 x AKS Cluster (Kubernetes v1.19.0)<!-- -->
<ul>
<li>Uses custom AKS module (private repo- for now)</li>
</ul>
</li>
<li>1 x Azure AD Group</li>
<li>RBAC Policies to determine who can do what.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="versions">Versions<a href="#versions" class="hash-link" aria-label="Direct link to Versions" title="Direct link to Versions">​</a></h3>
<p>It&#x27;s important you have the following versions, or later of the CLI&#x27;s, or the new feature <code>--enable-aad</code> won&#x27;t work properly</p>
<ul>
<li>az-cli: 2.11.0+</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">az --version</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">azure-cli                         2.12.1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">core                              2.12.1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">telemetry                          1.0.6</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Python location &#x27;/opt/az/bin/python3&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Extensions directory &#x27;/home/darthvaldr/.azure/cliextensions&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Python (Linux) 3.6.10 (default, Sep 28 2020, 08:40:52)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">[GCC 7.5.0]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Legal docs and information: aka.ms/AzureCliLegal</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Your CLI is up-to-date.</span><br></span></code></pre></div></div>
<ul>
<li>kubectl: 1.18.1</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl version</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Client Version: version.Info{Major:&quot;1&quot;, Minor:&quot;18&quot;, GitVersion:&quot;v1.18.2&quot;, GitCommit:&quot;52c56ce7a8272c798dbc29846288d7cd9fbae032&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2020-04-16T11:56:40Z&quot;, GoVersion:&quot;go1.13.9&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="terraform-infrastructure-build">Terraform: Infrastructure build<a href="#terraform-infrastructure-build" class="hash-link" aria-label="Direct link to Terraform: Infrastructure build" title="Direct link to Terraform: Infrastructure build">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="module-custom-azure-vnet">Module: Custom Azure VNET<a href="#module-custom-azure-vnet" class="hash-link" aria-label="Direct link to Module: Custom Azure VNET" title="Direct link to Module: Custom Azure VNET">​</a></h3>
<p>First, get a VNET up and running. I use a custom one from my github repo (private) just to have things done in a specific way, but you can just as easily get one running using the official <a href="https://registry.terraform.io/modules/Azure/vnet/azurerm/2.2.0" target="_blank" rel="noopener noreferrer">&#x27;Terraform Registry: Azure VNET Module&#x27;</a>.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">module </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;vnet&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  source  </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;git::git@github.com:ronamosa/modules.git//azure/network/vnet&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  vnet_name           </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> local</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">vnet_name</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  resource_group_name </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> azurerm_resource_group</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">vnet_resource_group</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location            </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  address_space       </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">address_space</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  dns_servers         </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">dns_servers</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  subnet_prefixes     </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">subnet_prefixes</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  subnet_names        </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">subnet_names</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags                </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">tags</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<p>Everything is pretty standard, but let&#x27;s look at my module for some key information about the network we&#x27;re going to deploy an AKS cluster into</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">resource </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;azurerm_virtual_network&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;vnet&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name                </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">vnet_name</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  resource_group_name </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">resource_group_name</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location            </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  address_space       </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">address_space</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  dns_servers         </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">dns_servers</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags                </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">tags</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;azurerm_subnet&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;subnet&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  count                </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">length</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">subnet_names</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name                 </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">subnet_names</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">count</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  resource_group_name  </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">resource_group_name</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  virtual_network_name </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> azurerm_virtual_network</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">vnet</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  address_prefixes     </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">subnet_prefixes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">count</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<p>Nothing out of the ordinary here, but I have defaults set in <code>variables.tf</code> which holds key information</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">variable </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;address_space&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">type</span><span class="token plain">        </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">list</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  description </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;The address space that is used by the virtual network.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">default</span><span class="token plain">     </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;10.0.0.0/16&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># If no values specified</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> this defaults to Azure DNS</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">variable </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;dns_servers&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  description </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;The DNS servers to be used with vNet.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">default</span><span class="token plain">     </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">variable </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;subnet_prefixes&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  description </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;The address prefix to use for the subnet.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">default</span><span class="token plain">     </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;10.0.0.0/22&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">variable </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;subnet_names&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  description </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;A list of public subnets inside the vNet.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">default</span><span class="token plain">     </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;subnet1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<p>So, our address space is a nice big <code>/16</code> and we cut a <code>/22</code> subnet out of that for which we will pass onto our AKS cluster setup to deploy the worker nodes.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="module-custom-azure-aks">Module: Custom Azure AKS<a href="#module-custom-azure-aks" class="hash-link" aria-label="Direct link to Module: Custom Azure AKS" title="Direct link to Module: Custom Azure AKS">​</a></h3>
<p>Again, a custom module from my private repo - I&#x27;ll explain later why its a custom module - but nothing too far from the official Azure AKS module.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">module </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;aks&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  source         </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;git::git@github.com:ronamosa/modules.git//azure/services/azure_kubernetes_service&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  prefix                  </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">prefix</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location                </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kubernetes_version      </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">kubernetes_version</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  resource_group_name     </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> azurerm_resource_group</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">main</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  vnet_subnet_id          </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">terraform_remote_state</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">vnet</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">outputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">vnet_subnet_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  default_node_pool       </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">default_node_pool</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public_ssh_key          </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">secrethub_secret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">ssh_public_key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">value</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  client_id               </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> module</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">service_principal</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">application_id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  client_secret           </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> module</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">service_principal</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  api_auth_ips            </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">api_auth_ips</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  aad_group_name          </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">aad_group_name</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<p>The key element in the module is <code>aad_group_name</code>- this is the Azure AD Group which will be the integration point of our AKS Cluster into Azure AD.</p>
<p>The code from the AKS module looks like this inside the <code>&quot;azurerm_kubernetes_cluster&quot; {}</code> block:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">data </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;azuread_group&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;aks&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">aad_group_name</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token operator" style="color:rgb(127, 219, 202)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token operator" style="color:rgb(127, 219, 202)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  role_based_access_control </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    enabled </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    azure_active_directory </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      managed </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      admin_group_object_ids </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">azuread_group</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">aks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="modules-issues-with-outputs">Modules: issues with outputs<a href="#modules-issues-with-outputs" class="hash-link" aria-label="Direct link to Modules: issues with outputs" title="Direct link to Modules: issues with outputs">​</a></h3>
<p>I wanted to note something I ran into when using modules and my terraform code in the following layout.</p>
<p>This line <code>vnet_subnet_id = data.terraform_remote_state.vnet.outputs.vnet_subnet_id[0]</code> caused a few headaches as I am using the <code>terraform_remote_state</code> data source imports an external terraform state file of another infrastructure component so I can reference existing infrastructure. It&#x27;s important to make sure the module <code>output.tf</code> externalizes the information from inside the module&#x27;s <code>main.tf</code> because <code>terraform_remote_state</code>&#x27;s &quot;outputs&quot; function can only reference what&#x27;s been defined by the <code>output</code> resource function.</p>
<p>So, this from the vnet module sources <code>output.tf</code> file</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">output </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;vnet_subnet_id&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  description </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;The ids of subnets created inside the new vNet&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  value       </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> azurerm_subnet</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">subnet</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<p>Which is referenced by my infrastructure-as-code setup in my <code>/network</code> folder, which defines the <code>vnet</code> module in its <code>outputs.tf</code> file like this</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">output </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;vnet_subnet_id&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  description </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;The ids of subnets created inside the newl vNet&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  value       </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> module</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">vnet</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">vnet_subnet_id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<p>And can then be referenced by <code>terraform_remote_state</code> like this</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">data </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;terraform_remote_state&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;vnet&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  backend </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;azurerm&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  config </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    resource_group_name  </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;prod-terraform-rg&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    storage_account_name </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;somestorageacc92831&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    container_name       </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;tfstate&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    key                  </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;prod/network/terraform.tfstate&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token operator" style="color:rgb(127, 219, 202)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">vnet_subnet_id </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">terraform_remote_state</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">vnet</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">outputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">vnet_subnet_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre></div></div>
<p>If you see any errors that look like this</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">Error: Incorrect attribute value type</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  on .terraform/modules/aks/azure/services/azure_kubernetes_service/main.tf line 30, in resource &quot;azurerm_kubernetes_cluster&quot; &quot;main&quot;:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  30:     vnet_subnet_id      = var.vnet_subnet_id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    |----------------</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    | var.vnet_subnet_id is tuple with 1 element</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Inappropriate value for attribute &quot;vnet_subnet_id&quot;: string required.</span><br></span></code></pre></div></div>
<p>Check the values of your <code>outputs.tf</code> are passing the appropriate value <code>types</code> through to module references to its final destination.</p>
<p>Now you have completed your build</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">module.aks.azurerm_kubernetes_cluster.main: Still creating... [3m40s elapsed]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">module.aks.azurerm_kubernetes_cluster.main: Still creating... [3m50s elapsed]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">module.aks.azurerm_kubernetes_cluster.main: Still creating... [4m0s elapsed]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">module.aks.azurerm_kubernetes_cluster.main: Still creating... [4m10s elapsed]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">module.aks.azurerm_kubernetes_cluster.main: Creation complete after 4m12s [id=/subscriptions/00bc7eba-0000-4d87-1111-rf29a73dfa/resourcegroups/prod-aks-cluster-rg/providers/Microsoft.ContainerService/managedClusters/prod-cluster]</span><br></span></code></pre></div></div>
<p>I retrieved the kubeconfig with the <code>--admin</code> switch, so I can do a quick check that the nodes are there</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">NAME                           STATUS   ROLES   AGE   VERSION</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">aks-prod-38331632-vmss000000   Ready    agent   86s   v1.19.0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">aks-prod-38331632-vmss000001   Ready    agent   84s   v1.19.0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">aks-prod-38331632-vmss000002   Ready    agent   87s   v1.19.0</span><br></span></code></pre></div></div>
<p>Good.</p>
<p>And from logging into <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">Azure Portal</a> I can see...</p>
<p><img decoding="async" loading="lazy" alt="portal aks" src="/assets/images/aad-portal-aks-3a81fed372ff480196078f7584cafecf.png" width="1215" height="502" class="img_ev3q"></p>
<ul>
<li>AAD Integrated AKS (AKS-managed AAD)</li>
<li>RBAC enabled</li>
<li>also, running latest <code>1.19.0</code> kubernetes version.</li>
</ul>
<p>Now we need to see these authentication and authorization layers in action- we need to see them working to protect the Cluster.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="authentication">Authentication<a href="#authentication" class="hash-link" aria-label="Direct link to Authentication" title="Direct link to Authentication">​</a></h2>
<p>Now that the AKS Cluster is AAD integrated users will need to be logged into Azure to talk to the cluster.</p>
<p>First, pull down a non-admin kubeconfig</p>
<ul>
<li><code>az aks get-credentials --name prod-aks-cluster --resource-group prod-aks-cluster-rg</code></li>
</ul>
<p>Now, when you try to run <code>kubectl</code> commands, AKS will ask you to authenticate:</p>
<p><img decoding="async" loading="lazy" alt="kubectl get nodes" src="data:image/png;base64,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" width="1140" height="48" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="kubectl az login" src="/assets/images/aad-kubectl-azlogin2-be4adffb48012fda1c669a1fc58807ad.png" width="450" height="354" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="kubectl az login" src="/assets/images/aad-kubectl-azlogin3-5b2a866e9addc9d571ba8603ccf22570.png" width="444" height="471" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="kubectl az login" src="/assets/images/aad-kubectl-azlogin4-da993c6a972be53b2b6c572f4f7de2c5.png" width="444" height="350" class="img_ev3q"></p>
<p>But if your account doesn&#x27;t have any permissions to the cluster, it&#x27;s a no-go for you.</p>
<p><img decoding="async" loading="lazy" alt="kubectl az login" src="data:image/png;base64,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" width="521" height="31" class="img_ev3q"></p>
<p>Here&#x27;s the thing though... my login <em>does</em> have permission because its in the Azure AD Group I specified in the AKS build above... so this isn&#x27;t right.</p>
<p>And that error message is not the &quot;you don&#x27;t have the right permission&quot; error, its saying I&#x27;m not authenticated- which I just did successfully before, so what&#x27;s happened to my auth?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="issue-with-azure-ad--kubernetes-v1190">Issue with Azure AD &amp; Kubernetes v1.19.0<a href="#issue-with-azure-ad--kubernetes-v1190" class="hash-link" aria-label="Direct link to Issue with Azure AD &amp; Kubernetes v1.19.0" title="Direct link to Issue with Azure AD &amp; Kubernetes v1.19.0">​</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Update</div><div class="admonitionContent_BuS1"><p>Issue was fixed by <a href="https://github.com/p7t/actus/issues/245" target="_blank" rel="noopener noreferrer">[AKS] Release 2020-10-12 #245</a> -
<em>&quot;Fixed an issue with Managed-AAD and kubernetes v1.19 preview. Closes #1891&quot;</em>.</p></div></div>
<p>So, in the course of building this thing and updating my Terraform code to use the new AKS-AAD integration method, I run into this issue.</p>
<p>I build the same AKS cluster using the terraform code above.</p>
<p>After building with <code>v1.17.1</code> I use the following command to pull down the kubeconfig file as a normal AD user:</p>
<ul>
<li><code>az aks get-credentials --name prod-aks-cluster --resource-group prod-aks-cluster-rg</code></li>
</ul>
<p>I run <code>kgno</code> which is just my alias for <code>kubectl get nodes</code>, and after authenticating (same as above) I can see my nodes:</p>
<p><img decoding="async" loading="lazy" alt="auth 1.17.1" src="/assets/images/auth-v1.17.1-f17c8d98a19b8495d1ad3518c2af4fda.png" width="1013" height="66" class="img_ev3q"></p>
<p>I re-build my AKS cluster with <code>v1.18.6</code>, I can see the same thing</p>
<p><img decoding="async" loading="lazy" alt="auth 1.18.6" src="/assets/images/auth-v1.18.6-326fee97bc579a733f2e19c481896119.png" width="1022" height="68" class="img_ev3q"></p>
<p>However, I re-build again with <code>v1.19.0</code> and get this error:</p>
<p><img decoding="async" loading="lazy" alt="auth 1.19.0" src="/assets/images/auth-v1.19.0-209e3a60393516b424808595824569c8.png" width="1018" height="52" class="img_ev3q"></p>
<p>I&#x27;ve already spent more time on this than I planned so I won&#x27;t go into detail here. I did open an issue <a href="https://github.com/Azure/AKS/issues/1891" target="_blank" rel="noopener noreferrer">#1891</a> on the <a href="https://github.com/Azure/AKS" target="_blank" rel="noopener noreferrer">Azure AKS GitHub Repo</a> for this, so hopefully something comes of it.</p>
<p>In the meantime, <code>v1.18.6</code> works so I&#x27;ll continue with that.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="azure-ad-groups">Azure AD Groups<a href="#azure-ad-groups" class="hash-link" aria-label="Direct link to Azure AD Groups" title="Direct link to Azure AD Groups">​</a></h3>
<p>So far, what we have built and configured here is an AKS Cluster where we have assigned an AAD Group, and anyone who belongs to that group, admin rights to the cluster.</p>
<p>Let&#x27;s setup a few simple, real-world scenarios, where we have 2 Dev Teams working in the cluster in their own namespaces. Dev1 user from Dev Team 1, and Dev2 user from Dev Team 2. They should be able to deploy and query their own namespaces &quot;dev1&quot; and &quot;dev2&quot; respectively, and nothing else.</p>
<p>To summarize:</p>
<ul>
<li>1 x SRE AD Group (cluster admins automatically)</li>
<li>2 x Dev Teams / AD Groups</li>
<li>Dev1 user in Dev Team 1 AD Group</li>
<li>Dev2 user in Dev Team 2 AD Group</li>
<li>2 x namespaces, &quot;dev1&quot; and &quot;dev2&quot;</li>
<li>Dev1 can only CRUD in &quot;dev1&quot; namespace</li>
<li>Dev2 can only CRUD in &quot;dev2&quot; namespace</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="authorization">Authorization<a href="#authorization" class="hash-link" aria-label="Direct link to Authorization" title="Direct link to Authorization">​</a></h2>
<blockquote>
<p>What are our users authorized to do after they&#x27;ve authenticated against the AAD by default?</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-rbac-policies">Kubernetes RBAC Policies<a href="#kubernetes-rbac-policies" class="hash-link" aria-label="Direct link to Kubernetes RBAC Policies" title="Direct link to Kubernetes RBAC Policies">​</a></h3>
<p>RBAC Policies come in 2 parts:</p>
<ul>
<li>1 x Role Definition - what a role can, or cannot do.</li>
<li>1 x Role Binding - where a role applies (i.e. bound to).</li>
</ul>
<p>In Azure portal I have the following AD Groups created (default create, no extra additives)</p>
<p><img decoding="async" loading="lazy" alt="aad groups" src="/assets/images/aad-ad-groups2-d208a95afbe6ef644a4087b5f48c8475.png" width="369" height="141" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="dev1-role-bindingyml">dev1-role-binding.yml<a href="#dev1-role-bindingyml" class="hash-link" aria-label="Direct link to dev1-role-binding.yml" title="Direct link to dev1-role-binding.yml">​</a></h4>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Role</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dev1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">full</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">access</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dev1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">rules</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">apiGroups</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;extensions&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;apps&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;*&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">verbs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;*&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">apiGroups</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;batch&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> jobs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> cronjobs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">verbs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;*&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> RoleBinding</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dev1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">access</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dev1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">roleRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">apiGroup</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Role</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dev1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">full</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">access</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">subjects</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dev1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> cefXXXXX</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">XXXX</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">XXXX</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">9768</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">0a6c83e39e91</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="dev2-role-bindingyml">dev2-role-binding.yml<a href="#dev2-role-bindingyml" class="hash-link" aria-label="Direct link to dev2-role-binding.yml" title="Direct link to dev2-role-binding.yml">​</a></h4>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Role</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dev2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">full</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">access</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dev2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">rules</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">apiGroups</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;extensions&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;apps&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;*&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">verbs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;*&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">apiGroups</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;batch&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> jobs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> cronjobs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">verbs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;*&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> RoleBinding</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dev2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">access</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dev2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">roleRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">apiGroup</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Role</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dev2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">full</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">access</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">subjects</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dev2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 5c9624fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">4808</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">a8xx518xxx2d</span><br></span></code></pre></div></div>
<p>Create the two <code>dev</code> namespaces</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">$ kubectl create ns dev1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace/dev1 created</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">$ kubectl create ns dev2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace/dev2 created</span><br></span></code></pre></div></div>
<p>Apply RBAC policy (role &amp; binding)</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">$ kubectl apply -f dev1-role-binding.yml</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">role.rbac.authorization.k8s.io/dev1-user-full-access created</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">rolebinding.rbac.authorization.k8s.io/dev1-user-access created</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">$ kubectl apply -f dev2-role-binding.yml</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">role.rbac.authorization.k8s.io/dev2-user-full-access created</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">rolebinding.rbac.authorization.k8s.io/dev2-user-access created</span><br></span></code></pre></div></div>
<p>Check...</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">$ kubectl get role -n dev1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">NAME                    CREATED AT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dev1-user-full-access   2020-10-07T12:03:39Z</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">$ kubectl get role -n dev2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">NAME                    CREATED AT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dev2-user-full-access   2020-10-07T12:07:27Z</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="test-rbac-policies">Test RBAC Policies<a href="#test-rbac-policies" class="hash-link" aria-label="Direct link to Test RBAC Policies" title="Direct link to Test RBAC Policies">​</a></h3>
<p>Login as <code>dev1</code> user and query pods in dev1 namespace</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">$ kubectl -n dev1 get pods</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code Q6GR3KMGL to authenticate.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">No resources found in dev1 namespace.</span><br></span></code></pre></div></div>
<p>There&#x27;s a cool feature of <code>kubectl</code> where you can basically ask the AKS cluster what you&#x27;re allowed to do e.g. at the moment I&#x27;m logged in as the <code>dev1</code> user so I ask the cluster (via kubectl)</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl auth can-i create pods</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">no</span><br></span></code></pre></div></div>
<blockquote>
<p>Why no?</p>
</blockquote>
<p>Because without a <code>-n</code> switch, the namespace will default to <code>&#x27;default&#x27;</code> and as <code>dev1</code> user, I don&#x27;t actually have any permission to the default namespace.</p>
<p>Next question</p>
<blockquote>
<p>Can I create pods in dev1 namespace?</p>
</blockquote>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl auth can-i create pods -n dev1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">yes</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl auth can-i delete pods -n dev1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">yes</span><br></span></code></pre></div></div>
<p>Ok, so &quot;yes&quot; I&#x27;m allowed to create and delete pods in <code>dev1</code> namespace.</p>
<p>Let&#x27;s try it.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">$ kubectl run nginx-dev1 --image=nginx --namespace dev1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">pod/nginx-dev1 created</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">$ kubectl -n dev1 get pods</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">NAME         READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">nginx-dev1   1/1     Running   0          22s</span><br></span></code></pre></div></div>
<p>Looks good. What can we do in <code>dev2</code>?</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">$ kubectl auth can-i create pods -n dev2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">no</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">$ kubectl auth can-i get pods -n dev2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">no</span><br></span></code></pre></div></div>
<p>As <code>dev1</code> user, I&#x27;m not allowed to create or even &quot;get&quot; pods from namespace dev2.</p>
<p>Let&#x27;s try it.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl run nginx-dev2 --image=nginx --namespace dev2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Error from server (Forbidden): pods is forbidden: User &quot;dev1@xxxxxxxx.onmicrosoft.com&quot; cannot create resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;dev2&quot;</span><br></span></code></pre></div></div>
<p>Perfect! We&#x27;re allowed to work where we&#x27;re supposed to and forbidden from doing things to areas we&#x27;re not allowed to.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary-1">Summary<a href="#summary-1" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2>
<p>This was just a simple Azure AD and RBAC demonstration to leverage the new &quot;managed aad&quot; feature for AKS integration. It shows specific details around the AKS build, and then the RBAC policies and how they&#x27;re deployed and tested to provide a secure, managed Kubernetes environment for multiple teams.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/aks/managed-aad" target="_blank" rel="noopener noreferrer">Managed AAD Integration</a></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/aks/azure-ad-rbac?toc=https%3A%2F%2Fdocs.microsoft.com%2Fen-us%2Fazure%2Faks%2Ftoc.json&amp;bc=https%3A%2F%2Fdocs.microsoft.com%2Fen-us%2Fazure%2Fbread%2Ftoc.json" target="_blank" rel="noopener noreferrer">Kubernetes RBAC for AAD User Groups</a></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/aks/concepts-identity" target="_blank" rel="noopener noreferrer">Azure: Identity Concepts</a></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/aks/operator-best-practices-identity" target="_blank" rel="noopener noreferrer">Azure: Operator Best Practices</a></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/aks/control-kubeconfig-access" target="_blank" rel="noopener noreferrer">Restrict kubeconfig Access</a></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/aks/azure-ad-rbac?toc=https%3A%2F%2Fdocs.microsoft.com%2Fen-us%2Fazure%2Faks%2Ftoc.json&amp;bc=https%3A%2F%2Fdocs.microsoft.com%2Fen-us%2Fazure%2Fbread%2Ftoc.json" target="_blank" rel="noopener noreferrer">Control access to cluster resources using role-based access control and Azure Active Directory identities in Azure Kubernetes Service</a></p>
</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/azure">azure</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/aks">aks</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/security">security</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/azure-ad">azure-ad</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/rbac">rbac</a></li></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/engineer/Azure/2020-09-27-AKS-AzureAD-Integration-2020.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-09-22T07:31:42.000Z" itemprop="dateModified">Sep 22, 2025</time></b> by <b>Ron Amosa</b></span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/engineer/Azure/2019-02-04-Azure-Kubernetes-up-and-running-3"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Azure Kubernetes Service (AKS) Setup Guide - Part 3: Monitoring, Scaling, and Security</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/engineer/GCP/2019-11-27-GCP-Install-Ambassador-Helm2"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Setup Ambassador API Gateway on GCP.</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a><ul><li><a href="#aks-aad-integration" class="table-of-contents__link toc-highlight">AKS-AAD Integration</a></li><li><a href="#components" class="table-of-contents__link toc-highlight">Components</a></li><li><a href="#versions" class="table-of-contents__link toc-highlight">Versions</a></li></ul></li><li><a href="#terraform-infrastructure-build" class="table-of-contents__link toc-highlight">Terraform: Infrastructure build</a><ul><li><a href="#module-custom-azure-vnet" class="table-of-contents__link toc-highlight">Module: Custom Azure VNET</a></li><li><a href="#module-custom-azure-aks" class="table-of-contents__link toc-highlight">Module: Custom Azure AKS</a></li><li><a href="#modules-issues-with-outputs" class="table-of-contents__link toc-highlight">Modules: issues with outputs</a></li></ul></li><li><a href="#authentication" class="table-of-contents__link toc-highlight">Authentication</a></li><li><a href="#issue-with-azure-ad--kubernetes-v1190" class="table-of-contents__link toc-highlight">Issue with Azure AD &amp; Kubernetes v1.19.0</a><ul><li><a href="#azure-ad-groups" class="table-of-contents__link toc-highlight">Azure AD Groups</a></li></ul></li><li><a href="#authorization" class="table-of-contents__link toc-highlight">Authorization</a><ul><li><a href="#kubernetes-rbac-policies" class="table-of-contents__link toc-highlight">Kubernetes RBAC Policies</a></li><li><a href="#test-rbac-policies" class="table-of-contents__link toc-highlight">Test RBAC Policies</a></li></ul></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li><li><a href="#summary-1" class="table-of-contents__link toc-highlight">Summary</a></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/ron-amosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/ronamosa/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@uncommonengineer" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Discover</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/docs">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/about">About</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Last updated on Mon Sep 22 2025</div></div></div></footer></div>
</body>
</html>