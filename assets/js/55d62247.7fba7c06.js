"use strict";(self.webpackChunkronamosa_github_io=self.webpackChunkronamosa_github_io||[]).push([[7172],{3322:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"archive/2017-10-20-NGINX-Centos7-SELinux","title":"NGINX on CentOS 7 with SELinux issues","description":"Quick setup of NGINX on CentOS 7, enable firewall and fix a few SELinux issues.","source":"@site/docs/archive/2017-10-20-NGINX-Centos7-SELinux.md","sourceDirName":"archive","slug":"/archive/2017-10-20-NGINX-Centos7-SELinux","permalink":"/docs/archive/2017-10-20-NGINX-Centos7-SELinux","draft":false,"unlisted":false,"editUrl":"https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/archive/2017-10-20-NGINX-Centos7-SELinux.md","tags":[],"version":"current","lastUpdatedBy":"Ron Amosa","lastUpdatedAt":1758526302000,"frontMatter":{"title":"NGINX on CentOS 7 with SELinux issues"},"sidebar":"docsSidebar","previous":{"title":"Docker Private Registry 2.0","permalink":"/docs/archive/2017-10-13-Docker_Private_Registry_v2.0"},"next":{"title":"Setup a Jenkins Server on CentOS 7","permalink":"/docs/archive/2017-10-21-Jenkins_Setup_CentOS7"}}');var r=s(74848),t=s(28453);const o={title:"NGINX on CentOS 7 with SELinux issues"},a=void 0,l={},c=[{value:"install nginx from epel-release",id:"install-nginx-from-epel-release",level:2},{value:"enable firewall-cmd",id:"enable-firewall-cmd",level:2},{value:"setup user-based website space",id:"setup-user-based-website-space",level:2},{value:"setup NGINX for &#39;VirtualHosts&#39; aka Server Blocks",id:"setup-nginx-for-virtualhosts-aka-server-blocks",level:2},{value:"configure NGINX",id:"configure-nginx",level:2},{value:"create block for the jekyll site",id:"create-block-for-the-jekyll-site",level:2},{value:"create symlink",id:"create-symlink",level:2},{value:"restart nginx",id:"restart-nginx",level:2},{value:"SELinux issues",id:"selinux-issues",level:2},{value:"References",id:"references",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"Quick setup of NGINX on CentOS 7, enable firewall and fix a few SELinux issues."}),"\n",(0,r.jsxs)(n.p,{children:["Sometimes you just need a quick reference of the last time you did something seemingly easy but every time you come back to it you're like... wtf?! Anyway, ",(0,r.jsx)(n.strong,{children:"notes"})," for those times."]}),"\n",(0,r.jsx)(n.h2,{id:"install-nginx-from-epel-release",children:"install nginx from epel-release"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"yum install epel-release\nyum -y install nginx\nservice nginx start\nsystemctl enable nginx\n"})}),"\n",(0,r.jsx)(n.h2,{id:"enable-firewall-cmd",children:"enable firewall-cmd"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo firewall-cmd --permanent --zone=public --add-service=http\nsudo firewall-cmd --permanent --zone=public --add-service=https\nsudo firewall-cmd --reload\n"})}),"\n",(0,r.jsx)(n.h2,{id:"setup-user-based-website-space",children:"setup user-based website space"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"useradd ron.amosa\npasswd ron.amosa\nmkdir -p /var/www/ronamosa.com/public_html\nchown -R ron.amosa:ron.amosa /var/www/ronamosa.com/public_html\n"})}),"\n",(0,r.jsx)(n.h2,{id:"setup-nginx-for-virtualhosts-aka-server-blocks",children:"setup NGINX for 'VirtualHosts' aka Server Blocks"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"mkdir /etc/nginx/sites-available\nmkdir /etc/nginx/sites-enabled\n"})}),"\n",(0,r.jsx)(n.h2,{id:"configure-nginx",children:"configure NGINX"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"vim /etc/nginx/nginx.conf\n"})}),"\n",(0,r.jsxs)(n.p,{children:["add after the '",(0,r.jsx)(n.em,{children:"http"}),"' block:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"include /etc/nginx/sites-enabled/*.conf;\nserver_names_hash_bucket_size 64;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"create-block-for-the-jekyll-site",children:"create block for the jekyll site"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"vim /etc/nginx/sites-available/ronamosa.com.conf\n"})}),"\n",(0,r.jsx)(n.p,{children:"add this"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"server {\n  listen       80;\n  server_name  ronamosa.com www.ronamosa.com;\n  location / {\n    root   /var/www/ronamosa.com/public_html;\n    index  index.html index.htm;\n    try_files $uri $uri/ =404;\n  }    \n  error_page   500 502 503 504  /50x.html;\n  location = /50x.html {\n    root   html;\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"create-symlink",children:"create symlink"}),"\n",(0,r.jsxs)(n.p,{children:["this will connect available sites to enabled sites:\n",(0,r.jsx)(n.code,{children:"ln -s /etc/nginx/sites-available/ronamosa.com.conf /etc/nginx/sites-enabled/ronamosa.com.conf"})]}),"\n",(0,r.jsx)(n.h2,{id:"restart-nginx",children:"restart nginx"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"systemctl restart nginx"})}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsxs)(n.p,{children:["You need to either add the FQDN to your /etc/hosts local to where you're calling/testing from, or hax your DNS server to point (exmple) ",(0,r.jsx)(n.a,{href:"http://www.nginx.com",children:"www.nginx.com"})," to your new local.nginx.com site **"]})}),"\n",(0,r.jsx)(n.h2,{id:"selinux-issues",children:"SELinux issues"}),"\n",(0,r.jsxs)(n.p,{children:["error : you get a ",(0,r.jsx)(n.code,{children:"403 Forbidden"})," when you try to browse to"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'[root@nginx ~]# tail /var/log/nginx/error.log\n2017/10/20 18:39:26 [error] 1699#0: *14 "/var/www/ronamosa.com/public_html/index.html" is forbidden (13: Permission denied), client: 172.16.45.15, server: ronamosa.com, request: "GET / HTTP/1.1", host: "www.ronamosa.com"\n'})}),"\n",(0,r.jsx)(n.p,{children:"get 'setools':"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"yum install -y setools"})}),"\n",(0,r.jsx)(n.p,{children:"get semanage (comes with audit2allow):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"[root@nginx ~]# yum provides /usr/sbin/semanage\nLoaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\n * base: ftp.wicks.co.nz\n * epel: mirror.xnet.co.nz\n * extras: ftp.wicks.co.nz\n * updates: ftp.wicks.co.nz\npolicycoreutils-python-2.5-17.1.el7.x86_64 : SELinux policy core python utilities\nRepo        : base\nMatched from:\nFilename    : /usr/sbin/semanage\n\n[root@nginx ~]# yum install -y policycoreutils-python-2.5-17.1.el7.x86_64\n"})}),"\n",(0,r.jsx)(n.p,{children:"find selinux errors in log, use audit2allow to format out a fix:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"[root@nginx ~]# grep nginx /var/log/audit/audit.log | audit2allow -m nginx > nginx"})}),"\n",(0,r.jsx)(n.p,{children:"check the output:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"[root@nginx ~]# cat nginx\n\nmodule nginx 1.0;\n\nrequire {\n        type httpd_t;\n        type var_t;\n        class file { getattr open read };\n}\n\n#============= httpd_t ==============\n\n#!!!! WARNING: 'var_t' is a base type.\n#!!!! The file '/var/www/ronamosa.com/public_html/index.html' is mislabeled on your system.\n#!!!! Fix with $ restorecon -R -v /var/www/ronamosa.com/public_html/index.html\nallow httpd_t var_t:file { getattr open read };\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.em,{children:(0,r.jsxs)(n.strong,{children:["note: see the WARNING here? you can follow the recommendation and use ",(0,r.jsx)(n.code,{children:"restorecon"}),"... I didnt and that's my mistake in hindsight. you live, you learn right? ;)"]})})}),"\n",(0,r.jsxs)(n.p,{children:["create an compiled policy with the ",(0,r.jsx)(n.code,{children:"-M"})," option:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"grep nginx /var/log/audit/audit.log | audit2allow -M nginx\n******************** IMPORTANT ***********************\nTo make this policy package active, execute:\n\nsemodule -i nginx.pp\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"let's do it, and then check its installed :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"[root@nginx ~]# semodule -i nginx.pp\n[root@nginx ~]# semodule -l | grep nginx\nnginx   1.0\n"})}),"\n",(0,r.jsxs)(n.p,{children:["go back to ",(0,r.jsx)(n.a,{href:"http://www.ronamosa.com",children:"www.ronamosa.com"})," and voila, its working :)"]}),"\n",(0,r.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,r.jsx)(n.admonition,{type:"info",children:(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.nginx.com/blog/nginx-se-linux-changes-upgrading-rhel-6-6/",children:"nginx and selinux"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.godaddy.com/garage/tech/config/how-to-install-and-configure-nginx-on-centos-7/",children:"nginx on centos-7"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://jekyllrb.com/docs/deployment-methods/",children:"Jekyll Documentation"})}),"\n"]})})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>a});var i=s(96540);const r={},t=i.createContext(r);function o(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);