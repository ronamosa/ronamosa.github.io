"use strict";(self.webpackChunkronamosa_github_io=self.webpackChunkronamosa_github_io||[]).push([[27064],{12063:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>d,frontMatter:()=>o,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"archive/2016-02-13-Ansible-CreateVMs-Vsphere-free_version","title":"Creating VM\'s using Ansible and ESXi 5.5 Free Version.","description":"Use Ansible to deploy a virtual machine instance on ESXi 5.5, free version.","source":"@site/docs/archive/2016-02-13-Ansible-CreateVMs-Vsphere-free_version.md","sourceDirName":"archive","slug":"/archive/2016-02-13-Ansible-CreateVMs-Vsphere-free_version","permalink":"/docs/archive/2016-02-13-Ansible-CreateVMs-Vsphere-free_version","draft":false,"unlisted":false,"editUrl":"https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/archive/2016-02-13-Ansible-CreateVMs-Vsphere-free_version.md","tags":[],"version":"current","lastUpdatedBy":"Ron Amosa","lastUpdatedAt":1771617957000,"frontMatter":{"title":"Creating VM\'s using Ansible and ESXi 5.5 Free Version."},"sidebar":"docsSidebar","previous":{"title":"Part 3 - Demos, Testing and Healthchecks.","permalink":"/docs/archive/terraform-aws-ec2/terraform-aws-3"},"next":{"title":"Setting up a CISCO ASA 5505 VLAN & VPN","permalink":"/docs/archive/2016-03-01-CISCO-ASA-VLAN-SETUP"}}');var a=s(74848),i=s(28453);const o={title:"Creating VM's using Ansible and ESXi 5.5 Free Version."},r=void 0,l={},c=[{value:"Install Ansible &amp; pysphere",id:"install-ansible--pysphere",level:2},{value:"debian/ubuntu",id:"debianubuntu",level:3},{value:"rhel/centos",id:"rhelcentos",level:3},{value:"Create inventory file",id:"create-inventory-file",level:2},{value:"Verify DNS for ESXi Host",id:"verify-dns-for-esxi-host",level:2},{value:"Create your Ansible Playbook",id:"create-your-ansible-playbook",level:2},{value:"Run the playbook",id:"run-the-playbook",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"References",id:"references",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"Use Ansible to deploy a virtual machine instance on ESXi 5.5, free version."}),"\n",(0,a.jsx)(n.h2,{id:"install-ansible--pysphere",children:"Install Ansible & pysphere"}),"\n",(0,a.jsx)(n.h3,{id:"debianubuntu",children:"debian/ubuntu"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"sudo apt-add-repository -y ppa:ansible/ansible\nsudo apt-get update\nsudo apt-get install -y ansible\n"})}),"\n",(0,a.jsx)(n.h3,{id:"rhelcentos",children:"rhel/centos"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"sudo yum install -y ansible\n"})}),"\n",(0,a.jsx)(n.p,{children:"install pysphere"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"easy_install -U pysphere\n"})}),"\n",(0,a.jsx)(n.p,{children:"via pip:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"pip install -U pysphere\n"})}),"\n",(0,a.jsx)(n.h2,{id:"create-inventory-file",children:"Create inventory file"}),"\n",(0,a.jsx)(n.p,{children:"Create inventory file containing ESXI Host (replace esxi.default.de with your esxi hostname):"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"$ cat inventory\n[esxi]\nesxi.darksyde.net\n"})}),"\n",(0,a.jsx)(n.h2,{id:"verify-dns-for-esxi-host",children:"Verify DNS for ESXi Host"}),"\n",(0,a.jsxs)(n.p,{children:["Infrastructure must match hostname EXACTLY: ssh into your esxi and run ",(0,a.jsx)(n.code,{children:"hostname"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"~ # hostname\nesxi.DARKSYDE.NET\n"})}),"\n",(0,a.jsx)(n.p,{children:"copy this EXACTLY to your esxi section below"}),"\n",(0,a.jsx)(n.h2,{id:"create-your-ansible-playbook",children:"Create your Ansible Playbook"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'# cat newvm.yml\n---\n- hosts: localhost\n  connection: local\n  vars_prompt:\n  - name: "rootpassword"\n    prompt: "Enter your password to esxi"\n    private: yes\n  tasks:\n  - vsphere_guest:\n      vcenter_hostname: esxi.darksyde.net\n      username: root\n      password: <your_root_password />\n      guest: newvm001\n      state: powered_on\n      vm_extra_config:\n        vcpu.hotadd: yes\n        mem.hotadd:  yes\n        notes: This is a test VM\n      vm_disk:\n        disk1:\n          size_gb: 10\n          type: thin\n          datastore: datastore1\n          # VMs can be put into folders. The value given here is either the full path\n          # to the folder (e.g. production/customerA/lamp) or just the last component\n          # of the path (e.g. lamp):\n          folder: DARK_LAB/10_DMZ\n      vm_nic:\n        nic1:\n          type: vmxnet3\n          network: DMZ\n          network_type: standard\n      vm_hardware:\n        memory_mb: 2048\n        num_cpus: 2\n        osid: centos64Guest\n        scsi: paravirtual\n        vm_cdrom:\n          type: "iso"\n          iso_path: "datastore1/ISO/CentOS-7.0-1406-x86_64-DVD.iso"\n      esxi:\n        datacenter: ha-datacenter\n        hostname: esxi.DARKSYDE.NET\n'})}),"\n",(0,a.jsx)(n.h2,{id:"run-the-playbook",children:"Run the playbook"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'[root@puppetmaster ansible-playbooks]# ansible-playbook -vvv -s vm-esxi.yml\nUsing /etc/ansible/ansible.cfg as config file\n\nPLAYBOOK: vm-esxi.yml ********************************************************************************************************************************************************\n1 plays in vm-esxi.yml\nEnter your password to esxi:\n\nPLAY [localhost] *************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *******************************************************************************************************************************************************\nUsing module file /usr/lib/python2.7/site-packages/ansible/modules/system/setup.py\n<127.0.0.1> ESTABLISH LOCAL CONNECTION FOR USER: root\n<127.0.0.1> EXEC /bin/sh -c \'echo ~ && sleep 0\'\n<127.0.0.1> EXEC /bin/sh -c \'( umask 77 && mkdir -p "` echo /root/.ansible/tmp/ansible-tmp-1507178886.36-229403027178035 `" && echo ansible-tmp-1507178886.36-229403027178035="` echo /root/.ansible/tmp/ansible-tmp-1507178886.36-229403027178035 `" ) && sleep 0\'\n<127.0.0.1> PUT /tmp/tmpxKbdW7 TO /root/.ansible/tmp/ansible-tmp-1507178886.36-229403027178035/setup.py\n<127.0.0.1> EXEC /bin/sh -c \'chmod u+x /root/.ansible/tmp/ansible-tmp-1507178886.36-229403027178035/ /root/.ansible/tmp/ansible-tmp-1507178886.36-229403027178035/setup.py && sleep 0\'\n<127.0.0.1> EXEC /bin/sh -c \'/usr/bin/python2 /root/.ansible/tmp/ansible-tmp-1507178886.36-229403027178035/setup.py; rm -rf "/root/.ansible/tmp/ansible-tmp-1507178886.36-229403027178035/" > /dev/null 2>&1 && sleep 0\'\nok: [localhost]\nMETA: ran handlers\n\nTASK [vsphere_guest] *********************************************************************************************************************************************************\ntask path: /root/ansible-playbooks/vm-esxi.yml:9\nUsing module file /usr/lib/python2.7/site-packages/ansible/modules/cloud/vmware/vsphere_guest.py\n<127.0.0.1> ESTABLISH LOCAL CONNECTION FOR USER: root\n<127.0.0.1> EXEC /bin/sh -c \'echo ~ && sleep 0\'\n<127.0.0.1> EXEC /bin/sh -c \'( umask 77 && mkdir -p "` echo /root/.ansible/tmp/ansible-tmp-1507178896.13-224568032954916 `" && echo ansible-tmp-1507178896.13-224568032954916="` echo /root/.ansible/tmp/ansible-tmp-1507178896.13-224568032954916 `" ) && sleep 0\'\n<127.0.0.1> PUT /tmp/tmp7cu5MB TO /root/.ansible/tmp/ansible-tmp-1507178896.13-224568032954916/vsphere_guest.py\n<127.0.0.1> EXEC /bin/sh -c \'chmod u+x /root/.ansible/tmp/ansible-tmp-1507178896.13-224568032954916/ /root/.ansible/tmp/ansible-tmp-1507178896.13-224568032954916/vsphere_guest.py && sleep 0\'\n<127.0.0.1> EXEC /bin/sh -c \'/usr/bin/python2 /root/.ansible/tmp/ansible-tmp-1507178896.13-224568032954916/vsphere_guest.py; rm -rf "/root/.ansible/tmp/ansible-tmp-1507178896.13-224568032954916/" > /dev/null 2>&1 && sleep 0\'\nchanged: [localhost] => {\n    "ansible_facts": {\n        "hw_guest_full_name": "CentOS 4/5/6/7 (64-bit)",\n        "hw_guest_id": "centos64Guest",\n        "hw_instance_uuid": "5213b94e-4b04-2409-484c-91136060a9aa",\n        "hw_interfaces": [],\n        "hw_memtotal_mb": 2048,\n        "hw_name": "newvm001",\n        "hw_power_status": "POWERED ON",\n        "hw_processor_count": 2,\n        "hw_product_uuid": "564dcb1e-c3ed-ff26-65f7-91f348abfb27",\n        "module_hw": true\n    },\n    "changed": true,\n    "changes": "Created VM newvm001",\n    "invocation": {\n        "module_args": {\n            "cluster": null,\n            "esxi": {\n                "datacenter": "ha-datacenter",\n                "hostname": "esxi.DARKSYDE.NET"\n            },\n            "force": false,\n            "from_template": null,\n            "guest": "newvm001",\n            "password": "VALUE_SPECIFIED_IN_NO_LOG_PARAMETER",\n            "power_on_after_clone": true,\n            "resource_pool": null,\n            "snapshot_to_clone": null,\n            "state": "powered_on",\n            "template_src": null,\n            "username": "root",\n            "validate_certs": true,\n            "vcenter_hostname": "esxi.darksyde.net",\n            "vm_disk": {\n                "disk1": {\n                    "datastore": "datastore1",\n                    "folder": "DARK_LAB/10_DMZ",\n                    "size_gb": 10,\n                    "type": "thin"\n                }\n            },\n            "vm_extra_config": {\n                "mem.hotadd": true,\n                "notes": "This is a test VM",\n                "vcpu.hotadd": true\n            },\n            "vm_hardware": {\n                "memory_mb": 2048,\n                "num_cpus": 2,\n                "osid": "centos64Guest",\n                "scsi": "paravirtual",\n                "vm_cdrom": {\n                    "iso_path": "datastore1/ISO/CentOS-7.0-1406-x86_64-DVD.iso",\n                    "type": "iso"\n                }\n            },\n            "vm_hw_version": null,\n            "vm_nic": {\n                "nic1": {\n                    "network": "DMZ",\n                    "network_type": "standard",\n                    "type": "vmxnet3"\n                }\n            },\n            "vmware_guest_facts": null\n        }\n    }\n}\nMETA: ran handlers\nMETA: ran handlers\n\nPLAY RECAP *******************************************************************************************************************************************************************\nlocalhost                  : ok=2    changed=1    unreachable=0    failed=0\n\n'})}),"\n",(0,a.jsx)(n.p,{children:"Done."}),"\n",(0,a.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,a.jsx)(n.p,{children:"if you dont get the hostname right you get this:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'},\n"vmware_guest_facts": null\n}\n},\n"msg": "Cannot find esx host named: esxi"\n}\nto retry, use: --limit @/root/ansible-playbooks/vm-esxi.retry\n\nPLAY RECAP *******************************************************************************************************************************************************************\nlocalhost                  : ok=1    changed=0    unreachable=0    failed=1\n'})}),"\n",(0,a.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,a.jsx)(n.admonition,{type:"info",children:(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://serversforhackers.com/c/an-ansible-tutorial",children:"Ansible Tutorial"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"http://docs.ansible.com/ansible/latest/vsphere_guest_module.html",children:"vSphere Guest Module"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://github.com/itnihao/pysphere/wiki/Quick-guide-to-start-using-PySphere",children:"Quick Guide to PySphere"})}),"\n"]})})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>r});var t=s(96540);const a={},i=t.createContext(a);function o(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);