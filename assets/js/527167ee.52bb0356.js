"use strict";(self.webpackChunkronamosa_github_io=self.webpackChunkronamosa_github_io||[]).push([[91117],{28453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>a});var s=r(96540);const t={},o=s.createContext(t);function i(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),s.createElement(o.Provider,{value:n},e.children)}},44818:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"archive/docker-wordpress/2018-04-30-AWS-Docker-Wordpress-Nginx-Ansible-Terraform-Part2","title":"Part 2 - Provision with Ansible","description":"Now that Terraform has taken care of standing up a single instance of EC2 and RDS/MariaDB in Part 1, the next part is pretty straight forward because we just need docker & docker-compose installed on our web server EC2 instance.","source":"@site/docs/archive/docker-wordpress/2018-04-30-AWS-Docker-Wordpress-Nginx-Ansible-Terraform-Part2.md","sourceDirName":"archive/docker-wordpress","slug":"/archive/docker-wordpress/docker-wordpress-2","permalink":"/docs/archive/docker-wordpress/docker-wordpress-2","draft":false,"unlisted":false,"editUrl":"https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/archive/docker-wordpress/2018-04-30-AWS-Docker-Wordpress-Nginx-Ansible-Terraform-Part2.md","tags":[],"version":"current","lastUpdatedBy":"Ron Amosa","lastUpdatedAt":1771617957000,"frontMatter":{"slug":"docker-wordpress-2","title":"Part 2 - Provision with Ansible"},"sidebar":"docsSidebar","previous":{"title":"Part 1 - Architecture, Database and Infrastructure.","permalink":"/docs/archive/docker-wordpress/docker-wordpress-1"},"next":{"title":"Part 3 - NGINX SSL Frontend, Docker Compose and Demo.","permalink":"/docs/archive/docker-wordpress/docker-wordpress-3"}}');var t=r(74848),o=r(28453);const i={slug:"docker-wordpress-2",title:"Part 2 - Provision with Ansible"},a=void 0,l={},d=[{value:"Part 2. Provision with Ansible",id:"part-2-provision-with-ansible",level:2},{value:"Directory Structure",id:"directory-structure",level:2},{value:"ansible.cfg",id:"ansiblecfg",level:2},{value:"hosts.yml",id:"hostsyml",level:2},{value:"the role of &#39;roles&#39;",id:"the-role-of-roles",level:2},{value:"defaults/main.yml",id:"defaultsmainyml",level:3},{value:"deploy.yml",id:"deployyml",level:2},{value:"Deploy, check Installation",id:"deploy-check-installation",level:2},{value:"References",id:"references",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["Now that Terraform has taken care of standing up a single instance of EC2 and RDS/MariaDB in ",(0,t.jsx)(n.a,{href:"docker-wordpress-1",children:"Part 1"}),", the next part is pretty straight forward because we just need docker & docker-compose installed on our web server EC2 instance."]}),"\n",(0,t.jsx)(n.p,{children:"Just a reminder of the simple setup we're trying to build here:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"diagram of app",src:r(59240).A+"",width:"578",height:"747"})}),"\n",(0,t.jsx)(n.h2,{id:"part-2-provision-with-ansible",children:"Part 2. Provision with Ansible"}),"\n",(0,t.jsxs)(n.p,{children:["All we're after here is for ansible to install docker & docker-compose on the target server. We could've done this with a ",(0,t.jsx)(n.code,{children:"user_data"}),' section of our Terraform build so the new instance would come fully formed with docker & docker-compose. But again, even though this is a small and really simple setup, I wanted to practice structuring and implementing things in a scalable "industry standard" sort of way (well, close to anyway).']}),"\n",(0,t.jsx)(n.h2,{id:"directory-structure",children:"Directory Structure"}),"\n",(0,t.jsx)(n.p,{children:"Let's go through the ansible directory and see what we're working with"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"ansible.cfg"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"deploy.yml"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"hosts.yml"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"roles/"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"ansiblecfg",children:"ansible.cfg"}),"\n",(0,t.jsxs)(n.p,{children:["all your defaults go into this for ansible to pick up and work with when you run ",(0,t.jsx)(n.code,{children:"ansible"})," or ",(0,t.jsx)(n.code,{children:"ansible-playbook"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"[defaults]\nremote_user = ubuntu\nansible_managed = Ansible managed\ndisplay_skipped_hosts = True\nsystem_warnings = True\ncommand_warnings = False\nretry_files_enabled = False\n"})}),"\n",(0,t.jsxs)(n.p,{children:["self explanatory, or you can read and add as required, read this page: ",(0,t.jsx)(n.a,{href:"https://raw.githubusercontent.com/ansible/ansible/devel/examples/ansible.cfg",children:"ansible.cfg example on github.com"})]}),"\n",(0,t.jsx)(n.h2,{id:"hostsyml",children:"hosts.yml"}),"\n",(0,t.jsx)(n.p,{children:"there's a couple ways to layout your hosts file, the ini way:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"[web]\nx.x.x.x   hostname\nx.x.x.x   another-hostname\n"})}),"\n",(0,t.jsxs)(n.p,{children:['or the way I\'ve decided to go, with YAML, the "ungrouped" way (per ',(0,t.jsx)(n.a,{href:"https://github.com/ansible/ansible/blob/devel/examples/hosts.yaml",children:"github inventory yaml example"}),")"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'all:\n    hosts:\n      web:\n        ansible_ssh_host: 174.129.47.133\n        ansible_user: ubuntu\n        ansible_ssh_private_key_file: "/path/to/private/key/infra_builder.pem"\n'})}),"\n",(0,t.jsx)(n.p,{children:"there's a few other ways to lay your inventory out with YAML, adding 'vars' and 'children', but these are some great practices to follow on inventory in YAML format:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"#   - Comments begin with the '#' character\n#   - Blank lines are ignored\n#   - Top level entries are assumed to be groups, start with 'all' to have a full hierarchy\n#   - Hosts must be specified in a group's hosts:\n#     and they must be a key (: terminated)\n#   - groups can have children, hosts and vars keys\n#   - Anything defined under a host is assumed to be a var\n#   - You can enter hostnames or IP addresses\n#   - A hostname/IP can be a member of multiple groups\n"})}),"\n",(0,t.jsx)(n.h2,{id:"the-role-of-roles",children:"the role of 'roles'"}),"\n",(0,t.jsx)(n.p,{children:"Now I'm no Ansible guru, but the more I'm learning about ansible the more powerful I see 'roles' being in terms of organizing the 'work' required to get from 'A' to 'B' for whatever you're trying to achieve."}),"\n",(0,t.jsx)(n.p,{children:"In the example of this little project, we want docker & docker-compose installed."}),"\n",(0,t.jsx)(n.p,{children:"Let's setup 'docker' as an Ansible role:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"ansible-galaxy init docker\n"})}),"\n",(0,t.jsx)(n.p,{children:"where 'docker' is the role we want to create. There's a way to pull down an already filled out 'docker' role much the way you pull down docker images, but its fun to start from scratch and see everything at the boilerplate level."}),"\n",(0,t.jsx)(n.p,{children:"You end up with this folder structure (I copied this from ansible's documentation):"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"README.md\n.travis.yml\ndefaults/\n    main.yml\nfiles/\nhandlers/\n    main.yml\nmeta/\n    main.yml\ntemplates/\ntests/\n    inventory\n    test.yml\nvars/\n    main.yml\n"})}),"\n",(0,t.jsx)(n.p,{children:"Rather than get into an Ansible tutorial (which there are much better out there to learn from), let's just highlight the files that actually do stuff:"}),"\n",(0,t.jsx)(n.h3,{id:"defaultsmainyml",children:"defaults/main.yml"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'---\n# defaults file for docker\n# this assumes either systemd or initd services\n# uncomment the one you need:\n\n## systemd\n#docker_service: /usr/lib/systemd/system/docker.service\n\n## initd\ndocker_service: /etc/init.d/docker\ndocker_install_docker_compose: True\ndocker_compose_version: "1.21.0"\n'})}),"\n",(0,t.jsx)(n.p,{children:"key points"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"pick the service system for your setup - systemd or init.d"}),"\n",(0,t.jsx)(n.li,{children:"docker compose flag = True/False"}),"\n",(0,t.jsx)(n.li,{children:"docker compose version to install"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["the main event, is ",(0,t.jsx)(n.strong,{children:"tasks/main.yml"}),". this is where docker and docker-compose get installed, and the docker service is enabled and started by this section:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'--\n# tasks file for docker\n\n- name: check docker installed\n  stat: path=\\{\\{ docker_service \\}\\}\n  register: install_result\n\n- debug: var=install_result\n\n- name: installing docker\n  shell: >\n    curl -fsSL https://get.docker.com/ | sh\n  when: not install_result.stat.exists\n\n- name: start docker service\n  service: name=docker state=started enabled=true\n\n- name: get docker_info\n  no_log: true\n  command: docker info\n  register: docker_result\n\n- name: Install Docker Compose\n  get_url:\n    url: "https://github.com/docker/compose/releases/download/\\{\\{ docker_compose_version \\}\\}/docker-compose-Linux-x86_64"\n    dest: "/usr/local/bin/docker-compose"\n    force: True\n    owner: "root"\n    group: "root"\n    mode: "0755"\n  when: docker_install_docker_compose\n'})}),"\n",(0,t.jsx)(n.p,{children:"key points:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"does the installation"}),"\n",(0,t.jsx)(n.li,{children:"enables the docker service"}),"\n",(0,t.jsx)(n.li,{children:"grabs docker_info and registers the result so it can be used for and by other sections"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"That's it. Now its time to deploy"}),"\n",(0,t.jsx)(n.h2,{id:"deployyml",children:"deploy.yml"}),"\n",(0,t.jsx)(n.p,{children:"Pretty non-eventful after all the meat and potatoes of this is already done in the 'roles' section. The following just deploys our hard earned config setup:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"# deploy.yml\n---\n- hosts: all\n  gather_facts: yes\n  become: yes\n  become_user: root\n\n  roles:\n    - { role: docker, tags: docker }\n\n  tasks:\n    - debug: var=docker_result\n"})}),"\n",(0,t.jsx)(n.p,{children:"key points:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"targets 'all' hosts (i.e. the 'root' level so will capture our web hosts)"}),"\n",(0,t.jsx)(n.li,{children:"the ansible_user will assume 'root' as it goes to work"}),"\n",(0,t.jsx)(n.li,{children:"going to deploy the 'docker role' against the target hosts"}),"\n",(0,t.jsx)(n.li,{children:"tag our docker role with 'docker' (not very creative)"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"deploy-check-installation",children:"Deploy, check Installation"}),"\n",(0,t.jsx)("iframe",{width:"560",height:"315",src:"https://www.youtube-nocookie.com/embed/CJ4FkvQm0R0?rel=0&controls=0&showinfo=0",frameBorder:"0",allow:"autoplay; encrypted-media",allowFullScreen:!0}),"\n",(0,t.jsx)(n.p,{children:"That's it!"}),"\n",(0,t.jsx)(n.p,{children:"Third and Final Part III, where we setup our Docker Wordpress site with RDS backend!"}),"\n",(0,t.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.ansible.com/ansible/latest/reference_appendices/galaxy.html",children:"ansible-galaxy creating roles"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/ansible/ansible/blob/devel/examples/hosts.yaml",children:"github inventory yaml example"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://everythingshouldbevirtual.com/ansible-generating-hostgroups-yaml-file/",children:"ansible yaml example"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/arbabnazar/terraform-ansible-aws-vpc-ha-wordpress.git",children:"terraform vpc examples"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://rbgeek.wordpress.com/2016/03/28/highly-available-wordpress-setup-inside-aws-vpc-using-terraform-ansible/",children:"aws wordpress terraform ansible example"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://hackernoon.com/setup-docker-swarm-on-aws-using-ansible-terraform-daa1eabbc27d",children:"bootstrap credit"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://alex.dzyoba.com/blog/terraform-ansible/",children:"using ansible with terraform"})}),"\n"]})})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},59240:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/dockerwordpress-appdiagram-a35236b50800df8bbb67315f0a0f9435.png"}}]);