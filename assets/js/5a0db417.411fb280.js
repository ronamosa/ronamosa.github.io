"use strict";(self.webpackChunkronamosa_github_io=self.webpackChunkronamosa_github_io||[]).push([[1279],{28453:(e,a,r)=>{r.d(a,{R:()=>t,x:()=>i});var n=r(96540);const c={},s=n.createContext(c);function t(e){const a=n.useContext(s);return n.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function i(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:t(e.components),n.createElement(s.Provider,{value:a},e.children)}},52810:(e,a,r)=>{r.d(a,{A:()=>n});const n=r.p+"assets/images/ecsworkshop-capacityproviders-asg-7a36dd2bc8128324940c5ad6bb0b13fb.png"},93134:(e,a,r)=>{r.r(a),r.d(a,{assets:()=>o,contentTitle:()=>i,default:()=>p,frontMatter:()=>t,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"engineer/AWS/AWS-ECS-3CapacityProviders","title":"AWS Workshop ECS Capacity Providers","description":"- ECS Workshop: Capacity Providers","source":"@site/docs/engineer/AWS/AWS-ECS-3CapacityProviders.md","sourceDirName":"engineer/AWS","slug":"/engineer/AWS/AWS-ECS-3CapacityProviders","permalink":"/docs/engineer/AWS/AWS-ECS-3CapacityProviders","draft":false,"unlisted":false,"editUrl":"https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/engineer/AWS/AWS-ECS-3CapacityProviders.md","tags":[],"version":"current","lastUpdatedBy":"Ron Amosa","lastUpdatedAt":1758526302000,"frontMatter":{"title":"AWS Workshop ECS Capacity Providers"},"sidebar":"docsSidebar","previous":{"title":"AWS Workshop ECS Monitoring","permalink":"/docs/engineer/AWS/AWS-ECS-2Monitoring"},"next":{"title":"AWS Workshop ECS Cats and Dogs - Part 1","permalink":"/docs/engineer/AWS/AWS-ECS-Cats-n-Dogs"}}');var c=r(74848),s=r(28453);const t={title:"AWS Workshop ECS Capacity Providers"},i=void 0,o={},d=[{value:"Tools Install",id:"tools-install",level:2},{value:"Environment Setup",id:"environment-setup",level:2},{value:"Build <code>platform</code>",id:"build-platform",level:3},{value:"Capacity Provider: Fargate and EC2",id:"capacity-provider-fargate-and-ec2",level:2},{value:"Deploy Fargate Capacity Provider",id:"deploy-fargate-capacity-provider",level:2},{value:"Clean Up",id:"clean-up",level:3},{value:"Deploy ECS Cluster Auto Scaling",id:"deploy-ecs-cluster-auto-scaling",level:2},{value:"Enable Cluster Auto Scaling",id:"enable-cluster-auto-scaling",level:2},{value:"associate with ecs cluster",id:"associate-with-ecs-cluster",level:3},{value:"scale out 1 to 10",id:"scale-out-1-to-10",level:3},{value:"Clean Up EC2",id:"clean-up-ec2",level:2}];function l(e){const a={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(a.admonition,{title:"Workshop Links",type:"tip",children:(0,c.jsxs)(a.ul,{children:["\n",(0,c.jsxs)(a.li,{children:["ECS Workshop: ",(0,c.jsx)(a.a,{href:"https://ecsworkshop.com/capacity_providers/",children:"Capacity Providers"})]}),"\n"]})}),"\n",(0,c.jsx)(a.admonition,{type:"note",children:(0,c.jsx)(a.p,{children:"I am running this from my local machine, with AWS creds and config setup with keys."})}),"\n",(0,c.jsx)(a.h2,{id:"tools-install",children:"Tools Install"}),"\n",(0,c.jsx)(a.p,{children:(0,c.jsx)(a.code,{children:"apt install jq nodejs python36"})}),"\n",(0,c.jsx)(a.h2,{id:"environment-setup",children:"Environment Setup"}),"\n",(0,c.jsxs)(a.p,{children:[(0,c.jsx)(a.code,{children:"ecsdemo-platform"})," we've seen from Monitoring, but ",(0,c.jsx)(a.code,{children:"capacityproviders"})," is new."]}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:"cd ~/environment\ngit clone https://github.com/aws-containers/ecsdemo-platform\ngit clone https://github.com/aws-containers/ecsdemo-capacityproviders\n"})}),"\n",(0,c.jsxs)(a.h3,{id:"build-platform",children:["Build ",(0,c.jsx)(a.code,{children:"platform"})]}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:"cd ~/environment/ecsdemo-platform/cdk\npip install -r requirements.txt\ncdk context --clear && cdk deploy --require-approval never\n"})}),"\n",(0,c.jsx)(a.p,{children:"output"}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:"~/Repositories/AWSECS/environment/ecsdemo-platform/cdk on main \u276f cdk context --clear && cdk deploy --require-approval never                              at \uf017 08:59:55\nAll context values cleared.\n\n\u2728  Synthesis time: 7.92s\n\necsworkshop-base: building assets...\n\n[0%] start: Building f75f7b3f459bf2b86416c9e442c35658b46a76de9b93b17b2d3c30f5a43758d8:current_account-us-east-1\n[100%] success: Built f75f7b3f459bf2b86416c9e442c35658b46a76de9b93b17b2d3c30f5a43758d8:current_account-us-east-1\n\necsworkshop-base: assets built\n\necsworkshop-base: deploying... [1/1]\n[0%] start: Publishing f75f7b3f459bf2b86416c9e442c35658b46a76de9b93b17b2d3c30f5a43758d8:current_account-us-east-1\n[100%] success: Published f75f7b3f459bf2b86416c9e442c35658b46a76de9b93b17b2d3c30f5a43758d8:current_account-us-east-1\necsworkshop-base: creating CloudFormation changeset...\n\n \u2705  ecsworkshop-base\n\n\u2728  Deployment time: 41.24s\n\nOutputs:\necsworkshop-base.ECSClusterName = container-demo\necsworkshop-base.ECSClusterSecGrp = []\necsworkshop-base.FE2BESecGrp = sg-08ad8552ab5a42e2d\necsworkshop-base.NSArn = arn:aws:servicediscovery:us-east-1:REDACTED:namespace/ns-qbclwxxkojytxj2w\necsworkshop-base.NSId = ns-qbclwxxkojytxj2w\necsworkshop-base.NSName = service.local\necsworkshop-base.ServicesSecGrp = sg-08ad8552ab5a42e2d\necsworkshop-base.StressToolEc2Id = i-0b5aa0dca21ce4bec\necsworkshop-base.StressToolEc2Ip = 10.0.0.188\nStack ARN:\narn:aws:cloudformation:us-east-1:REDACTED:stack/ecsworkshop-base/ca39eeb0-ed8d-11ee-b7f5-0affd09b0077\n\n\u2728  Total time: 49.16s\n"})}),"\n",(0,c.jsx)(a.h2,{id:"capacity-provider-fargate-and-ec2",children:"Capacity Provider: Fargate and EC2"}),"\n",(0,c.jsx)(a.p,{children:"key points"}),"\n",(0,c.jsxs)(a.ul,{children:["\n",(0,c.jsxs)(a.li,{children:["Fargate CP enable use of both Fargate & Fargate ",(0,c.jsx)(a.strong,{children:"Spot"}),", for ECS tasks"]}),"\n",(0,c.jsxs)(a.li,{children:['EC2 CP enables "',(0,c.jsx)(a.strong,{children:"Cluster Auto Scaling"}),'" using EC2 spot instances.']}),"\n"]}),"\n",(0,c.jsx)(a.h2,{id:"deploy-fargate-capacity-provider",children:"Deploy Fargate Capacity Provider"}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:"aws ecs put-cluster-capacity-providers \\\n--cluster container-demo \\\n--capacity-providers FARGATE FARGATE_SPOT \\\n--default-capacity-provider-strategy \\\ncapacityProvider=FARGATE,weight=1,base=1 \\\ncapacityProvider=FARGATE_SPOT,weight=4\n"})}),"\n",(0,c.jsx)(a.p,{children:"notes"}),"\n",(0,c.jsxs)(a.ul,{children:["\n",(0,c.jsxs)(a.li,{children:["only one provider can be ",(0,c.jsx)(a.code,{children:"base"})," provider i.e. ",(0,c.jsx)(a.code,{children:"base=1"})]}),"\n",(0,c.jsxs)(a.li,{children:[(0,c.jsx)(a.code,{children:"weight"})," designates ratio e.g. for every 1 task running on ",(0,c.jsx)(a.code,{children:"FARGATE"})," cp, 4 tasks would use ",(0,c.jsx)(a.code,{children:"FARGATE_SPOT"}),"."]}),"\n"]}),"\n",(0,c.jsx)(a.p,{children:"output"}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:'{\n    "cluster": {\n        "clusterArn": "arn:aws:ecs:us-east-1:REDACTED:cluster/container-demo",\n        "clusterName": "container-demo",\n        "status": "ACTIVE",\n        "registeredContainerInstancesCount": 0,\n        "runningTasksCount": 0,\n        "pendingTasksCount": 0,\n        "activeServicesCount": 0,\n        "statistics": [],\n        "tags": [],\n        "settings": [\n            {\n                "name": "containerInsights",\n                "value": "enabled"\n            }\n        ],\n        "capacityProviders": [\n            "FARGATE",\n            "FARGATE_SPOT"\n        ],\n        "defaultCapacityProviderStrategy": [\n            {\n                "capacityProvider": "FARGATE",\n                "weight": 1,\n                "base": 1\n            },\n            {\n                "capacityProvider": "FARGATE_SPOT",\n                "weight": 4,\n                "base": 0\n            }\n        ],\n        "attachments": [],\n        "attachmentsStatus": "UPDATE_IN_PROGRESS"\n    }\n}\n'})}),"\n",(0,c.jsxs)(a.p,{children:["run ",(0,c.jsx)(a.code,{children:"cdk diff"})]}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:'~/R/A/environment/ecsdemo-capacityproviders/fargate on main !1 \u276f cdk diff\njsii.errors.JavaScriptError:\n  @jsii/kernel.RuntimeError: Error: Cannot retrieve value from context provider vpc-provider since account/region are not specified at the stack level. Configure "env" with an account and region when you define your stack.See https://docs.aws.amazon.com/cdk/latest/guide/environments.html for more details.\n      at Kernel._Kernel_ensureSync (/tmp/tmp2tkxlbre/lib/program.js:10491:23)\n      at Kernel.sinvoke (/tmp/tmp2tkxlbre/lib/program.js:9876:102)\n      at KernelHost.processRequest (/tmp/tmp2tkxlbre/lib/program.js:11696:36)\n      at KernelHost.run (/tmp/tmp2tkxlbre/lib/program.js:11656:22)\n      at Immediate._onImmediate (/tmp/tmp2tkxlbre/lib/program.js:11657:46)\n      at process.processImmediate (node:internal/timers:471:21)\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File "/home/rxhackk/Repositories/AWSECS/environment/ecsdemo-capacityproviders/fargate/app.py", line 98, in <module />\n    CapacityProviderFargateService(app, stack_name, env=_env)\n'})}),"\n",(0,c.jsxs)(a.p,{children:["I checked line 98 in ",(0,c.jsx)(a.code,{children:"ecsdemo-capacityproviders/fargate/app.py"})," and found this:"]}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:"_env = cdk.Environment(account=getenv('AWS_ACCOUNT_ID'), region=getenv('AWS_DEFAULT_REGION'))\nenvironment = \"ecsworkshop\"\nstack_name = \"{}-capacityproviders-fargate\".format(environment)\napp = cdk.App()\nCapacityProviderFargateService(app, stack_name, env=_env)\n"})}),"\n",(0,c.jsxs)(a.p,{children:["It is looking for ",(0,c.jsx)(a.code,{children:"AWS_ACCOUNT_ID"})," and ",(0,c.jsx)(a.code,{children:"AWS_DEFAULT_REGION"})," where previous cdk environments have run on ",(0,c.jsx)(a.code,{children:"AWS_DEFAULT_ACCOUNT"})," not ",(0,c.jsx)(a.code,{children:"ACCOUNT_ID"})," so this is dumb."]}),"\n",(0,c.jsxs)(a.p,{children:["I changed ",(0,c.jsx)(a.code,{children:"AWS_ACCOUNT_ID"})," to ",(0,c.jsx)(a.code,{children:"AWS_DEFAULT_ACCOUNT"})," in ",(0,c.jsx)(a.code,{children:"app.py"})," and re-ran."]}),"\n",(0,c.jsx)(a.p,{children:"successful diff"}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:'~/R/A/e/ecsdemo-capacityproviders/fargate on main !2 \u276f cdk diff\nStack ecsworkshop-capacityproviders-fargate\nIAM Statement Changes\n\u250c\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   \u2502 Resource                                       \u2502 Effect \u2502 Action                                         \u2502 Principal                                       \u2502 Condition \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 $\\{FargateCapacityProviderService/TaskDef/Execu \u2502 Allow  \u2502 sts:AssumeRole                                 \u2502 Service:ecs-tasks.amazonaws.com                 \u2502           \u2502\n\u2502   \u2502 tionRole.Arn}                                  \u2502        \u2502                                                \u2502                                                 \u2502           \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 $\\{FargateCapacityProviderService/TaskDef/TaskR \u2502 Allow  \u2502 sts:AssumeRole                                 \u2502 Service:ecs-tasks.amazonaws.com                 \u2502           \u2502\n\u2502   \u2502 ole.Arn}                                       \u2502        \u2502                                                \u2502                                                 \u2502           \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 $\\{FargateCapacityProviderService/TaskDef/web/L \u2502 Allow  \u2502 logs:CreateLogStream                           \u2502 AWS:$\\{FargateCapacityProviderService/TaskDef/Ex \u2502           \u2502\n\u2502   \u2502 ogGroup.Arn}                                   \u2502        \u2502 logs:PutLogEvents                              \u2502 ecutionRole}                                    \u2502           \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 *                                              \u2502 Allow  \u2502 ecs:DescribeTasks                              \u2502 AWS:$\\{FargateCapacityProviderService/TaskDef/Ta \u2502           \u2502\n\u2502   \u2502                                                \u2502        \u2502 ecs:ListTasks                                  \u2502 skRole}                                         \u2502           \u2502\n\u2514\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nSecurity Group Changes\n\u250c\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   \u2502 Group                                                           \u2502 Dir \u2502 Protocol   \u2502 Peer                                                            \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 $\\{FargateCapacityProviderService/LB/SecurityGroup.GroupId}      \u2502 In  \u2502 TCP 80     \u2502 Everyone (IPv4)                                                 \u2502\n\u2502 + \u2502 $\\{FargateCapacityProviderService/LB/SecurityGroup.GroupId}      \u2502 Out \u2502 TCP 5000   \u2502 $\\{FargateCapacityProviderService/Service/SecurityGroup.GroupId} \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 $\\{FargateCapacityProviderService/Service/SecurityGroup.GroupId} \u2502 In  \u2502 TCP 5000   \u2502 $\\{FargateCapacityProviderService/LB/SecurityGroup.GroupId}      \u2502\n\u2502 + \u2502 $\\{FargateCapacityProviderService/Service/SecurityGroup.GroupId} \u2502 Out \u2502 Everything \u2502 Everyone (IPv4)                                                 \u2502\n\u2514\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n(NOTE: There may be security-related changes not in this list. See https://github.com/aws/aws-cdk/issues/1299)\n\nParameters\n[+] Parameter BootstrapVersion BootstrapVersion: {"Type":"AWS::SSM::Parameter::Value<String />","Default":"/cdk-bootstrap/hnb659fds/version","Description":"Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"}\n\nResources\n[+] AWS::ElasticLoadBalancingV2::LoadBalancer FargateCapacityProviderService/LB FargateCapacityProviderServiceLB3C8F1707\n[+] AWS::EC2::SecurityGroup FargateCapacityProviderService/LB/SecurityGroup FargateCapacityProviderServiceLBSecurityGroupA31B6195\n[+] AWS::EC2::SecurityGroupEgress FargateCapacityProviderService/LB/SecurityGroup/to ecsworkshopcapacityprovidersfargateFargateCapacityProviderServiceSecurityGroup90410566:5000 FargateCapacityProviderServiceLBSecurityGrouptoecsworkshopcapacityprovidersfargateFargateCapacityProviderServiceSecurityGroup904105665000197B1D89\n[+] AWS::ElasticLoadBalancingV2::Listener FargateCapacityProviderService/LB/PublicListener FargateCapacityProviderServiceLBPublicListener81ED71E7\n[+] AWS::ElasticLoadBalancingV2::TargetGroup FargateCapacityProviderService/LB/PublicListener/ECSGroup FargateCapacityProviderServiceLBPublicListenerECSGroup64EDCBC8\n[+] AWS::IAM::Role FargateCapacityProviderService/TaskDef/TaskRole FargateCapacityProviderServiceTaskDefTaskRole240ABAF7\n[+] AWS::IAM::Policy FargateCapacityProviderService/TaskDef/TaskRole/DefaultPolicy FargateCapacityProviderServiceTaskDefTaskRoleDefaultPolicy88C80793\n[+] AWS::ECS::TaskDefinition FargateCapacityProviderService/TaskDef FargateCapacityProviderServiceTaskDefB0B80EC1\n[+] AWS::Logs::LogGroup FargateCapacityProviderService/TaskDef/web/LogGroup FargateCapacityProviderServiceTaskDefwebLogGroup9A7D3AC7\n[+] AWS::IAM::Role FargateCapacityProviderService/TaskDef/ExecutionRole FargateCapacityProviderServiceTaskDefExecutionRoleF572264B\n[+] AWS::IAM::Policy FargateCapacityProviderService/TaskDef/ExecutionRole/DefaultPolicy FargateCapacityProviderServiceTaskDefExecutionRoleDefaultPolicy83908004\n[+] AWS::ECS::Service FargateCapacityProviderService/Service/Service FargateCapacityProviderService6E87B372\n[+] AWS::EC2::SecurityGroup FargateCapacityProviderService/Service/SecurityGroup FargateCapacityProviderServiceSecurityGroupF0D9098B\n[+] AWS::EC2::SecurityGroupIngress FargateCapacityProviderService/Service/SecurityGroup/from ecsworkshopcapacityprovidersfargateFargateCapacityProviderServiceLBSecurityGroupE024A5C0:5000 FargateCapacityProviderServiceSecurityGroupfromecsworkshopcapacityprovidersfargateFargateCapacityProviderServiceLBSecurityGroupE024A5C050001D9B585F\n\nOutputs\n[+] Output FargateCapacityProviderService/LoadBalancerDNS FargateCapacityProviderServiceLoadBalancerDNS1BE52BC6: {"Value":{"Fn::GetAtt":["FargateCapacityProviderServiceLB3C8F1707","DNSName"]\\}\\}\n[+] Output FargateCapacityProviderService/ServiceURL FargateCapacityProviderServiceServiceURL128E9753: {"Value":{"Fn::Join":["",["http://",{"Fn::GetAtt":["FargateCapacityProviderServiceLB3C8F1707","DNSName"]}]]\\}\\}\n\nOther Changes\n[+] Unknown Rules: {"CheckBootstrapVersion":{"Assertions":[{"Assert":{"Fn::Not":[{"Fn::Contains":[["1","2","3","4","5"],{"Ref":"BootstrapVersion"}]}]},"AssertDescription":"CDK bootstrap stack version 6 required. Please run \'cdk bootstrap\' with a recent version of the CDK CLI."}]\\}\\}\n\n\n\u2728  Number of stacks with differences: 1\n'})}),"\n",(0,c.jsxs)(a.p,{children:["now you deploy the changes: ",(0,c.jsx)(a.code,{children:"cdk deploy --require-approval never"})]}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:"~/R/A/environment/ecsdemo-capacityproviders/fargate on main !2 \u276f cdk deploy --require-approval never                                                     at \uf017 09:55:47\n\n\u2728  Synthesis time: 4.03s\n\necsworkshop-capacityproviders-fargate:  start: Building e50504156dfaebec0bdd50ee904ea799570a057eaaa20001683e3796b809bf2d:REDACTED-us-east-1\necsworkshop-capacityproviders-fargate:  success: Built e50504156dfaebec0bdd50ee904ea799570a057eaaa20001683e3796b809bf2d:REDACTED-us-east-1\necsworkshop-capacityproviders-fargate:  start: Publishing e50504156dfaebec0bdd50ee904ea799570a057eaaa20001683e3796b809bf2d:REDACTED-us-east-1\necsworkshop-capacityproviders-fargate:  success: Published e50504156dfaebec0bdd50ee904ea799570a057eaaa20001683e3796b809bf2d:REDACTED-us-east-1\necsworkshop-capacityproviders-fargate: deploying... [1/1]\necsworkshop-capacityproviders-fargate: creating CloudFormation changeset...\n\n \u2705  ecsworkshop-capacityproviders-fargate\n\n\u2728  Deployment time: 240.84s\n\nOutputs:\necsworkshop-capacityproviders-fargate.FargateCapacityProviderServiceLoadBalancerDNS1BE52BC6 = ecswor-Farga-7IuUzA1K0m0c-1594881063.us-east-1.elb.amazonaws.com\necsworkshop-capacityproviders-fargate.FargateCapacityProviderServiceServiceURL128E9753 = http://ecswor-Farga-7IuUzA1K0m0c-1594881063.us-east-1.elb.amazonaws.com\nStack ARN:\narn:aws:cloudformation:us-east-1:REDACTED:stack/ecsworkshop-capacityproviders-fargate/cee34de0-ee0e-11ee-828d-123f5209faef\n\n\u2728  Total time: 244.88s\n"})}),"\n",(0,c.jsx)(a.p,{children:"success."}),"\n",(0,c.jsx)(a.p,{children:'now curl that endpoint to get the app output of "ARNs of all tasks running":'}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:'~/R/A/e/ecsdemo-capacityproviders/fargate on main !2 \u276f curl -s http://ecswor-Farga-7IuUzA1K0m0c-1594881063.us-east-1.elb.amazonaws.com | jq\n{\n  "ALL_TASKS": {\n    "arn:aws:ecs:us-east-1:REDACTED:task/container-demo/05dba4e68c42462a891d988b71db3216": "NON_DEFAULT",\n    "arn:aws:ecs:us-east-1:REDACTED:task/container-demo/4f67f206eb074640ab5c1144e41cfe0b": "FARGATE",\n    "arn:aws:ecs:us-east-1:REDACTED:task/container-demo/8257ba58fe664ccaa9d5fd4a3f1d69b8": "NON_DEFAULT",\n    "arn:aws:ecs:us-east-1:REDACTED:task/container-demo/845c8b305f2a4774a5504d7af2744254": "FARGATE_SPOT",\n    "arn:aws:ecs:us-east-1:REDACTED:task/container-demo/8599c12591a446fe835b1b8601fb8a6d": "NON_DEFAULT",\n    "arn:aws:ecs:us-east-1:REDACTED:task/container-demo/873b9bcd04754785926828a03a298715": "FARGATE_SPOT",\n    "arn:aws:ecs:us-east-1:REDACTED:task/container-demo/8acf82da96cb4f57a6e05e6faa3604ae": "FARGATE_SPOT",\n    "arn:aws:ecs:us-east-1:REDACTED:task/container-demo/b4fa297cbadb4f8999a6767e86f651fd": "FARGATE",\n    "arn:aws:ecs:us-east-1:REDACTED:task/container-demo/d268bc8f86c840c881cd43b8d43422f8": "FARGATE_SPOT",\n    "arn:aws:ecs:us-east-1:REDACTED:task/container-demo/e5dff1e8a027499289c840eda2611493": "FARGATE",\n    "arn:aws:ecs:us-east-1:REDACTED:task/container-demo/f0a65d4cf0e74f0c8c654b6ac0a1bdb7": "FARGATE_SPOT",\n    "arn:aws:ecs:us-east-1:REDACTED:task/container-demo/f6f10c7633ff42c3866d9786a5f1fef0": "FARGATE_SPOT",\n    "arn:aws:ecs:us-east-1:REDACTED:task/container-demo/fd8e007f93f1447bb9f0b0604ffd60ee": "FARGATE_SPOT"\n  },\n  "MY_ARN": "arn:aws:ecs:us-east-1:REDACTED:task/container-demo/4f67f206eb074640ab5c1144e41cfe0b",\n  "MY_STRATEGY": "FARGATE"\n}\n'})}),"\n",(0,c.jsx)(a.p,{children:"Done."}),"\n",(0,c.jsx)(a.h3,{id:"clean-up",children:"Clean Up"}),"\n",(0,c.jsxs)(a.p,{children:[(0,c.jsx)(a.code,{children:"cdk destroy -f"})," inside the fargate folder."]}),"\n",(0,c.jsx)(a.h2,{id:"deploy-ecs-cluster-auto-scaling",children:"Deploy ECS Cluster Auto Scaling"}),"\n",(0,c.jsx)(a.admonition,{type:"note",children:(0,c.jsxs)(a.p,{children:["I did not destroy  the ",(0,c.jsx)(a.code,{children:"ecsdemo-platform"})," code from previous section, I plan to just do ",(0,c.jsx)(a.code,{children:"cdk diff"})," and deploy deltas to save time."]})}),"\n",(0,c.jsxs)(a.ul,{children:["\n",(0,c.jsxs)(a.li,{children:["changed to ",(0,c.jsx)(a.code,{children:"/ecsdemo-platform/cdk"})," and edited ",(0,c.jsx)(a.code,{children:"app.py"})]}),"\n",(0,c.jsxs)(a.li,{children:["uncommented the ",(0,c.jsx)(a.code,{children:"#### CAPACITY PROVIDERS SECTION"})," for EC2"]}),"\n",(0,c.jsxs)(a.li,{children:["run ",(0,c.jsx)(a.code,{children:"cdk diff"})]}),"\n",(0,c.jsxs)(a.li,{children:["deploy with ",(0,c.jsx)(a.code,{children:"cdk deploy --require-approval never"})]}),"\n"]}),"\n",(0,c.jsx)(a.p,{children:"output for deploy from diff"}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:'~/R/A/environment/ecsdemo-platform/cdk on main !1 \u276f cdk diff                                                                                  took \uf252 12s at \uf017 11:05:53\nStack ecsworkshop-base\nHold on while we create a read-only change set to get a diff with accurate replacement information (use --no-change-set to use a less accurate but faster template-only diff)\nIAM Statement Changes\n\u250c\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   \u2502 Resource                              \u2502 Effect \u2502 Action                                \u2502 Principal                             \u2502 Condition                             \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 $\\{ECSCluster.Arn}                     \u2502 Allow  \u2502 ecs:DeregisterContainerInstance       \u2502 AWS:$\\{ECSCluster/ECSEC2Capacity/Insta \u2502                                       \u2502\n\u2502   \u2502                                       \u2502        \u2502 ecs:RegisterContainerInstance         \u2502 nceRole}                              \u2502                                       \u2502\n\u2502   \u2502                                       \u2502        \u2502 ecs:Submit*                           \u2502                                       \u2502                                       \u2502\n\u2502 + \u2502 $\\{ECSCluster.Arn}                     \u2502 Allow  \u2502 ecs:ListContainerInstances            \u2502 AWS:$\\{ECSCluster/ECSEC2Capacity/Drain \u2502                                       \u2502\n\u2502   \u2502                                       \u2502        \u2502 ecs:SubmitContainerStateChange        \u2502 ECSHook/Function/ServiceRole}         \u2502                                       \u2502\n\u2502   \u2502                                       \u2502        \u2502 ecs:SubmitTaskStateChange             \u2502                                       \u2502                                       \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 $\\{ECSCluster/ECSEC2Capacity/DrainECSH \u2502 Allow  \u2502 lambda:InvokeFunction                 \u2502 Service:sns.amazonaws.com             \u2502 "ArnLike": {                          \u2502\n\u2502   \u2502 ook/Function.Arn}                     \u2502        \u2502                                       \u2502                                       \u2502   "AWS:SourceArn": "$\\{ECSCluster/ECSE \u2502\n\u2502   \u2502                                       \u2502        \u2502                                       \u2502                                       \u2502 C2Capacity/LifecycleHookDrainHook/Top \u2502\n\u2502   \u2502                                       \u2502        \u2502                                       \u2502                                       \u2502 ic}"                                  \u2502\n\u2502   \u2502                                       \u2502        \u2502                                       \u2502                                       \u2502 }                                     \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 $\\{ECSCluster/ECSEC2Capacity/DrainECSH \u2502 Allow  \u2502 sts:AssumeRole                        \u2502 Service:lambda.amazonaws.com          \u2502                                       \u2502\n\u2502   \u2502 ook/Function/ServiceRole.Arn}         \u2502        \u2502                                       \u2502                                       \u2502                                       \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 $\\{ECSCluster/ECSEC2Capacity/InstanceR \u2502 Allow  \u2502 sts:AssumeRole                        \u2502 Service:ec2.amazonaws.com             \u2502                                       \u2502\n\u2502   \u2502 ole.Arn}                              \u2502        \u2502                                       \u2502                                       \u2502                                       \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 $\\{ECSCluster/ECSEC2Capacity/Lifecycle \u2502 Allow  \u2502 sts:AssumeRole                        \u2502 Service:autoscaling.amazonaws.com     \u2502                                       \u2502\n\u2502   \u2502 HookDrainHook/Role.Arn}               \u2502        \u2502                                       \u2502                                       \u2502                                       \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 $\\{ECSCluster/ECSEC2Capacity/Lifecycle \u2502 Allow  \u2502 sns:Publish                           \u2502 AWS:$\\{ECSCluster/ECSEC2Capacity/Lifec \u2502                                       \u2502\n\u2502   \u2502 HookDrainHook/Topic}                  \u2502        \u2502                                       \u2502 ycleHookDrainHook/Role}               \u2502                                       \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 *                                     \u2502 Allow  \u2502 ecs:Poll                              \u2502 AWS:$\\{ECSCluster/ECSEC2Capacity/Insta \u2502 "ArnEquals": {                        \u2502\n\u2502   \u2502                                       \u2502        \u2502 ecs:StartTelemetrySession             \u2502 nceRole}                              \u2502   "ecs:cluster": "$\\{ECSCluster.Arn}"  \u2502\n\u2502   \u2502                                       \u2502        \u2502                                       \u2502                                       \u2502 }                                     \u2502\n\u2502 + \u2502 *                                     \u2502 Allow  \u2502 ecr:GetAuthorizationToken             \u2502 AWS:$\\{ECSCluster/ECSEC2Capacity/Insta \u2502                                       \u2502\n\u2502   \u2502                                       \u2502        \u2502 ecs:DiscoverPollEndpoint              \u2502 nceRole}                              \u2502                                       \u2502\n\u2502   \u2502                                       \u2502        \u2502 logs:CreateLogStream                  \u2502                                       \u2502                                       \u2502\n\u2502   \u2502                                       \u2502        \u2502 logs:PutLogEvents                     \u2502                                       \u2502                                       \u2502\n\u2502 + \u2502 *                                     \u2502 Allow  \u2502 ec2:DescribeHosts                     \u2502 AWS:$\\{ECSCluster/ECSEC2Capacity/Drain \u2502                                       \u2502\n\u2502   \u2502                                       \u2502        \u2502 ec2:DescribeInstanceAttribute         \u2502 ECSHook/Function/ServiceRole}         \u2502                                       \u2502\n\u2502   \u2502                                       \u2502        \u2502 ec2:DescribeInstanceStatus            \u2502                                       \u2502                                       \u2502\n\u2502   \u2502                                       \u2502        \u2502 ec2:DescribeInstances                 \u2502                                       \u2502                                       \u2502\n\u2502 + \u2502 *                                     \u2502 Allow  \u2502 ecs:DescribeContainerInstances        \u2502 AWS:$\\{ECSCluster/ECSEC2Capacity/Drain \u2502 "ArnEquals": {                        \u2502\n\u2502   \u2502                                       \u2502        \u2502 ecs:DescribeTasks                     \u2502 ECSHook/Function/ServiceRole}         \u2502   "ecs:cluster": "$\\{ECSCluster.Arn}"  \u2502\n\u2502   \u2502                                       \u2502        \u2502                                       \u2502                                       \u2502 }                                     \u2502\n\u2502 + \u2502 *                                     \u2502 Allow  \u2502 ecs:ListTasks                         \u2502 AWS:$\\{ECSCluster/ECSEC2Capacity/Drain \u2502 "ArnEquals": {                        \u2502\n\u2502   \u2502                                       \u2502        \u2502 ecs:UpdateContainerInstancesState     \u2502 ECSHook/Function/ServiceRole}         \u2502   "ecs:cluster": "$\\{ECSCluster.Arn}"  \u2502\n\u2502   \u2502                                       \u2502        \u2502                                       \u2502                                       \u2502 }                                     \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 arn:$\\{AWS::Partition}:autoscaling:us- \u2502 Allow  \u2502 autoscaling:CompleteLifecycleAction   \u2502 AWS:$\\{ECSCluster/ECSEC2Capacity/Drain \u2502                                       \u2502\n\u2502   \u2502 east-1:$\\{AWS::AccountId}:autoScalingG \u2502        \u2502                                       \u2502 ECSHook/Function/ServiceRole}         \u2502                                       \u2502\n\u2502   \u2502 roup:*:autoScalingGroupName/$\\{ECSClus \u2502        \u2502                                       \u2502                                       \u2502                                       \u2502\n\u2502   \u2502 ter/ECSEC2Capacity/ASG}               \u2502        \u2502                                       \u2502                                       \u2502                                       \u2502\n\u2514\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nIAM Policy Changes\n\u250c\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   \u2502 Resource                                                       \u2502 Managed Policy ARN                                                             \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 $\\{ECSCluster/ECSEC2Capacity/DrainECSHook/Function/ServiceRole} \u2502 arn:$\\{AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole \u2502\n\u2514\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nSecurity Group Changes\n\u250c\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   \u2502 Group                                                      \u2502 Dir \u2502 Protocol   \u2502 Peer            \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 $\\{ECSCluster/ECSEC2Capacity/InstanceSecurityGroup.GroupId} \u2502 Out \u2502 Everything \u2502 Everyone (IPv4) \u2502\n\u2514\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n(NOTE: There may be security-related changes not in this list. See https://github.com/aws/aws-cdk/issues/1299)\n\nParameters\n[+] Parameter SsmParameterValue:--aws--service--ecs--optimized-ami--amazon-linux-2--recommended--image_id:C96584B6-F00A-464E-AD19-53AFF4B05118.Parameter SsmParameterValueawsserviceecsoptimizedamiamazonlinux2recommendedimageidC96584B6F00A464EAD1953AFF4B05118Parameter: {"Type":"AWS::SSM::Parameter::Value<AWS::EC2::Image::Id />","Default":"/aws/service/ecs/optimized-ami/amazon-linux-2/recommended/image_id"}\n\nResources\n[+] AWS::EC2::SecurityGroup ECSCluster/ECSEC2Capacity/InstanceSecurityGroup ECSClusterECSEC2CapacityInstanceSecurityGroupDAADD78F\n[+] AWS::IAM::Role ECSCluster/ECSEC2Capacity/InstanceRole ECSClusterECSEC2CapacityInstanceRole5C2EC45B\n[+] AWS::IAM::Policy ECSCluster/ECSEC2Capacity/InstanceRole/DefaultPolicy ECSClusterECSEC2CapacityInstanceRoleDefaultPolicy204B9A6A\n[+] AWS::IAM::InstanceProfile ECSCluster/ECSEC2Capacity/InstanceProfile ECSClusterECSEC2CapacityInstanceProfileB82D3818\n[+] AWS::AutoScaling::LaunchConfiguration ECSCluster/ECSEC2Capacity/LaunchConfig ECSClusterECSEC2CapacityLaunchConfigC81E218C\n[+] AWS::AutoScaling::AutoScalingGroup ECSCluster/ECSEC2Capacity/ASG ECSClusterECSEC2CapacityASG0360B1DE\n[+] AWS::IAM::Role ECSCluster/ECSEC2Capacity/DrainECSHook/Function/ServiceRole ECSClusterECSEC2CapacityDrainECSHookFunctionServiceRole8F3CBCE3\n[+] AWS::IAM::Policy ECSCluster/ECSEC2Capacity/DrainECSHook/Function/ServiceRole/DefaultPolicy ECSClusterECSEC2CapacityDrainECSHookFunctionServiceRoleDefaultPolicyBD54F91C\n[+] AWS::Lambda::Function ECSCluster/ECSEC2Capacity/DrainECSHook/Function ECSClusterECSEC2CapacityDrainECSHookFunctionBC271921\n[+] AWS::Lambda::Permission ECSCluster/ECSEC2Capacity/DrainECSHook/Function/AllowInvoke:ecsworkshopbaseECSClusterECSEC2CapacityLifecycleHookDrainHookTopic6CB57177 ECSClusterECSEC2CapacityDrainECSHookFunctionAllowInvokeecsworkshopbaseECSClusterECSEC2CapacityLifecycleHookDrainHookTopic6CB5717791CA5D6C\n[+] AWS::SNS::Subscription ECSCluster/ECSEC2Capacity/DrainECSHook/Function/Topic ECSClusterECSEC2CapacityDrainECSHookFunctionTopicECD58342\n[+] AWS::SNS::Topic ECSCluster/ECSEC2Capacity/LifecycleHookDrainHook/Topic ECSClusterECSEC2CapacityLifecycleHookDrainHookTopicCA6236FC\n[+] AWS::IAM::Role ECSCluster/ECSEC2Capacity/LifecycleHookDrainHook/Role ECSClusterECSEC2CapacityLifecycleHookDrainHookRoleA957F608\n[+] AWS::IAM::Policy ECSCluster/ECSEC2Capacity/LifecycleHookDrainHook/Role/DefaultPolicy ECSClusterECSEC2CapacityLifecycleHookDrainHookRoleDefaultPolicy94FDFE21\n[+] AWS::AutoScaling::LifecycleHook ECSCluster/ECSEC2Capacity/LifecycleHookDrainHook ECSClusterECSEC2CapacityLifecycleHookDrainHook247A252F\n\nOutputs\n[+] Output EC2AutoScalingGroupName EC2AutoScalingGroupName: {"Value":{"Ref":"ECSClusterECSEC2CapacityASG0360B1DE"},"Export":{"Name":"EC2ASGName"\\}\\}\n[~] Output ECSClusterSecGrp ECSClusterSecGrp: {"Value":"[]","Export":{"Name":"ECSSecGrpList"\\}\\} to {"Value":{"Fn::GetAtt":["ECSClusterECSEC2CapacityInstanceSecurityGroupDAADD78F","GroupId"]},"Export":{"Name":"ECSSecGrpList"\\}\\}\n\n\n\u2728  Number of stacks with differences: 1\n'})}),"\n",(0,c.jsx)(a.p,{children:"deploy it"}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:"~/R/A/environment/ecsdemo-platform/cdk on main !1 \u276f cdk deploy --require-approval never                                                       took \uf252 36s at \uf017 11:06:30\n\n\u2728  Synthesis time: 4.31s\n\necsworkshop-base:  start: Building d68465c701bd94c7cbb8e20a0e2c5c976d6b2f15809bc2863698ac8a0fe8f5a3:current_account-us-east-1\necsworkshop-base:  success: Built d68465c701bd94c7cbb8e20a0e2c5c976d6b2f15809bc2863698ac8a0fe8f5a3:current_account-us-east-1\necsworkshop-base:  start: Publishing d68465c701bd94c7cbb8e20a0e2c5c976d6b2f15809bc2863698ac8a0fe8f5a3:current_account-us-east-1\necsworkshop-base:  success: Published d68465c701bd94c7cbb8e20a0e2c5c976d6b2f15809bc2863698ac8a0fe8f5a3:current_account-us-east-1\necsworkshop-base: deploying... [1/1]\necsworkshop-base: creating CloudFormation changeset...\n\n \u2705  ecsworkshop-base\n\n\u2728  Deployment time: 234.63s\n\nOutputs:\necsworkshop-base.EC2AutoScalingGroupName = ecsworkshop-base-ECSClusterECSEC2CapacityASG0360B1DE-xEFw4dFsjW1P\necsworkshop-base.ECSClusterName = container-demo\necsworkshop-base.ECSClusterSecGrp = sg-0d4e883de3f665308\necsworkshop-base.FE2BESecGrp = sg-08ad8552ab5a42e2d\necsworkshop-base.NSArn = arn:aws:servicediscovery:us-east-1:REDACTED:namespace/ns-qbclwxxkojytxj2w\necsworkshop-base.NSId = ns-qbclwxxkojytxj2w\necsworkshop-base.NSName = service.local\necsworkshop-base.ServicesSecGrp = sg-08ad8552ab5a42e2d\necsworkshop-base.StressToolEc2Id = i-0b5aa0dca21ce4bec\necsworkshop-base.StressToolEc2Ip = 10.0.0.188\nStack ARN:\narn:aws:cloudformation:us-east-1:REDACTED:stack/ecsworkshop-base/ca39eeb0-ed8d-11ee-b7f5-0affd09b0077\n\n\u2728  Total time: 238.94s\n"})}),"\n",(0,c.jsx)(a.h2,{id:"enable-cluster-auto-scaling",children:"Enable Cluster Auto Scaling"}),"\n",(0,c.jsxs)(a.p,{children:["cd to ",(0,c.jsx)(a.code,{children:"/ecsdemo-capacityproviders/ec2"})]}),"\n",(0,c.jsx)(a.p,{children:"this cli command will get us our variables and create capacity providers"}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:'# Get the required cluster values needed when creating the capacity provider\nexport asg_name=$(aws cloudformation describe-stacks --stack-name ecsworkshop-base --query \'Stacks[*].Outputs[?ExportName==`EC2ASGName`].OutputValue\' --output text)\nexport asg_arn=$(aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names $asg_name --query \'AutoScalingGroups[].AutoScalingGroupARN\' --output text)\nexport capacity_provider_name=$(echo "EC2$(date +\'%s\')")\n# Creating capacity provider\naws ecs create-capacity-provider \\\n     --name $capacity_provider_name \\\n     --auto-scaling-group-provider autoScalingGroupArn="$asg_arn",managedScaling=\\{status="ENABLED",targetCapacity=80\\},managedTerminationProtection="DISABLED" \\\n     --region $AWS_DEFAULT_REGION\n'})}),"\n",(0,c.jsxs)(a.p,{children:["note I changed ",(0,c.jsx)(a.code,{children:"--region $AWS_REGION"})," to ",(0,c.jsx)(a.code,{children:"--region $AWS_DEFAULT_REGION"})," for consistency with the rest of the workshop."]}),"\n",(0,c.jsxs)(a.p,{children:["run export commands first, check with ",(0,c.jsx)(a.code,{children:"env"})," command:"]}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:"asg_name=ecsworkshop-base-ECSClusterECSEC2CapacityASG0360B1DE-xEFw4dFsjW1P\nasg_arn=arn:aws:autoscaling:us-east-1:REDACTED:autoScalingGroup:a0d50b0e-2c73-4e46-96b6-b2ddd87e7c4f:autoScalingGroupName/ecsworkshop-base-ECSClusterECSEC2CapacityASG0360B1DE-xEFw4dFsjW1P\ncapacity_provider_name=EC21711750959\n"})}),"\n",(0,c.jsxs)(a.p,{children:["run the ",(0,c.jsx)(a.code,{children:"aws ecs create-capacity-provider..."})," command"]}),"\n",(0,c.jsx)(a.p,{children:"output"}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:'{\n    "capacityProvider": {\n        "capacityProviderArn": "arn:aws:ecs:us-east-1:REDACTED:capacity-provider/EC21711750959",\n        "name": "EC21711750959",\n        "status": "ACTIVE",\n        "autoScalingGroupProvider": {\n            "autoScalingGroupArn": "arn:aws:autoscaling:us-east-1:REDACTED:autoScalingGroup:a0d50b0e-2c73-4e46-96b6-b2ddd87e7c4f:autoScalingGroupName/ecsworkshop-base-ECSClusterECSEC2CapacityASG0360B1DE-xEFw4dFsjW1P",\n            "managedScaling": {\n                "status": "ENABLED",\n                "targetCapacity": 80,\n                "minimumScalingStepSize": 1,\n                "maximumScalingStepSize": 10000,\n                "instanceWarmupPeriod": 300\n            },\n            "managedTerminationProtection": "DISABLED",\n            "managedDraining": "ENABLED"\n        },\n        "tags": []\n    }\n}\n'})}),"\n",(0,c.jsx)(a.h3,{id:"associate-with-ecs-cluster",children:"associate with ecs cluster"}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:"aws ecs put-cluster-capacity-providers \\\n--cluster container-demo \\\n--capacity-providers $capacity_provider_name \\\n--default-capacity-provider-strategy capacityProvider=$capacity_provider_name,weight=1,base=1\n"})}),"\n",(0,c.jsx)(a.p,{children:"output"}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:'{\n    "cluster": {\n        "clusterArn": "arn:aws:ecs:us-east-1:REDACTED:cluster/container-demo",\n        "clusterName": "container-demo",\n        "status": "ACTIVE",\n        "registeredContainerInstancesCount": 0,\n        "runningTasksCount": 0,\n        "pendingTasksCount": 0,\n        "activeServicesCount": 0,\n        "statistics": [],\n        "tags": [],\n        "settings": [\n            {\n                "name": "containerInsights",\n                "value": "enabled"\n            }\n        ],\n        "capacityProviders": [\n            "EC21711750959"\n        ],\n        "defaultCapacityProviderStrategy": [\n            {\n                "capacityProvider": "EC21711750959",\n                "weight": 1,\n                "base": 1\n            }\n        ],\n        "attachments": [\n            {\n                "id": "3535c39c-3023-4831-8095-1ef0fff4ca73",\n                "type": "as_policy",\n                "status": "PRECREATED",\n                "details": [\n                    {\n                        "name": "capacityProviderName",\n                        "value": "EC21711750959"\n                    },\n                    {\n                        "name": "scalingPolicyName",\n                        "value": "ECSManagedAutoScalingPolicy-94cad5b7-6c97-46c9-afd9-d9c29966cd3d"\n                    }\n                ]\n            },\n            {\n                "id": "d169fff6-30d3-453e-b9c9-8ae22cb8868b",\n                "type": "managed_draining",\n                "status": "PRECREATED",\n                "details": [\n                    {\n                        "name": "capacityProviderName",\n                        "value": "EC21711750959"\n                    },\n                    {\n                        "name": "autoScalingLifecycleHookName",\n                        "value": "ecs-managed-draining-termination-hook"\n                    }\n                ]\n            }\n        ],\n        "attachmentsStatus": "UPDATE_IN_PROGRESS"\n    }\n}\n'})}),"\n",(0,c.jsxs)(a.p,{children:["run ",(0,c.jsx)(a.code,{children:"cdk diff"})]}),"\n",(0,c.jsx)(a.admonition,{type:"warning",children:(0,c.jsxs)(a.p,{children:["the environment vars in ",(0,c.jsx)(a.code,{children:"app.py"})," are again inconsistent with the other environments, using ",(0,c.jsx)(a.code,{children:"AWS_ACCOUNT_ID"})," instead of ",(0,c.jsx)(a.code,{children:"AWS_DEFAULT_ACCOUNT"}),". change this and re-run."]})}),"\n",(0,c.jsx)(a.p,{children:"our diff at this point"}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:'~/R/A/environment/ecsdemo-capacityproviders/ec2 on main !3 \u276f cdk diff                                                                                    at \uf017 11:32:29\nStack ecsworkshop-capacityproviders-ec2\nIAM Statement Changes\n\u250c\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   \u2502 Resource                                       \u2502 Effect \u2502 Action                                         \u2502 Principal                                       \u2502 Condition \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 $\\{EC2CapacityProviderService/TaskDef/Execution \u2502 Allow  \u2502 sts:AssumeRole                                 \u2502 Service:ecs-tasks.amazonaws.com                 \u2502           \u2502\n\u2502   \u2502 Role.Arn}                                      \u2502        \u2502                                                \u2502                                                 \u2502           \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 $\\{EC2CapacityProviderService/TaskDef/TaskRole. \u2502 Allow  \u2502 sts:AssumeRole                                 \u2502 Service:ecs-tasks.amazonaws.com                 \u2502           \u2502\n\u2502   \u2502 Arn}                                           \u2502        \u2502                                                \u2502                                                 \u2502           \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 $\\{EC2CapacityProviderService/TaskDef/web/LogGr \u2502 Allow  \u2502 logs:CreateLogStream                           \u2502 AWS:$\\{EC2CapacityProviderService/TaskDef/Execut \u2502           \u2502\n\u2502   \u2502 oup.Arn}                                       \u2502        \u2502 logs:PutLogEvents                              \u2502 ionRole}                                        \u2502           \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 *                                              \u2502 Allow  \u2502 ecs:DescribeTasks                              \u2502 AWS:$\\{EC2CapacityProviderService/TaskDef/TaskRo \u2502           \u2502\n\u2502   \u2502                                                \u2502        \u2502 ecs:ListTasks                                  \u2502 le}                                             \u2502           \u2502\n\u2514\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nSecurity Group Changes\n\u250c\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   \u2502 Group                                                  \u2502 Dir \u2502 Protocol        \u2502 Peer                                                   \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 $\\{EC2CapacityProviderService/LB/SecurityGroup.GroupId} \u2502 In  \u2502 TCP 80          \u2502 Everyone (IPv4)                                        \u2502\n\u2502 + \u2502 $\\{EC2CapacityProviderService/LB/SecurityGroup.GroupId} \u2502 Out \u2502 TCP 32768-65535 \u2502 {"Fn::ImportValue":"ECSSecGrpList"}                    \u2502\n\u251c\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + \u2502 {"Fn::ImportValue":"ECSSecGrpList"}                    \u2502 In  \u2502 TCP 32768-65535 \u2502 $\\{EC2CapacityProviderService/LB/SecurityGroup.GroupId} \u2502\n\u2514\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n(NOTE: There may be security-related changes not in this list. See https://github.com/aws/aws-cdk/issues/1299)\n\nParameters\n[+] Parameter BootstrapVersion BootstrapVersion: {"Type":"AWS::SSM::Parameter::Value<String />","Default":"/cdk-bootstrap/hnb659fds/version","Description":"Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"}\n\nResources\n[+] AWS::EC2::SecurityGroupIngress ecsworkshop-capacityproviders-ec2/ClusterSecGrp/from ecsworkshopcapacityprovidersec2EC2CapacityProviderServiceLBSecurityGroup97DF3EC1:32768-65535 ecsworkshopcapacityprovidersec2ClusterSecGrpfromecsworkshopcapacityprovidersec2EC2CapacityProviderServiceLBSecurityGroup97DF3EC13276865535377BCE64\n[+] AWS::ElasticLoadBalancingV2::LoadBalancer EC2CapacityProviderService/LB EC2CapacityProviderServiceLBDC92E31F\n[+] AWS::EC2::SecurityGroup EC2CapacityProviderService/LB/SecurityGroup EC2CapacityProviderServiceLBSecurityGroup1FC0A81A\n[+] AWS::EC2::SecurityGroupEgress EC2CapacityProviderService/LB/SecurityGroup/to ecsworkshopcapacityprovidersec2ClusterSecGrp2FAA1878:32768-65535 EC2CapacityProviderServiceLBSecurityGrouptoecsworkshopcapacityprovidersec2ClusterSecGrp2FAA187832768655354D60F766\n[+] AWS::ElasticLoadBalancingV2::Listener EC2CapacityProviderService/LB/PublicListener EC2CapacityProviderServiceLBPublicListenerD5E769DC\n[+] AWS::ElasticLoadBalancingV2::TargetGroup EC2CapacityProviderService/LB/PublicListener/ECSGroup EC2CapacityProviderServiceLBPublicListenerECSGroupFB7C9653\n[+] AWS::IAM::Role EC2CapacityProviderService/TaskDef/TaskRole EC2CapacityProviderServiceTaskDefTaskRoleE63CB5D4\n[+] AWS::IAM::Policy EC2CapacityProviderService/TaskDef/TaskRole/DefaultPolicy EC2CapacityProviderServiceTaskDefTaskRoleDefaultPolicyD8AD577A\n[+] AWS::ECS::TaskDefinition EC2CapacityProviderService/TaskDef EC2CapacityProviderServiceTaskDefEF5CC3D5\n[+] AWS::Logs::LogGroup EC2CapacityProviderService/TaskDef/web/LogGroup EC2CapacityProviderServiceTaskDefwebLogGroupADF50DEA\n[+] AWS::IAM::Role EC2CapacityProviderService/TaskDef/ExecutionRole EC2CapacityProviderServiceTaskDefExecutionRole8EC4417E\n[+] AWS::IAM::Policy EC2CapacityProviderService/TaskDef/ExecutionRole/DefaultPolicy EC2CapacityProviderServiceTaskDefExecutionRoleDefaultPolicyECD3E026\n[+] AWS::ECS::Service EC2CapacityProviderService/Service/Service EC2CapacityProviderServiceF75CB01B\n\nOutputs\n[+] Output EC2CapacityProviderService/LoadBalancerDNS EC2CapacityProviderServiceLoadBalancerDNS3B55F46D: {"Value":{"Fn::GetAtt":["EC2CapacityProviderServiceLBDC92E31F","DNSName"]\\}\\}\n[+] Output EC2CapacityProviderService/ServiceURL EC2CapacityProviderServiceServiceURL81036241: {"Value":{"Fn::Join":["",["http://",{"Fn::GetAtt":["EC2CapacityProviderServiceLBDC92E31F","DNSName"]}]]\\}\\}\n\nOther Changes\n[+] Unknown Rules: {"CheckBootstrapVersion":{"Assertions":[{"Assert":{"Fn::Not":[{"Fn::Contains":[["1","2","3","4","5"],{"Ref":"BootstrapVersion"}]}]},"AssertDescription":"CDK bootstrap stack version 6 required. Please run \'cdk bootstrap\' with a recent version of the CDK CLI."}]\\}\\}\n\n\n\u2728  Number of stacks with differences: 1\n'})}),"\n",(0,c.jsxs)(a.p,{children:["deploy changes: ",(0,c.jsx)(a.code,{children:"cdk deploy --require-approval never"})]}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:"~/R/A/e/ecsdemo-capacityproviders/ec2 on main !3 \u276f cdk deploy --require-approval never                                                        took \uf252 20s at \uf017 11:32:52\n\n\u2728  Synthesis time: 4.4s\n\necsworkshop-capacityproviders-ec2:  start: Building ab7a872fe0b5ea93e4f3b2c6cf19703f2465644c60cb1cc942578cd17ef35c97:REDACTED-us-east-1\necsworkshop-capacityproviders-ec2:  success: Built ab7a872fe0b5ea93e4f3b2c6cf19703f2465644c60cb1cc942578cd17ef35c97:REDACTED-us-east-1\necsworkshop-capacityproviders-ec2:  start: Publishing ab7a872fe0b5ea93e4f3b2c6cf19703f2465644c60cb1cc942578cd17ef35c97:REDACTED-us-east-1\necsworkshop-capacityproviders-ec2:  success: Published ab7a872fe0b5ea93e4f3b2c6cf19703f2465644c60cb1cc942578cd17ef35c97:REDACTED-us-east-1\necsworkshop-capacityproviders-ec2: deploying... [1/1]\necsworkshop-capacityproviders-ec2: creating CloudFormation changeset...\n\n \u2705  ecsworkshop-capacityproviders-ec2\n\n\u2728  Deployment time: 240.24s\n\nOutputs:\necsworkshop-capacityproviders-ec2.EC2CapacityProviderServiceLoadBalancerDNS3B55F46D = ecswor-EC2Ca-wrQjekI8GOdK-91492963.us-east-1.elb.amazonaws.com\necsworkshop-capacityproviders-ec2.EC2CapacityProviderServiceServiceURL81036241 = http://ecswor-EC2Ca-wrQjekI8GOdK-91492963.us-east-1.elb.amazonaws.com\nStack ARN:\narn:aws:cloudformation:us-east-1:REDACTED:stack/ecsworkshop-capacityproviders-ec2/818cd710-ee1c-11ee-9632-12aa7a2ddd5f\n\n\u2728  Total time: 244.64s\n"})}),"\n",(0,c.jsx)(a.p,{children:"check in console"}),"\n",(0,c.jsx)(a.p,{children:(0,c.jsx)(a.img,{alt:"ec2 asg",src:r(52810).A+"",width:"1539",height:"822"})}),"\n",(0,c.jsx)(a.h3,{id:"scale-out-1-to-10",children:"scale out 1 to 10"}),"\n",(0,c.jsxs)(a.p,{children:["edit ",(0,c.jsx)(a.code,{children:"app.py"})," change count from ",(0,c.jsx)(a.code,{children:"1"})," to ",(0,c.jsx)(a.code,{children:"10"})," and redeploy."]}),"\n",(0,c.jsx)(a.p,{children:'From the notes, understand what will happen. The capacity provider (CP) is set to maintain "total cluster capacity" at 80% and below. If the CP detects we\'re going to blow that, it\'ll trigger the autoscaling event and scale EC2\'s until "total cluster capacity" is 80% and below again.'}),"\n",(0,c.jsxs)(a.p,{children:["change in ",(0,c.jsx)(a.code,{children:"app.py"})]}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:"        self.load_balanced_service = aws_ecs_patterns.ApplicationLoadBalancedEc2Service(\n            self, \"EC2CapacityProviderService\",\n            service_name='ecsdemo-capacityproviders-ec2',\n            cluster=self.base_platform.ecs_cluster,\n            cpu=256,\n            memory_limit_mib=512,\n            #desired_count=1,\n            desired_count=10,\n            public_load_balancer=True,\n            task_image_options=self.task_image,\n        )\n"})}),"\n",(0,c.jsx)(a.p,{children:"output"}),"\n",(0,c.jsx)(a.pre,{children:(0,c.jsx)(a.code,{className:"language-bash",children:"~/R/A/e/ecsdemo-capacityproviders/ec2 on main !3 \u276f cdk deploy --require-approval never                                                        took \uf252 29s at \uf017 12:28:34\n\n\u2728  Synthesis time: 4.7s\n\necsworkshop-capacityproviders-ec2:  start: Building d0479eaf8688429dd4e51bfc4154dcf5d34a599cb48341ad8cc82555f02567ce:REDACTED-us-east-1\necsworkshop-capacityproviders-ec2:  success: Built d0479eaf8688429dd4e51bfc4154dcf5d34a599cb48341ad8cc82555f02567ce:REDACTED-us-east-1\necsworkshop-capacityproviders-ec2:  start: Publishing d0479eaf8688429dd4e51bfc4154dcf5d34a599cb48341ad8cc82555f02567ce:REDACTED-us-east-1\necsworkshop-capacityproviders-ec2:  success: Published d0479eaf8688429dd4e51bfc4154dcf5d34a599cb48341ad8cc82555f02567ce:REDACTED-us-east-1\necsworkshop-capacityproviders-ec2: deploying... [1/1]\necsworkshop-capacityproviders-ec2: creating CloudFormation changeset...\n\n \u2705  ecsworkshop-capacityproviders-ec2\n\n\u2728  Deployment time: 231.23s\n\nOutputs:\necsworkshop-capacityproviders-ec2.EC2CapacityProviderServiceLoadBalancerDNS3B55F46D = ecswor-EC2Ca-wrQjekI8GOdK-91492963.us-east-1.elb.amazonaws.com\necsworkshop-capacityproviders-ec2.EC2CapacityProviderServiceServiceURL81036241 = http://ecswor-EC2Ca-wrQjekI8GOdK-91492963.us-east-1.elb.amazonaws.com\nStack ARN:\narn:aws:cloudformation:us-east-1:REDACTED:stack/ecsworkshop-capacityproviders-ec2/818cd710-ee1c-11ee-9632-12aa7a2ddd5f\n\n\u2728  Total time: 235.93s\n"})}),"\n",(0,c.jsx)(a.p,{children:"check console"}),"\n",(0,c.jsx)(a.p,{children:(0,c.jsx)(a.img,{alt:"asg scale",src:r(93387).A+"",width:"1514",height:"658"})}),"\n",(0,c.jsx)(a.h2,{id:"clean-up-ec2",children:"Clean Up EC2"}),"\n",(0,c.jsxs)(a.p,{children:["You can scale it back down, change cound to ",(0,c.jsx)(a.code,{children:"1"})," and ",(0,c.jsx)(a.code,{children:"cdk deploy..."})," again, then clean up with ",(0,c.jsx)(a.code,{children:"cdk destroy -f"})," inside the ",(0,c.jsx)(a.code,{children:"/ec2"})," folder."]}),"\n",(0,c.jsx)(a.p,{children:"Done."})]})}function p(e={}){const{wrapper:a}={...(0,s.R)(),...e.components};return a?(0,c.jsx)(a,{...e,children:(0,c.jsx)(l,{...e})}):l(e)}},93387:(e,a,r)=>{r.d(a,{A:()=>n});const n=r.p+"assets/images/ecsworkshop-capacityproviders-asg-scale-059d263cd13b1d047a7ecdf3e0354eb5.png"}}]);