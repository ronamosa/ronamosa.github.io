"use strict";(self.webpackChunkronamosa_github_io=self.webpackChunkronamosa_github_io||[]).push([[32507],{21644:(e,r,n)=>{n.d(r,{A:()=>o});const o=n.p+"assets/images/pve-opn-100-841f0b7461f15465dbd3c42608b3c1f5.png"},28453:(e,r,n)=>{n.d(r,{R:()=>t,x:()=>a});var o=n(96540);const s={},i=o.createContext(s);function t(e){const r=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),o.createElement(i.Provider,{value:r},e.children)}},36606:(e,r,n)=>{n.d(r,{A:()=>o});const o=n.p+"assets/images/pve-upload-dir-41665a2181e75f286f01ea7e9633c936.png"},38068:(e,r,n)=>{n.d(r,{A:()=>o});const o=n.p+"assets/images/pve-priv-separate-746c2788878b8a9defdfdf631d8a301f.png"},52516:(e,r,n)=>{n.d(r,{A:()=>o});const o=n.p+"assets/images/pve-error-priv-sep-a6581c2c55b3b0ed6406813ca0cb4aff.png"},66924:(e,r,n)=>{n.d(r,{A:()=>o});const o=n.p+"assets/images/pve-upload-2ec3fca78e4031cdac3374133e3e3133.png"},76249:(e,r,n)=>{n.d(r,{A:()=>o});const o=n.p+"assets/images/pve-qemu-success-953892254f15babb01d48b8fbb9f8e43.png"},77344:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>d,contentTitle:()=>a,default:()=>p,frontMatter:()=>t,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"engineer/LAB/proxmox-terraform","title":"Proxmox: Deploying Infrastructure with Terraform","description":"Nerd-sniped by someone in the PTN playing with this, so I decided to give it a go. Objective is to create an OPNsense Firewall VM, in proxmox, using the terraform proxmox provider.","source":"@site/docs/engineer/LAB/proxmox-terraform.md","sourceDirName":"engineer/LAB","slug":"/engineer/LAB/proxmox-terraform","permalink":"/docs/engineer/LAB/proxmox-terraform","draft":false,"unlisted":false,"editUrl":"https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/engineer/LAB/proxmox-terraform.md","tags":[],"version":"current","lastUpdatedBy":"Ron Amosa","lastUpdatedAt":1771617957000,"frontMatter":{"title":"Proxmox: Deploying Infrastructure with Terraform"},"sidebar":"docsSidebar","previous":{"title":"Proxmox: Systems Administration Notes","permalink":"/docs/engineer/LAB/proxmox-sysad"},"next":{"title":"Algorithms for Systems Design - Scalable Architecture Patterns and Data Structures","permalink":"/docs/engineer/Misc/algos-system-design"}}');var s=n(74848),i=n(28453);const t={title:"Proxmox: Deploying Infrastructure with Terraform"},a=void 0,d={},l=[{value:"Proxmox Setup",id:"proxmox-setup",level:2},{value:"User Setup",id:"user-setup",level:3},{value:"API Token",id:"api-token",level:3},{value:"Terraform Setup",id:"terraform-setup",level:2},{value:"cli using password",id:"cli-using-password",level:3},{value:"cli with API token",id:"cli-with-api-token",level:3},{value:"Download OPNsense ISO",id:"download-opnsense-iso",level:2},{value:"Terraform Code",id:"terraform-code",level:2},{value:"providers.tf",id:"providerstf",level:3},{value:"main.tf",id:"maintf",level:3},{value:"Execute: init, plan, apply",id:"execute-init-plan-apply",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Provider not found",id:"provider-not-found",level:3},{value:"API token reference in code",id:"api-token-reference-in-code",level:3},{value:"501 no such file &#39;/json/access/users&#39;",id:"501-no-such-file-jsonaccessusers",level:3},{value:"privilege separation error",id:"privilege-separation-error",level:3}];function c(e){const r={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.p,{children:"Nerd-sniped by someone in the PTN playing with this, so I decided to give it a go. Objective is to create an OPNsense Firewall VM, in proxmox, using the terraform proxmox provider."}),"\n",(0,s.jsx)(r.admonition,{title:"terraform proxmox provider",type:"info",children:(0,s.jsxs)(r.p,{children:["docs: ",(0,s.jsx)(r.a,{href:"https://registry.terraform.io/providers/Telmate/proxmox/latest/docs",children:"https://registry.terraform.io/providers/Telmate/proxmox/latest/docs"})]})}),"\n",(0,s.jsx)(r.h2,{id:"proxmox-setup",children:"Proxmox Setup"}),"\n",(0,s.jsx)(r.h3,{id:"user-setup",children:"User Setup"}),"\n",(0,s.jsx)(r.p,{children:"SSH into your PVE host, and run the following commands to create a role, a user, and associate them together:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'# 1. Create Role\n\npveum role add TerraformProv -privs "Datastore.AllocateSpace Datastore.Audit Pool.Allocate Sys.Audit Sys.Console Sys.Modify VM.Allocate VM.Audit VM.Clone VM.Config.CDROM VM.Config.Cloudinit VM.Config.CPU VM.Config.Disk VM.Config.HWType VM.Config.Memory VM.Config.Network VM.Config.Options VM.Migrate VM.Monitor VM.PowerMgmt"\n\n# 2. Create User\n# - note the command balks at special characters in the terminal\n# - ended up resetting to strong password via GUI\n\npveum user add terraform-prov@pve --password <password />\n\n# 3. Associate Role & User\npveum aclmod / -user terraform-prov@pve -role TerraformProv\n'})}),"\n",(0,s.jsx)(r.h3,{id:"api-token",children:"API Token"}),"\n",(0,s.jsxs)(r.p,{children:["From the proxmox GUI, create an API Token for the ",(0,s.jsx)(r.code,{children:"terraform-prov"})," user."]}),"\n",(0,s.jsx)(r.p,{children:'note: ensure "privilege separation" for your API Token is disabled or terraform will error out later on:'}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.img,{alt:"pve disable priv separation",src:n(38068).A+"",width:"1242",height:"454"})}),"\n",(0,s.jsx)(r.h2,{id:"terraform-setup",children:"Terraform Setup"}),"\n",(0,s.jsx)(r.p,{children:"Use the proxmox credentials we've created, with the cli tool to authenticate to the proxmox environment."}),"\n",(0,s.jsx)(r.h3,{id:"cli-using-password",children:"cli using password"}),"\n",(0,s.jsx)(r.p,{children:"couple of options:"}),"\n",(0,s.jsx)(r.p,{children:"pass through via environment variables:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'export PM_USER="terraform-prov@pve"\nexport PM_PASS="password"\n'})}),"\n",(0,s.jsxs)(r.p,{children:["or use Hashicorp Vault, but don't hard code them in ",(0,s.jsx)(r.code,{children:"main.tf"})," even if you can."]}),"\n",(0,s.jsx)(r.p,{children:"setup provider:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'provider "proxmox" {\n  pm_api_url = "https://proxmox-server01.example.com:8006/api2/json"\n}\n'})}),"\n",(0,s.jsx)(r.h3,{id:"cli-with-api-token",children:"cli with API token"}),"\n",(0,s.jsxs)(r.p,{children:["create a token via GUI, example below is token name ",(0,s.jsx)(r.code,{children:"infra"})," and token value ",(0,s.jsx)(r.code,{children:"9f526660-eda2-4696-XXXX-33ea3e8691e7"})]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"export PM_API_TOKEN_ID='terraform-prov@pve!infra'\nexport PM_API_TOKEN_SECRET=\"9f526660-eda2-4696-XXXX-33ea3e8691e7\"\n"})}),"\n",(0,s.jsx)(r.admonition,{type:"tip",children:(0,s.jsxs)(r.p,{children:["For your ",(0,s.jsx)(r.code,{children:"PM_API_TOKEN_ID"})," value, with special characters, use single quotes ",(0,s.jsx)(r.code,{children:"'"})," for zsh to escape the ",(0,s.jsx)(r.code,{children:"!"})]})}),"\n",(0,s.jsx)(r.p,{children:"and same provider"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'provider "proxmox" {\n  pm_api_url = "https://proxmox-server01.example.com:8006/api2/json"\n}\n'})}),"\n",(0,s.jsx)(r.h2,{id:"download-opnsense-iso",children:"Download OPNsense ISO"}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsxs)(r.li,{children:["Download dvd iso here: ",(0,s.jsx)(r.a,{href:"https://opnsense.org/download/",children:"OPNsense download"})," (pick a local mirror)"]}),"\n",(0,s.jsxs)(r.li,{children:["Unzip in your local ",(0,s.jsx)(r.code,{children:"bzip2 -d OPNsense-23.7-dvd-amd64.iso.bz2"})]}),"\n",(0,s.jsxs)(r.li,{children:["Upload to your PVE storage ",(0,s.jsx)(r.img,{alt:"pve upload",src:n(66924).A+"",width:"1368",height:"1060"})]}),"\n",(0,s.jsxs)(r.li,{children:["Confirm its in your PVE host: ",(0,s.jsx)(r.img,{alt:"pve confirm",src:n(36606).A+"",width:"576",height:"388"})]}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:"OPNsense should be good to go as the target OS for this post."}),"\n",(0,s.jsx)(r.h2,{id:"terraform-code",children:"Terraform Code"}),"\n",(0,s.jsx)(r.p,{children:"The following two files is all you need create the OPNsense QEMU VM on proxmox."}),"\n",(0,s.jsx)(r.h3,{id:"providerstf",children:"providers.tf"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-hcl",children:'terraform {\n  required_version = ">= 0.15"\n  required_providers {\n    proxmox = {\n      source = "telmate/proxmox"\n    }\n  }\n}\n\nprovider "proxmox" {\n  # pm_debug = true\n  # pm_tls_insecure = true\n\n  pm_api_url = "https://$\\{PROXMOX_HOST}:8006/api2/json"\n}\n'})}),"\n",(0,s.jsx)(r.h3,{id:"maintf",children:"main.tf"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-hcl",children:'resource "proxmox_vm_qemu" "firewall" {\n  name        = "OPNsenseFW"\n  desc        = "OPNsense Firewall"\n  target_node = "pve1"\n  iso         = "SynoNFS1:iso/OPNsense-23.7-dvd-amd64.iso"\n  os_type     = "Linux"\n  cores       = 2\n  sockets     = 1\n  memory      = 2048\n  scsihw      = "virtio-scsi-single"\n  bootdisk    = "scsi0"\n\n  disk {\n    slot = 0\n    # set disk size here. leave it small for testing because expanding the disk takes time.\n    size     = "10G"\n    type     = "scsi"\n    storage  = "SynoNFS1"\n    iothread = 1\n  }\n\n  network {\n    model  = "virtio"\n    bridge = "vmbr0"\n  }\n\n  ### or for a PXE boot VM operation\n  # pxe = true\n  # boot = "scsi0;net0"\n  # agent = 0\n}\n'})}),"\n",(0,s.jsx)(r.h3,{id:"execute-init-plan-apply",children:"Execute: init, plan, apply"}),"\n",(0,s.jsxs)(r.p,{children:["Setup your credentials in the terminal, ready for ",(0,s.jsx)(r.code,{children:"terraform"}),", here I'm using API tokens:"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"export PM_API_TOKEN_ID='terraform-prov@pve!infra'\nexport PM_API_TOKEN_SECRET=\"9f526660-eda2-4696-XXXX-33ea3e8691e7\"\n"})}),"\n",(0,s.jsx)(r.p,{children:"Run:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"terraform init\nterraform plan\nterraform apply\n"})}),"\n",(0,s.jsx)(r.p,{children:"Success!"}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.code,{children:"terraform apply"})," ran to completion:"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.img,{alt:"cli success",src:n(76249).A+"",width:"1418",height:"1614"})}),"\n",(0,s.jsx)(r.p,{children:"You can see the OPNsense VM is up & running:"}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.img,{alt:"cli success",src:n(21644).A+"",width:"2206",height:"738"})}),"\n",(0,s.jsx)(r.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,s.jsx)(r.p,{children:"Some errors and solutions from this adventure:"}),"\n",(0,s.jsx)(r.h3,{id:"provider-not-found",children:"Provider not found"}),"\n",(0,s.jsx)(r.p,{children:"trying to install Hashicorp/proxmox, gets me errors:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"~/Repos/proxmox-terraform \u276f terraform init\n\nInitializing the backend...\n\nInitializing provider plugins...\n- Finding latest version of hashicorp/proxmox...\n\u2577\n\u2502 Error: Failed to query available provider packages\n\u2502\n\u2502 Could not retrieve the list of available versions for provider hashicorp/proxmox: provider registry registry.terraform.io does not have a provider named\n\u2502 registry.terraform.io/hashicorp/proxmox\n\u2502\n\u2502 All modules should specify their required_providers so that external consumers will get the correct providers when using a module. To see which modules are\n\u2502 currently depending on hashicorp/proxmox, run the following command:\n\u2502     terraform providers\n"})}),"\n",(0,s.jsxs)(r.p,{children:["solution: ensure the ",(0,s.jsx)(r.code,{children:"proviers.tf"})," has ",(0,s.jsx)(r.code,{children:"telemate/proxmox"})," as the provider- I skipped the very first step."]}),"\n",(0,s.jsx)(r.h3,{id:"api-token-reference-in-code",children:"API token reference in code"}),"\n",(0,s.jsx)(r.p,{children:":::notes Docs"}),"\n",(0,s.jsxs)(r.p,{children:["documentation ",(0,s.jsx)(r.a,{href:"https://github.com/Telmate/terraform-provider-proxmox/blob/master/docs/index.md#creating-the-connection-via-username-and-api-token",children:"here"})]}),"\n",(0,s.jsx)(r.p,{children:":::"}),"\n",(0,s.jsx)(r.p,{children:"this is the hard-coded option (not recommended)"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'provider "proxmox" {\n  pm_api_url = "https://proxmox-server01.example.com:8006/api2/json"\n  pm_api_token_id = "somehardcodedvalue@pam!zxzxzxzxzcxczxczxczxc"\n  pm_api_token_secret = "zxxxxzxzxxzxzxzxzxzx"\n}\n'})}),"\n",(0,s.jsx)(r.p,{children:"use environment variables"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'export PM_API_TOKEN_ID="terraform-prov@pve!mytoken"\nexport PM_API_TOKEN_SECRET="afcd8f45-acc1-4d0f-bb12-a70b0777ec11"\n'})}),"\n",(0,s.jsx)(r.h3,{id:"501-no-such-file-jsonaccessusers",children:"501 no such file '/json/access/users'"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'~/Repos/proxmox-terraform \u276f terraform plan                                                                                                            13:56:59\n\nPlanning failed. Terraform encountered an error while generating this plan.\n\n\u2577\n\u2502 Error: 501 no such file \'/json/access/users\'\n\u2502\n\u2502   with provider["registry.terraform.io/telmate/proxmox"],\n\u2502   on providers.tf line 10, in provider "proxmox":\n\u2502   10: provider "proxmox" {\n\u2502\n\u2575\n'})}),"\n",(0,s.jsx)(r.p,{children:"turn on TF Debugging:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'~/Repos/proxmox-terraform \u276f export TF_LOG="DEBUG"\n'})}),"\n",(0,s.jsx)(r.p,{children:"logs"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'2023-09-23T15:56:31.415+1200 [ERROR] provider.terraform-provider-proxmox_v2.9.14: Response contains error diagnostic: diagnostic_summary="501 no such file \'/json/access/users\'" tf_provider_addr=registry.terraform.io/telmate/proxmox @caller=github.com/hashicorp/terraform-plugin-go@v0.14.3/tfprotov5/internal/diag/diagnostics.go:55 diagnostic_severity=ERROR tf_proto_version=5.3 tf_req_id=6fdfb1a2-9992-79d4-a33b-c2d4f441c2ba tf_rpc=Configure @module=sdk.proto diagnostic_detail= timestamp=2023-09-23T15:56:31.414+1200\n2023-09-23T15:56:31.416+1200 [ERROR] vertex "provider[\\"registry.terraform.io/telmate/proxmox\\"]" error: 501 no such file \'/json/access/users\'\n2023-09-23T15:56:31.417+1200 [INFO]  backend/local: plan operation completed\n'})}),"\n",(0,s.jsx)(r.p,{children:"solution: I had"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'provider "proxmox" {\n  pm_api_url = "https://pve1.darksyde.lan:8006//api2/json" #\n}\n'})}),"\n",(0,s.jsx)(r.p,{children:"instead of"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'provider "proxmox" {\n  pm_api_url = "https://pve1.darksyde.lan:8006/api2/json"\n}\n'})}),"\n",(0,s.jsx)(r.h3,{id:"privilege-separation-error",children:"privilege separation error"}),"\n",(0,s.jsx)(r.p,{children:"check the box is disabled when creating your API token (see above), or you get this error:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'Planning failed. Terraform encountered an error while generating this plan.\n\n\u2577\n\u2502 Error: user terraform-prov@pve has valid credentials but cannot retrieve user list, check privilege separation of api token\n\u2502\n\u2502   with provider["registry.terraform.io/telmate/proxmox"],\n\u2502   on providers.tf line 10, in provider "proxmox":\n\u2502   10: provider "proxmox" {\n\u2502\n'})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.img,{alt:"pve error priv separation",src:n(52516).A+"",width:"1782",height:"312"})})]})}function p(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}}}]);