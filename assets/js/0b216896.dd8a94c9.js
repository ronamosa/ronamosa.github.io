"use strict";(self.webpackChunkronamosa_github_io=self.webpackChunkronamosa_github_io||[]).push([[9193],{3972:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>p,frontMatter:()=>l,metadata:()=>a,toc:()=>o});const a=JSON.parse('{"id":"study/CKS/Supply Chain Security/SupplyChainImages","title":"Container Images","description":"Supply Chain Security and Container Images","source":"@site/docs/study/CKS/5. Supply Chain Security/SupplyChainImages.md","sourceDirName":"study/CKS/5. Supply Chain Security","slug":"/study/CKS/Supply Chain Security/SupplyChainImages","permalink":"/docs/study/CKS/Supply Chain Security/SupplyChainImages","draft":false,"unlisted":false,"editUrl":"https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/study/CKS/5. Supply Chain Security/SupplyChainImages.md","tags":[],"version":"current","lastUpdatedBy":"Ron Amosa","lastUpdatedAt":1758526302000,"frontMatter":{"title":"Container Images"},"sidebar":"docsSidebar","previous":{"title":"Manage Kubernetes Secrets","permalink":"/docs/study/CKS/Microservice Vulnerability/VulnerableSecrets"},"next":{"title":"Secure Supply Chain","permalink":"/docs/study/CKS/Supply Chain Security/SupplyChainSecurity"}}');var s=i(74848),r=i(28453);const l={title:"Container Images"},t=void 0,c={},o=[{value:"Containers &amp; Docker",id:"containers--docker",level:2},{value:"Reduce Footprint (Multistage)",id:"reduce-footprint-multistage",level:2},{value:"Secure Images",id:"secure-images",level:2},{value:"Layers",id:"layers",level:3},{value:"Image Vulnerability Scanning",id:"image-vulnerability-scanning",level:2},{value:"image scanning tools",id:"image-scanning-tools",level:3}];function d(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"Supply Chain Security and Container Images"}),"\n",(0,s.jsx)(n.h2,{id:"containers--docker",children:"Containers & Docker"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"review of previous info on containers vs vm"}),"\n",(0,s.jsx)(n.li,{children:"app / kernel group / host kernel / OS"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"continers build in layers"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dockerfile",children:'FROM ubuntu\nRUN apt update -y && apt get install -y curl\nCMD ["sh"]\n'})}),"\n",(0,s.jsx)(n.h2,{id:"reduce-footprint-multistage",children:"Reduce Footprint (Multistage)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dockerfile",children:'FROM ubuntu\nARG DEBIAN_FRONTEND=noninteractive\nRUN apt-get update && apt-get install -y golang-go\nCOPY app.go .\nRUN CGO_ENABLED=0 go build app.go\nCMD ["./app"]\n'})}),"\n",(0,s.jsx)(n.p,{children:"app.go"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-golang",children:'package main\n\nimport (\n    "fmt"\n    "time"\n    "os/user"\n)\n\nfunc main () {\n    user, err := user.Current()\n    if err != nil {\n        panic(err)\n    }\n\n    for {\n        fmt.Println("user: " + user.Username + " id: " + user.Uid)\n        time.Sleep(1 * time.Second)\n    }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"look at the size of the image"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker image list | grep app\napp                                             latest    095865436e26   4 minutes ago   693MB\n"})}),"\n",(0,s.jsx)(n.p,{children:"lets reduce using multi-stage build"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dockerfile",children:'# build stage (0)\nFROM ubuntu\nARG DEBIAN_FRONTEND=noninteractive\nRUN apt-get update && apt-get install -y golang-go\nCOPY app.go .\nRUN CGO_ENABLED=0 go build app.go\n\n# runtime stage\nFROM alpine\nCOPY --from=0 /app .\nCMD ["./app"]\n'})}),"\n",(0,s.jsx)(n.p,{children:"check size"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:" docker image list | grep app\napp                                             latest    8ed877429a72   15 seconds ago   7.73MB\n"})}),"\n",(0,s.jsx)(n.h2,{id:"secure-images",children:"Secure Images"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["use specific verions of images (not default/latest) e.g. ",(0,s.jsx)(n.code,{children:"FROM alpine:3.12.1"})]}),"\n",(0,s.jsxs)(n.li,{children:["dont run as root, create a user e.g. ",(0,s.jsx)(n.code,{children:"RUN addgroup -S appgroup && adduser -G appgroup -h /home/appuser"})," (see below)"]}),"\n",(0,s.jsxs)(n.li,{children:["make filesystem read-only e.g. ",(0,s.jsx)(n.code,{children:"RUN chmod a-w /etc"})," or any other folders"]}),"\n",(0,s.jsxs)(n.li,{children:["remove shell access e.g. ",(0,s.jsx)(n.code,{children:"RUN rm -fr /bin/*"})," AFTER all ",(0,s.jsx)(n.code,{children:"RUN"})," is complete that might need apps under ",(0,s.jsx)(n.code,{children:"/bin/*"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"final solution:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dockerfile",children:'FROM ubuntu\nARG DEBIAN_FRONTEND=noninteractive\nRUN apt-get update && apt-get install -y golang-go\nCOPY app.go .\nRUN CGO_ENABLED=0 go build app.go\n\n# runtime stage\nFROM alpine:3.12.1\nRUN chmod a-w /etc\nRUN addgroup -S appgroup && adduser -G appgroup -h /home/appuser\nRUN rm -fr /bin/*\nCOPY --from=0 /app /home/appuser/\nUSER appuser\nCMD ["/home/appuser/app"]\n'})}),"\n",(0,s.jsx)(n.h3,{id:"layers",children:"Layers"}),"\n",(0,s.jsx)(n.p,{children:"note look at layers in docker best practice on best way to use them."}),"\n",(0,s.jsx)(n.h2,{id:"image-vulnerability-scanning",children:"Image Vulnerability Scanning"}),"\n",(0,s.jsx)(n.p,{children:"examples"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"buffer overflows in vuln apache images"}),"\n",(0,s.jsx)(n.li,{children:"the app itself"}),"\n",(0,s.jsx)(n.li,{children:"the dependencies inside the container"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"result"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"privesc"}),"\n",(0,s.jsx)(n.li,{children:"info leak"}),"\n",(0,s.jsx)(n.li,{children:"ddos"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"check each layer of the image, where bins may be installed on those layers e.g. curl, nginx, base image."}),"\n",(0,s.jsx)(n.p,{children:"when to check?"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"during build time"}),"\n",(0,s.jsx)(n.li,{children:"during run time"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"during code->commit, build (scan the registry when image pushed), enforce at deploy time using OPA"}),"\n",(0,s.jsx)(n.h3,{id:"image-scanning-tools",children:"image scanning tools"}),"\n",(0,s.jsx)(n.p,{children:"look at Clair (complex) and Trivy (simple) for image scanning"})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>t});var a=i(96540);const s={},r=a.createContext(s);function l(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);