"use strict";(self.webpackChunkronamosa_github_io=self.webpackChunkronamosa_github_io||[]).push([[39794],{28453:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>o});var r=s(96540);const t={},i=r.createContext(t);function c(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),r.createElement(i.Provider,{value:n},e.children)}},35715:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>c,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"study/CKS/Cluster Hardening/HardenRestrictAPI","title":"API Hardening / Restricting","description":"Request (human/pod+sa) --\x3e authN --\x3e authZ (k8s api) --\x3e admission controller","source":"@site/docs/study/CKS/2. Cluster Hardening/HardenRestrictAPI.md","sourceDirName":"study/CKS/2. Cluster Hardening","slug":"/study/CKS/Cluster Hardening/HardenRestrictAPI","permalink":"/docs/study/CKS/Cluster Hardening/HardenRestrictAPI","draft":false,"unlisted":false,"editUrl":"https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/study/CKS/2. Cluster Hardening/HardenRestrictAPI.md","tags":[],"version":"current","lastUpdatedBy":"Ron Amosa","lastUpdatedAt":1771617957000,"frontMatter":{"title":"API Hardening / Restricting"},"sidebar":"docsSidebar","previous":{"title":"Role Based Access Control (RBAC)","permalink":"/docs/study/CKS/Cluster Hardening/HardenRBAC"},"next":{"title":"AppArmor and Seccomp","permalink":"/docs/study/CKS/System Hardening/SystemHardAppArmorSeccomp"}}');var t=s(74848),i=s(28453);const c={title:"API Hardening / Restricting"},o=void 0,l={},d=[{value:"Anonymous Access",id:"anonymous-access",level:2},{value:"Insecure Access",id:"insecure-access",level:2},{value:"Manual API Request",id:"manual-api-request",level:2},{value:"External API Access",id:"external-api-access",level:2},{value:"NodeRestriction AdmissionController",id:"noderestriction-admissioncontroller",level:2},{value:"Verify NodeRestriction",id:"verify-noderestriction",level:2}];function a(e){const n={code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"Request (human/pod+sa) --\x3e authN --\x3e authZ (k8s api) --\x3e admission controller"}),"\n",(0,t.jsx)(n.p,{children:"Do's"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"dont allow anonymous access"}),"\n",(0,t.jsx)(n.li,{children:"close insecure ports"}),"\n",(0,t.jsx)(n.li,{children:"dont expose ApiServer to the internet"}),"\n",(0,t.jsx)(n.li,{children:"restrict access from Node --\x3e API (NodeRestriction)"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"anonymous-access",children:"Anonymous Access"}),"\n",(0,t.jsxs)(n.p,{children:["check ",(0,t.jsx)(n.code,{children:"/etc/kubernetes/manifest/kube-apiserver.yaml"})," for allowing anoymous access flags"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"spec:\n  containers:\n  - command:\n    - kube-apiserver\n    - --anonymous-auth=false\n"})}),"\n",(0,t.jsxs)(n.p,{children:["then check it via curl ",(0,t.jsx)(n.code,{children:"root@master$ curl -k https://localhost:6443"})]}),"\n",(0,t.jsx)(n.p,{children:'should show "Unauthorized" now.'}),"\n",(0,t.jsx)(n.p,{children:"BUT- we need to enable it because liveness pods need it for calling k8s api anonymously."}),"\n",(0,t.jsx)(n.h2,{id:"insecure-access",children:"Insecure Access"}),"\n",(0,t.jsxs)(n.p,{children:["note, since v1.20 you can no longer run kube-apiserver with ",(0,t.jsx)(n.code,{children:"--insecure-port=XXXX"})," as it is diabled BUT- learn this for places running older k8s."]}),"\n",(0,t.jsxs)(n.p,{children:["if you use ",(0,t.jsx)(n.code,{children:"--insecure-port"})," it will do the following"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"HTTP (sniff)"}),"\n",(0,t.jsx)(n.li,{children:"bypasses authN and authZ modules"}),"\n",(0,t.jsx)(n.li,{children:"admin controller still enforced"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"can disable by setting port=0"}),"\n",(0,t.jsx)(n.h2,{id:"manual-api-request",children:"Manual API Request"}),"\n",(0,t.jsx)(n.p,{children:"using kubeconfig to make manual request."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["copy server-certificate-data from ",(0,t.jsx)(n.code,{children:"~/.kube/config"})," through ",(0,t.jsx)(n.code,{children:"| base64 -d"})," to ca.crt"]}),"\n",(0,t.jsxs)(n.li,{children:["copy client-certificate-data from ",(0,t.jsx)(n.code,{children:"~/.kube/config"})," through ",(0,t.jsx)(n.code,{children:"| base64 -d"})," to client.crt"]}),"\n",(0,t.jsxs)(n.li,{children:["copy client-key-data from ",(0,t.jsx)(n.code,{children:"~/.kube/config"})," through ",(0,t.jsx)(n.code,{children:"| base64 -d"})," to key.pem"]}),"\n",(0,t.jsxs)(n.li,{children:["get ip address from ",(0,t.jsx)(n.code,{children:"~/.kube/config"})," section under ",(0,t.jsx)(n.code,{children:"clusters:cluster:server"})]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"the call"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"curl https://master-local-ip:6443 --cacert ca.crt # works\n\ncurl https://master-local-ip:6443 --cacert ca.crt --cert crt --key key.pem # works\n\n"})}),"\n",(0,t.jsx)(n.h2,{id:"external-api-access",children:"External API Access"}),"\n",(0,t.jsx)(n.p,{children:"api-server reachable from the outside world."}),"\n",(0,t.jsxs)(n.p,{children:["simple - edit the ",(0,t.jsx)(n.code,{children:"kubernetes"})," service change ",(0,t.jsx)(n.code,{children:"ClusterIP"})," to ",(0,t.jsx)(n.code,{children:"NodePort"})," : ",(0,t.jsx)(n.code,{children:"k edit svc kubernetes"})]}),"\n",(0,t.jsxs)(n.p,{children:["grab the port from ",(0,t.jsx)(n.code,{children:"k get svc"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# external-ip from cloud provider e.g. GCP\nlocalhost$ curl https://external-ip:NodePort -k # authN as user\n"})}),"\n",(0,t.jsxs)(n.p,{children:["get kubeconfig from your master node: ",(0,t.jsx)(n.code,{children:"k config view --raw"})," copy output to a local ",(0,t.jsx)(n.code,{children:"~/config"})," file BUT you need to change the server address from the local-ip (e.g. 10.4.10.24) to the ",(0,t.jsx)(n.code,{children:"external-ip:NodePort"})," that works for you in the curl command previously."]}),"\n",(0,t.jsxs)(n.p,{children:["use the local external access via: ",(0,t.jsx)(n.code,{children:"k --kubeconfig ~/config get ns"})]}),"\n",(0,t.jsx)(n.p,{children:"you get an error. why?"}),"\n",(0,t.jsx)(n.p,{children:"ip address of the cert is valid for the local-ip where the cert was setup (master node), but now we're trying to use it on the external-ip."}),"\n",(0,t.jsx)(n.p,{children:"inspect the cert as follows:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# inspect apiserver cert\ncd /etc/kubernetes/pki\nopenssl x509 -in apiserver.crt -text\n"})}),"\n",(0,t.jsx)(n.p,{children:"it checks out that the cert only allows the two ip addresses local to the node... how to fix?"}),"\n",(0,t.jsxs)(n.p,{children:["add a host entry in your local machine ",(0,t.jsx)(n.code,{children:"/etc/hosts"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"&lt;external-ip&gt; kubernetes\n"})}),"\n",(0,t.jsxs)(n.p,{children:["now try use the local external access via: ",(0,t.jsx)(n.code,{children:"k --kubeconfig ~/config get ns"})," and it should work."]}),"\n",(0,t.jsx)(n.h2,{id:"noderestriction-admissioncontroller",children:"NodeRestriction AdmissionController"}),"\n",(0,t.jsx)(n.p,{children:"this admin controller"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"kube-apiserver --enable-admission-plugins=NodeRestriction"})}),"\n",(0,t.jsx)(n.li,{children:"limits the node labels a kubelet can modify"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"secure workload isolation via labels!"}),"\n",(0,t.jsx)(n.h2,{id:"verify-noderestriction",children:"Verify NodeRestriction"}),"\n",(0,t.jsx)(n.p,{children:"do this on worker node."}),"\n",(0,t.jsxs)(n.p,{children:["check in kube-apiserver manifest that ",(0,t.jsx)(n.code,{children:"NodeRestriction"})," is enabled."]}),"\n",(0,t.jsxs)(n.p,{children:["on the worker node, ",(0,t.jsx)(n.code,{children:"export KUBECONFIG=/etc/kubernetes/kubelet.conf"})," \u2190 this is the kubelets ",(0,t.jsx)(n.code,{children:"kubeconfg"})," file for talking to the k8sAPI."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"worker$ export KUBECONFIG=/etc/kubernetes/kubelet.conf\nworker$ k get ns # fails, forbidden\nworker$ k get node # works\nworker$ k label node cks-master cks/test=yes # fails, forbidden\nworker$ k label node cks-worker cks/test=yes # works\nworker$ k label node cks-worker node-restriction.kubernetes.io/test=yes # fails, forbidden\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}}}]);