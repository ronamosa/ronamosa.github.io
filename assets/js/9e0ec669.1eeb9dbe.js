"use strict";(self.webpackChunkronamosa_github_io=self.webpackChunkronamosa_github_io||[]).push([[86212],{28453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>o});var s=i(96540);const r={},t=s.createContext(r);function a(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(t.Provider,{value:n},e.children)}},31448:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"study/CKS/Supply Chain Security/SupplyChainSecurity","title":"Secure Supply Chain","description":"Supply Chain","source":"@site/docs/study/CKS/5. Supply Chain Security/SupplyChainSecurity.md","sourceDirName":"study/CKS/5. Supply Chain Security","slug":"/study/CKS/Supply Chain Security/SupplyChainSecurity","permalink":"/docs/study/CKS/Supply Chain Security/SupplyChainSecurity","draft":false,"unlisted":false,"editUrl":"https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/study/CKS/5. Supply Chain Security/SupplyChainSecurity.md","tags":[],"version":"current","lastUpdatedBy":"Ron Amosa","lastUpdatedAt":1771617957000,"frontMatter":{"title":"Secure Supply Chain"},"sidebar":"docsSidebar","previous":{"title":"Container Images","permalink":"/docs/study/CKS/Supply Chain Security/SupplyChainImages"},"next":{"title":"Static Analysis","permalink":"/docs/study/CKS/Supply Chain Security/SupplyChainStaticAnalysis"}}');var r=i(74848),t=i(28453);const a={title:"Secure Supply Chain"},o="Supply Chain Security - Secure Supply Chain",c={},l=[{value:"Supply Chain",id:"supply-chain",level:2},{value:"K8s &amp; Container Registries",id:"k8s--container-registries",level:2},{value:"Allow-list Registries with OPA",id:"allow-list-registries-with-opa",level:2},{value:"ImagePolicyWebhook",id:"imagepolicywebhook",level:2},{value:"Enable Admission Controller and Policy Webhook",id:"enable-admission-controller-and-policy-webhook",level:3}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"supply-chain-security---secure-supply-chain",children:"Supply Chain Security - Secure Supply Chain"})}),"\n",(0,r.jsx)(n.h2,{id:"supply-chain",children:"Supply Chain"}),"\n",(0,r.jsx)(n.p,{children:"Tools --\x3e Software Dev --\x3e Container --\x3e CICD Registry --\x3e K8s Cloud --\x3e Browser"}),"\n",(0,r.jsx)(n.h2,{id:"k8s--container-registries",children:"K8s & Container Registries"}),"\n",(0,r.jsx)(n.p,{children:"private registries, docker login first with docker-registry k8s secret, with docker registry username, password"}),"\n",(0,r.jsxs)(n.p,{children:["ensure/patch your service accounts so they have ",(0,r.jsx)(n.code,{children:"imagePullSecrets"})," pointed to your docker-registry secret to pull images."]}),"\n",(0,r.jsxs)(n.p,{children:["if you look at the ",(0,r.jsx)(n.code,{children:"image:k8s.gcr.io/someimage:v1.29.1"})," section of your pod, e.g. kube-apiserver via describe or something, you can also see a digest listed"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"  containerStatuses:\n  - containerID: containerd://87cf84840ab758c375988491da7e71bb8c78ea435d92ccb41fe05aae19d62eae\n    image: k8s.gcr.io/kube-apiserver:v1.20.2\n    imageID: sha256:3ad0575b6f10437a84a59522bb4489aa88312bfde6c766ace295342bbc179d49\n"})}),"\n",(0,r.jsxs)(n.p,{children:["technically, you can edit the ",(0,r.jsx)(n.code,{children:"/etc/kubernetes/manifests/kube-apiserver.yaml"})," and change image to be the hash (imageID) and it will run that image ",(0,r.jsx)(n.strong,{children:"exactly"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"allow-list-registries-with-opa",children:"Allow-list Registries with OPA"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# install opa\nkubectl create -f https://raw.githubusercontent.com/killer-sh/cks-course-environment/master/course-content/opa/gatekeeper.yaml\n"})}),"\n",(0,r.jsx)(n.p,{children:"Contraint Template"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'apiVersion: templates.gatekeeper.sh/v1beta1\nkind: ConstraintTemplate\nmetadata:\n  name: k8strustedimages\nspec:\n  crd:\n    spec:\n      names:\n        kind: K8sTrustedImages\n  targets:\n    - target: admission.k8s.gatekeeper.sh\n      rego: |\n        package k8strustedimages\n\n        violation[{"msg": msg}] {\n          image := input.review.object.spec.containers[_].image\n          not startswith(image, "docker.io/")\n          not startswith(image, "k8s.gcr.io/")\n          msg := "not trusted image!"\n        }\n'})}),"\n",(0,r.jsx)(n.p,{children:"if ALL conditions are TRUE then violation is thrown, pod creation denied."}),"\n",(0,r.jsx)(n.p,{children:"Constraint Resource"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'apiVersion: constraints.gatekeeper.sh/v1beta1\nkind: K8sTrustedImages\nmetadata:\n  name: pod-trusted-images\nspec:\n  match:\n    kinds:\n      - apiGroups: [""]\n        kinds: ["Pod"]\n'})}),"\n",(0,r.jsx)(n.p,{children:"create template, then resource"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"k create -f k8strustedimages_template.yaml\nk create -f ./all_pod_must_have_trusted_images.yaml\n"})}),"\n",(0,r.jsx)(n.p,{children:"try create pod"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'k run nginx --image=nginx\nError from server ([denied by pod-trusted-images] not trusted image!): admission webhook "validation.gatekeeper.sh" denied the request: [denied by pod-trusted-images] not trusted image!\n'})}),"\n",(0,r.jsx)(n.p,{children:"try again, but from allowed registry"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"k run nginx --image=docker.io/nginx\npod/nginx created\n"})}),"\n",(0,r.jsx)(n.h2,{id:"imagepolicywebhook",children:"ImagePolicyWebhook"}),"\n",(0,r.jsxs)(n.p,{children:["see cks course folder for ",(0,r.jsx)(n.code,{children:"ImagePolicyWebhook"})," setup files."]}),"\n",(0,r.jsx)(n.p,{children:"the flow of where policy webhook works --"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"`api request` --\x3e [1] ApiServer --\x3e [3] Allow/Deny\n\n[2] ApiServer <--\x3e AdmissionContollers <--\x3e ImagePolicyWebhook <--\x3e External Service\n"})}),"\n",(0,r.jsx)(n.h3,{id:"enable-admission-controller-and-policy-webhook",children:"Enable Admission Controller and Policy Webhook"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["edit kubeapi manifest to enable ",(0,r.jsx)(n.code,{children:"ImagePolicyWebhook"})," admission controller under ",(0,r.jsx)(n.code,{children:"--enable-admission-plugins=ImagePolicyWebhook"})]}),"\n",(0,r.jsxs)(n.li,{children:["copy all your admission files to ",(0,r.jsx)(n.code,{children:"/etc/kubernetes/admission"})]}),"\n",(0,r.jsxs)(n.li,{children:["add ",(0,r.jsx)(n.code,{children:"--admission-control-config-file=/etc/kubernetes/admission/admission_config.yaml"})]}),"\n",(0,r.jsxs)(n.li,{children:["add ",(0,r.jsx)(n.code,{children:"hostPath"})," and ",(0,r.jsx)(n.code,{children:"volumeMount"})," to mount the  ",(0,r.jsx)(n.code,{children:"/etc/kubernetes/admission"})," so all your config files are available to the container."]}),"\n",(0,r.jsx)(n.li,{children:"apiserver will restart"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"have a look at the admission config file"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apiserver.config.k8s.io/v1\nkind: AdmissionConfiguration\nplugins:\n  - name: ImagePolicyWebhook\n    configuration:\n      imagePolicy:\n        kubeConfigFile: /etc/kubernetes/admission/kubeconf\n        allowTTL: 50\n        denyTTL: 50\n        retryBackoff: 500\n        defaultAllow: false # important: if `true`, then if policy webhook can't be reached will just allow the image.\n"})}),"\n",(0,r.jsxs)(n.p,{children:["look at the ",(0,r.jsx)(n.code,{children:"kubeconf"})," file, it's to query the external service for the webhook policy"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Config\n\n# clusters refers to the remote service.\nclusters:\n- cluster:\n    certificate-authority: /etc/kubernetes/admission/external-cert.pem  # CA for verifying the remote service.\n    server: https://external-service:1234/check-image                   # URL of remote service to query. Must use 'https'.\n  name: image-checker\n\ncontexts:\n- context:\n    cluster: image-checker\n    user: api-server\n  name: image-checker\ncurrent-context: image-checker\npreferences: {}\n\n# users refers to the API server's webhook configuration.\nusers:\n- name: api-server\n  user:\n    client-certificate: /etc/kubernetes/admission/apiserver-client-cert.pem     # cert for the webhook admission controller to use\n    client-key:  /etc/kubernetes/admission/apiserver-client-key.pem             # key matching the cert\n"})}),"\n",(0,r.jsx)(n.p,{children:"exam tip: if you have a question, check these configs for accuracy."})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);