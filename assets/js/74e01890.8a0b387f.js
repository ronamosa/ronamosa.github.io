"use strict";(self.webpackChunkronamosa_github_io=self.webpackChunkronamosa_github_io||[]).push([[74473],{4613:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"study/CKS/OPAGatekeeper","title":"Open Policy Agent (OPA)","description":"OPA and Gatekeeper","source":"@site/docs/study/CKS/OPAGatekeeper.md","sourceDirName":"study/CKS","slug":"/study/CKS/OPAGatekeeper","permalink":"/docs/study/CKS/OPAGatekeeper","draft":false,"unlisted":false,"editUrl":"https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/study/CKS/OPAGatekeeper.md","tags":[],"version":"current","lastUpdatedBy":"Ron Amosa","lastUpdatedAt":1771617957000,"frontMatter":{"title":"Open Policy Agent (OPA)"},"sidebar":"docsSidebar","previous":{"title":"Immutability","permalink":"/docs/study/CKS/Runtime Security/RuntimeImmutable"},"next":{"title":"Certified Kubernetes Administrator (CKA) - Complete Study Guide","permalink":"/docs/study/CKA/kubernetes-administrator-cka-study-guide"}}');var t=s(74848),i=s(28453);const r={title:"Open Policy Agent (OPA)"},o=void 0,l={},c=[{value:"OPA and Gatekeeper",id:"opa-and-gatekeeper",level:2},{value:"Gatekeeper",id:"gatekeeper",level:3},{value:"Install OPA",id:"install-opa",level:2},{value:"example deny all policy",id:"example-deny-all-policy",level:3},{value:"Enforce Namespace Labels",id:"enforce-namespace-labels",level:2},{value:"Enforce Pod Replica Count",id:"enforce-pod-replica-count",level:2},{value:"rego playground examples",id:"rego-playground-examples",level:2}];function d(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"opa-and-gatekeeper",children:"OPA and Gatekeeper"}),"\n",(0,t.jsx)(n.p,{children:"remind refresh flow: request --\x3e authN --\x3e authZ --\x3e admission control"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"OPA = admission controller stage"}),"\n",(0,t.jsx)(n.li,{children:"not k8s specific (general-purpose policy engine)"}),"\n",(0,t.jsx)(n.li,{children:"json/yaml"}),"\n",(0,t.jsx)(n.li,{children:"doesn't know pods/deployments (just json/yaml)"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Gatekeeper = Custom CRDs that interact with OPA for you."}),"\n",(0,t.jsx)(n.h3,{id:"gatekeeper",children:"Gatekeeper"}),"\n",(0,t.jsx)(n.p,{children:"Constraint template --\x3e Constraint"}),"\n",(0,t.jsx)(n.p,{children:"e.g."}),"\n",(0,t.jsxs)(n.p,{children:['When we create this "Template" = ',(0,t.jsx)(n.code,{children:"kind:ContraintTemplate"})," + ",(0,t.jsx)(n.code,{children:"name:k8srequiredLabel"})]}),"\n",(0,t.jsxs)(n.p,{children:['OPA Gatekeerp will create a CRD of "Constraint" = ',(0,t.jsx)(n.code,{children:"kind:k8srequiredLabel"})," + ",(0,t.jsx)(n.code,{children:"name:whatever"})," for us automatically."]}),"\n",(0,t.jsx)(n.h2,{id:"install-opa",children:"Install OPA"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"kubectl create -f https://raw.githubusercontent.com/killer-sh/cks-course-environment/master/course-content/opa/gatekeeper.yaml"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"root@cks-master:~# kubectl create -f https://raw.githubusercontent.com/killer-sh/cks-course-environment/master/course-content/opa/gatekeeper.yaml\nnamespace/gatekeeper-system created\nWarning: apiextensions.k8s.io/v1beta1 CustomResourceDefinition is deprecated in v1.16+, unavailable in v1.22+; use apiextensions.k8s.io/v1 CustomResourceDefinition\ncustomresourcedefinition.apiextensions.k8s.io/configs.config.gatekeeper.sh created\ncustomresourcedefinition.apiextensions.k8s.io/constraintpodstatuses.status.gatekeeper.sh created\ncustomresourcedefinition.apiextensions.k8s.io/constrainttemplatepodstatuses.status.gatekeeper.sh created\ncustomresourcedefinition.apiextensions.k8s.io/constrainttemplates.templates.gatekeeper.sh created\nserviceaccount/gatekeeper-admin created\nrole.rbac.authorization.k8s.io/gatekeeper-manager-role created\nclusterrole.rbac.authorization.k8s.io/gatekeeper-manager-role created\nrolebinding.rbac.authorization.k8s.io/gatekeeper-manager-rolebinding created\nclusterrolebinding.rbac.authorization.k8s.io/gatekeeper-manager-rolebinding created\nsecret/gatekeeper-webhook-server-cert created\nservice/gatekeeper-webhook-service created\ndeployment.apps/gatekeeper-audit created\ndeployment.apps/gatekeeper-controller-manager created\nWarning: admissionregistration.k8s.io/v1beta1 ValidatingWebhookConfiguration is deprecated in v1.16+, unavailable in v1.22+; use admissionregistration.k8s.io/v1 ValidatingWebhookConfiguration\nvalidatingwebhookconfiguration.admissionregistration.k8s.io/gatekeeper-validating-webhook-configuration created\nroot@cks-master:~# k get ns\nNAME                   STATUS   AGE\nblue                   Active   5d4h\ncassandra              Active   13d\ndefault                Active   28d\ngatekeeper-system      Active   7s\ningress-nginx          Active   6d19h\nkube-node-lease        Active   28d\nkube-public            Active   28d\nkube-system            Active   28d\nkubernetes-dashboard   Active   13d\nred                    Active   5d4h\nroot@cks-master:~# k -n gatekeeper-system get pod,svc\nNAME                                                 READY   STATUS    RESTARTS   AGE\npod/gatekeeper-audit-6ffc8f5544-br7lt                1/1     Running   0          46s\npod/gatekeeper-controller-manager-6f9c99b4d7-jwd8d   1/1     Running   0          46s\n\nNAME                                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE\nservice/gatekeeper-webhook-service   ClusterIP   10.103.154.120   <none />        443/TCP   46s\n"})}),"\n",(0,t.jsx)(n.p,{children:"types of webhooks:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"validating = validate request and/or enforce custom policies"}),"\n",(0,t.jsx)(n.li,{children:"mutating = mutate requests to enforce custom policies"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"example-deny-all-policy",children:"example deny all policy"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"https://github.com/killer-sh/cks-course-environment/tree/master/course-content/opa/deny-all"})}),"\n",(0,t.jsx)(n.p,{children:"Contraint Template:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: templates.gatekeeper.sh/v1beta1\nkind: ConstraintTemplate\nmetadata:\n  name: k8salwaysdeny\nspec:\n  crd:\n    spec:\n      names:\n        kind: K8sAlwaysDeny\n      validation:\n        # Schema for the `parameters` field\n        openAPIV3Schema:\n          properties:\n            message:\n              type: string\n  targets:\n    - target: admission.k8s.gatekeeper.sh\n      rego: |\n        package k8salwaysdeny\n\n        violation[{"msg": msg}] {\n          1 > 0 # true\n          msg := input.parameters.message\n        }\n'})}),"\n",(0,t.jsx)(n.p,{children:"check the rego -> \"if violation is true (is '1>0'? always yes, so true), then throw violation, show msg\"."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"EVERY condition in the rego has to be true for it to be true"})}),"\n",(0,t.jsx)(n.p,{children:"create the resource of that kind"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: constraints.gatekeeper.sh/v1beta1\nkind: K8sAlwaysDeny\nmetadata:\n  name: pod-always-deny\nspec:\n  match:\n    kinds:\n      - apiGroups: [""]\n        kinds: ["Pod"]\n  parameters:\n    message: "ACCESS DENIED!"\n'})}),"\n",(0,t.jsxs)(n.p,{children:["the rego error message from the template (",(0,t.jsx)(n.code,{children:"msg := input.parameters.message"}),") will match whatever's in the section:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'parameters:\n  message: "whatever you like"\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Describe our CRD: ",(0,t.jsx)(n.code,{children:"k describe <ConstraintKind /> <podName />"})," e.g. ",(0,t.jsx)(n.code,{children:"k describe K8sAlwaysDeny pod-always-deny"})]}),"\n",(0,t.jsx)(n.h2,{id:"enforce-namespace-labels",children:"Enforce Namespace Labels"}),"\n",(0,t.jsx)(n.p,{children:"create template"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: templates.gatekeeper.sh/v1beta1\nkind: ConstraintTemplate\nmetadata:\n  name: k8srequiredlabels\nspec:\n  crd:\n    spec:\n      names:\n        kind: K8sRequiredLabels\n      validation:\n        # Schema for the `parameters` field\n        openAPIV3Schema:\n          properties:\n            labels:\n              type: array\n              items: string\n  targets:\n    - target: admission.k8s.gatekeeper.sh\n      rego: |\n        package k8srequiredlabels\n        violation[{"msg": msg, "details": {"missing_labels": missing\\}\\}] {\n          provided := {label | input.review.object.metadata.labels[label]}\n          required := {label | label := input.parameters.labels[_]}\n          missing := required - provided\n          count(missing) > 0\n          msg := sprintf("you must provide labels: %v", [missing])\n        }\n'})}),"\n",(0,t.jsxs)(n.p,{children:["this line ",(0,t.jsx)(n.code,{children:"provided := {label | input.review.object.metadata.labels[label]}"})," gets all the labels in the namespace where ",(0,t.jsx)(n.code,{children:".object."})," gets substituted for the namespace resource."]}),"\n",(0,t.jsxs)(n.p,{children:["this line ",(0,t.jsx)(n.code,{children:"required := {label | label := input.parameters.labels[_]}"}),' gets the "required" labels of our resources we define (below)']}),"\n",(0,t.jsxs)(n.p,{children:["then do a calculation of ",(0,t.jsx)(n.code,{children:"required - provided = missing"})," and if ",(0,t.jsx)(n.code,{children:"count(missing) > 0"}),' (i.e. "true") then throw violation, send message.']}),"\n",(0,t.jsxs)(n.p,{children:["namespace must have ",(0,t.jsx)(n.code,{children:"cks"})," label"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: constraints.gatekeeper.sh/v1beta1\nkind: K8sRequiredLabels\nmetadata:\n  name: ns-must-have-cks\nspec:\n  match:\n    kinds:\n      - apiGroups: [""]\n        kinds: ["Namespace"]\n  parameters:\n    labels: ["cks"]\n'})}),"\n",(0,t.jsxs)(n.p,{children:["add to the array of labels as needed ",(0,t.jsx)(n.code,{children:'labels: ["cks", "team"]'})," -- if you try to create a ns without the required labels, you get denied."]}),"\n",(0,t.jsx)(n.p,{children:"pods must have `cks label"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: constraints.gatekeeper.sh/v1beta1\nkind: K8sRequiredLabels\nmetadata:\n  name: pod-must-have-cks\nspec:\n  match:\n    kinds:\n      - apiGroups: [""]\n        kinds: ["Pod"]\n  parameters:\n    labels: ["cks"]\n'})}),"\n",(0,t.jsx)(n.h2,{id:"enforce-pod-replica-count",children:"Enforce Pod Replica Count"}),"\n",(0,t.jsx)(n.p,{children:"minimum replica count"}),"\n",(0,t.jsx)(n.p,{children:"template"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: templates.gatekeeper.sh/v1beta1\nkind: ConstraintTemplate\nmetadata:\n  name: k8sminreplicacount\nspec:\n  crd:\n    spec:\n      names:\n        kind: K8sMinReplicaCount\n      validation:\n        # Schema for the `parameters` field\n        openAPIV3Schema:\n          properties:\n            min:\n              type: integer\n  targets:\n    - target: admission.k8s.gatekeeper.sh\n      rego: |\n        package k8sminreplicacount\n        violation[{"msg": msg, "details": {"missing_replicas": missing\\}\\}] {\n          provided := input.review.object.spec.replicas\n          required := input.parameters.min\n          missing := required - provided\n          missing > 0\n          msg := sprintf("you must provide %v more replicas", [missing])\n        }\n'})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: constraints.gatekeeper.sh/v1beta1\nkind: K8sMinReplicaCount\nmetadata:\n  name: deployment-must-have-min-replicas\nspec:\n  match:\n    kinds:\n      - apiGroups: ["apps"]\n        kinds: ["Deployment"]\n  parameters:\n    min: 2\n'})}),"\n",(0,t.jsx)(n.h2,{id:"rego-playground-examples",children:"rego playground examples"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"https://play.openpolicyagent.org\n\nhttps://github.com/BouweCeunen/gatekeeper-policies\n"})})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>o});var a=s(96540);const t={},i=a.createContext(t);function r(e){const n=a.useContext(i);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),a.createElement(i.Provider,{value:n},e.children)}}}]);