"use strict";(self.webpackChunkronamosa_github_io=self.webpackChunkronamosa_github_io||[]).push([[4822],{13985:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/istiomtls-arch-notworking-20310f07fb5f6f6f03d2ad97dd743677.png"},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>c});var s=t(96540);const i={},r=s.createContext(i);function a(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),s.createElement(r.Provider,{value:n},e.children)}},45808:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/istiomtls-arch-working-42d8d9b65b80bf568cbde097ed198f53.png"},71420:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"engineer/K8s/2020-04-08-Istio-MTLS-with-External-Endpoint","title":"Istio mTLS with External Endpoints - Egress Gateway Configuration Guide","description":"Configure Istio service mesh to handle mutual TLS (mTLS) with external sites using egress gateways. Learn secure external service communication and traffic management.","source":"@site/docs/engineer/K8s/2020-04-08-Istio-MTLS-with-External-Endpoint.md","sourceDirName":"engineer/K8s","slug":"/engineer/K8s/2020-04-08-Istio-MTLS-with-External-Endpoint","permalink":"/docs/engineer/K8s/2020-04-08-Istio-MTLS-with-External-Endpoint","draft":false,"unlisted":false,"editUrl":"https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/engineer/K8s/2020-04-08-Istio-MTLS-with-External-Endpoint.md","tags":[{"inline":true,"label":"istio","permalink":"/docs/tags/istio"},{"inline":true,"label":"service-mesh","permalink":"/docs/tags/service-mesh"},{"inline":true,"label":"mtls","permalink":"/docs/tags/mtls"},{"inline":true,"label":"egress","permalink":"/docs/tags/egress"},{"inline":true,"label":"external-services","permalink":"/docs/tags/external-services"}],"version":"current","lastUpdatedBy":"Ron Amosa","lastUpdatedAt":1771617957000,"sidebarPosition":3,"frontMatter":{"title":"Istio mTLS with External Endpoints - Egress Gateway Configuration Guide","description":"Configure Istio service mesh to handle mutual TLS (mTLS) with external sites using egress gateways. Learn secure external service communication and traffic management.","keywords":["istio mtls","egress gateway","external endpoints","istio external services","service mesh security","istio traffic management","kubernetes security"],"tags":["istio","service-mesh","mtls","egress","external-services"],"sidebar_position":3},"sidebar":"docsSidebar","previous":{"title":"Istio mTLS with SDS and Cert-Manager - Complete Service Mesh Security Guide","permalink":"/docs/engineer/K8s/2020-03-06-Istio-SDS-Cert-Manager"},"next":{"title":"Ambassador API Gateway TLS Security - Disable TLS 1.0 and 1.1 for Better Security","permalink":"/docs/engineer/K8s/2019-07-09-Ambassador-Disable-TLS1"}}');var i=t(74848),r=t(28453);const a={title:"Istio mTLS with External Endpoints - Egress Gateway Configuration Guide",description:"Configure Istio service mesh to handle mutual TLS (mTLS) with external sites using egress gateways. Learn secure external service communication and traffic management.",keywords:["istio mtls","egress gateway","external endpoints","istio external services","service mesh security","istio traffic management","kubernetes security"],tags:["istio","service-mesh","mtls","egress","external-services"],sidebar_position:3},c=void 0,o={},l=[{value:"Architecture Diagram",id:"architecture-diagram",level:2},{value:"Key Components",id:"key-components",level:3},{value:"Pre-requisites",id:"pre-requisites",level:2},{value:"MTLS Server",id:"mtls-server",level:2},{value:"Certificates: server certs, client certs and intermediate certs",id:"certificates-server-certs-client-certs-and-intermediate-certs",level:3},{value:"NGINX Webserver",id:"nginx-webserver",level:3},{value:"nginx.conf &amp; certs",id:"nginxconf--certs",level:4},{value:"the MTLS client (test)",id:"the-mtls-client-test",level:3},{value:"Istio Egress Gateway Setup",id:"istio-egress-gateway-setup",level:2},{value:"install istio with egressgateway",id:"install-istio-with-egressgateway",level:3},{value:"create the cert k8s secrets",id:"create-the-cert-k8s-secrets",level:3},{value:"patch the egressgateway",id:"patch-the-egressgateway",level:3},{value:"WARNING: Istio Documented Configs (NOT WORKING)",id:"warning-istio-documented-configs-not-working",level:2},{value:"Errors: nginx certs &amp; root-cert.pem",id:"errors-nginx-certs--root-certpem",level:2},{value:"invalid path nginx certs",id:"invalid-path-nginx-certs",level:3},{value:"invalid path /etc/certs/root-cert.pem",id:"invalid-path-etccertsroot-certpem",level:3},{value:"HTTP/1.1 503 Service Unavailable (obviously)",id:"http11-503-service-unavailable-obviously",level:3},{value:"UNOFFICIAL: WORKING CONFIGURATION",id:"unofficial-working-configuration",level:2},{value:"/etc/root-cert.pem fix",id:"etcroot-certpem-fix",level:3},{value:"Invalid path: /etc/istio/nginx-ca-certs/ca-chain.cert.pem fix",id:"invalid-path-etcistionginx-ca-certsca-chaincertpem-fix",level:3},{value:"Add ServiceEntry and VirtualService",id:"add-serviceentry-and-virtualservice",level:3},{value:"Changed Gateway to HTTP",id:"changed-gateway-to-http",level:3},{value:"Changed DestinationRule",id:"changed-destinationrule",level:3},{value:"Changed VirtualService to port 80",id:"changed-virtualservice-to-port-80",level:3},{value:"Working Output",id:"working-output",level:2},{value:"Conclusion",id:"conclusion",level:2}];function d(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsx)(n.p,{children:"Published Date: 08-APR-2020"})}),"\n",(0,i.jsxs)(n.p,{children:["In this post I endeavour to go through setting up ",(0,i.jsx)(n.a,{href:"https://istio.io/docs/tasks/traffic-management/egress/egress-gateway-tls-origination/",children:"Istio Egress Gateway with TLS Origination"})," using a real-world external/remote server setup to do MTLS between an outside client and itself."]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.em,{children:"Why do I care?"})}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["I came across the need for this setup on a previous client engagement where Security was super important. The client wanted ",(0,i.jsx)(n.em,{children:"all"})," points in the system to be secured as much as possible, which included mTLS between microservices in the AKS cluster; network segregation between all components, and the final piece was to setup MTLS between the azure cloud application and a 3rd party vendor with a public endpoint."]}),"\n",(0,i.jsx)(n.p,{children:"So, here we are!"}),"\n",(0,i.jsx)(n.h2,{id:"architecture-diagram",children:"Architecture Diagram"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"architecture",src:t(13985).A+"",width:"1585",height:"862"})}),"\n",(0,i.jsx)(n.h3,{id:"key-components",children:"Key Components"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"AKS cluster"}),"\n",(0,i.jsx)(n.li,{children:"Istio Service Mesh"}),"\n",(0,i.jsx)(n.li,{children:"External NGINX Webserver with MTLS enabled."}),"\n",(0,i.jsxs)(n.li,{children:["FQDN ",(0,i.jsx)(n.code,{children:"mtls.cloudbuild.site"})," used for as my example domain for the remote server."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"pre-requisites",children:"Pre-requisites"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"az-cli installed"}),"\n",(0,i.jsx)(n.li,{children:"kubectl instlaled"}),"\n",(0,i.jsx)(n.li,{children:"istioctl installed"}),"\n",(0,i.jsx)(n.li,{children:"azure dns zone (or something you can resolve dns to for your certs)"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"mtls-server",children:"MTLS Server"}),"\n",(0,i.jsx)(n.h3,{id:"certificates-server-certs-client-certs-and-intermediate-certs",children:"Certificates: server certs, client certs and intermediate certs"}),"\n",(0,i.jsxs)(n.p,{children:["As per Istio's documentation, we will use the following repo by ",(0,i.jsx)(n.a,{href:"https://github.com/nicholasjackson/",children:"Nicholas Jackson"})," called ",(0,i.jsx)(n.a,{href:"https://github.com/nicholasjackson/mtls-go-example",children:"mtls-go-example"})," to create the cert combination we need."]}),"\n",(0,i.jsx)(n.p,{children:"To create your certs, as per the website run:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"./generate.sh <domain_name /> <some-password />"})}),"\n",(0,i.jsxs)(n.p,{children:["for the example they use ",(0,i.jsx)(n.code,{children:"localhost"})," to run it, and connect to it locally via ",(0,i.jsx)(n.code,{children:"https://localhost"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["When you run the ",(0,i.jsx)(n.code,{children:"./generate.sh"}),' script, it will create 4 folders of certs for you that will make up a complete "certificate chain" aka ',(0,i.jsx)(n.a,{href:"https://www.thesslstore.com/knowledgebase/ssl-support/explaining-the-chain-of-trust/",children:'"chain of trust"'}),"."]}),"\n",(0,i.jsx)(n.p,{children:"and looks like this:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"go certs",src:t(79106).A+"",width:"231",height:"118"})}),"\n",(0,i.jsx)(n.p,{children:"with the following directories:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["root cert (",(0,i.jsx)(n.code,{children:"ca.cert.pem"}),") & private key"]}),"\n",(0,i.jsxs)(n.li,{children:["intermediate certs (",(0,i.jsx)(n.code,{children:"ca-chain.pem"})," and ",(0,i.jsx)(n.code,{children:"intermediate.cert.pem"}),") & private key"]}),"\n",(0,i.jsxs)(n.li,{children:['application (aka "server") cert (',(0,i.jsx)(n.code,{children:"<domain_name />.cert.pem"}),") & private key -- e.g. ",(0,i.jsx)(n.code,{children:"mtls.cloudbuild.site.cert.pem"})]}),"\n",(0,i.jsxs)(n.li,{children:["client cert (",(0,i.jsx)(n.code,{children:"<domain_name />.cert.pem"}),") & private key -- e.g. ",(0,i.jsx)(n.code,{children:"mtls.cloudbuild.site.cert.pem"})]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"now that your certs are created and you understand what each one does,"}),"\n",(0,i.jsx)(n.h3,{id:"nginx-webserver",children:"NGINX Webserver"}),"\n",(0,i.jsxs)(n.p,{children:["All you need is a server that runs nginx so you can throw this ",(0,i.jsx)(n.code,{children:"nginx.conf"}),' and the certs in there to be the MTLS endpoint that we will call from our "client" later on.']}),"\n",(0,i.jsxs)(n.p,{children:["I spent way too much time getting this done via terraform and ansible that I'm going to put the ansible code here: ",(0,i.jsx)(n.a,{href:"https://gist.link",children:"link to gist"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"nginxconf--certs",children:"nginx.conf & certs"}),"\n",(0,i.jsx)(n.p,{children:"Once you have nginx up & running on your server:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["upload the ",(0,i.jsx)(n.code,{children:"nginx.conf"})," below and save it to ",(0,i.jsx)(n.code,{children:"/etc/nginx/nginx.conf"})]}),"\n",(0,i.jsxs)(n.li,{children:["upload the following certs (I'm using my domain ",(0,i.jsx)(n.code,{children:"mtls.cloudbuild.site"})," as an example):","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["server cert: ",(0,i.jsx)(n.code,{children:"certs/3_application/certs/mtls.cloudbuild.site.cert.pem"})," = ",(0,i.jsx)(n.code,{children:"/etc/nginx-server-certs/tls.crt"})]}),"\n",(0,i.jsxs)(n.li,{children:["server private key: ",(0,i.jsx)(n.code,{children:"certs/3_application/private/mtls.cloudbuild.site.key.pem"})," = ",(0,i.jsx)(n.code,{children:"/etc/nginx-server-certs/tls.key"})]}),"\n",(0,i.jsxs)(n.li,{children:["ca-certs: ",(0,i.jsx)(n.code,{children:"certs/2_intermediate/certs/ca-chain.cert.pem"})," = ",(0,i.jsx)(n.code,{children:"/etc/nginx-ca-certs/ca-chain.cert.pem"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ruby",metastring:'title="nginx.conf"',children:"user www-data;\nworker_processes auto;\npid /run/nginx.pid;\n\nevents {\n}\n\nhttp {\n\n  # custom log format to show good debugging information.\n  log_format ssl_client\n  '$remote_addr - $remote_user [$time_local] '\n  '\"$request\" $status $body_bytes_sent '\n  '\"Client fingerprint\" $ssl_client_fingerprint '\n  '\"Client DN\" $ssl_client_s_dn';\n\n  error_log  /var/log/nginx/error.log;\n\n  server {\n\n    listen 443 ssl;\n\n    # set our access_log to use the log_format from above.\n    access_log /var/log/nginx/listener.log ssl_client;\n\n    # homepage for the NGINX server -- edit as needed.\n    root /usr/share/nginx/html;\n    index index.html;\n\n    # server's name -- mine is a fqdn\n    server_name mtls.cloudbuild.site;\n\n    # setup the server cert, key and the ca-cert which will be the same one that signed the client certs.\n    ssl_certificate /etc/nginx-server-certs/tls.crt;\n    ssl_certificate_key /etc/nginx-server-certs/tls.key;\n    ssl_client_certificate /etc/nginx-ca-certs/ca-chain.cert.pem;\n\n    # enable mutual tls and set depth to be >2.\n    ssl_verify_client on;\n    ssl_verify_depth 10;\n  }\n}\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.em,{children:["The ",(0,i.jsx)(n.code,{children:"ssl_verify_client"})," is the thing that enables MTLS with incoming calls, and ",(0,i.jsx)(n.code,{children:"ssl_verify_depth"})," needs to be set to >2 or things behave badly."]})})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["restart your ",(0,i.jsx)(n.code,{children:"nginx.service"})," e.g. on ubuntu ",(0,i.jsx)(n.code,{children:"sudo systemctl restart nginx.service"})]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"the-mtls-client-test",children:"the MTLS client (test)"}),"\n",(0,i.jsx)(n.p,{children:"With our MTLS server setup We'll use curl to test if we can talk to the server using our client certificates."}),"\n",(0,i.jsxs)(n.p,{children:["The MTLS URL to call is ",(0,i.jsx)(n.code,{children:"https://mtls.cloudbuild.site"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"curl without certificates:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl -v -k -I https://mtls.cloudbuild.site\n* Rebuilt URL to: https://mtls.cloudbuild.site/\n*   Trying 13.70.185.45...\n* TCP_NODELAY set\n* Connected to mtls.cloudbuild.site (13.70.185.45) port 443\n* ALPN, offering h2\n* ALPN, offering http/1.1\n* successfully set certificate verify locations:\n*   CAfile: /etc/ssl/certs/ca-certificates.crt\n  CApath: /etc/ssl/certs\n* TLSv1.3 (OUT), TLS handshake, Client hello (1):\n* TLSv1.3 (IN), TLS handshake, Server hello (2):\n* TLSv1.2 (IN), TLS handshake, Certificate (11):\n* TLSv1.2 (IN), TLS handshake, Server key exchange (12):\n* TLSv1.2 (IN), TLS handshake, Request CERT (13):\n* TLSv1.2 (IN), TLS handshake, Server finished (14):\n* TLSv1.2 (OUT), TLS handshake, Certificate (11):\n* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):\n* TLSv1.2 (OUT), TLS change cipher, Client hello (1):\n* TLSv1.2 (OUT), TLS handshake, Finished (20):\n* TLSv1.2 (IN), TLS handshake, Finished (20):\n* SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384\n* ALPN, server accepted to use http/1.1\n* Server certificate:\n*  subject: C=US; ST=Denial; L=Springfield; O=Dis; CN=mtls.cloudbuild.site\n*  start date: Apr  4 11:36:35 2020 GMT\n*  expire date: Apr 14 11:36:35 2021 GMT\n*  issuer: C=US; ST=Denial; O=Dis; CN=mtls.cloudbuild.site\n*  SSL certificate verify result: unable to get local issuer certificate (20), continuing anyway.\n> HEAD / HTTP/1.1\n> Host: mtls.cloudbuild.site\n> User-Agent: curl/7.58.0\n> Accept: */*\n>\n< HTTP/1.1 400 Bad Request\nHTTP/1.1 400 Bad Request\n< Server: nginx/1.10.3 (Ubuntu)\nServer: nginx/1.10.3 (Ubuntu)\n< Date: Wed, 08 Apr 2020 10:13:19 GMT\nDate: Wed, 08 Apr 2020 10:13:19 GMT\n< Content-Type: text/html\nContent-Type: text/html\n< Content-Length: 262\nContent-Length: 262\n< Connection: close\nConnection: close\n\n<\n* Closing connection 0\n* TLSv1.2 (OUT), TLS alert, Client hello (1):\n\n"})}),"\n",(0,i.jsxs)(n.p,{children:["We get an ",(0,i.jsx)(n.code,{children:"HTTP 400"})," error code, telling us to go away."]}),"\n",(0,i.jsxs)(n.p,{children:["Now ",(0,i.jsx)(n.code,{children:"curl"})," the same endpoint but this time present the server with the right client certificates:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ curl --cacert certs/2_intermediate/certs/ca-chain.cert.pem \\\n    --cert certs/4_client/certs/mtls.cloudbuild.site.cert.pem \\\n    --key certs/4_client/private/mtls.cloudbuild.site.key.pem \\\n    https://mtls.cloudbuild.site\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Note, the ",(0,i.jsx)(n.code,{children:"ca-chain.pem"})," will be the same intermediate ca-cert the MTLS nginx server has configured for its setup. The server has the server cert & key pair, and our client will present the client cert & key pair which is signed by the same intermediate ca-cert as the server."]}),"\n",(0,i.jsxs)(n.p,{children:["And we get a successful ",(0,i.jsx)(n.code,{children:"HTTP 200 OK"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'* Rebuilt URL to: https://mtls.cloudbuild.site/\n*   Trying 13.70.185.45...\n* TCP_NODELAY set\n* Connected to mtls.cloudbuild.site (13.70.185.45) port 443\n* ALPN, offering h2\n* ALPN, offering http/1.1\n* successfully set certificate verify locations:\n*   CAfile: certs/2_intermediate/certs/ca-chain.cert.pem\n  CApath: /etc/ssl/certs\n* TLSv1.3 (OUT), TLS handshake, Client hello (1):\n* TLSv1.3 (IN), TLS handshake, Server hello (2):\n* TLSv1.2 (IN), TLS handshake, Certificate (11):\n* TLSv1.2 (IN), TLS handshake, Server key exchange (12):\n* TLSv1.2 (IN), TLS handshake, Request CERT (13):\n* TLSv1.2 (IN), TLS handshake, Server finished (14):\n* TLSv1.2 (OUT), TLS handshake, Certificate (11):\n* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):\n* TLSv1.2 (OUT), TLS handshake, CERT verify (15):\n* TLSv1.2 (OUT), TLS change cipher, Client hello (1):\n* TLSv1.2 (OUT), TLS handshake, Finished (20):\n* TLSv1.2 (IN), TLS handshake, Finished (20):\n* SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384\n* ALPN, server accepted to use http/1.1\n* Server certificate:\n*  subject: C=US; ST=Denial; L=Springfield; O=Dis; CN=mtls.cloudbuild.site\n*  start date: Apr  4 11:36:35 2020 GMT\n*  expire date: Apr 14 11:36:35 2021 GMT\n*  common name: mtls.cloudbuild.site (matched)\n*  issuer: C=US; ST=Denial; O=Dis; CN=mtls.cloudbuild.site\n*  SSL certificate verify ok.\n> HEAD / HTTP/1.1\n> Host: mtls.cloudbuild.site\n> User-Agent: curl/7.58.0\n> Accept: */*\n>\n< HTTP/1.1 200 OK\nHTTP/1.1 200 OK\n< Server: nginx/1.10.3 (Ubuntu)\nServer: nginx/1.10.3 (Ubuntu)\n< Date: Wed, 08 Apr 2020 10:25:29 GMT\nDate: Wed, 08 Apr 2020 10:25:29 GMT\n< Content-Type: text/html\nContent-Type: text/html\n< Content-Length: 557\nContent-Length: 557\n< Last-Modified: Wed, 08 Apr 2020 00:53:53 GMT\nLast-Modified: Wed, 08 Apr 2020 00:53:53 GMT\n< Connection: keep-alive\nConnection: keep-alive\n< ETag: "5e8d20a1-22d"\nETag: "5e8d20a1-22d"\n< Accept-Ranges: bytes\nAccept-Ranges: bytes\n\n<\n* Connection #0 to host mtls.cloudbuild.site left intact\n'})}),"\n",(0,i.jsxs)(n.p,{children:["And just for posterity, the logs from ",(0,i.jsx)(n.code,{children:"/var/log/nginx/listener.log"})," with the new log_format we configured above looks like this:"]}),"\n",(0,i.jsx)(n.p,{children:"curl with no certs"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'115.189.88.95 - - [08/Apr/2020:10:13:11 +0000] "HEAD / HTTP/1.1" 400 0 "Client fingerprint" - "Client DN" -\n'})}),"\n",(0,i.jsx)(n.p,{children:"curl with certs"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'115.189.88.95 - - [08/Apr/2020:10:25:29 +0000] "HEAD / HTTP/1.1" 200 0 "Client fingerprint" 7dccb99b6584e9b6cf624290952c7bd4b905412b "Client DN" /C=US/ST=Denial/L=Springfield/O=Dis/CN=mtls.cloudbuild.site\n'})}),"\n",(0,i.jsx)(n.p,{children:"Ok, now the real work begins... setting up an Istio Egress Gateway to do this MTLS certificate exchange with the MTLS server on the K8s cluster's behalf."}),"\n",(0,i.jsx)(n.h2,{id:"istio-egress-gateway-setup",children:"Istio Egress Gateway Setup"}),"\n",(0,i.jsxs)(n.p,{children:["You should have ",(0,i.jsx)(n.code,{children:"istioctl"})," installed already (if not, go ",(0,i.jsx)(n.a,{href:"https://istio.io/docs/setup/getting-started/",children:"here"}),")."]}),"\n",(0,i.jsx)(n.h3,{id:"install-istio-with-egressgateway",children:"install istio with egressgateway"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'istioctl manifest apply --set values.global.istioNamespace=istio-system \\\n    --set values.gateways.istio-ingressgateway.enabled=false \\\n    --set values.gateways.istio-egressgateway.enabled=true \\\n    --set values.global.proxy.accessLogFile="/dev/stdout" \\\n    --set values.sidecarInjectorWebhook.rewriteAppHTTPProbe=true\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["*enables ",(0,i.jsx)(n.code,{children:"istio-egressgateway"})]}),"\n",(0,i.jsxs)(n.li,{children:["*disables ",(0,i.jsx)(n.code,{children:"istio-ingressgateway"})]}),"\n",(0,i.jsx)(n.li,{children:"*enables access logs for istio-proxy containers"}),"\n",(0,i.jsxs)(n.li,{children:["*enables ",(0,i.jsx)(n.code,{children:"rewriteAppHTTPProbe"})," which helps with healthcheck 503 errors."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"create-the-cert-k8s-secrets",children:"create the cert k8s secrets"}),"\n",(0,i.jsxs)(n.p,{children:["create the following secrets in the ",(0,i.jsx)(n.code,{children:"istio-system"})," namespace so ",(0,i.jsx)(n.code,{children:"egressgateway"})," can find them"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"*1 x tls secret with the cert & key pair"}),"\n",(0,i.jsxs)(n.li,{children:["*1 x generic secret with the ",(0,i.jsx)(n.code,{children:"ca-chain.cert.pem"})," file contents."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl -n istio-system create secret tls nginx-client-certs --key certs/4_client/private/mtls.cloudbuild.site.key.pem --cert certs/4_client/certs/mtls.cloudbuild.site.cert.pem\nkubectl -n istio-system create secret generic nginx-ca-certs --from-file=certs/2_intermediate/certs/ca-chain.cert.pem\n"})}),"\n",(0,i.jsx)(n.h3,{id:"patch-the-egressgateway",children:"patch the egressgateway"}),"\n",(0,i.jsxs)(n.p,{children:["There's a better way to do this by setting these mounts during the ",(0,i.jsx)(n.code,{children:"istioctl"})," install, but this is the manual post-install way:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'kubectl -n istio-system patch --type=json deploy istio-egressgateway -p "$(cat patch-egress.json)"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["where ",(0,i.jsx)(n.code,{children:"patch-egress.json"})," is"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'[{\n  "op": "add",\n  "path": "/spec/template/spec/containers/0/volumeMounts/0",\n  "value": {\n    "mountPath": "/etc/istio/nginx-client-certs",\n    "name": "nginx-client-certs",\n    "readOnly": true\n  }\n},\n{\n  "op": "add",\n  "path": "/spec/template/spec/volumes/0",\n  "value": {\n  "name": "nginx-client-certs",\n    "secret": {\n      "secretName": "nginx-client-certs",\n      "optional": true\n    }\n  }\n},\n{\n  "op": "add",\n  "path": "/spec/template/spec/containers/0/volumeMounts/1",\n  "value": {\n    "mountPath": "/etc/istio/nginx-ca-certs",\n    "name": "nginx-ca-certs",\n    "readOnly": true\n  }\n},\n{\n  "op": "add",\n  "path": "/spec/template/spec/volumes/1",\n  "value": {\n  "name": "nginx-ca-certs",\n    "secret": {\n      "secretName": "nginx-ca-certs",\n      "optional": true\n    }\n  }\n}]\n'})}),"\n",(0,i.jsxs)(n.p,{children:["kill the egressgateway pod (",(0,i.jsx)(n.code,{children:"$ kubectl -n istio-system delete pods -lapp=istio-egressgateway"}),") so it can pick up the secrets (and the certs inside them)."]}),"\n",(0,i.jsxs)(n.p,{children:["Check you can now see the certs in the ",(0,i.jsx)(n.code,{children:"egressgateway"})," pod in the ",(0,i.jsx)(n.code,{children:"istio-system"})," namespace:"]}),"\n",(0,i.jsx)(n.p,{children:"client certs"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ kubectl -n istio-system exec -ti istio-egressgateway-8544965cd5-2hdnc -- ls -al /etc/istio/nginx-client-certs\ntotal 8\ndrwxrwxrwt 3 root root  120 Apr  8 13:56 .\ndrwxr-xr-x 1 root root 4096 Apr  8 13:56 ..\ndrwxr-xr-x 2 root root   80 Apr  8 13:56 ..2020_04_08_13_56_42.418467475\nlrwxrwxrwx 1 root root   31 Apr  8 13:56 ..data -> ..2020_04_08_13_56_42.418467475\nlrwxrwxrwx 1 root root   14 Apr  8 13:56 tls.crt -> ..data/tls.crt\nlrwxrwxrwx 1 root root   14 Apr  8 13:56 tls.key -> ..data/tls.key\n"})}),"\n",(0,i.jsx)(n.p,{children:"ca-certs"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ kubectl -n istio-system exec -ti istio-egressgateway-8544965cd5-2hdnc -- ls -al /etc/istio/nginx-ca-certs\ntotal 8\ndrwxrwxrwt 3 root root  100 Apr  8 13:56 .\ndrwxr-xr-x 1 root root 4096 Apr  8 13:56 ..\ndrwxr-xr-x 2 root root   60 Apr  8 13:56 ..2020_04_08_13_56_42.910605930\nlrwxrwxrwx 1 root root   31 Apr  8 13:56 ..data -> ..2020_04_08_13_56_42.910605930\nlrwxrwxrwx 1 root root   24 Apr  8 13:56 ca-chain.cert.pem -> ..data/ca-chain.cert.pem\n\n"})}),"\n",(0,i.jsx)(n.h2,{id:"warning-istio-documented-configs-not-working",children:"WARNING: Istio Documented Configs (NOT WORKING)"}),"\n",(0,i.jsxs)(n.p,{children:["I followed the Istio documentation closely, and for the life of me could not get the configurations to work, or find any resolution to the error messages via the github issues section, or on their ",(0,i.jsx)(n.a,{href:"https://discuss.istio.io/",children:"discuss forums"})," and slack channel."]}),"\n",(0,i.jsxs)(n.p,{children:["I logged an issues ticket (",(0,i.jsx)(n.a,{href:"https://github.com/istio/istio.io/issues/7063",children:"https://github.com/istio/istio.io/issues/7063"}),") with the istio.io repo as I don't think it's an issue with Istio itself, just the documentation."]}),"\n",(0,i.jsxs)(n.p,{children:["So the ",(0,i.jsx)(n.em,{children:(0,i.jsx)(n.strong,{children:'"not working"'})})," setup is as follows:"]}),"\n",(0,i.jsxs)(n.p,{children:["With everything setup as above, and following the ",(0,i.jsx)(n.a,{href:"https://istio.io/docs/tasks/traffic-management/egress/egress-gateway-tls-origination/",children:"Egress Gateways with TLS Origination (v1.5.0)"})," I deployed the following configurations to a namespace called ",(0,i.jsx)(n.code,{children:"mesh-internal"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"---\napiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: istio-egressgateway\nspec:\n  selector:\n    istio: egressgateway\n  servers:\n  - port:\n      number: 443\n      name: https\n      protocol: HTTPS\n    hosts:\n    - mtls.cloudbuild.site\n    tls:\n      mode: MUTUAL\n      serverCertificate: /etc/certs/cert-chain.pem\n      privateKey: /etc/certs/key.pem\n      caCertificates: /etc/certs/root-cert.pem\n\n---\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: egressgateway-for-nginx\nspec:\n  host: istio-egressgateway.istio-system.svc.cluster.local\n  subsets:\n  - name: nginx\n    trafficPolicy:\n      loadBalancer:\n        simple: ROUND_ROBIN\n      portLevelSettings:\n      - port:\n          number: 443\n        tls:\n          mode: ISTIO_MUTUAL\n          sni: mtls.cloudbuild.site\n\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: direct-nginx-through-egress-gateway\nspec:\n  hosts:\n  - mtls.cloudbuild.site\n  gateways:\n  - istio-egressgateway\n  - mesh\n  http:\n  - match:\n    - gateways:\n      - mesh\n      port: 80\n    route:\n    - destination:\n        host: istio-egressgateway.istio-system.svc.cluster.local\n        subset: nginx\n        port:\n          number: 443\n      weight: 100\n  - match:\n    - gateways:\n      - istio-egressgateway\n      port: 443\n    route:\n    - destination:\n        host: mtls.cloudbuild.site\n        port:\n          number: 443\n      weight: 100\n---\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: originate-mtls-for-nginx\nspec:\n  host: mtls.cloudbuild.site\n  trafficPolicy:\n    loadBalancer:\n      simple: ROUND_ROBIN\n    portLevelSettings:\n    - port:\n        number: 443\n      tls:\n        mode: MUTUAL\n        clientCertificate: /etc/istio/nginx-client-certs/tls.crt\n        privateKey: /etc/istio/nginx-client-certs/tls.key\n        caCertificates: /etc/istio/nginx-ca-certs/ca-chain.cert.pem\n        sni: mtls.cloudbuild.site\n"})}),"\n",(0,i.jsx)(n.p,{children:"this creates 4 x objects"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"gateway.networking.istio.io/istio-egressgateway created"}),"\n",(0,i.jsx)(n.li,{children:"destinationrule.networking.istio.io/egressgateway-for-nginx created"}),"\n",(0,i.jsx)(n.li,{children:"virtualservice.networking.istio.io/direct-nginx-through-egress-gateway created"}),"\n",(0,i.jsx)(n.li,{children:"destinationrule.networking.istio.io/originate-mtls-for-nginx created"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"errors-nginx-certs--root-certpem",children:"Errors: nginx certs & root-cert.pem"}),"\n",(0,i.jsx)(n.h3,{id:"invalid-path-nginx-certs",children:"invalid path nginx certs"}),"\n",(0,i.jsxs)(n.p,{children:["checking the istio-proxy container for a ",(0,i.jsx)(n.code,{children:"sleep"})," pod inside my ",(0,i.jsx)(n.code,{children:"mesh-internal"})," namespace:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"2020-04-12T02:39:07.916502Z\tinfo\tEnvoy proxy is ready\n[Envoy (Epoch 0)] [2020-04-12 02:40:53.418][16][warning][config] [external/envoy/source/common/config/grpc_subscription_impl.cc:87] gRPC config for type.googleapis.com/envoy.api.v2.Cluster rejected: Error adding/updating cluster(s) outbound|443||mtls.cloudbuild.site: Invalid path: /etc/istio/nginx-ca-certs/ca-chain.cert.pem\n"})}),"\n",(0,i.jsx)(n.h3,{id:"invalid-path-etccertsroot-certpem",children:"invalid path /etc/certs/root-cert.pem"}),"\n",(0,i.jsxs)(n.p,{children:["checking the ",(0,i.jsx)(n.code,{children:"istio-egressgateway"})," pod I can see the following errors as well:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"[Envoy (Epoch 0)] [2020-04-12 02:54:07.787][15][warning][config] [external/envoy/source/common/config/grpc_subscription_impl.cc:87] gRPC config for type.googleapis.com/envoy.api.v2.Listener rejected: Error adding/updating listener(s) 0.0.0.0_443: Invalid path: /etc/certs/root-cert.pem\n"})}),"\n",(0,i.jsx)(n.h3,{id:"http11-503-service-unavailable-obviously",children:"HTTP/1.1 503 Service Unavailable (obviously)"}),"\n",(0,i.jsx)(n.p,{children:"Without the certs, checking with curl calling my mtls server I get:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ kubectl -n mesh-internal exec sleep-74997ffb46-flkcg -c sleep -- curl -s -I http://mtls.cloudbuild.site\nHTTP/1.1 503 Service Unavailable\ncontent-length: 91\ncontent-type: text/plain\ndate: Sat, 11 Apr 2020 13:24:33 GMT\nserver: envoy\n"})}),"\n",(0,i.jsx)(n.h2,{id:"unofficial-working-configuration",children:"UNOFFICIAL: WORKING CONFIGURATION"}),"\n",(0,i.jsx)(n.p,{children:"After a lot of reading through istio githubs issues and discuss.istio.io forum, I pieced together the following changes that eventually lead to a successful TLS client-verified session with my external MTLS server."}),"\n",(0,i.jsxs)(n.p,{children:["Disclaimer: I don't think this is how this setup is supposed to work (being able to only call the mtls server from a deployment with the annotation is a bit meh right?), this is just how I got things to work so that a bare ",(0,i.jsx)(n.code,{children:"curl"})," to an http endpoint gets upgraded to ",(0,i.jsx)(n.code,{children:"tls/443"})," and does the clint-certificate verification automatically."]}),"\n",(0,i.jsx)(n.p,{children:"Our architectural diagram ends up looking more like this:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"architecture",src:t(45808).A+"",width:"1585",height:"882"})}),"\n",(0,i.jsx)(n.p,{children:"So, first the fixes for the cert errors-"}),"\n",(0,i.jsx)(n.h3,{id:"etcroot-certpem-fix",children:"/etc/root-cert.pem fix"}),"\n",(0,i.jsxs)(n.p,{children:["I changed port protocal from ",(0,i.jsx)(n.code,{children:"HTTPS"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: istio-egressgateway\nspec:\n  selector:\n    istio: egressgateway\n  servers:\n  - port:\n      number: 443\n      name: https\n      protocol: HTTPS\n    hosts:\n    - mtls.cloudbuild.site\n    tls:\n      mode: MUTUAL\n      serverCertificate: /etc/certs/cert-chain.pem\n      privateKey: /etc/certs/key.pem\n      caCertificates: /etc/certs/root-cert.pem\n"})}),"\n",(0,i.jsxs)(n.p,{children:["to ",(0,i.jsx)(n.code,{children:"TLS"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: istio-egressgateway\nspec:\n  selector:\n    istio: egressgateway\n  servers:\n  - port:\n      number: 443\n      name: https\n      protocol: TLS\n    hosts:\n    - mtls.cloudbuild.site\n    tls:\n      mode: MUTUAL\n      serverCertificate: /etc/certs/cert-chain.pem\n      privateKey: /etc/certs/key.pem\n      caCertificates: /etc/certs/root-cert.pem\n"})}),"\n",(0,i.jsx)(n.p,{children:"And the error goes away."}),"\n",(0,i.jsxs)(n.p,{children:["I'm assuming its because there's a ",(0,i.jsx)(n.code,{children:"tls"})," section there and cert lookups get treated differently?"]}),"\n",(0,i.jsx)(n.h3,{id:"invalid-path-etcistionginx-ca-certsca-chaincertpem-fix",children:"Invalid path: /etc/istio/nginx-ca-certs/ca-chain.cert.pem fix"}),"\n",(0,i.jsxs)(n.p,{children:["For this one I came across an open issue where someone advised the sidecar of the pod calling the MTLS backend server needs to have the certs mounted to it - which sort of defeats the purpose of this ",(0,i.jsx)(n.em,{children:'"egressgateway will handle verifying calls to the backend using istio"'})," example right?"]}),"\n",(0,i.jsx)(n.p,{children:"Anyway, I did the following:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["created the ",(0,i.jsx)(n.code,{children:"nginx-client-certs"})," and ",(0,i.jsx)(n.code,{children:"nginx-ca-certs"})," secrets inside my namespace ",(0,i.jsx)(n.code,{children:"mesh-internal"})," (where my ",(0,i.jsx)(n.code,{children:"sleep"})," pod is deployed)"]}),"\n",(0,i.jsxs)(n.li,{children:["added the following annotations (",(0,i.jsx)(n.code,{children:"sidecar.istio.io/userVolumeMount"})," and ",(0,i.jsx)(n.code,{children:"sidecar.istio.io/userVolume"}),") to my sleep pods deployment manifest:"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: sleep\n  namespace: mesh-internal\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: sleep\n  template:\n    metadata:\n      annotations:\n        sidecar.istio.io/userVolumeMount: \'[{"name":"nginx-client-certs", "mountPath":"/etc/istio/nginx-client-certs", "readonly":true},{"name":"nginx-ca-certs", "mountPath":"/etc/istio/nginx-ca-certs", "readonly":true}]\'\n        sidecar.istio.io/userVolume: \'[{"name":"nginx-client-certs", "secret":{"secretName":"nginx-client-certs"\\}\\},{"name":"nginx-ca-certs", "secret":{"secretName":"nginx-ca-certs"\\}\\}]\'\n      labels:\n        app: sleep\n    spec:\n      serviceAccountName: sleep\n      containers:\n      - name: sleep\n        image: governmentpaas/curl-ssl\n        command: ["/bin/sleep", "3650d"]\n        imagePullPolicy: IfNotPresent\n        volumeMounts:\n        - mountPath: /etc/sleep/tls\n          name: secret-volume\n      volumes:\n      - name: secret-volume\n        secret:\n          secretName: sleep-secret\n          optional: true\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Now my ",(0,i.jsx)(n.code,{children:"sleep"})," pod doesn't complain about the nginx certs anymore."]}),"\n",(0,i.jsxs)(n.p,{children:["I see other pods like prometheus and an httpbin pod in my ",(0,i.jsx)(n.code,{children:"mesh-internal"})," namespace complaining about not finding the certs, but I understand (currently) it's because I haven't \"sidecar mounted\" these certs directly to them."]}),"\n",(0,i.jsx)(n.h3,{id:"add-serviceentry-and-virtualservice",children:"Add ServiceEntry and VirtualService"}),"\n",(0,i.jsxs)(n.p,{children:["I added a ",(0,i.jsx)(n.code,{children:"ServiceEntry"})," and ",(0,i.jsx)(n.code,{children:"VirtualService"})," combination (it wasn't clear in the example that I needed to have one, and the previous section of the documentation delete's the ServiceEntry so the following section seems to go ahead without one and doesn't specify creating a new one?)"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.istio.io/v1alpha3\nkind: ServiceEntry\nmetadata:\n  name: external-mtls-nginx-server\n  namespace: mesh-internal\nspec:\n  hosts:\n  - mtls.cloudbuild.site\n  ports:\n  - number: 80\n    name: http\n    protocol: HTTP\n  - number: 443\n    name: https\n    protocol: TLS\n  resolution: DNS\n\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: nginx\n  namespace: mesh-internal\nspec:\n  hosts:\n  - mtls.cloudbuild.site\n  tls:\n  - match:\n    - port: 443\n      sni_hosts:\n      - mtls.cloudbuild.site\n    route:\n    - destination:\n        host: mtls.cloudbuild.site\n        port:\n          number: 443\n      weight: 100\n"})}),"\n",(0,i.jsx)(n.h3,{id:"changed-gateway-to-http",children:"Changed Gateway to HTTP"}),"\n",(0,i.jsx)(n.p,{children:"Changed this from tls.."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"---\napiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: istio-egressgateway\nspec:\n  selector:\n    istio: egressgateway\n  servers:\n  - port:\n      number: 443\n      name: https\n      protocol: HTTPS\n    hosts:\n    - mtls.cloudbuild.site\n    tls:\n      mode: MUTUAL\n      serverCertificate: /etc/certs/cert-chain.pem\n      privateKey: /etc/certs/key.pem\n      caCertificates: /etc/certs/root-cert.pem\n"})}),"\n",(0,i.jsx)(n.p,{children:"to HTTP"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"---\napiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: istio-egressgateway\n  namespace: mesh-internal\nspec:\n  selector:\n    istio: egressgateway\n  servers:\n  - port:\n      number: 80\n      name: http\n      protocol: HTTP\n    hosts:\n    - mtls.cloudbuild.site\n"})}),"\n",(0,i.jsx)(n.h3,{id:"changed-destinationrule",children:"Changed DestinationRule"}),"\n",(0,i.jsx)(n.p,{children:"from"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: egressgateway-for-nginx\nspec:\n  host: istio-egressgateway.istio-system.svc.cluster.local\n  subsets:\n  - name: nginx\n    trafficPolicy:\n      loadBalancer:\n        simple: ROUND_ROBIN\n      portLevelSettings:\n      - port:\n          number: 443\n        tls:\n          mode: ISTIO_MUTUAL\n          sni: mtls.cloudbuild.site\n"})}),"\n",(0,i.jsx)(n.p,{children:"to"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: egressgateway-for-nginx\n  namespace: mesh-internal\nspec:\n  host: istio-egressgateway.istio-system.svc.cluster.local\n  subsets:\n  - name: nginx\n"})}),"\n",(0,i.jsx)(n.h3,{id:"changed-virtualservice-to-port-80",children:"Changed VirtualService to port 80"}),"\n",(0,i.jsxs)(n.p,{children:["Now that my ",(0,i.jsx)(n.code,{children:"Gateway"})," is port 80, I update the following route from ",(0,i.jsx)(n.code,{children:"istio-egressgateway.istio-system.svc.cluster.local:443"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: direct-nginx-through-egress-gateway\nspec:\n  hosts:\n  - mtls.cloudbuild.site\n  gateways:\n  - istio-egressgateway\n  - mesh\n  http:\n  - match:\n    - gateways:\n      - mesh\n      port: 80\n    route:\n    - destination:\n        host: istio-egressgateway.istio-system.svc.cluster.local\n        subset: nginx\n        port:\n          number: 443\n      weight: 100\n  - match:\n    - gateways:\n      - istio-egressgateway\n      port: 443\n    route:\n    - destination:\n        host: mtls.cloudbuild.site\n        port:\n          number: 443\n      weight: 100\n"})}),"\n",(0,i.jsxs)(n.p,{children:["to ",(0,i.jsx)(n.code,{children:"istio-egressgateway.istio-system.svc.cluster.local:80"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: direct-nginx-through-egress-gateway\n  namespace: mesh-internal\nspec:\n  hosts:\n  - mtls.cloudbuild.site\n  gateways:\n  - istio-egressgateway\n  - mesh\n  http:\n  - match:\n    - gateways:\n      - mesh\n      port: 80\n    route:\n    - destination:\n        host: istio-egressgateway.istio-system.svc.cluster.local\n        subset: nginx\n        port:\n          number: 80\n      weight: 100\n  - match:\n    - gateways:\n      - istio-egressgateway\n      port: 80\n    route:\n    - destination:\n        host: mtls.cloudbuild.site\n        port:\n          number: 443\n      weight: 100\n"})}),"\n",(0,i.jsx)(n.p,{children:"And then it all works."}),"\n",(0,i.jsx)(n.h2,{id:"working-output",children:"Working Output"}),"\n",(0,i.jsxs)(n.p,{children:["So now when I curl from the ",(0,i.jsx)(n.code,{children:"sleep"})," pod inside the ",(0,i.jsx)(n.code,{children:"mesh-internal"})," namespace, I get the expected output:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'$ kubectl -n mesh-internal exec sleep-74997ffb46-cxs77 -c sleep -- curl  http://mtls.cloudbuild.site\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0<!DOCTYPE html>\n<html />\n<head />\n<title />Welcome to nginx!</title>\n<style />\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n</style>\n</head>\n<body />\n<h1 />Welcome to the Mutual TLS Server!</h1>\n\n<p />If you see this page, you have successfully used the correct client-side certificates that match the ones\n  deployed on this server.\n</p>\n\n<p />For more information please visit my website:<a href="https://iamronamo.io/" />iamronamo.io</a>.\n\n<p /><em />Thank you and goodnight.</em></p>\n</body>\n</html>\n'})}),"\n",(0,i.jsxs)(n.p,{children:["From the sleep pod's ",(0,i.jsx)(n.code,{children:"istio-proxy"})," container I can see it hitting my port 80 outbound endpoint:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'[2020-04-11T15:03:16.493Z] "GET / HTTP/1.1" 200 - "-" "-" 0 557 4 4 "-" "curl/7.64.0" "738ceb49-93c9-4462-a53b-ab690bef4b93" "mtls.cloudbuild.site" "16.0.1.90:80" outbound|80|nginx|istio-egressgateway.istio-system.svc.cluster.local 16.0.1.103:39040 52.189.232.175:80 16.0.1.103:45092 - -\n'})}),"\n",(0,i.jsxs)(n.p,{children:["and from the ",(0,i.jsx)(n.code,{children:"istio-egressgateway"})," pod I can see it going outbound on 443:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'[2020-04-11T15:04:37.866Z] "GET / HTTP/2" 200 - "-" "-" 0 557 4 4 "16.0.1.103" "curl/7.64.0" "7d158baa-3ac4-4da7-9e91-a4ae6115c090" "mtls.cloudbuild.site" "52.189.232.175:443" outbound|443||mtls.cloudbuild.site 16.0.1.90:43866 16.0.1.90:80 16.0.1.103:39040 - -\n'})}),"\n",(0,i.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,i.jsxs)(n.p,{children:["I have found Istio's documentation to be workable most of the time. But sometimes the examples run into each other, so its hard to know what are the specifics of that example without something explicitly saying \"this example will create ",(0,i.jsx)(n.code,{children:"n"}),' components", or a repo/folder with the exact configs used to achieve whatever the thing was in the example.']}),"\n",(0,i.jsx)(n.p,{children:"The discuss forum and slack channels were very underwhelming. I don't know what to put that down to, but they weren't very active or helpful."}),"\n",(0,i.jsx)(n.p,{children:"Anyway I've spent way too much time on this and it's just good to get it working so I can put this all behind me."})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},79106:(e,n,t)=>{t.d(n,{A:()=>s});const s="data:image/png;base64,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"}}]);