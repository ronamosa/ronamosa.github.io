"use strict";(self.webpackChunkronamosa_github_io=self.webpackChunkronamosa_github_io||[]).push([[2207],{28453:(e,n,r)=>{r.d(n,{R:()=>l,x:()=>a});var i=r(96540);const s={},t=i.createContext(s);function l(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),i.createElement(t.Provider,{value:n},e.children)}},33707:(e,n,r)=>{r.d(n,{A:()=>i});const i=r.p+"assets/images/azure-aks-portfoward-0b32bd78f20621c134e7949743b510f1.png"},89585:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>u,frontMatter:()=>l,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"engineer/Azure/2019-02-04-Azure-Kubernetes-up-and-running-3","title":"Azure Kubernetes Service (AKS) Setup Guide - Part 3: Monitoring, Scaling, and Security","description":"Complete AKS setup with monitoring, auto-scaling, and security best practices. Final part of comprehensive Azure Kubernetes Service deployment guide.","source":"@site/docs/engineer/Azure/2019-02-04-Azure-Kubernetes-up-and-running-3.md","sourceDirName":"engineer/Azure","slug":"/engineer/Azure/2019-02-04-Azure-Kubernetes-up-and-running-3","permalink":"/docs/engineer/Azure/2019-02-04-Azure-Kubernetes-up-and-running-3","draft":false,"unlisted":false,"editUrl":"https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/engineer/Azure/2019-02-04-Azure-Kubernetes-up-and-running-3.md","tags":[{"inline":true,"label":"azure","permalink":"/docs/tags/azure"},{"inline":true,"label":"aks","permalink":"/docs/tags/aks"},{"inline":true,"label":"kubernetes","permalink":"/docs/tags/kubernetes"},{"inline":true,"label":"monitoring","permalink":"/docs/tags/monitoring"},{"inline":true,"label":"security","permalink":"/docs/tags/security"},{"inline":true,"label":"part-3","permalink":"/docs/tags/part-3"}],"version":"current","lastUpdatedBy":"Ron Amosa","lastUpdatedAt":1771617957000,"sidebarPosition":5,"frontMatter":{"title":"Azure Kubernetes Service (AKS) Setup Guide - Part 3: Monitoring, Scaling, and Security","description":"Complete AKS setup with monitoring, auto-scaling, and security best practices. Final part of comprehensive Azure Kubernetes Service deployment guide.","keywords":["aks monitoring","kubernetes scaling","aks security","azure monitor","k8s autoscaling","aks best practices","azure kubernetes"],"tags":["azure","aks","kubernetes","monitoring","security","part-3"],"sidebar_position":5},"sidebar":"docsSidebar","previous":{"title":"Azure Kubernetes Service (AKS) Setup Guide - Part 2: Application Deployment and Services","permalink":"/docs/engineer/Azure/2019-02-04-Azure-Kubernetes-up-and-running-2"},"next":{"title":"AKS Azure AD Integration - Complete Security Setup with Kubernetes RBAC","permalink":"/docs/engineer/Azure/2020-09-27-AKS-AzureAD-Integration-2020"}}');var s=r(74848),t=r(28453);const l={title:"Azure Kubernetes Service (AKS) Setup Guide - Part 3: Monitoring, Scaling, and Security",description:"Complete AKS setup with monitoring, auto-scaling, and security best practices. Final part of comprehensive Azure Kubernetes Service deployment guide.",keywords:["aks monitoring","kubernetes scaling","aks security","azure monitor","k8s autoscaling","aks best practices","azure kubernetes"],tags:["azure","aks","kubernetes","monitoring","security","part-3"],sidebar_position:5},a=void 0,o={},c=[{value:"Series Overview",id:"series-overview",level:2},{value:"Pre-requisites tools",id:"pre-requisites-tools",level:2},{value:"(new) AKS cluster deployed",id:"new-aks-cluster-deployed",level:2},{value:"(new) Azure Container Registry",id:"new-azure-container-registry",level:2},{value:"K8s Deployment",id:"k8s-deployment",level:2},{value:"kubectl: deploy",id:"kubectl-deploy",level:3},{value:"kubectl: check deployment",id:"kubectl-check-deployment",level:3},{value:"kubectl: check pods",id:"kubectl-check-pods",level:3},{value:"K8s Service",id:"k8s-service",level:2},{value:"Delete deployment",id:"delete-deployment",level:2},{value:"Deploy NGINX yaml",id:"deploy-nginx-yaml",level:2},{value:"nginx.yaml",id:"nginxyaml",level:3},{value:"use our own azurecr.io (container registry)",id:"use-our-own-azurecrio-container-registry",level:3},{value:"prepare our image",id:"prepare-our-image",level:4},{value:"deploy nginx.yaml",id:"deploy-nginxyaml",level:3},{value:"port-forward (cheating)",id:"port-forward-cheating",level:3},{value:"References",id:"references",level:2}];function d(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsx)(n.p,{children:"Published Date: 04-FEB-2019"})}),"\n",(0,s.jsxs)(n.p,{children:["In ",(0,s.jsx)(n.a,{href:"2019-02-04-Azure-Kubernetes-up-and-running-2",children:"Part 2"}),", we setup a private Azure Container Register using azure-cli and terraform."]}),"\n",(0,s.jsxs)(n.p,{children:['For the 3rd and final instalment of this "Look Ma, I\'m playing with Azure!", we will deploy an application to our AKS cluster using ',(0,s.jsx)(n.code,{children:"kubectl"})]}),"\n",(0,s.jsx)(n.h2,{id:"series-overview",children:"Series Overview"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Part 1 - get Kubernetes cluster up and running on Azure Kubernetes Managed Service (AKS)"}),"\n",(0,s.jsx)(n.li,{children:"Part 2 - create a private Docker Registry in the cloud using Azure's Container Registry Managed service (ACR)"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Part 3 - deploy a simple application to AKS."})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"pre-requisites-tools",children:"Pre-requisites tools"}),"\n",(0,s.jsx)(n.p,{children:"Get these installed if you haven't already:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Azure ",(0,s.jsx)(n.a,{href:"https://portal.azure.com",children:"portal account"})]}),"\n",(0,s.jsxs)(n.li,{children:["Azure ",(0,s.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/cli/azure/install-azure-cli-apt?view=azure-cli-latest",children:"az-cli"})," (command line interface)"]}),"\n",(0,s.jsxs)(n.li,{children:["Terraform ",(0,s.jsx)(n.a,{href:"https://learn.hashicorp.com/terraform/getting-started/install.html",children:"installed"})," (zipped binary, copy to ~/bin)"]}),"\n",(0,s.jsxs)(n.li,{children:["Kubectl ",(0,s.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/tools/install-kubectl/",children:"installed"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Right, quick run through the new ACR setup so that the rest of the code below is relevant to that:"}),"\n",(0,s.jsx)(n.h2,{id:"new-aks-cluster-deployed",children:"(new) AKS cluster deployed"}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["I have updated ",(0,s.jsx)(n.a,{href:"2019-01-28-Azure-Kubernetes-up-and-running-1",children:"Part 1"})," so if you've followed that you should be up to speed at this point."]})}),"\n",(0,s.jsx)(n.admonition,{type:"danger",children:(0,s.jsx)(n.p,{children:"Make sure you have your kubeconfig file handy for the 'helm' section!"})}),"\n",(0,s.jsxs)(n.p,{children:["run this to get your kubeconfig: ",(0,s.jsx)(n.code,{children:"$ az aks get-credentials --resource-group AKS-CLOUDRESOURCES --name AKS-cloudbuilderio"})]}),"\n",(0,s.jsx)(n.h2,{id:"new-azure-container-registry",children:"(new) Azure Container Registry"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"2019-02-04-Azure-Kubernetes-up-and-running-2",children:"Part 2"})," has also been updated, so hopefully you have a running AKS cluster AND a working Azure Container Registry now!"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Right. We are ready to deploy something to our AKS cluster!"}),"\n",(0,s.jsx)(n.h2,{id:"k8s-deployment",children:"K8s Deployment"}),"\n",(0,s.jsxs)(n.p,{children:["This file basically uses 'kubectl' to deploy whatever we specify in here, as \"pods\" in our cluster (note ",(0,s.jsx)(n.code,{children:"kubectl"})," by default will point to whatever you have in ",(0,s.jsx)(n.code,{children:"~/.kube/config"}),")"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title="deployment.yaml"',children:"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx\nspec:\n  selector:\n    matchLabels:\n      app: nginx\n  replicas: 2\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:1.8\n        ports:\n        - containerPort: 80\n"})}),"\n",(0,s.jsx)(n.h3,{id:"kubectl-deploy",children:"kubectl: deploy"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ kubectl apply -f ./deployment.yaml\ndeployment.apps/nginx created\n"})}),"\n",(0,s.jsx)(n.h3,{id:"kubectl-check-deployment",children:"kubectl: check deployment"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ kubectl get deploy\nNAME    DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\nnginx   2         2         2            2           81s\n"})}),"\n",(0,s.jsx)(n.h3,{id:"kubectl-check-pods",children:"kubectl: check pods"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ kubectl get pods -lapp=nginx -o wide\nNAME                     READY   STATUS    RESTARTS   AGE     IP           NODE                   NOMINATED NODE\nnginx-5cd6d46846-cr5m7   1/1     Running   0          6m10s   10.244.0.9   aks-nodes-28201024-2   <none />\nnginx-5cd6d46846-ntszh   1/1     Running   0          6m10s   10.244.2.3   aks-nodes-28201024-1   <none />\n"})}),"\n",(0,s.jsx)(n.h2,{id:"k8s-service",children:"K8s Service"}),"\n",(0,s.jsx)(n.p,{children:"Again, like the deployment this is just a basic \"service\" component to be deployed. A Service is an abstraction that defines a set of pods somewhere on your cluster that all do the same thing.\nIf a node dies and takes all the pods with it, as long as there was a 'Service' configured for the functionality of those pods, the new pods that come up with new IP addresses will be known to the Service."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ kubectl apply -f service.yaml\nservice/nginx created\n"})}),"\n",(0,s.jsx)(n.p,{children:"check our service is up & running"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ kubectl get svc nginx\nNAME    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE\nnginx   ClusterIP   10.0.154.171   <none />        80/TCP    24s\n"})}),"\n",(0,s.jsx)(n.h2,{id:"delete-deployment",children:"Delete deployment"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'$ kubectl delete deploy nginx\ndeployment.extensions "nginx" deleted\n'})}),"\n",(0,s.jsx)(n.h2,{id:"deploy-nginx-yaml",children:"Deploy NGINX yaml"}),"\n",(0,s.jsxs)(n.p,{children:["Okay, you get the idea pretty much you can ",(0,s.jsx)(n.code,{children:"kubectl"})," 'apply' yaml files of deployments and services to your AKS cluster as easy as that."]}),"\n",(0,s.jsx)(n.p,{children:"So for our grand finale, we will do an nginx deploy we can actually get to from the internet."}),"\n",(0,s.jsx)(n.h3,{id:"nginxyaml",children:"nginx.yaml"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Service\nmetadata:\n  name: nginx\n  labels:\n    run: nginx\nspec:\n  type: NodePort\n  ports:\n  - port: 8080\n    targetPort: 80\n    protocol: TCP\n  selector:\n    run: nginx\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx\nspec:\n  selector:\n    matchLabels:\n      run: nginx\n  replicas: 2\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: registercloudbuilderio.azurecr.io/nginx:1.8\n        ports:\n        - containerPort: 80\n"})}),"\n",(0,s.jsx)(n.h3,{id:"use-our-own-azurecrio-container-registry",children:"use our own azurecr.io (container registry)"}),"\n",(0,s.jsx)(n.p,{children:"let's pull the image from our own ACR instead"}),"\n",(0,s.jsx)(n.h4,{id:"prepare-our-image",children:"prepare our image"}),"\n",(0,s.jsx)(n.p,{children:"pull from docker hub."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ docker pull nginx:1.8\n1.8: Pulling from library/nginx\nefd26ecc9548: Pull complete\na3ed95caeb02: Pull complete\n24941909ea54: Pull complete\n7e605cb95896: Pull complete\nDigest: sha256:c97ee70c4048fe79765f7c2ec0931957c2898f47400128f4f3640d0ae5d60d10\nStatus: Downloaded newer image for nginx:1.8\n"})}),"\n",(0,s.jsx)(n.p,{children:"re-tag"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker tag nginx:1.8 registercloudbuilderio.azurecr.io/nginx:1.8\n"})}),"\n",(0,s.jsx)(n.p,{children:"push to our ACR."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ docker push registercloudbuilderio.azurecr.io/nginx:1.8\nThe push refers to repository [registercloudbuilderio.azurecr.io/nginx]\n5f70bf18a086: Pushed\n62fd1c28b3bf: Pushed\n6d700a2d8883: Pushed\nc12ecfd4861d: Pushed\n1.8: digest: sha256:746419199c9569216937fc59604805b7ac0f52b438bb5ca4ec6b7f990873b198 size: 1977\n"})}),"\n",(0,s.jsx)(n.h3,{id:"deploy-nginxyaml",children:"deploy nginx.yaml"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ kubectl apply -f ./nginx.yaml\nservice/nginx created\ndeployment.apps/nginx created\n"})}),"\n",(0,s.jsxs)(n.p,{children:["do a ",(0,s.jsx)(n.code,{children:"describe"})," on the pods to verify it pulled the image we pushed to ACR"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'$ kubectl describe pods nginx-66867b8df4-kzbd2\n...\nEvents:\n  Type    Reason     Age   From                           Message\n  ----    ------     ----  ----                           -------\n  Normal  Scheduled  28s   default-scheduler              Successfully assigned default/nginx-66867b8df4-kzbd2 to aks-nodes-28201024-0\n  Normal  Pulling    26s   kubelet, aks-nodes-28201024-0  pulling image "registercloudbuilderio.azurecr.io/nginx:1.8"\n  Normal  Pulled     10s   kubelet, aks-nodes-28201024-0  Successfully pulled image "registercloudbuilderio.azurecr.io/nginx:1.8"\n  Normal  Created    10s   kubelet, aks-nodes-28201024-0  Created container\n  Normal  Started    9s    kubelet, aks-nodes-28201024-0  Started container\n'})}),"\n",(0,s.jsx)(n.p,{children:"looks good!"}),"\n",(0,s.jsx)(n.h3,{id:"port-forward-cheating",children:"port-forward (cheating)"}),"\n",(0,s.jsx)(n.p,{children:"A quick way to check the app (nginx) is serving correctly is to port-forward a local port to the AKS cluster and into the nginx pods."}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["Here is how I had to do it because I run my ",(0,s.jsx)(n.code,{children:"kubectl"})," from a linux vm, so I serve the port-forward on that vm and connect to it from this (windows) PC."]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl port-forward --address 0.0.0.0 deployment/nginx 8080:80\n"})}),"\n",(0,s.jsx)(n.p,{children:"what this does"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["forwards traffic to the ",(0,s.jsx)(n.code,{children:"nginx"})," deployment"]}),"\n",(0,s.jsxs)(n.li,{children:["serves it locally via ",(0,s.jsx)(n.code,{children:"0.0.0.0"})," (made available via a 192.x.x.x local ip)"]}),"\n",(0,s.jsxs)(n.li,{children:["serves locally on port ",(0,s.jsx)(n.code,{children:"8080"})," and forwards through to port ",(0,s.jsx)(n.code,{children:"80"})," on the nginx deployment."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"tada!"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"port-forward success",src:r(33707).A+"",width:"720",height:"376"})}),"\n",(0,s.jsx)(n.p,{children:"Thanks for following along and if you see anything that needs updating/correcting etc. please feel free to let me know!"}),"\n",(0,s.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/run-application/run-stateless-application-deployment/#creating-and-exploring-an-nginx-deployment",children:"K8s Nginx Deployment"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/azure/aks/ingress-tls",children:"HTTPS ingress for AKS"})," ",(0,s.jsx)(n.em,{children:"(Ive just got this here for future refernce when I want to come back and do this properly.)"})]}),"\n"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);