"use strict";(self.webpackChunkronamosa_github_io=self.webpackChunkronamosa_github_io||[]).push([[5567],{28453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>o});var r=s(96540);const a={},i=r.createContext(a);function t(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:t(e.components),r.createElement(i.Provider,{value:n},e.children)}},96537:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>t,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"study/CKS/Microservice Vulnerability/VulnerableContainerRuntime","title":"Container Runtime Sandboxes","description":"tech over view","source":"@site/docs/study/CKS/4. Microservice Vulnerability/VulnerableContainerRuntime.md","sourceDirName":"study/CKS/4. Microservice Vulnerability","slug":"/study/CKS/Microservice Vulnerability/VulnerableContainerRuntime","permalink":"/docs/study/CKS/Microservice Vulnerability/VulnerableContainerRuntime","draft":false,"unlisted":false,"editUrl":"https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/study/CKS/4. Microservice Vulnerability/VulnerableContainerRuntime.md","tags":[],"version":"current","lastUpdatedBy":"Ron Amosa","lastUpdatedAt":1771617957000,"frontMatter":{"title":"Container Runtime Sandboxes"},"sidebar":"docsSidebar","previous":{"title":"Reduce Attack Surface","permalink":"/docs/study/CKS/System Hardening/SystemHardReduceAttackSurface"},"next":{"title":"Mutual TLS (mTLS)","permalink":"/docs/study/CKS/Microservice Vulnerability/VulnerableMTLS"}}');var a=s(74848),i=s(28453);const t={title:"Container Runtime Sandboxes"},o=void 0,c={},l=[{value:"tech over view",id:"tech-over-view",level:2},{value:"container calls Linux kernel",id:"container-calls-linux-kernel",level:2},{value:"OCI",id:"oci",level:2},{value:"different cli&#39;s",id:"different-clis",level:2},{value:"kata containers",id:"kata-containers",level:2},{value:"gVisor",id:"gvisor",level:2},{value:"create and run RuntimeClasses",id:"create-and-run-runtimeclasses",level:2},{value:"breakout",id:"breakout",level:2},{value:"gvisor, kata",id:"gvisor-kata",level:2}];function d(e){const n={code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h2,{id:"tech-over-view",children:"tech over view"}),"\n",(0,a.jsx)(n.p,{children:"containers:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"doesn't mean its contained"}),"\n",(0,a.jsx)(n.li,{children:"run on shared kernel, but in kernel group"}),"\n",(0,a.jsx)(n.li,{children:"breakout of kernel group, get all containers"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"sandbox?"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"a playground"}),"\n",(0,a.jsx)(n.li,{children:"simluated testing env"}),"\n",(0,a.jsx)(n.li,{children:"a dev server"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"we mean a security layer when we say sandbox here."}),"\n",(0,a.jsx)(n.p,{children:'system calls - like an "API" for talking to the kernel.'}),"\n",(0,a.jsx)(n.p,{children:"kernel space vs user space."}),"\n",(0,a.jsxs)(n.p,{children:["sandbox goes here: ",(0,a.jsx)(n.code,{children:"app1 <--\x3e sandbox <--\x3e system calls <--\x3e kernel <--\x3e hardware"})]}),"\n",(0,a.jsx)(n.p,{children:"sandbox are not FREE"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"more resources"}),"\n",(0,a.jsx)(n.li,{children:"not good for heavy syscall"}),"\n",(0,a.jsx)(n.li,{children:"no direct access to hw"}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"container-calls-linux-kernel",children:"container calls Linux kernel"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"root@cks-master:/etc/kubernetes/manifests# k run pod --image=nginx\npod/pod created\n\nroot@cks-master:/etc/kubernetes/manifests# k exec pod -it -- bash\n\nroot@pod:/# uname -r\n5.4.0-1051-gcp\n\nroot@pod:/# strace uname -r | head -n 10\n"})}),"\n",(0,a.jsx)(n.p,{children:"try out dirty cow exploit."}),"\n",(0,a.jsx)(n.h2,{id:"oci",children:"OCI"}),"\n",(0,a.jsx)(n.p,{children:"open container initiative -- allowing communication across different container runtimes."}),"\n",(0,a.jsx)(n.p,{children:"early days, k8s heavy coupled with docker"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubelet --\x3e dockershim --\x3e dockerd\nkubelet --\x3e dockershim --\x3e containerd\nkubelet --\x3e dockershim --\x3e runc\n"})}),"\n",(0,a.jsx)(n.p,{children:"new days, created CRI (container runtime interface) allows kubelet to talk to ANY container runtime."}),"\n",(0,a.jsxs)(n.p,{children:["configure kubelet to use a diff CR ",(0,a.jsx)(n.code,{children:"kubelet --container-runtime <runtime />"})," but kubelet can only use ONE runtime at any one time, not mix and match."]}),"\n",(0,a.jsx)(n.h2,{id:"different-clis",children:"different cli's"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"crictl"})," - CRI runtime"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"root@cks-master:/etc/kubernetes/manifests# crictl pull nginx\nImage is up to date for nginx@sha256:a05b0cdd4fc1be3b224ba9662ebdf98fe44c09c0c9215b45f84344c12867002e\nroot@cks-master:/etc/kubernetes/manifests# crictl pods\nPOD ID              CREATED             STATE               NAME                                 NAMESPACE           ATTEMPT\n247186a6c9853       About an hour ago   Ready               kube-apiserver-cks-master            kube-system         2\na1282f11a2f2c       About an hour ago   NotReady            kube-apiserver-cks-master            kube-system         1\nc97ffdc923d6f       3 hours ago         Ready               coredns-558bd4d5db-nvqqp             kube-system         5\ne938e33d5d299       3 hours ago         Ready               coredns-558bd4d5db-kf8j9             kube-system         5\neea6bb0addd94       3 hours ago         Ready               weave-net-2d9st                      kube-system         5\n2f7bdc6478b86       3 hours ago         Ready               kube-proxy-rzbsd                     kube-system         5\nc6fce2a6dfc8d       3 hours ago         Ready               kube-scheduler-cks-master            kube-system         5\n42f5e053e1ff2       3 hours ago         Ready               kube-controller-manager-cks-master   kube-system         5\n8f2fb530b4336       3 hours ago         Ready               etcd-cks-master                      kube-system         5\nf4533c76a11ee       4 days ago          NotReady            coredns-558bd4d5db-kf8j9             kube-system         4\n7c36e278ff27a       4 days ago          NotReady            coredns-558bd4d5db-nvqqp             kube-system         4\na84684b5e22d3       4 days ago          NotReady            weave-net-2d9st                      kube-system         4\n13fb2f701e765       4 days ago          NotReady            kube-proxy-rzbsd                     kube-system         4\nf4a0df336c460       4 days ago          NotReady            etcd-cks-master                      kube-system         4\n"})}),"\n",(0,a.jsx)(n.h2,{id:"kata-containers",children:"kata containers"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"a container runtime sandbox"}),"\n",(0,a.jsx)(n.li,{children:"hypervisor/vm based"}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"gvisor",children:"gVisor"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"from Google"}),"\n",(0,a.jsx)(n.li,{children:"a userspace kernel for containers"}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["looks like this: ",(0,a.jsx)(n.code,{children:"app1 <--\x3e system calls <--\x3e gVisor <--\x3e LIMITED system calls <--\x3e host kernel <--\x3e hardware"})]}),"\n",(0,a.jsx)(n.h2,{id:"create-and-run-runtimeclasses",children:"create and run RuntimeClasses"}),"\n",(0,a.jsx)(n.p,{children:"runsc(gvisor)"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"create runtime class"}),"\n",(0,a.jsx)(n.li,{children:"create a pod to use this class"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"apiVersion: node.k8s.io/v1  # RuntimeClass is defined in the node.k8s.io API group\nkind: RuntimeClass\nmetadata:\n  name: myclass  # The name the RuntimeClass will be referenced by\n  # RuntimeClass is a non-namespaced resource\nhandler: myconfiguration  # The name of the corresponding CRI configuration\n"})}),"\n",(0,a.jsx)(n.p,{children:"edit"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"apiVersion: node.k8s.io/v1\nkind: RuntimeClass\nmetadata:\n  name: gvisor\nhandler: runsc\n"})}),"\n",(0,a.jsxs)(n.p,{children:["create class: ",(0,a.jsx)(n.code,{children:"k create -f ./rc.yaml"})]}),"\n",(0,a.jsx)(n.p,{children:"create and edit a pod to use our new runtime class"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"root@cks-master:~# k run gvisor --image=nginx -oyaml --dry-run=client > gvisor-pod.yaml\nroot@cks-master:~# vim gvisor-pod.yaml\n"})}),"\n",(0,a.jsx)(n.p,{children:"gvisor-pod.yaml:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Pod\nmetadata:\n  creationTimestamp: null\n  labels:\n    run: gvisor\n  name: gvisor\nspec:\n  runtimeClassName: gvisor\n  containers:\n  - image: nginx\n    name: gvisor\n    resources: {}\n  dnsPolicy: ClusterFirst\n  restartPolicy: Always\nstatus: {}\n"})}),"\n",(0,a.jsx)(n.p,{children:"create pod"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'root@cks-master:~# k create -f ./gvisor-pod.yaml\npod/gvisor created\n\n# its stuck\nroot@cks-master:~# k get pod\nNAME     READY   STATUS              RESTARTS   AGE\ngvisor   0/1     ContainerCreating   0          18s\npod      1/1     Running             0          21m\n\n# check event messages with describe\nk describe pod gvisor\nEvents:\n  Type     Reason                  Age                From               Message\n  ----     ------                  ----               ----               -------\n  Normal   Scheduled               69s                default-scheduler  Successfully assigned default/gvisor to cks-worker\n  Warning  FailedCreatePodSandBox  13s (x5 over 68s)  kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = RuntimeHandler "runsc" not supported\n'})}),"\n",(0,a.jsx)(n.p,{children:"runtime is missing. just install it and it will work."}),"\n",(0,a.jsx)(n.p,{children:"from resources, install gvisor script"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# don't do this at home ;)\n# IF THIS FAILS then you can try to change the URL= further down in the script from latest to a specific release\n\nbash <(curl -s https://raw.githubusercontent.com/killer-sh/cks-course-environment/master/course-content/microservice-vulnerabilities/container-runtimes/gvisor/install_gvisor.sh)\n"})}),"\n",(0,a.jsx)(n.h2,{id:"breakout",children:"breakout"}),"\n",(0,a.jsx)(n.h2,{id:"gvisor-kata",children:"gvisor, kata"})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}}}]);