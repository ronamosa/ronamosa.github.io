"use strict";(self.webpackChunkronamosa_github_io=self.webpackChunkronamosa_github_io||[]).push([[58795],{28453:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>t});var o=s(96540);const i={},r=o.createContext(i);function c(e){const n=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),o.createElement(r.Provider,{value:n},e.children)}},74904:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>t,default:()=>h,frontMatter:()=>c,metadata:()=>o,toc:()=>a});const o=JSON.parse('{"id":"archive/2017-06-20-Docker-Jenkins-Pipeline-permission-ISSUES","title":"Troubleshooting Docker issues on a Jenkins Pipeline","description":"I am trying to run a jenkins docker pipeline plugin script on a slave node which creates a docker image and runs some commands inside the container. script runs into problems at this point in the script:","source":"@site/docs/archive/2017-06-20-Docker-Jenkins-Pipeline-permission-ISSUES.md","sourceDirName":"archive","slug":"/archive/2017-06-20-Docker-Jenkins-Pipeline-permission-ISSUES","permalink":"/docs/archive/2017-06-20-Docker-Jenkins-Pipeline-permission-ISSUES","draft":false,"unlisted":false,"editUrl":"https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/archive/2017-06-20-Docker-Jenkins-Pipeline-permission-ISSUES.md","tags":[],"version":"current","lastUpdatedBy":"Ron Amosa","lastUpdatedAt":1771617957000,"frontMatter":{"title":"Troubleshooting Docker issues on a Jenkins Pipeline"},"sidebar":"docsSidebar","previous":{"title":"Troubleshooting Docker Volumes errors","permalink":"/docs/archive/2017-06-09-Docker-volumes-no-such-file-ISSUE"},"next":{"title":"i3wm (Window Manager) + Blocks + Screencasting","permalink":"/docs/archive/2017-07-10-i3wm-Block-Status-Screen"}}');var i=s(74848),r=s(28453);const c={title:"Troubleshooting Docker issues on a Jenkins Pipeline"},t=void 0,l={},a=[{value:"Classic Docker Issue",id:"classic-docker-issue",level:2},{value:"Troubleshooting",id:"troubleshooting",level:3},{value:"check user",id:"check-user",level:4},{value:"check alias",id:"check-alias",level:4},{value:"Solution",id:"solution",level:2},{value:"SELinux to the rescue",id:"selinux-to-the-rescue",level:2}];function d(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"I am trying to run a jenkins docker pipeline plugin script on a slave node which creates a docker image and runs some commands inside the container. script runs into problems at this point in the script:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"docker.image('<image name />').inside {"})}),"\n",(0,i.jsx)(n.h2,{id:"classic-docker-issue",children:"Classic Docker Issue"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"error : Cannot connect to the Docker daemon. Is the docker daemon running on this host?"})}),"\n",(0,i.jsx)(n.p,{children:"ever seen this error when trying to run docker either in your shell or in a Jenkinsfile pipeline job?"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"[build-docker.images-pipeline] Running shell script\n+ docker inspect -f . ruby:2.3.1\n\nCannot connect to the Docker daemon. Is the docker daemon running on this host?\n[Pipeline] sh\n[build-docker.images-pipeline] Running shell script\n+ docker pull ruby:2.3.1\nCannot connect to the Docker daemon. Is the docker daemon running on this host?\n"})}),"\n",(0,i.jsx)(n.h3,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,i.jsx)(n.h4,{id:"check-user",children:"check user"}),"\n",(0,i.jsx)(n.p,{children:'check my "using docker as a non-root user" setup is in place'}),"\n",(0,i.jsx)(n.p,{children:"visudo setup :"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"confirm who the jenkins build slave user is e.g. build-jks"}),"\n",(0,i.jsxs)(n.li,{children:["as root run ",(0,i.jsx)(n.code,{children:"visudo"})]}),"\n",(0,i.jsx)(n.li,{children:"ensure your jenkins build slave user has these 'passwordless' permissions setup"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"## Allow Jenkins user Docker access with no password\nbuild-jks       ALL=(ALL)       NOPASSWD: /usr/bin/docker\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"add 'sudo docker' alias into jenkins user startup file e.g. ~/.bash_profile."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'# Docker alias\nalias docker="sudo /usr/bin/docker"\n'})}),"\n",(0,i.jsx)(n.h4,{id:"check-alias",children:"check alias"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'[build-jks@docker ~]$ /usr/bin/docker ps\nCannot connect to the Docker daemon. Is the docker daemon running on this host?\n\n[build-jks@docker ~]$ docker ps\nCONTAINER ID        IMAGE                      COMMAND                  CREATED             STATUS                          PORTS                    NAMES\nf154ec00624a        composeworkflow_frontend   "redis-commander --re"   2 weeks ago         Up Less than a second           0.0.0.0:8081->8081/tcp   composeworkflow_frontend_\n'})}),"\n",(0,i.jsxs)(n.p,{children:["from this I know my slave-jenkins user has the permissions, and therefore whoever is ",(0,i.jsx)(n.em,{children:"actually"})," running the pipeline code, a) is NOT my slave-jenkins user and b) is a user who doesn't have DOCKER permissions."]}),"\n",(0,i.jsx)(n.p,{children:"possible fix - find who the user is (probably someone from the jenkins master/host) and set that user & UID up on the slave."}),"\n",(0,i.jsx)(n.h2,{id:"solution",children:"Solution"}),"\n",(0,i.jsxs)(n.p,{children:["endless googling and reading various peoples situations finally stumbled across this user @carlossg comment on here: (",(0,i.jsx)(n.a,{href:"https://github.com/jenkinsci/docker/issues/263",children:"https://github.com/jenkinsci/docker/issues/263"}),") where its suggested to do the following:"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"Try chmod 777 /var/run/docker.sock and then reduce permissions as needed"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Good idea!"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"-rw-r--r--. 1 root root 3 Jun 20  2017 /var/run/docker.pid\nsrw-rw----. 1 root root 0 Jun 20  2017 /var/run/docker.sock\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"-rw-r--r--. 1 root root 3 Jun 20  2017 /var/run/docker.pid\nsrwxrwxrwx. 1 root root 0 Jun 20  2017 /var/run/docker.sock\n"})}),"\n",(0,i.jsx)(n.p,{children:"doing this and my jenkins pipeline job error goes away and the docker commands are successfully run."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"[Pipeline] sh\n[build-docker.images-pipeline] Running shell script\n+ docker inspect -f . ruby:2.3.1\n\nError: No such image, container or task: ruby:2.3.1\n[Pipeline] sh\n[build-docker.images-pipeline] Running shell script\n+ docker pull ruby:2.3.1\nTrying to pull repository docker.io/library/ruby ...\n2.3.1: Pulling from docker.io/library/ruby\n386a066cd84a: Pulling fs layer\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"caution",children:(0,i.jsxs)(n.p,{children:["however, as we all know, ",(0,i.jsx)(n.code,{children:"chmod 777"})," is not a good fix security-wise so this still needs to be completed with the best permissions."]})}),"\n",(0,i.jsx)(n.h2,{id:"selinux-to-the-rescue",children:"SELinux to the rescue"}),"\n",(0,i.jsx)(n.p,{children:"but SELinux keeps messing with my chmod?"}),"\n",(0,i.jsx)(n.p,{children:"weird thing cos my setenforce was set to 'permissive' but on reboot of my docker vm (every night) the permissions of /var/run/docker.sock were reverted back. don't know selinux well enough to confirm that's the behaviour, only that chmod didn't stick, so had to look up & figure out selinux ACL's to enfore '777'."}),"\n",(0,i.jsx)(n.p,{children:"this worked for me:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"[root@docker run]# setfacl -m u::rwx,g::rwx,o::rwx docker.sock\n[root@docker run]# getfacl docker.sock\n# file: docker.sock\n# owner: root\n# group: root\nuser::rwx\ngroup::rwx\nother::rwx\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);