"use strict";(self.webpackChunkronamosa_github_io=self.webpackChunkronamosa_github_io||[]).push([[61481],{28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var s=t(96540);const r={},i=s.createContext(r);function o(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(i.Provider,{value:n},e.children)}},98522:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"archive/2017-07-18-RaspberryPi-Kali-Reverse-STunnel","title":"Kali Raspberry Pi Reverse Shell (STunnel)","description":"I have kali on an old Pi2 and was going through my copy of \\"Penetration Testing with Raspberry Pi\\" book from PACKT. Had issues trying to figure this out so went to Google and found Charles Reids notes and managed to make it work from there, but his page also has a very minor error which caused my setup to not work.","source":"@site/docs/archive/2017-07-18-RaspberryPi-Kali-Reverse-STunnel.md","sourceDirName":"archive","slug":"/archive/2017-07-18-RaspberryPi-Kali-Reverse-STunnel","permalink":"/docs/archive/2017-07-18-RaspberryPi-Kali-Reverse-STunnel","draft":false,"unlisted":false,"editUrl":"https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/archive/2017-07-18-RaspberryPi-Kali-Reverse-STunnel.md","tags":[],"version":"current","lastUpdatedBy":"Ron Amosa","lastUpdatedAt":1771617957000,"frontMatter":{"title":"Kali Raspberry Pi Reverse Shell (STunnel)"},"sidebar":"docsSidebar","previous":{"title":"i3wm (Window Manager) + Blocks + Screencasting","permalink":"/docs/archive/2017-07-10-i3wm-Block-Status-Screen"},"next":{"title":"FreeNAS: Using Transmission over OpenVPN (jailed)","permalink":"/docs/archive/2017-08-23-FreeNAS-Torrent-Over_OpenVPN"}}');var r=t(74848),i=t(28453);const o={title:"Kali Raspberry Pi Reverse Shell (STunnel)"},a=void 0,l={},c=[{value:"Working Setup",id:"working-setup",level:2},{value:"Setup Pi",id:"setup-pi",level:3},{value:"Setup Server (i.e. Laptop)",id:"setup-server-ie-laptop",level:3},{value:"STunnel on Boot",id:"stunnel-on-boot",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Notes",id:"notes",level:2},{value:"References",id:"references",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:'I have kali on an old Pi2 and was going through my copy of "Penetration Testing with Raspberry Pi" book from PACKT. Had issues trying to figure this out so went to Google and found Charles Reids notes and managed to make it work from there, but his page also has a very minor error which caused my setup to not work.'}),"\n",(0,r.jsx)(n.h2,{id:"working-setup",children:"Working Setup"}),"\n",(0,r.jsx)(n.h3,{id:"setup-pi",children:"Setup Pi"}),"\n",(0,r.jsx)(n.p,{children:"On Client (RaspberryPi):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Stunnel Config: /etc/stunnel/stunnel.conf\noutput = /var/log/stunnel4/stunnel4.log\ncert = /etc/stunnel/stunnel.pem\nkey = /etc/stunnel/stunnel.pem\nclient = yes\n\n[ssh]\naccept = 443\nconnect = server-ip:443\n"})}),"\n",(0,r.jsx)(n.h3,{id:"setup-server-ie-laptop",children:"Setup Server (i.e. Laptop)"}),"\n",(0,r.jsx)(n.p,{children:"On Server (my Laptop):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Stunnel Config: /etc/stunnel/stunnel.conf\noutput = /var/log/stunnel4/stunnel4.log\ncert = /etc/stunnel/stunnel.pem\nkey = /etc/stunnel/stunnel.pem\nclient = no\n\n[ssh]\naccept = 443\nconnect = 127.0.0.1:443\n"})}),"\n",(0,r.jsx)(n.h3,{id:"stunnel-on-boot",children:"STunnel on Boot"}),"\n",(0,r.jsx)(n.p,{children:"make sure both your kali-pi and command & control client starts /etc/init.d/stunnel4 on boot"}),"\n",(0,r.jsx)(n.p,{children:"systemd things into play"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"systemctl enable reverse-ssh\nreboot (test if it comes back up)\n"})}),"\n",(0,r.jsx)(n.p,{children:"this didn't work for me straight off the bat and i had to 'disable' and copy the systemd-generated 'reverse-ssh.service' file into place:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"cp /run/systemd/generator.late/reverse-ssh.service /etc/systemd/system/\n"})}),"\n",(0,r.jsxs)(n.p,{children:["then edit it to make sure it came up after ",(0,r.jsx)(n.code,{children:"ssh.service"})," was running because i was getting a bunch of these in the logs from bootup attempts on the pi:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-log",children:"Jul 18 10:32:40 kaliwifipi reverse-ssh[142]: Opening reverse shell\nJul 18 10:32:41 kaliwifipi reverse-ssh[142]: ssh: connect to host localhost port 2200: Connection refused\n"})}),"\n",(0,r.jsx)(n.p,{children:"so yea, not playing ball, so did the copy and then edited like so:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ini",children:"# Automatically generated by systemd-sysv-generator\n\n[Unit]\nDocumentation=man:systemd-sysv-generator(8)\nSourcePath=/etc/init.d/reverse-ssh\nDescription=LSB: Start reverse ssh at boot time\nAfter=ssh.service\n\n[Install]\nWantedBy=multi-user.target\n\n[Service]\nType=forking\nRestart=no\nTimeoutSec=5min\nIgnoreSIGPIPE=no\nKillMode=process\nGuessMainPID=no\nRemainAfterExit=yes\nSuccessExitStatus=5 6\nExecStart=/etc/init.d/reverse-ssh start\nExecStop=/etc/init.d/reverse-ssh stop\n"})}),"\n",(0,r.jsx)(n.p,{children:"key things are 'After=ssh.service' and 'WantedBy=multi-user.tartet' - not sure about the latter, but systemctl complained about not having an '[install]' block in the '.service' file so, yea, it comes up as required with this .service file."}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsxs)(n.p,{children:["in my case, Charles original page has the SERVER stunnel.conf file with ",(0,r.jsx)(n.code,{children:"client = yes"})," which, when i tried to ",(0,r.jsx)(n.code,{children:"ssh -p 443 root@localhost"})," on my client (Pi), would fail and give me this error in the SERVER side logs:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-log",children:"SSL_connect: 140770FC: error:140770FC:SSL routines:SSL23_GET_SERVER_HELLO:unknown protocol.\n"})}),"\n",(0,r.jsxs)(n.p,{children:["which from this ",(0,r.jsx)(n.a,{href:"https://stackoverflow.com/questions/43782454/stunnel-ssl23-get-server-hello-error/43815877#43815877",children:"stackoverflow thread"})," explains this error is when the stunnel client tries to connect to an endpoint/server that's NOT SSL/Stunnel... i.e. the 2 ends dont match up protocol wise"]}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"i just realized the stackoverflow ticket response is from Charles himself who answers the issue, but dont think there's any mental link back to his page which the 'client = yes' in the wrong place is the cause of the protocol mismatch"})}),"\n",(0,r.jsx)(n.h2,{id:"notes",children:"Notes"}),"\n",(0,r.jsx)(n.p,{children:"the section for setting up 'stunnel', Chapter 2, page 46, is a bit shit. For example there's no mention of the file 'server.key' anywhere and suddenly it pops up out of nowhere and you're supposed to know what it refers to. This section is pretty messy and not that easy to follow, whereas the page by Charles is pretty clearly laid out. Props to Charles."}),"\n",(0,r.jsx)(n.p,{children:"also, /etc/init.d/stunnel4 & 'systemctl restart/start stunnel4' is shithouse and doesn't actually start anything. i have to literally run 'stunnel4' and the deamon starts. w.t.actual.f."}),"\n",(0,r.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,r.jsx)(n.admonition,{type:"info",children:(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://charlesreid1.com/wiki/RaspberryPi/Reverse_SSH_Stunnel",children:"Charles Reid Stunnel and Reverse Shell Documentation"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.amazon.com/Penetration-Testing-Raspberry-Joseph-Muniz/dp/1784396435",children:"Penetration Testing with Raspberry Pi"})}),"\n"]})})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}}}]);