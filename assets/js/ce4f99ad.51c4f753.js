"use strict";(self.webpackChunkronamosa_github_io=self.webpackChunkronamosa_github_io||[]).push([[8548],{28453:(e,n,i)=>{i.d(n,{R:()=>t,x:()=>l});var o=i(96540);const r={},s=o.createContext(r);function t(e){const n=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),o.createElement(s.Provider,{value:n},e.children)}},39980:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>o,toc:()=>a});const o=JSON.parse('{"id":"engineer/LAB/pihole-compromise","title":"Pihole Checking for Compromise","description":"Recently, DNS lookups for websites when I\'m browsing have been returning \\"unsecured\\" domains I never requested e.g. on bluesky I would click an external link, and hit a \\"privacy error\\" (Chrome), the URL is correct in the address bar, but when I check the cert for the page there\'s a random domain cert there.","source":"@site/docs/engineer/LAB/pihole-compromise.md","sourceDirName":"engineer/LAB","slug":"/engineer/LAB/pihole-compromise","permalink":"/docs/engineer/LAB/pihole-compromise","draft":false,"unlisted":false,"editUrl":"https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/engineer/LAB/pihole-compromise.md","tags":[],"version":"current","lastUpdatedBy":"Ron Amosa","lastUpdatedAt":1758526302000,"frontMatter":{"title":"Pihole Checking for Compromise"},"sidebar":"docsSidebar","previous":{"title":"How to Set Up CursorAI AppImage on GNOME Desktop (Linux)","permalink":"/docs/engineer/LAB/setup-cursorai-appimage-gnome"},"next":{"title":"Fixing SERVFAIL DNS Resolution for AWS Console with Pi-hole + Unbound","permalink":"/docs/engineer/LAB/fixing-pihole-unbound-servfail-aws"}}');var r=i(74848),s=i(28453);const t={title:"Pihole Checking for Compromise"},l=void 0,c={},a=[{value:"\ud83d\udd0d 1. <strong>Inspect Container Behavior</strong>",id:"-1-inspect-container-behavior",level:2},{value:"\u2705 <em>Check for unexpected changes in the container</em>",id:"-check-for-unexpected-changes-in-the-container",level:3},{value:"\u2705 <em>Audit running processes inside the container</em>",id:"-audit-running-processes-inside-the-container",level:3},{value:"\u2705 <em>Check for modified binaries or injected scripts</em>",id:"-check-for-modified-binaries-or-injected-scripts",level:3},{value:"\ud83d\udd75\ufe0f\u200d\u2642\ufe0f 2. <strong>Network &amp; DNS Traffic Auditing</strong>",id:"\ufe0f\ufe0f-2-network--dns-traffic-auditing",level:2},{value:"\u2705 <em>Check Pi-hole query logs for anomalies</em>",id:"-check-pi-hole-query-logs-for-anomalies",level:3},{value:"\u2705 <em>Review Unbound logs (if logging enabled)</em>",id:"-review-unbound-logs-if-logging-enabled",level:3},{value:"\ud83d\udd10 3. <strong>File System &amp; Image Integrity</strong>",id:"-3-file-system--image-integrity",level:2},{value:"\u2705 <em>Check for modified files inside the container</em>",id:"-check-for-modified-files-inside-the-container",level:3},{value:"\u2705 <em>Check image hash integrity</em>",id:"-check-image-hash-integrity",level:3},{value:"\ud83e\uddf1 4. <strong>Host-Level Monitoring</strong>",id:"-4-host-level-monitoring",level:2},{value:"\u2705 <em>Check for suspicious outbound traffic on host</em>",id:"-check-for-suspicious-outbound-traffic-on-host",level:3},{value:"\u2705 <em>Run a rootkit or malware scanner on host</em>",id:"-run-a-rootkit-or-malware-scanner-on-host",level:3},{value:"\ud83d\udce6 5. <strong>Container Security Best Practices</strong>",id:"-5-container-security-best-practices",level:2},{value:"\ud83e\uddea Optional: Threat Hunting with Falco or Wazuh",id:"-optional-threat-hunting-with-falco-or-wazuh",level:2},{value:"\ud83d\udccc Final Tips",id:"-final-tips",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.admonition,{title:"Compromise?",type:"danger",children:(0,r.jsx)(n.p,{children:'Recently, DNS lookups for websites when I\'m browsing have been returning "unsecured" domains I never requested e.g. on bluesky I would click an external link, and hit a "privacy error" (Chrome), the URL is correct in the address bar, but when I check the cert for the page there\'s a random domain cert there.'})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"-1-inspect-container-behavior",children:["\ud83d\udd0d 1. ",(0,r.jsx)(n.strong,{children:"Inspect Container Behavior"})]}),"\n",(0,r.jsxs)(n.h3,{id:"-check-for-unexpected-changes-in-the-container",children:["\u2705 ",(0,r.jsx)(n.em,{children:"Check for unexpected changes in the container"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"docker ps -a\ndocker inspect <pihole_container_id />\n"})}),"\n",(0,r.jsx)(n.p,{children:"Look for:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"New volumes or mounts not configured by you"}),"\n",(0,r.jsx)(n.li,{children:"Exposed ports that you didn\u2019t set"}),"\n",(0,r.jsx)(n.li,{children:"Unexpected environment variables"}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"-audit-running-processes-inside-the-container",children:["\u2705 ",(0,r.jsx)(n.em,{children:"Audit running processes inside the container"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"docker exec -it <pihole_container /> ps aux\n"})}),"\n",(0,r.jsx)(n.p,{children:"Look for unexpected or non-Pi-hole processes like reverse shells, cryptominers, or Python scripts."}),"\n",(0,r.jsxs)(n.h3,{id:"-check-for-modified-binaries-or-injected-scripts",children:["\u2705 ",(0,r.jsx)(n.em,{children:"Check for modified binaries or injected scripts"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'docker exec -it <pihole_container /> find / -type f -name "*.sh" -o -name "*.py" -exec ls -l {} \\;\n'})}),"\n",(0,r.jsx)(n.p,{children:"Scan for recently modified or unusual files."}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"\ufe0f\ufe0f-2-network--dns-traffic-auditing",children:["\ud83d\udd75\ufe0f\u200d\u2642\ufe0f 2. ",(0,r.jsx)(n.strong,{children:"Network & DNS Traffic Auditing"})]}),"\n",(0,r.jsxs)(n.h3,{id:"-check-pi-hole-query-logs-for-anomalies",children:["\u2705 ",(0,r.jsx)(n.em,{children:"Check Pi-hole query logs for anomalies"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"docker exec -it <pihole_container /> cat /var/log/pihole.log | less\n"})}),"\n",(0,r.jsx)(n.p,{children:"Look for:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"High-frequency queries to unknown domains"}),"\n",(0,r.jsx)(n.li,{children:"Outbound domains that aren\u2019t related to your known network activity"}),"\n",(0,r.jsxs)(n.li,{children:["Sudden requests to TLDs like ",(0,r.jsx)(n.code,{children:".onion"}),", ",(0,r.jsx)(n.code,{children:".xyz"}),", ",(0,r.jsx)(n.code,{children:".top"}),", etc."]}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"-review-unbound-logs-if-logging-enabled",children:["\u2705 ",(0,r.jsx)(n.em,{children:"Review Unbound logs (if logging enabled)"})]}),"\n",(0,r.jsxs)(n.p,{children:["Unbound logging is usually minimal by default. Add verbose logging to ",(0,r.jsx)(n.code,{children:"unbound.conf"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:'logfile: "/var/log/unbound/unbound.log"\nverbosity: 3\n'})}),"\n",(0,r.jsx)(n.p,{children:"Then tail the logs:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"docker exec -it <unbound_container /> tail -f /var/log/unbound/unbound.log\n"})}),"\n",(0,r.jsx)(n.p,{children:"Look for:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Excessive or repeated lookups to obscure domains"}),"\n",(0,r.jsx)(n.li,{children:"High failure rates or DNS poisoning patterns"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"-3-file-system--image-integrity",children:["\ud83d\udd10 3. ",(0,r.jsx)(n.strong,{children:"File System & Image Integrity"})]}),"\n",(0,r.jsxs)(n.h3,{id:"-check-for-modified-files-inside-the-container",children:["\u2705 ",(0,r.jsx)(n.em,{children:"Check for modified files inside the container"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"docker diff <pihole_container />\n"})}),"\n",(0,r.jsx)(n.p,{children:"Shows which files were added/modified/deleted compared to the original image."}),"\n",(0,r.jsxs)(n.h3,{id:"-check-image-hash-integrity",children:["\u2705 ",(0,r.jsx)(n.em,{children:"Check image hash integrity"})]}),"\n",(0,r.jsx)(n.p,{children:"Compare the current container image ID against the known trusted version."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"docker images | grep pihole\n"})}),"\n",(0,r.jsx)(n.p,{children:"Then cross-reference with the official Docker Hub repo or trusted mirror."}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"-4-host-level-monitoring",children:["\ud83e\uddf1 4. ",(0,r.jsx)(n.strong,{children:"Host-Level Monitoring"})]}),"\n",(0,r.jsxs)(n.h3,{id:"-check-for-suspicious-outbound-traffic-on-host",children:["\u2705 ",(0,r.jsx)(n.em,{children:"Check for suspicious outbound traffic on host"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo lsof -i -nP | grep ESTABLISHED\nsudo netstat -tulnp\n"})}),"\n",(0,r.jsx)(n.p,{children:"Look for:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Unexpected IP destinations"}),"\n",(0,r.jsx)(n.li,{children:"Connections from the Pi-hole container going outbound (especially non-DNS ports)"}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"-run-a-rootkit-or-malware-scanner-on-host",children:["\u2705 ",(0,r.jsx)(n.em,{children:"Run a rootkit or malware scanner on host"})]}),"\n",(0,r.jsx)(n.p,{children:"Use tools like:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"chkrootkit"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"rkhunter"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"clamav"})," (can scan for known malware signatures)"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"-5-container-security-best-practices",children:["\ud83d\udce6 5. ",(0,r.jsx)(n.strong,{children:"Container Security Best Practices"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Ensure you're using ",(0,r.jsx)(n.strong,{children:"read-only volumes"})," where possible"]}),"\n",(0,r.jsxs)(n.li,{children:["Use ",(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"--read-only"})})," flag on container if you don\u2019t need writes"]}),"\n",(0,r.jsxs)(n.li,{children:["Use a ",(0,r.jsx)(n.strong,{children:"non-root user"})," inside the container if Pi-hole supports it"]}),"\n",(0,r.jsxs)(n.li,{children:["Set up ",(0,r.jsx)(n.strong,{children:"AppArmor/SELinux"})," profiles for container restrictions"]}),"\n",(0,r.jsx)(n.li,{children:"If you use Docker Compose, pin to known image hashes:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"image: pihole/pihole@sha256:abc123...\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-optional-threat-hunting-with-falco-or-wazuh",children:"\ud83e\uddea Optional: Threat Hunting with Falco or Wazuh"}),"\n",(0,r.jsx)(n.p,{children:"Install runtime security tools on the host:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.a,{href:"https://falco.org/",children:"Falco"})}),": Monitors container behavior and alerts on anomalies (e.g., shell inside container)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Wazuh"}),": Full SIEM agent capable of monitoring Docker activity + file integrity"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-final-tips",children:"\ud83d\udccc Final Tips"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Regularly update both Pi-hole and Unbound images"}),"\n",(0,r.jsx)(n.li,{children:"Isolate the container in a dedicated Docker network with restricted egress"}),"\n",(0,r.jsx)(n.li,{children:"Avoid exposing your admin interface externally, or use VPN/bastion access"}),"\n",(0,r.jsxs)(n.li,{children:["Enable Pi-hole audit logs: ",(0,r.jsx)(n.code,{children:"auditlog.list"})," is useful to track manually allowed/blocked domains"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.admonition,{title:"Disclaimer",type:"caution",children:(0,r.jsx)(n.p,{children:"This documentation was AI-assisted i.e. generated by AI, checked, tested working and updated by me."})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);