"use strict";(self.webpackChunkronamosa_github_io=self.webpackChunkronamosa_github_io||[]).push([[2511],{15833:(e,o,r)=>{r.r(o),r.d(o,{assets:()=>d,contentTitle:()=>a,default:()=>m,frontMatter:()=>s,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"engineer/LAB/proxmox-lvm-mount","title":"Mount Proxmox VM Logical Volumes for Direct Filesystem Access","description":"Technical guide to mount and access Proxmox virtual machine logical volumes from the host system for troubleshooting, recovery, and filesystem modifications.","source":"@site/docs/engineer/LAB/proxmox-lvm-mount.md","sourceDirName":"engineer/LAB","slug":"/engineer/LAB/proxmox-lvm-mount","permalink":"/docs/engineer/LAB/proxmox-lvm-mount","draft":false,"unlisted":false,"editUrl":"https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/engineer/LAB/proxmox-lvm-mount.md","tags":[{"inline":true,"label":"proxmox","permalink":"/docs/tags/proxmox"},{"inline":true,"label":"lvm","permalink":"/docs/tags/lvm"},{"inline":true,"label":"troubleshooting","permalink":"/docs/tags/troubleshooting"},{"inline":true,"label":"virtualization","permalink":"/docs/tags/virtualization"},{"inline":true,"label":"system-admin","permalink":"/docs/tags/system-admin"}],"version":"current","lastUpdatedBy":"Ron Amosa","lastUpdatedAt":1758526302000,"sidebarPosition":4,"frontMatter":{"title":"Mount Proxmox VM Logical Volumes for Direct Filesystem Access","description":"Technical guide to mount and access Proxmox virtual machine logical volumes from the host system for troubleshooting, recovery, and filesystem modifications.","keywords":["proxmox","lvm","logical volume","vm mount","filesystem access","vm recovery","proxmox troubleshooting","vm disk access"],"tags":["proxmox","lvm","troubleshooting","virtualization","system-admin"],"sidebar_position":4},"sidebar":"docsSidebar","previous":{"title":"Ultimate Linux Terminal Setup - Oh My Zsh, Powerlevel10k, and Productivity Tools","permalink":"/docs/engineer/LAB/Terminal"},"next":{"title":"Pi-hole with Unbound DNS: Complete Docker Setup for Privacy & Ad-Blocking","permalink":"/docs/engineer/LAB/pihole-docker-unbound"}}');var t=r(74848),i=r(28453);const s={title:"Mount Proxmox VM Logical Volumes for Direct Filesystem Access",description:"Technical guide to mount and access Proxmox virtual machine logical volumes from the host system for troubleshooting, recovery, and filesystem modifications.",keywords:["proxmox","lvm","logical volume","vm mount","filesystem access","vm recovery","proxmox troubleshooting","vm disk access"],tags:["proxmox","lvm","troubleshooting","virtualization","system-admin"],sidebar_position:4},a=void 0,d={},l=[{value:"Background",id:"background",level:2},{value:"Related Proxmox Troubleshooting &amp; Automation",id:"related-proxmox-troubleshooting--automation",level:2},{value:"Overview",id:"overview",level:2},{value:"LVM",id:"lvm",level:2},{value:"vgchange",id:"vgchange",level:3},{value:"Device Mappings",id:"device-mappings",level:2},{value:"kpartx",id:"kpartx",level:3},{value:"Mount Device",id:"mount-device",level:2},{value:"References",id:"references",level:2},{value:"delete device mappings",id:"delete-device-mappings",level:3},{value:"qemu commands",id:"qemu-commands",level:3}];function c(e){const o={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(o.h2,{id:"background",children:"Background"}),"\n",(0,t.jsxs)(o.p,{children:["I created an Ubuntu VM using Packer, which was supposed to bootstrap my username & ssh_key access when the VM was running but instead the packer build process would time out and rollback destroying the VM and any logs I needed to troubleshoot what was happening. I managed to clone the VM before it was destroyed again, but there was no root account and I could see my username had made it into the ",(0,t.jsx)(o.code,{children:"/etc/passwd"})," file by using ",(0,t.jsx)(o.code,{children:"qm guest exec <vmid /> cat /etc/passwd"})," from the proxmox host. I couldn't use the ",(0,t.jsx)(o.code,{children:"qm"})," command to try to set a password for my user, so I decided to go old school and mount the VM disk (volume) and edit things from there."]}),"\n",(0,t.jsx)(o.h2,{id:"related-proxmox-troubleshooting--automation",children:"Related Proxmox Troubleshooting & Automation"}),"\n",(0,t.jsxs)(o.p,{children:["\ud83d\udd27 ",(0,t.jsx)(o.strong,{children:"Proxmox Troubleshooting Context"}),": This advanced technique complements the automation workflow:"]}),"\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.strong,{children:"Root Cause"}),": ",(0,t.jsx)(o.a,{href:"./proxmox-packer-vm",children:"Packer VM Template Creation"})," - The original Packer process that led to this troubleshooting"]}),"\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.strong,{children:"Prevention"}),": ",(0,t.jsx)(o.a,{href:"./proxmox-cloudinit",children:"Ansible VM Automation"})," - Automated deployment to avoid manual VM issues"]}),"\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.strong,{children:"Complete Workflow"}),": ",(0,t.jsx)(o.a,{href:"./proxmox-hub",children:"Proxmox Virtualization Hub"})," - End-to-end Proxmox automation and management"]}),"\n"]}),"\n",(0,t.jsxs)(o.p,{children:["\ud83c\udfd7\ufe0f ",(0,t.jsx)(o.strong,{children:"Advanced Infrastructure Skills"}),": Build comprehensive troubleshooting capabilities:"]}),"\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.strong,{children:"Container Debugging"}),": ",(0,t.jsx)(o.a,{href:"/docs/engineer/K8s/",children:"Kubernetes Troubleshooting"})," - Similar debugging techniques for containers"]}),"\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.strong,{children:"Home Lab Context"}),": ",(0,t.jsx)(o.a,{href:"./home-lab-hub",children:"Home Lab Infrastructure Hub"})," - Complete infrastructure troubleshooting strategies"]}),"\n"]}),"\n",(0,t.jsx)(o.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(o.p,{children:'We\'re dealing with a LVM volumes on a Proxmox host, so this is the process of finding the necessary information, installing the right tools and getting to the point of mounting the voluming, editing the filesystem, unmounting and booting the VM up again with the "fixed" volume attached.'}),"\n",(0,t.jsx)(o.h2,{id:"lvm",children:"LVM"}),"\n",(0,t.jsxs)(o.p,{children:["Check out your logical volumes, in volume group (VG) ",(0,t.jsx)(o.code,{children:"pve"}),":"]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-bash",children:"root@pve1:~# lvs\n  LV            VG  Attr       LSize    Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  data          pve twi-aotz-- <794.79g             3.17   0.32\n  root          pve -wi-ao----   96.00g\n  swap          pve -wi-ao----    8.00g\n  vm-101-disk-0 pve Vwi-a-tz--   20.00g data        100.00\n  vm-200-disk-0 pve Vwi-aotz--   32.00g data        16.17\n"})}),"\n",(0,t.jsxs)(o.p,{children:["use ",(0,t.jsx)(o.code,{children:"lvdisplay"})," for more detailed info on each volume."]}),"\n",(0,t.jsx)(o.h3,{id:"vgchange",children:"vgchange"}),"\n",(0,t.jsx)(o.p,{children:"I'm not 100% sure you need this step, but it's one I did."}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-bash",children:"root@pve1:~# vgchange --help\n  vgchange - Change volume group attributes\n\n  Change a general VG attribute.\n  For options listed in parentheses, any one is\n  required, after which the others are optional.\n  vgchange\n"})}),"\n",(0,t.jsx)(o.p,{children:'"activate" your volumes:'}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-bash",children:'root@pve1:~# vgchange -ay pve\n  5 logical volume(s) in volume group "pve" now active\n'})}),"\n",(0,t.jsx)(o.h2,{id:"device-mappings",children:"Device Mappings"}),"\n",(0,t.jsxs)(o.p,{children:["You need to create device mappings from the segments of the LV you want to mount, for this we'll use ",(0,t.jsx)(o.code,{children:"kpartx"})]}),"\n",(0,t.jsx)(o.h3,{id:"kpartx",children:"kpartx"}),"\n",(0,t.jsxs)(o.p,{children:["install ",(0,t.jsx)(o.code,{children:"kpartx"})," with ",(0,t.jsx)(o.code,{children:"apt install -y kpartx"})," from the proxmox host (up to you if you want to ",(0,t.jsx)(o.code,{children:"-y"})," that)."]}),"\n",(0,t.jsxs)(o.admonition,{title:"man kpartx",type:"info",children:[(0,t.jsx)(o.p,{children:"kpartx - Create device maps from partition tables"}),(0,t.jsx)(o.p,{children:"This  tool, derived from util-linux' partx, reads partition tables on specified device and create device maps over partitions segments detected. It  is  called  from  hotplug  upon device maps creation and deletion."})]}),"\n",(0,t.jsxs)(o.p,{children:["I can see the currently mapped devices under ",(0,t.jsx)(o.code,{children:"/dev/mapper"}),", and I want my ",(0,t.jsx)(o.code,{children:"vmid=101"})," disks:"]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-bash",children:"root@pve1:~# ls -l /dev/mapper/\ntotal 0\ncrw------- 1 root root 10, 236 Apr 21 23:08 control\nlrwxrwxrwx 1 root root       7 Apr 21 23:08 pve-data -> ../dm-5\nlrwxrwxrwx 1 root root       7 Apr 21 23:08 pve-data_tdata -> ../dm-3\nlrwxrwxrwx 1 root root       7 Apr 21 23:08 pve-data_tmeta -> ../dm-2\nlrwxrwxrwx 1 root root       7 Apr 21 23:08 pve-data-tpool -> ../dm-4\nlrwxrwxrwx 1 root root       7 Apr 21 23:08 pve-root -> ../dm-1\nlrwxrwxrwx 1 root root       7 Apr 21 23:08 pve-swap -> ../dm-0\nlrwxrwxrwx 1 root root       7 Apr 27 22:20 pve-vm--101--disk--0 -> ../dm-8\nlrwxrwxrwx 1 root root       7 Apr 26 22:21 pve-vm--200--disk--0 -> ../dm-6\n"})}),"\n",(0,t.jsxs)(o.p,{children:["use ",(0,t.jsx)(o.code,{children:"kpartx"}),' to "add mappings" (',(0,t.jsx)(o.code,{children:"-av"}),", add, verbose) from that LV:"]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-bash",children:"root@pve1:~# kpartx -av /dev/mapper/pve-vm--101--disk--0\nadd map pve-vm--101--disk--0p1 (253:7): 0 2048 linear 253:8 2048\nadd map pve-vm--101--disk--0p2 (253:9): 0 41936896 linear 253:8 4096\n"})}),"\n",(0,t.jsx)(o.h2,{id:"mount-device",children:"Mount Device"}),"\n",(0,t.jsxs)(o.p,{children:["Make a dir under ",(0,t.jsx)(o.code,{children:"/mnt"}),", mount your newly mapped device, and check the mounted dir"]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-bash",children:"root@pve1:/mnt# mkdir vm\nroot@pve1:/mnt# mount /dev/mapper/pve-vm--101--disk--0p2 /mnt/vm\nroot@pve1:/mnt# ls -l /mnt/vm\ntotal 4030552\nlrwxrwxrwx  1 root root          7 Aug 24  2021 bin -> usr/bin\ndrwxr-xr-x  3 root root       4096 Apr 27 09:39 boot\ndrwxr-xr-x  2 root root       4096 Apr 27 09:18 cdrom\ndrwxr-xr-x  5 root root       4096 Aug 24  2021 dev\ndrwxr-xr-x 97 root root       4096 Apr 27 09:41 etc\ndrwxr-xr-x  3 root root       4096 Apr 27 09:41 home\nlrwxrwxrwx  1 root root          7 Aug 24  2021 lib -> usr/lib\nlrwxrwxrwx  1 root root          9 Aug 24  2021 lib32 -> usr/lib32\nlrwxrwxrwx  1 root root          9 Aug 24  2021 lib64 -> usr/lib64\nlrwxrwxrwx  1 root root         10 Aug 24  2021 libx32 -> usr/libx32\ndrwx------  2 root root      16384 Apr 27 09:18 lost+found\ndrwxr-xr-x  2 root root       4096 Aug 24  2021 media\ndrwxr-xr-x  2 root root       4096 Aug 24  2021 mnt\ndrwxr-xr-x  2 root root       4096 Aug 24  2021 opt\ndrwxr-xr-x  2 root root       4096 Apr 15  2020 proc\ndrwx------  5 root root       4096 Apr 27 22:13 root\ndrwxr-xr-x 11 root root       4096 Aug 24  2021 run\nlrwxrwxrwx  1 root root          8 Aug 24  2021 sbin -> usr/sbin\ndrwxr-xr-x  7 root root       4096 Apr 27 13:45 snap\ndrwxr-xr-x  2 root root       4096 Aug 24  2021 srv\n-rw-------  1 root root 4127195136 Apr 27 09:19 swap.img\ndrwxr-xr-x  2 root root       4096 Apr 15  2020 sys\ndrwxrwxrwt  8 root root       4096 Apr 27 22:20 tmp\ndrwxr-xr-x 14 root root       4096 Apr 27 09:38 usr\ndrwxr-xr-x 13 root root       4096 Aug 24  2021 var\nroot@pve1:/mnt#\n"})}),"\n",(0,t.jsxs)(o.p,{children:["You can now make the changes you need to the filesystem, save, unmount and try rebooting the vm again with the edited volume. For me, I just needed to see what happed to the ",(0,t.jsx)(o.code,{children:"sshd"})," config under ",(0,t.jsx)(o.code,{children:"/etc/ssh/sshd_config"})," because Packer ",(0,t.jsx)(o.code,{children:"autoinstall"})," was supposed to have set it to accept PubKey AuthN, instead I found this -> ",(0,t.jsx)(o.code,{children:"#PubkeyAuthentication yes"}),"."]}),"\n",(0,t.jsx)(o.p,{children:"Back to the Packer configs to see what went wrong. Enjoy."}),"\n",(0,t.jsx)(o.h2,{id:"references",children:"References"}),"\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsx)(o.li,{children:(0,t.jsx)(o.a,{href:"https://forum.proxmox.com/threads/how-to-mount-lvm-disk-of-vm.25218/",children:"Proxmox Forum"})}),"\n"]}),"\n",(0,t.jsx)(o.h3,{id:"delete-device-mappings",children:"delete device mappings"}),"\n",(0,t.jsxs)(o.p,{children:["to reverse the kpartx mappings: ",(0,t.jsx)(o.code,{children:"root@pve1:~# kpartx -av /dev/mapper/pve-vm--101--disk--0"})]}),"\n",(0,t.jsx)(o.h3,{id:"qemu-commands",children:"qemu commands"}),"\n",(0,t.jsxs)(o.p,{children:["some useful ",(0,t.jsx)(o.code,{children:"qm"})," commands:"]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-bash",children:"qm guest exec <vmid /> <command />\n# more to come\n"})})]})}function m(e={}){const{wrapper:o}={...(0,i.R)(),...e.components};return o?(0,t.jsx)(o,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},28453:(e,o,r)=>{r.d(o,{R:()=>s,x:()=>a});var n=r(96540);const t={},i=n.createContext(t);function s(e){const o=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(o):{...o,...e}}),[o,e])}function a(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),n.createElement(i.Provider,{value:o},e.children)}}}]);