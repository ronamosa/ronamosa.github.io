"use strict";(self.webpackChunkronamosa_github_io=self.webpackChunkronamosa_github_io||[]).push([[35478],{28453:(e,n,i)=>{i.d(n,{R:()=>r,x:()=>l});var t=i(96540);const o={},s=t.createContext(o);function r(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),t.createElement(s.Provider,{value:n},e.children)}},63926:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>a});const t=JSON.parse('{"id":"archive/2018-04-13-Docker-Remote-Work-Fortinet","title":"Docker: Fortinet VPN in a container for remote work","description":"I needed a really simple enclosed and fully functional work environment that wasn\'t on my work laptop so I could do work on another station, without having to mess that environment up with work stuff.","source":"@site/docs/archive/2018-04-13-Docker-Remote-Work-Fortinet.md","sourceDirName":"archive","slug":"/archive/2018-04-13-Docker-Remote-Work-Fortinet","permalink":"/docs/archive/2018-04-13-Docker-Remote-Work-Fortinet","draft":false,"unlisted":false,"editUrl":"https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/archive/2018-04-13-Docker-Remote-Work-Fortinet.md","tags":[],"version":"current","lastUpdatedBy":"Ron Amosa","lastUpdatedAt":1771617957000,"frontMatter":{"title":"Docker: Fortinet VPN in a container for remote work"},"sidebar":"docsSidebar","previous":{"title":"Quick Note - Install Ubuntu 16.04 via bootable USB","permalink":"/docs/archive/2017-10-22-Ubuntu-Desktop-USB-Thinkpad13"},"next":{"title":"Cisco WAP200 Firmware Upgrade","permalink":"/docs/archive/2018-04-21-Cisco-WAP200-Firmware-Upgrade"}}');var o=i(74848),s=i(28453);const r={title:"Docker: Fortinet VPN in a container for remote work"},l=void 0,c={},a=[{value:"Pre-Requisites",id:"pre-requisites",level:2},{value:"Objectives",id:"objectives",level:2},{value:"Dockerfile",id:"dockerfile",level:2},{value:"Setting up the forticlient SSL VPN",id:"setting-up-the-forticlient-ssl-vpn",level:2},{value:"Remove Section from &#39;setup.linux.sh&#39;",id:"remove-section-from-setuplinuxsh",level:3},{value:"Forticlient Expect Script",id:"forticlient-expect-script",level:3},{value:"Build Work VPN Container Image",id:"build-work-vpn-container-image",level:2},{value:"Run it",id:"run-it",level:2},{value:"Example of output success",id:"example-of-output-success",level:2},{value:"References",id:"references",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.p,{children:"I needed a really simple enclosed and fully functional work environment that wasn't on my work laptop so I could do work on another station, without having to mess that environment up with work stuff."}),"\n",(0,o.jsx)(n.p,{children:"So Docker was of course the logical choice."}),"\n",(0,o.jsx)(n.h2,{id:"pre-requisites",children:"Pre-Requisites"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Docker installed"}),"\n",(0,o.jsx)(n.li,{children:"your work ssh-keys"}),"\n",(0,o.jsx)(n.li,{children:"your office AD login details"}),"\n",(0,o.jsx)(n.li,{children:"copy of Fortinet Linux ssl cli client (see below for link) packed in a .xz file"}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"objectives",children:"Objectives"}),"\n",(0,o.jsx)(n.p,{children:"what did I want my work container to do?"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"fire up and connect the work Fortinet VPN client with no user input."}),"\n",(0,o.jsx)(n.li,{children:"have my authorised ssh-keys set up for all work environments I needed to be able to access"}),"\n",(0,o.jsx)(n.li,{children:"have my bash alises loaded (cos I like convenience)"}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"dockerfile",children:"Dockerfile"}),"\n",(0,o.jsx)(n.p,{children:"I'm going to go through each block and try and explain what's happening. I'll have a link at the end with all the files in full so you can skip to that to see everything in its' entirety."}),"\n",(0,o.jsx)(n.p,{children:"So, what's it doing?"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"sets up base image and installs desired packages (add as needed)."}),"\n",(0,o.jsx)(n.li,{children:"install PPP & PPTP packages are a must for VPN to work."}),"\n",(0,o.jsx)(n.li,{children:"sets up 'utmp' and 'root' user, sets password"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-docker",children:'FROM centos:7\n\nRUN \\\n  yum -y update && yum -y install epel-release && \\\n  yum -y install openssl openssh-clients openssh-server && \\\n  yum -y install bind-utils net-utils ppp pptp curl wget git which less \\\n  vim expect ansible python-pip bash-completion net-tools zip unzip && \\\n  yum -y clean all && \\\n  touch /run/utmp && \\\n  echo "root:root" | chpasswd\n'})}),"\n",(0,o.jsx)(n.p,{children:"Next"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"it creates a (work) user"}),"\n",(0,o.jsx)(n.li,{children:"creates our .ssh directory and"}),"\n",(0,o.jsx)(n.li,{children:"sets the user's passwd (loginid = your AD login at the office)"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-docker",children:'RUN \\\n  useradd loginid && \\\n  mkdir ~loginid/.ssh && \\\n  echo "loginid:loginid" | chpasswd\n'})}),"\n",(0,o.jsx)(n.p,{children:"Next it's adding our vpn client package, and copying the vpn runtime script."}),"\n",(0,o.jsx)(n.p,{children:"When you add this (or any package for that matter of this type) .xz file, Docker will automagically unpack the contents in your destination directory (in this case /usr/local/bin):"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-docker",children:'ADD ["bin/forticlientsslvpn.xz", "/usr/local/bin"]\nCOPY ["bin/forticlientvpn.sh", "/usr/bin"]\n'})}),"\n",(0,o.jsx)(n.p,{children:"Then, copy ALL my keys and my ssh config file to $HOME/.ssh:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-docker",children:'COPY ["keys", "/home/loginid/.ssh"]\nCOPY ["conf/ssh.config", "/home/loginid/.ssh/config"]\n'})}),"\n",(0,o.jsx)(n.p,{children:"Also copy my bash aliases to ~/.alias, and add a line to my ~/.bashrc so that it automagically sources my aliases everytime I login"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-docker",children:'COPY ["conf/bash_aliases", "/home/loginid/.alias"]\nRUN echo " . ~/.alias " >> /home/loginid/.bashrc\n'})}),"\n",(0,o.jsx)(n.p,{children:"set the right owners and permissions or my keys wont work"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-docker",children:"RUN chown -R loginid:loginid /home/loginid/.ssh\nRUN chmod -R 600 /home/loginid/.ssh/*\nRUN chown loginid:loginid /home/loginid/.alias\n"})}),"\n",(0,o.jsx)(n.p,{children:"Next, this script is needed by forticlient to inialise and accept the license:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-docker",children:"RUN /usr/local/bin/forticlientsslvpn/64bit/helper/setup.linux.sh\n"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"copy our entrypoint.sh (see further down for setting this script up)"}),"\n",(0,o.jsx)(n.li,{children:"and chmod 755 entrypoint and forticlientvpn** scripts:"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-docker",children:'COPY ["entrypoint.sh", "/"]\nRUN chmod 755 /entrypoint.sh\nRUN chmod 755 /usr/bin/forticlientvpn.sh\n'})}),"\n",(0,o.jsx)(n.p,{children:"That's it."}),"\n",(0,o.jsx)(n.p,{children:"Next, we have to prep the forticlient setup so that it doesn't have to wait for us to input anything and it just goes ahead and"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"installs without us needing to accept the license"}),"\n",(0,o.jsx)(n.li,{children:"runs without us needing to type 'Y' to start the VPN tunnel"}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"setting-up-the-forticlient-ssl-vpn",children:"Setting up the forticlient SSL VPN"}),"\n",(0,o.jsx)(n.p,{children:"When you first download the forticlient package on Linux and run it, you'll get an error saying you need to run the following script:"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"/usr/local/bin/forticlientsslvpn/64bit/helper/setup.linux.sh"})}),"\n",(0,o.jsx)(n.p,{children:"and this will show you the license you have to scroll through and accept the license."}),"\n",(0,o.jsx)(n.p,{children:"This is a problem if you just want the container to fire up, set itself up and run without any user input. So we need to remove this section of the script before we can run the container successfully"}),"\n",(0,o.jsx)(n.h3,{id:"remove-section-from-setuplinuxsh",children:"Remove Section from 'setup.linux.sh'"}),"\n",(0,o.jsx)(n.p,{children:"This section is the one where you need to scroll through the 'more' output to the bottom, and say 'yes' or whatever to get it to go to the next step. We don't want to do this, we want things to work automagically."}),"\n",(0,o.jsx)(n.p,{children:"So, remove this section from the script:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'if [ "$1" != "2" ]; then\n        echo "begin setup at $base..." >> "$inlog"\n        more "$base/License.txt"\n        echo -n "Do you agree with this license ?[Yes/No]"\n        read ans\n        yn=`echo $ans|sed \'\n        s/y/Y/\n        s/e/E/\n        s/s/S/\n        \'`\n        if [ "$yn" != "YES" -a "$yn" != "Y" ]; then\n                touch "$base/.nolicense"\n                chmod a+w "$base/.nolicense"\n                echo "Do not agree with this license, aborting..."\n                exit 0\n        fi\nfi\n'})}),"\n",(0,o.jsx)(n.p,{children:"Just delete everything in this 'if' statement. Save your file. It's done."}),"\n",(0,o.jsx)(n.h3,{id:"forticlient-expect-script",children:"Forticlient Expect Script"}),"\n",(0,o.jsx)(n.p,{children:"For the 2nd part, every time you fire up forticlient vpn it asks you if you want to start the VPN tunnel. Yes. Yes you do. and No, no you don't want to have to type 'Y' every time."}),"\n",(0,o.jsxs)(n.p,{children:["So, we want our entrypoint for the container to be an 'expect' bash script that answers that question for us. Big thanks and full credit for script goes to ",(0,o.jsx)(n.a,{href:"https://gist.github.com/mgeeky/8afc0e32b8b97fd6f96fce6098615a93",children:"mgeeky/github.com"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"Just include your own VPN details and save this as 'entrypoint.sh'"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'#!/usr/bin/env bash\nFORTICLIENT_PATH="/usr/local/bin/forticlientsslvpn/64bit/forticlientsslvpn_cli"\nVPN_HOST="host:port"\nVPN_USER=""\nVPN_PASS=""\n'})}),"\n",(0,o.jsx)(n.p,{children:"Right, time to build our image."}),"\n",(0,o.jsx)(n.h2,{id:"build-work-vpn-container-image",children:"Build Work VPN Container Image"}),"\n",(0,o.jsx)(n.p,{children:"(make sure you're in the same folder as your Dockerfile file)"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"docker build --rm -t companyname/vpn:centos7 .\n"})}),"\n",(0,o.jsx)(n.h2,{id:"run-it",children:"Run it"}),"\n",(0,o.jsx)(n.p,{children:"Run the container, then 'exec' into it and you should find it connects to your work VPN and is ready for you to remote to all your work environments (well, mine anyway)."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.em,{children:"note: you need to run container as 'privileged' for pppd kernel support\nthe vpn inside docker would complain about kernel not supporting pppd if you don't run privileged."})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"docker run -dP --name=workvpn --privileged companyname/vpn:centos7\ndocker exec -u loginid -ti <name_of_container /> /bin/bash\n"})}),"\n",(0,o.jsx)(n.h2,{id:"example-of-output-success",children:"Example of output success"}),"\n",(0,o.jsxs)(n.p,{children:["Run ",(0,o.jsx)(n.code,{children:"$ docker logs <name_of_container />"})," and see if you can see the following"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"$ docker logs workvpn\nKilling previous instances of Forticlient SSL VPN client...\nspawn /usr/local/bin/forticlientsslvpn/64bit/forticlientsslvpn_cli --server remote.site.com:443 --vpnuser loginid --keepalive\nPassword for VPN:\nSTATUS::Setting up the tunnel\nSTATUS::Connecting...\nCertificate:Certificate:\n    Data:\n        Version: 3 (0x2)\n        Serial Number:\n...\n... //certificate output\n... //certificate output\n... //certificate output\n...\n\nThe certificate for the SSLVPN server is invalid.\nYou are connecting to an untrusted server. which could put your confidential information at risk.\nWould you like to connect to this server? (Y/N)\nY\nSTATUS::Login succeed\nSTATUS::Starting PPPd\nSTATUS::Initializing tunnel\nSTATUS::Connecting to server\nSTATUS::Connected\nPress Ctrl-C to quit\nSTATUS::Tunnel running\n"})}),"\n",(0,o.jsx)(n.p,{children:"When you see 'Tunnel running' you should be good to go!"}),"\n",(0,o.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"https://github.com/ronamosa/forticlient-vpn",children:"Fortinet VPN Docker Container on Github."})," ",(0,o.jsx)(n.em,{children:"*repo includes the forticlient linux cli package."})]}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://hadler.me/linux/forticlient-sslvpn-deb-packages/",children:"Debian based GUI versions of forticlient-ssl-vpn."})}),"\n"]})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}}}]);