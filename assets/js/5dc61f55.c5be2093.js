"use strict";(self.webpackChunkronamosa_github_io=self.webpackChunkronamosa_github_io||[]).push([[36656],{28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var s=t(96540);const a={},l=s.createContext(a);function r(e){const n=s.useContext(l);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(l.Provider,{value:n},e.children)}},48077:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"study/CKS/Cluster Setup/ClusterNetworkPolicies","title":"Network Policies","description":"What are they?","source":"@site/docs/study/CKS/1. Cluster Setup/ClusterNetworkPolicies.md","sourceDirName":"study/CKS/1. Cluster Setup","slug":"/study/CKS/Cluster Setup/ClusterNetworkPolicies","permalink":"/docs/study/CKS/Cluster Setup/ClusterNetworkPolicies","draft":false,"unlisted":false,"editUrl":"https://github.com/ronamosa/ronamosa.github.io/edit/main/website/docs/study/CKS/1. Cluster Setup/ClusterNetworkPolicies.md","tags":[],"version":"current","lastUpdatedBy":"Ron Amosa","lastUpdatedAt":1771617957000,"frontMatter":{"title":"Network Policies"},"sidebar":"docsSidebar","previous":{"title":"Dashboard","permalink":"/docs/study/CKS/Cluster Setup/ClusterDashboard"},"next":{"title":"Node Metadata","permalink":"/docs/study/CKS/Cluster Setup/ClusterNodeMetatdata"}}');var a=t(74848),l=t(28453);const r={title:"Network Policies"},o=void 0,i={},d=[{value:"Single Network Policy",id:"single-network-policy",level:3},{value:"Multi Network Policy",id:"multi-network-policy",level:3},{value:"Default Deny",id:"default-deny",level:2},{value:"Allow DNS",id:"allow-dns",level:3},{value:"Allow Egress to Backend",id:"allow-egress-to-backend",level:3},{value:"Backend Default Deny",id:"backend-default-deny",level:3},{value:"Summary",id:"summary",level:2}];function c(e){const n={admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"What are they?"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"fw rules in k8s"}),"\n",(0,a.jsx)(n.li,{children:"implemented by CNI (calico/weave)"}),"\n",(0,a.jsx)(n.li,{children:"ns level"}),"\n",(0,a.jsx)(n.li,{children:"restrict ingress/egress for pods based specific conditions."}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Without network policies (NP)"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"every pod can talk to every pod"}),"\n",(0,a.jsxs)(n.li,{children:["no pods are ",(0,a.jsx)(n.em,{children:"isolated"})]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["NP flow example ",(0,a.jsx)(n.code,{children:"podSelector"}),":"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"podSelector"})," = will be applied TO (source)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"policyType"})," = e.g. egress, ingress"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"podSelector"})," = policy applied TO (destination)"]}),"\n"]}),"\n",(0,a.jsx)(n.admonition,{type:"note",children:(0,a.jsx)(n.p,{children:"As soon as you specific a NP e.g. an ingress from pod group A to pod group B --\x3e ALL other ingress will be blocked. Essentially NP become the network dictator for those pods selected"})}),"\n",(0,a.jsxs)(n.p,{children:["NP flow example ",(0,a.jsx)(n.code,{children:"namespaceSelector"}),":"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"podSelector"})," \u2190 ",(0,a.jsx)(n.code,{children:"policyType:Ingress"})," \u2190 ",(0,a.jsx)(n.code,{children:"namespaceSelector"})]}),"\n",(0,a.jsxs)(n.p,{children:["NP flow example ",(0,a.jsx)(n.code,{children:"ipBlock"}),":"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"podSelector"})," \u2192 ",(0,a.jsx)(n.code,{children:"policyType:Egress"})," \u2192 ",(0,a.jsx)(n.code,{children:"ipBlock:10.0.0.0/24"})]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"podSelector"})," \u2190 ",(0,a.jsx)(n.code,{children:"policyType:Inress"})," \u2190 ",(0,a.jsx)(n.code,{children:"ipBlock:10.0.0.0/24"})]}),"\n",(0,a.jsx)(n.p,{children:"You can put the rules in two separate policies (which will get merged) or just in a single yaml file."}),"\n",(0,a.jsx)(n.h3,{id:"single-network-policy",children:"Single Network Policy"}),"\n",(0,a.jsx)(n.p,{children:"single network policy"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"kind: NetworkPolicy\nmetadata:\n  name: 'example'\n  namespace: 'default'\nspec:\n  podSelector:\n    matchLabels:\n      id: 'frontend'\n    policyTypes:\n    - Egress\n"})}),"\n",(0,a.jsx)(n.p,{children:"this policy right now"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"is valid"}),"\n",(0,a.jsxs)(n.li,{children:["lives in namespace ",(0,a.jsx)(n.code,{children:"default"})]}),"\n",(0,a.jsx)(n.li,{children:"denies ALL outgoing traffic (it has indicated Egress so now its the all-controlling egress ruler)"}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"multi-network-policy",children:"Multi Network Policy"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"kind: NetworkPolicy\nmetadata:\n  name: 'example'\n  namespace: 'default' # \u2190 policy applies to this namespace\nspec:\n  podSelector:\n    matchLabels:\n      id: 'frontend' # \u2190 applied to these pods as the SUBJECT/TARGET\n    policyTypes:\n    - Egress\n    egress:\n\n    # RULE 1.\n    - to: # to AND ports i.e. id=ns1 AND port=80\n      - namespaceSelector:\n          matchLabels:\n            id: 'ns1'\n      ports:\n      - protoco: 'TCP'\n        port: 80\n\n    # RULE 2.\n    - to:\n      - podSelector:\n          matchLabels:\n            id: 'backend' # \u2190 applies to these pods in SAME namespace where the policy lives, unless otherwise specified with a `namespaceSelector` label here.\n"})}),"\n",(0,a.jsx)(n.p,{children:"Rule 1 and Rule 1 are OR'd."}),"\n",(0,a.jsx)(n.p,{children:"multiple network policies - what the difference?"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"they get merged"}),"\n",(0,a.jsx)(n.li,{children:"would operate exactly as if it were a single NP"}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"default-deny",children:"Default Deny"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"is good practice."}),"\n",(0,a.jsx)(n.li,{children:"required for CKS."}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"root@cks-master:~# k run frontend --image=nginx\npod/frontend created\n\nroot@cks-master:~# k run backend --image=nginx\npod/backend created\n"})}),"\n",(0,a.jsx)(n.p,{children:"expose our pods"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"root@cks-master:~# k expose pod frontend --port 80\nservice/frontend exposed\n\nroot@cks-master:~# k expose pod backend --port 80\nservice/backend exposed\n\nroot@cks-master:~# k get pod,svc\nNAME           READY   STATUS    RESTARTS   AGE\npod/backend    1/1     Running   0          3m41s\npod/frontend   1/1     Running   0          3m53s\n\nNAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE\nservice/backend      ClusterIP   10.107.165.22   &lt;none&gt;        80/TCP    8s\nservice/frontend     ClusterIP   10.103.184.90   &lt;none&gt;        80/TCP    14s\nservice/kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   14d\n"})}),"\n",(0,a.jsxs)(n.p,{children:["check connectivity ",(0,a.jsx)(n.code,{children:"frontend --\x3e backend"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'root@cks-master:~# k exec frontend -- curl backend\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href="http://nginx.org/"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href="http://nginx.com/"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n100   612  100   612    0     0    99k      0 --:--:-- --:--:-- --:--:--  119k\n'})}),"\n",(0,a.jsxs)(n.p,{children:["check ",(0,a.jsx)(n.code,{children:"backend --\x3e frontend"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'root@cks-master:~# k exec backend -- curl frontend\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100   612  100   612    0     0    99k      0 --:--:-- --:--:-- --:--:--   99k\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href="http://nginx.org/"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href="http://nginx.com/"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n'})}),"\n",(0,a.jsx)(n.p,{children:"create our default deny policy"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: 'default-deny'\n  namespace: 'default'\nspec:\n  podSelector: {}\n  policyTypes:\n  - Egress\n  - Ingress\n"})}),"\n",(0,a.jsx)(n.p,{children:"apply"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"root@cks-master:~# k apply -f ./default-deny.yaml\nnetworkpolicy.networking.k8s.io/default-deny created\n"})}),"\n",(0,a.jsx)(n.p,{children:"test our connectivity like before"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"root@cks-master:~# k exec backend -- curl frontend\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:--  0:00:17 --:--:--     0^C\n\nroot@cks-master:~# k exec frontend -- curl backend\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:--  0:00:09 --:--:--     0^C\n"})}),"\n",(0,a.jsx)(n.p,{children:"blocked!"}),"\n",(0,a.jsx)(n.p,{children:"now allow frontend-to-backend traffic with a single policy"}),"\n",(0,a.jsx)(n.h2,{id:""}),"\n",(0,a.jsxs)(n.p,{children:["new policy ",(0,a.jsx)(n.code,{children:"frontend.yaml"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: 'frontend'\n  namespace: 'default'\nspec:\n  podSelector:\n    matchLabels:\n      run: 'frontend'\n  policyTypes:\n  - Egress\n  egress:\n  - to:\n    - podSelector:\n        matchLabels:\n          run: 'backend'\n"})}),"\n",(0,a.jsx)(n.p,{children:"create"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"root@cks-master:~# k create -f ./frontend.yaml\nnetworkpolicy.networking.k8s.io/frontend created\n"})}),"\n",(0,a.jsx)(n.p,{children:"test connectivity"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"root@cks-master:~# k exec frontend -- curl backend\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:--  0:00:19 --:--:--     0curl: (6) Could not resolve host: backend\ncommand terminated with exit code 6\n"})}),"\n",(0,a.jsx)(n.p,{children:"doesnt' work!! why?"}),"\n",(0,a.jsx)(n.p,{children:"default deny policy still in effect!"}),"\n",(0,a.jsxs)(n.p,{children:["create ",(0,a.jsx)(n.code,{children:"backend.yaml"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: 'backend'\n  namespace: 'default'\nspec:\n  podSelector:\n    matchLabels:\n      run: 'backend'\n  policyTypes:\n  - Ingress\n  ingress:\n  - from:\n    - podSelector:\n        matchLabels:\n          run: 'frontend'\n"})}),"\n",(0,a.jsx)(n.p,{children:"create, test"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"root@cks-master:~# k create -f backend.yaml\nnetworkpolicy.networking.k8s.io/backend created\nroot@cks-master:~# k exec frontend -- curl backend\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:--  0:00:03 --:--:--     0^C\n"})}),"\n",(0,a.jsx)(n.p,{children:"still nothing! why?!"}),"\n",(0,a.jsxs)(n.p,{children:["DNS! if we want ",(0,a.jsx)(n.code,{children:"frontend"})," to find and connect to ",(0,a.jsx)(n.code,{children:"backend"})," it needs to be able to resolve the addresses"]}),"\n",(0,a.jsx)(n.p,{children:"let's test that it is in fact DNS"}),"\n",(0,a.jsx)(n.p,{children:"lookup the IP address of our pods and try to hit frontend--\x3ebackend via IP"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"root@cks-master:~# k get pods --show-labels -owide\nNAME       READY   STATUS    RESTARTS   AGE     IP          NODE         NOMINATED NODE   READINESS GATES   LABELS\nbackend    1/1     Running   0          5h35m   10.44.0.2   cks-worker   <none />           <none />            run=backend\nfrontend   1/1     Running   0          5h36m   10.44.0.1   cks-worker   <none />           <none />            run=frontend\n"})}),"\n",(0,a.jsx)(n.p,{children:"curl works!!"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'root@cks-master:~# k exec frontend -- curl 10.44.0.2\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100   612  100   612    0     0   597k      0 --:--:-- --:--:-- --:--:--  597k\n<!DOCTYPE html>\n<html />\n<head />\n<title />Welcome to nginx!</title>\n<style />\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n</style>\n</head>\n<body />\n<h1 />Welcome to nginx!</h1>\n<p />If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.</p>\n\n<p />For online documentation and support please refer to\n<a href="http://nginx.org/" />nginx.org</a>.<br/>\nCommercial support is available at\n<a href="http://nginx.com/" />nginx.com</a>.</p>\n\n<p /><em />Thank you for using nginx.</em></p>\n</body>\n</html>\n'})}),"\n",(0,a.jsxs)(n.p,{children:["let's update our ",(0,a.jsx)(n.code,{children:"default-deny"})," policy to allow DNS"]}),"\n",(0,a.jsx)(n.h3,{id:"allow-dns",children:"Allow DNS"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: 'default-deny'\n  namespace: 'default'\nspec:\n  podSelector: {}\n  policyTypes:\n  - Egress\n  - Ingress\n  egress:\n  - to:\n    ports:\n      - port: 53\n        protocol: 'TCP'\n      - port: 53\n        protocol: 'UDP'\n"})}),"\n",(0,a.jsx)(n.p,{children:"apply and test"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'root@cks-master:~# k apply -f ./default-deny.yaml\nnetworkpolicy.networking.k8s.io/default-deny configured\nroot@cks-master:~# k exec frontend -- curl backend\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0<!DOCTYPE html>\n<html />\n<head />\n<title />Welcome to nginx!</title>\n<style />\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n</style>\n</head>\n<body />\n<h1 />Welcome to nginx!</h1>\n<p />If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.</p>\n\n<p />For online documentation and support please refer to\n<a href="http://nginx.org/" />nginx.org</a>.<br/>\nCommercial support is available at\n<a href="http://nginx.com/" />nginx.com</a>.</p>\n\n<p /><em />Thank you for using nginx.</em></p>\n</body>\n</html>\n100   612  100   612    0     0   149k      0 --:--:-- --:--:-- --:--:--  149k\n'})}),"\n",(0,a.jsx)(n.p,{children:"success!! front to back..."}),"\n",(0,a.jsx)(n.p,{children:"back to front?"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"root@cks-master:~# k exec backend -- curl frontend\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:--  0:00:02 --:--:--     0^C\n"})}),"\n",(0,a.jsxs)(n.p,{children:["NO! but that's because we are ONLY allowing ",(0,a.jsx)(n.code,{children:"Ingress"})," into backend and ",(0,a.jsx)(n.code,{children:"Egress"})," out of front end."]}),"\n",(0,a.jsx)(n.p,{children:'"policy pairs" if you will - one to allow leaving the source, and one to allow entering the destiation.'}),"\n",(0,a.jsx)(n.h3,{id:"allow-egress-to-backend",children:"Allow Egress to Backend"}),"\n",(0,a.jsx)(n.p,{children:"allow a cassandra backend connection"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"root@cks-master:~# k create ns cassandra\nnamespace/cassandra created\n\nroot@cks-master:~# k edit ns cassandra\nnamespace/cassandra edited\n\nroot@cks-master:~# k -n cassandra run cassandra --image=nginx\npod/cassandra created\n\nroot@cks-master:~# k -n cassandra get pods -owide\nNAME        READY   STATUS    RESTARTS   AGE   IP          NODE         NOMINATED NODE   READINESS GATES\ncassandra   1/1     Running   0          8s    10.44.0.3   cks-worker   <none />           <none />\n\nroot@cks-master:~# k exec backend -- curl 10.44.0.3\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0^C\n"})}),"\n",(0,a.jsx)(n.p,{children:"allow egress to cassandra ns"}),"\n",(0,a.jsxs)(n.p,{children:["new ",(0,a.jsx)(n.code,{children:"backend.yaml"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: 'backend'\n  namespace: 'default'\nspec:\n  podSelector:\n    matchLabels:\n      run: 'backend'\n  policyTypes:\n  - Ingress\n  - Egress\n  ingress:\n  - from:\n    - podSelector:\n        matchLabels:\n          run: 'frontend'\n  egress:\n  - to:\n    - namespaceSelector:\n        matchLabels:\n          ns: 'cassandra'\n"})}),"\n",(0,a.jsx)(n.p,{children:"create/apply"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"root@cks-master:~# k create -f ./backend.yaml\nnetworkpolicy.networking.k8s.io/backend created\n"})}),"\n",(0,a.jsx)(n.p,{children:"success!!"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'root@cks-master:~# k exec backend -- curl 10.44.0.3\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0<!DOCTYPE html>\n<html />\n<head />\n<title />Welcome to nginx!</title>\n<style />\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n</style>\n</head>\n<body />\n<h1 />Welcome to nginx!</h1>\n<p />If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.</p>\n\n<p />For online documentation and support please refer to\n<a href="http://nginx.org/" />nginx.org</a>.<br/>\nCommercial support is available at\n<a href="http://nginx.com/" />nginx.com</a>.</p>\n\n<p /><em />Thank you for using nginx.</em></p>\n</body>\n</html>\n100   612  100   612    0     0   597k      0 --:--:-- --:--:-- --:--:--  597k\n'})}),"\n",(0,a.jsx)(n.h3,{id:"backend-default-deny",children:"Backend Default Deny"}),"\n",(0,a.jsx)(n.p,{children:"add a default deny policy to ns cassandra (best practice)"}),"\n",(0,a.jsxs)(n.p,{children:["new ",(0,a.jsx)(n.code,{children:"cassandra-deny.yaml"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: 'cassandra-deny'\n  namespace: 'cassandra'\nspec:\n  podSelector: {}\n  policyTypes:\n  - Egress\n  - Ingress\n  egress:\n  - to:\n    ports:\n      - port: 53\n        protocol: 'TCP'\n      - port: 53\n        protocol: 'UDP'\n"})}),"\n",(0,a.jsxs)(n.p,{children:["doesn't work! needs explicit allow ",(0,a.jsx)(n.code,{children:"Ingress"})," into cassandra."]}),"\n",(0,a.jsxs)(n.p,{children:["cp ",(0,a.jsx)(n.code,{children:"backend.yaml"})," to ",(0,a.jsx)(n.code,{children:"cassandra.yaml"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: 'cassandra'\n  namespace: 'cassandra'\nspec:\n  podSelector:\n    matchLabels:\n      run: 'cassandra'\n  policyTypes:\n  - Ingress\n  ingress:\n  - from:\n    - namespaceSelector:\n        matchLabels:\n          ns: 'default'\n"})}),"\n",(0,a.jsxs)(n.p,{children:["still wont work because we need to add the ",(0,a.jsx)(n.code,{children:"ns: default"})," label to the default namespace: ",(0,a.jsx)(n.code,{children:"kubectl edit ns default"})]}),"\n",(0,a.jsx)(n.p,{children:"magic!!"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'root@cks-master:~# k exec backend -- curl 10.44.0.3\n<!DOCTYPE html>\n<html />\n<head />\n<title />Welcome to nginx!</title>\n<style />\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n</style>\n</head>\n<body />\n<h1 />Welcome to nginx!</h1>\n<p />If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.</p>\n\n<p />For online documentation and support please refer to\n<a href="http://nginx.org/" />nginx.org</a>.<br/>\nCommercial support is available at\n<a href="http://nginx.com/" />nginx.com</a>.</p>\n\n<p /><em />Thank you for using nginx.</em></p>\n</body>\n</html>\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100   612  100   612    0     0   597k      0 --:--:-- --:--:-- --:--:--  597k\n'})}),"\n",(0,a.jsx)(n.p,{children:"frontend (egress) --\x3e (ingress) backend : based on pod labels"}),"\n",(0,a.jsx)(n.p,{children:"backend (egress) --\x3e (ingress) cassandra : based on namespace labels"}),"\n",(0,a.jsx)(n.p,{children:"default deny policies for both namespaces"}),"\n",(0,a.jsx)(n.h2,{id:"summary",children:"Summary"})]})}function p(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}}}]);